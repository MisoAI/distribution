{"version":3,"file":"miso-myrecipe-widget.js","sources":["../src/utils/html.ts","../src/imgs/icon-add.svg","../src/imgs/icon-loading.svg","../src/widgets/plan-listing/index.ts","../src/imgs/icon-arrow-left.svg","../src/imgs/icon-arrow-up.svg","../src/imgs/icon-dots.svg","../src/imgs/icon-close.svg","../src/imgs/icon-like.svg","../src/imgs/icon-like-active.svg","../src/widgets/plan-editor/renderers.ts","../src/utils/modal/index.ts","../src/widgets/plan-editor/modals/MoveModal.ts","../src/widgets/plan-editor/modals/SwapModal.ts","../src/widgets/plan-editor/index.ts","../src/widgets/plan-editor/state.ts","../src/services/api.ts","../src/core/instance.ts","../src/index.ts"],"sourcesContent":["/**\n * Escapes HTML special characters in a string to prevent XSS attacks.\n * Uses the browser's built-in text content handling for safety.\n */\nexport function escapeHtml(text: string): string {\n  const div = document.createElement('div')\n  div.textContent = text\n  return div.innerHTML\n}\n","export default \"data:image/svg+xml,%3csvg%20width='16'%20height='16'%20viewBox='0%200%2016%2016'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20fill-rule='evenodd'%20clip-rule='evenodd'%20d='M13.3334%208.76191H8.76193V13.3333H7.23812V8.76191H2.66669V7.2381H7.23812V2.66667H8.76193V7.2381H13.3334V8.76191V8.76191Z'%20fill='black'/%3e%3c/svg%3e\"","export default \"data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3ccircle%20cx='12'%20cy='12'%20r='10'%20stroke='%23000000'%20stroke-width='3'%20stroke-linecap='round'%20stroke-dasharray='53.4%209.4'%3e%3canimateTransform%20attributeName='transform'%20type='rotate'%20from='0%2012%2012'%20to='360%2012%2012'%20dur='1s'%20repeatCount='indefinite'/%3e%3c/circle%3e%3c/svg%3e\"","import type { MisoWidgetInstance } from '../../core/instance'\nimport type { SimplePlan } from '../../types/api'\nimport { escapeHtml } from '../../utils/html'\nimport iconAdd from '../../imgs/icon-add.svg'\nimport iconLoading from '../../imgs/icon-loading.svg'\nimport './styles.css'\n\nexport class PlanListingWidget {\n  private container: HTMLElement\n  private instance: MisoWidgetInstance\n  private widgetElement: HTMLElement | null = null\n  private plans: SimplePlan[] = []\n  private isLoading = false\n\n  constructor(container: HTMLElement, instance: MisoWidgetInstance) {\n    this.container = container\n    this.instance = instance\n  }\n\n  render(): void {\n    // Initial render with loading state\n    this.renderContent()\n\n    // Fetch plans asynchronously\n    this.loadPlans()\n  }\n\n  private async loadPlans(): Promise<void> {\n    this.isLoading = true\n    this.renderContent()\n\n    try {\n      this.plans = await this.instance.apiService.getPlans()\n    } catch (error) {\n      console.error('Failed to fetch plans:', error)\n      this.plans = []\n    } finally {\n      this.isLoading = false\n      this.renderContent()\n    }\n  }\n\n  private renderContent(): void {\n    const template = `\n      <div class=\"miso-plan-listing\">\n        <h1 class=\"miso-plan-listing__title\">Meal Plans</h1>\n        ${this.isLoading ? this.renderLoading() : this.renderPlans()}\n      </div>\n    `\n\n    this.container.innerHTML = template\n    this.widgetElement = this.container.firstElementChild as HTMLElement\n\n    // Attach event listeners after rendering\n    if (!this.isLoading) {\n      this.attachEventListeners()\n    }\n  }\n\n  private renderLoading(): string {\n    return `\n      <div class=\"miso-plan-listing__loading\">\n        <img src=\"${iconLoading}\" alt=\"Loading\" class=\"miso-plan-listing__loading-icon\" />\n      </div>\n    `\n  }\n\n  private renderPlans(): string {\n    if (this.plans.length === 0) {\n      return this.renderEmptyState()\n    }\n\n    const planCount = this.plans.length === 1 ? '1 Plan' : `${this.plans.length} Plans`\n\n    return `\n      <div class=\"miso-plan-listing__header\">\n        <div class=\"miso-plan-listing__count\">${planCount}</div>\n        <button class=\"miso-plan-listing__new-btn\" data-action=\"create-plan\">\n          <span>New Plan</span>\n          <img src=\"${iconAdd}\" alt=\"\" class=\"miso-plan-listing__new-btn-icon\" />\n        </button>\n      </div>\n      <div class=\"miso-plan-listing__list\">\n        ${this.plans.map(plan => this.renderPlanCard(plan)).join('')}\n      </div>\n    `\n  }\n\n  private renderEmptyState(): string {\n    return `\n      <div class=\"miso-plan-listing__empty\">\n        <p class=\"miso-plan-listing__empty-text\">No meal plan yet. Create a new plan to get started!</p>\n        <button class=\"miso-plan-listing__new-btn\" data-action=\"create-plan\">\n          <span>New Plan</span>\n          <img src=\"${iconAdd}\" alt=\"\" class=\"miso-plan-listing__new-btn-icon\" />\n        </button>\n      </div>\n    `\n  }\n\n  private renderPlanCard(plan: SimplePlan): string {\n    const recipeCount = plan.n_recipes === 1 ? '1 RECIPE' : `${plan.n_recipes} RECIPES`\n    const createdDate = this.formatDate(plan.created_at)\n\n    return `\n      <div class=\"miso-plan-listing__card\" data-plan-id=\"${plan.id}\">\n        <div class=\"miso-plan-listing__card-title\">${escapeHtml(plan.title)}</div>\n        <div class=\"miso-plan-listing__card-meta\">\n          <span class=\"miso-plan-listing__card-recipes\">${recipeCount}</span>\n          <span class=\"miso-plan-listing__card-date\">CREATED ON ${createdDate}</span>\n        </div>\n      </div>\n    `\n  }\n\n  private formatDate(timestamp: number): string {\n    const date = new Date(timestamp)\n    const day = date.getDate()\n    const month = date.getMonth() + 1\n    const year = date.getFullYear().toString().slice(-2)\n    return `${day}/${month}/${year}`\n  }\n\n  private attachEventListeners(): void {\n    if (!this.widgetElement) return\n\n    // New Plan button\n    const newPlanBtn = this.widgetElement.querySelector('[data-action=\"create-plan\"]')\n    if (newPlanBtn) {\n      newPlanBtn.addEventListener('click', () => {\n        this.instance.emit('create-plan')\n      })\n    }\n\n    // Plan cards\n    const planCards = this.widgetElement.querySelectorAll('[data-plan-id]')\n    planCards.forEach(card => {\n      card.addEventListener('click', () => {\n        const planId = (card as HTMLElement).dataset.planId\n        if (planId) {\n          this.instance.emit('view-plan', planId)\n        }\n      })\n    })\n  }\n\n  async getPlans(): Promise<SimplePlan[]> {\n    return this.plans\n  }\n\n  async refreshPlans(): Promise<void> {\n    await this.loadPlans()\n  }\n\n  destroy(): void {\n    if (this.widgetElement) {\n      this.container.removeChild(this.widgetElement)\n      this.widgetElement = null\n    }\n    this.plans = []\n  }\n}\n","export default \"data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20fill-rule='evenodd'%20clip-rule='evenodd'%20d='M9.9172%2018.7216L4.26035%2012.6722C3.91322%2012.3009%203.91322%2011.6991%204.26035%2011.3278L9.91721%205.27842C10.2643%204.90719%2010.8272%204.90719%2011.1743%205.27842C11.5214%205.64964%2011.5214%206.25151%2011.1743%206.62273L7.03486%2011.0494L19.1111%2011.0494C19.602%2011.0494%2020%2011.475%2020%2012C20%2012.525%2019.602%2012.9506%2019.1111%2012.9506L7.03486%2012.9506L11.1743%2017.3773C11.5214%2017.7485%2011.5214%2018.3504%2011.1743%2018.7216C10.8271%2019.0928%2010.2643%2019.0928%209.9172%2018.7216Z'%20fill='white'/%3e%3cpath%20fill-rule='evenodd'%20clip-rule='evenodd'%20d='M9.1868%2019.4046L3.52994%2013.3552C2.82335%2012.5995%202.82335%2011.4005%203.52994%2010.6448L9.1868%204.59541C9.92916%203.80153%2011.1623%203.80153%2011.9047%204.59541C12.6113%205.35103%2012.6113%206.55012%2011.9047%207.30574L9.33906%2010.0494L19.1111%2010.0494C20.2165%2010.0494%2021%2010.987%2021%2012C21%2013.013%2020.2165%2013.9506%2019.1111%2013.9506L9.33906%2013.9506L11.9047%2016.6943C12.6113%2017.4499%2012.6113%2018.649%2011.9047%2019.4046C11.1623%2020.1985%209.92915%2020.1985%209.1868%2019.4046ZM11.1743%2017.3773C11.5214%2017.7485%2011.5214%2018.3504%2011.1743%2018.7216C10.8272%2019.0928%2010.2643%2019.0928%209.9172%2018.7216L4.26035%2012.6722C3.91322%2012.3009%203.91322%2011.6991%204.26035%2011.3278L9.91721%205.27842C10.2643%204.90719%2010.8272%204.90719%2011.1743%205.27842C11.5214%205.64964%2011.5214%206.25151%2011.1743%206.62273L7.03486%2011.0494L19.1111%2011.0494C19.602%2011.0494%2020%2011.475%2020%2012C20%2012.525%2019.602%2012.9506%2019.1111%2012.9506L7.03486%2012.9506L11.1743%2017.3773Z'%20fill='black'/%3e%3c/svg%3e\"","export default \"data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20fill-rule='evenodd'%20clip-rule='evenodd'%20d='M18.7216%209.91721L12.6722%204.26035C12.3009%203.91322%2011.6991%203.91322%2011.3278%204.26035L5.27842%209.91721C4.90719%2010.2643%204.90719%2010.8272%205.27842%2011.1743C5.64964%2011.5214%206.25151%2011.5214%206.62273%2011.1743L11.0494%207.03486L11.0494%2019.1111C11.0494%2019.602%2011.475%2020%2012%2020C12.525%2020%2012.9506%2019.602%2012.9506%2019.1111L12.9506%207.03486L17.3773%2011.1743C17.7485%2011.5214%2018.3504%2011.5214%2018.7216%2011.1743C19.0928%2010.8272%2019.0928%2010.2643%2018.7216%209.91721Z'%20fill='white'/%3e%3cpath%20fill-rule='evenodd'%20clip-rule='evenodd'%20d='M19.4046%209.1868L13.3552%203.52994C12.5995%202.82336%2011.4005%202.82336%2010.6448%203.52994L4.59541%209.1868C3.80153%209.92916%203.80153%2011.1623%204.59541%2011.9047C5.35103%2012.6113%206.55012%2012.6113%207.30574%2011.9047L10.0494%209.33906L10.0494%2019.1111C10.0494%2020.2165%2010.987%2021%2012%2021C13.013%2021%2013.9506%2020.2165%2013.9506%2019.1111L13.9506%209.33906L16.6943%2011.9047C17.4499%2012.6113%2018.649%2012.6113%2019.4046%2011.9047C20.1985%2011.1623%2020.1985%209.92915%2019.4046%209.1868ZM17.3773%2011.1743C17.7485%2011.5214%2018.3504%2011.5214%2018.7216%2011.1743C19.0928%2010.8272%2019.0928%2010.2643%2018.7216%209.91721L12.6722%204.26035C12.3009%203.91322%2011.6991%203.91322%2011.3278%204.26035L5.27842%209.91721C4.90719%2010.2643%204.90719%2010.8272%205.27842%2011.1743C5.64964%2011.5214%206.25151%2011.5214%206.62273%2011.1743L11.0494%207.03486L11.0494%2019.1111C11.0494%2019.602%2011.475%2020%2012%2020C12.525%2020%2012.9506%2019.602%2012.9506%2019.1111L12.9506%207.03486L17.3773%2011.1743Z'%20fill='black'/%3e%3c/svg%3e\"","export default \"data:image/svg+xml,%3csvg%20width='32'%20height='32'%20viewBox='0%200%2032%2032'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3ccircle%20cx='7.5'%20cy='15.5'%20r='3'%20fill='white'%20stroke='black'/%3e%3ccircle%20cx='16'%20cy='15.5'%20r='3'%20fill='white'%20stroke='black'/%3e%3ccircle%20cx='24.5'%20cy='15.5'%20r='3'%20fill='white'%20stroke='black'/%3e%3c/svg%3e\"","export default \"data:image/svg+xml,%3csvg%20width='24'%20height='24'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20fill-rule='evenodd'%20clip-rule='evenodd'%20d='M18.6897%206.80873C19.1034%206.39496%2019.1034%205.7241%2018.6897%205.31033C18.2759%204.89656%2017.605%204.89656%2017.1913%205.31033L12%2010.5016L6.80873%205.31033C6.39496%204.89656%205.7241%204.89656%205.31033%205.31033C4.89656%205.7241%204.89656%206.39496%205.31033%206.80873L10.5016%2012L5.31033%2017.1913C4.89656%2017.605%204.89656%2018.2759%205.31033%2018.6897C5.7241%2019.1034%206.39496%2019.1034%206.80873%2018.6897L12%2013.4984L17.1913%2018.6897C17.605%2019.1034%2018.2759%2019.1034%2018.6897%2018.6897C19.1034%2018.2759%2019.1034%2017.605%2018.6897%2017.1913L13.4984%2012L18.6897%206.80873Z'%20fill='black'/%3e%3c/svg%3e\"","export default \"data:image/svg+xml,%3csvg%20width='20'%20height='20'%20viewBox='0%200%2020%2020'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M19.1667%205.31804C19.1667%205.31804%2019.1667%205.31479%2019.1667%205.31284C19.1647%204.60204%2019.0286%203.91203%2018.7622%203.25905C18.4952%202.60347%2018.1105%202.01871%2017.6186%201.52102C17.1241%201.02008%2016.5467%200.633487%2015.9022%200.370996C15.2978%200.124748%2014.6619%200%2014.0122%200C13.9707%200%2013.9293%200%2013.8872%200.00129946C13.0665%200.00779676%2012.2714%200.189072%2011.5243%200.540576C10.7792%200.89143%2010.1262%201.38977%209.58366%202.02326C9.04046%201.38977%208.38809%200.89078%207.64299%200.540576C6.89526%200.189072%206.10019%200.00779676%205.27946%200.00129946C5.23803%200%205.19594%200%205.15451%200C4.50477%200%203.86884%200.124748%203.26448%200.370996C2.62%200.633487%202.0426%201.02008%201.54806%201.52102C1.05616%202.01871%200.671442%202.60347%200.404443%203.25905C0.138103%203.91138%200.00197289%204.60204%200%205.31025C0%205.31285%200%205.31544%200%205.31804V7.50828C0%207.50828%200%207.50828%200%207.50893C0%207.50893%200%207.51023%200%207.51088V7.54727C0.0105221%209.23917%200.700377%2010.844%202.23397%2012.7458L2.24384%2012.7581L2.25436%2012.7704C4.09244%2014.8665%206.08704%2016.8495%208.18291%2018.6635L9.03125%2019.4815L9.56854%2020L10.119%2019.4952L10.9746%2018.7109C13.0698%2016.8917%2015.067%2014.9074%2016.9097%2012.8127L16.9241%2012.7964L16.938%2012.7789C18.4676%2010.8284%2019.1561%209.21318%2019.1653%207.54727V5.31804H19.1667Z'%20fill='black'/%3e%3cpath%20d='M13.9003%200.780983C13.198%200.785531%2012.5035%200.943415%2011.863%201.24424C11.2225%201.54572%2010.6503%201.98363%2010.1828%202.53006L9.583%203.24671L8.98324%202.53006C8.51566%201.98363%207.94287%201.54572%207.30233%201.24424C6.6618%200.942766%205.968%200.784881%205.26565%200.780983C4.6843%200.765389%204.10625%200.871295%203.56436%201.09155C3.02313%201.31181%202.52925%201.64317%202.11231%202.0655C1.69537%202.48782%201.36327%202.99201%201.13638%203.55013C0.908843%204.1076%200.791127%204.7073%200.789154%205.31285C0.789154%206.82867%201.42048%208.28667%202.85149%2010.0611C4.67641%2012.1428%206.63747%2014.0914%208.71953%2015.8924L9.583%2016.7254L10.4465%2015.934C12.5259%2014.1297%2014.4863%2012.1812%2016.3145%2010.1027C17.7455%208.27822%2018.3775%206.82023%2018.3775%205.31285C18.3755%204.7073%2018.2572%204.1076%2018.0303%203.55013C17.8034%202.99266%2017.4713%202.48782%2017.0537%202.0655C16.6368%201.64317%2016.1429%201.31246%2015.6016%201.09155C15.0604%200.871295%2014.4817%200.765389%2013.9003%200.780983Z'%20fill='white'/%3e%3c/svg%3e\"","export default \"data:image/svg+xml,%3csvg%20width='20'%20height='20'%20viewBox='0%200%2020%2020'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M19.1667%205.31804C19.1667%205.31804%2019.1667%205.31479%2019.1667%205.31284C19.1647%204.60204%2019.0286%203.91203%2018.7622%203.25905C18.4952%202.60347%2018.1105%202.01871%2017.6186%201.52102C17.1241%201.02008%2016.5467%200.633487%2015.9022%200.370996C15.2978%200.124748%2014.6619%200%2014.0122%200C13.9707%200%2013.9293%200%2013.8872%200.00129946C13.0665%200.00779676%2012.2714%200.189072%2011.5243%200.540576C10.7792%200.89143%2010.1262%201.38977%209.58366%202.02326C9.04046%201.38977%208.38809%200.89078%207.64299%200.540576C6.89526%200.189072%206.10019%200.00779676%205.27946%200.00129946C5.23803%200%205.19594%200%205.15451%200C4.50477%200%203.86884%200.124748%203.26448%200.370996C2.62%200.633487%202.0426%201.02008%201.54806%201.52102C1.05616%202.01871%200.671442%202.60347%200.404443%203.25905C0.138103%203.91138%200.00197289%204.60204%200%205.31025C0%205.31285%200%205.31544%200%205.31804V7.50828C0%207.50828%200%207.50828%200%207.50893C0%207.50893%200%207.51023%200%207.51088V7.54727C0.0105221%209.23917%200.700377%2010.844%202.23397%2012.7458L2.24384%2012.7581L2.25436%2012.7704C4.09244%2014.8665%206.08704%2016.8495%208.18291%2018.6635L9.03125%2019.4815L9.56854%2020L10.119%2019.4952L10.9746%2018.7109C13.0698%2016.8917%2015.067%2014.9074%2016.9097%2012.8127L16.9241%2012.7964L16.938%2012.7789C18.4676%2010.8284%2019.1561%209.21318%2019.1653%207.54727V5.31804H19.1667Z'%20fill='black'/%3e%3cpath%20d='M13.9003%200.780983C13.198%200.785531%2012.5035%200.943415%2011.863%201.24424C11.2225%201.54572%2010.6503%201.98363%2010.1828%202.53006L9.583%203.24671L8.98324%202.53006C8.51566%201.98363%207.94287%201.54572%207.30233%201.24424C6.6618%200.942766%205.968%200.784881%205.26565%200.780983C4.6843%200.765389%204.10625%200.871295%203.56436%201.09155C3.02313%201.31181%202.52925%201.64317%202.11231%202.0655C1.69537%202.48782%201.36327%202.99201%201.13638%203.55013C0.908843%204.1076%200.791127%204.7073%200.789154%205.31285C0.789154%206.82867%201.42048%208.28667%202.85149%2010.0611C4.67641%2012.1428%206.63747%2014.0914%208.71953%2015.8924L9.583%2016.7254L10.4465%2015.934C12.5259%2014.1297%2014.4863%2012.1812%2016.3145%2010.1027C17.7455%208.27822%2018.3775%206.82023%2018.3775%205.31285C18.3755%204.7073%2018.2572%204.1076%2018.0303%203.55013C17.8034%202.99266%2017.4713%202.48782%2017.0537%202.0655C16.6368%201.64317%2016.1429%201.31246%2015.6016%201.09155C15.0604%200.871295%2014.4817%200.765389%2013.9003%200.780983Z'%20fill='url(%23paint0_linear_2439_35)'/%3e%3cdefs%3e%3clinearGradient%20id='paint0_linear_2439_35'%20x1='20.0615'%20y1='12.1852'%20x2='-3.82082'%20y2='-4.58681'%20gradientUnits='userSpaceOnUse'%3e%3cstop%20offset='0.36291'%20stop-color='%23FF597A'/%3e%3cstop%20offset='0.572672'%20stop-color='%23FF29C4'/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e\"","import type { Recipe } from '../../types/api'\nimport type { PlanEditorState } from './state'\nimport { escapeHtml } from '../../utils/html'\nimport iconArrowLeft from '../../imgs/icon-arrow-left.svg'\nimport iconArrowUp from '../../imgs/icon-arrow-up.svg'\nimport iconDots from '../../imgs/icon-dots.svg'\nimport iconClose from '../../imgs/icon-close.svg'\nimport iconLoading from '../../imgs/icon-loading.svg'\nimport iconLike from '../../imgs/icon-like.svg'\nimport iconLikeActive from '../../imgs/icon-like-active.svg'\n\n/**\n * Loading step messages for plan creation phases\n */\nexport const loadingSteps = {\n  searching: [\n    \"Browsing our recipe collection...\",\n    \"Hunting down delicious ideas...\",\n    \"Exploring thousands of recipes...\",\n    \"Searching for the perfect dishes...\",\n    \"Digging through our cookbook...\",\n    \"Scouring the kitchen for inspiration...\",\n    \"Flipping through recipe pages...\",\n    \"Discovering culinary gems...\",\n    \"Peeking into our recipe vault...\",\n    \"Gathering tasty possibilities...\",\n  ],\n  validating: [\n    \"Checking dietary requirements...\",\n    \"Making sure everything fits your needs...\",\n    \"Filtering out what doesn't match...\",\n    \"Double-checking ingredients for you...\",\n    \"Ensuring every dish works for you...\",\n    \"Scanning for allergens and restrictions...\",\n    \"Verifying nutritional balance...\",\n    \"Matching recipes to your preferences...\",\n    \"Reviewing ingredients carefully...\",\n    \"Confirming everything meets your criteria...\",\n  ],\n  building: [\n    \"Putting together your meal plan...\",\n    \"Balancing flavors and nutrition...\",\n    \"Crafting the perfect day of meals...\",\n    \"Almost ready to serve...\",\n    \"Adding the finishing touches...\",\n    \"Arranging your daily menu...\",\n    \"Mixing variety into your plan...\",\n    \"Plating your personalized meals...\",\n    \"Seasoning your schedule with great picks...\",\n    \"Wrapping up your delicious day...\",\n  ],\n} as const\n\n/**\n * Render context passed to all render functions\n */\nexport interface RenderContext {\n  state: PlanEditorState\n}\n\n/**\n * Renders the full loading state when loading a plan in edit mode\n */\nexport function renderFullLoading(): string {\n  return `\n    <div class=\"miso-plan-editor\">\n      <div class=\"miso-plan-editor__loading-full\">\n        <img src=\"${iconLoading}\" alt=\"Loading\" class=\"miso-plan-editor__loading-icon\" />\n      </div>\n    </div>\n  `\n}\n\n/**\n * Renders the plan not found error view\n */\nexport function renderPlanNotFound(): string {\n  return `\n    <div class=\"miso-plan-editor\">\n      <div class=\"miso-plan-editor__not-found\">\n        <div class=\"miso-plan-editor__not-found-content\">\n          <h2 class=\"miso-plan-editor__not-found-title\">Plan Not Found</h2>\n          <p class=\"miso-plan-editor__not-found-message\">The meal plan you're looking for doesn't exist or has been removed.</p>\n          <button class=\"miso-plan-editor__not-found-btn\" data-action=\"back-to-home\">\n            <img src=\"${iconArrowLeft}\" alt=\"Back\" class=\"miso-plan-editor__not-found-icon\" />\n            Back to Home\n          </button>\n        </div>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Renders the main plan editor layout\n */\nexport function renderPlanEditor(ctx: RenderContext): string {\n  return `\n    <div class=\"miso-plan-editor\">\n      ${renderTopSection(ctx)}\n      ${renderBottomSection(ctx)}\n      ${renderPromptSection(ctx)}\n    </div>\n  `\n}\n\n/**\n * Renders the top section with title and recipe area\n */\nexport function renderTopSection(ctx: RenderContext): string {\n  const { state } = ctx\n  const title = state.plan?.title || 'Untitled Plan'\n  const hasRecipes = state.plan?.recipes && state.plan.recipes.length > 0\n\n  return `\n    <div class=\"miso-plan-editor__top\">\n      <div class=\"miso-plan-editor__title-area ${!hasRecipes ? 'miso-plan-editor__title-area--no-recipes' : ''}\">\n        <div class=\"miso-plan-editor__title-left\">\n          <img src=\"${iconArrowLeft}\" alt=\"Back\" class=\"miso-plan-editor__back-btn\" />\n          <h1 class=\"miso-plan-editor__title\">${escapeHtml(title)}</h1>\n        </div>\n        <img src=\"${iconDots}\" alt=\"More\" class=\"miso-plan-editor__dots-icon\" />\n      </div>\n      ${hasRecipes ? renderRecipeArea(ctx) : ''}\n      <button class=\"miso-plan-editor__scroll-top-btn\">\n        <img src=\"${iconArrowUp}\" alt=\"Scroll to top\" class=\"miso-plan-editor__scroll-top-icon\" />\n      </button>\n    </div>\n  `\n}\n\n/**\n * Renders the horizontal scrollable recipe area\n */\nexport function renderRecipeArea(ctx: RenderContext): string {\n  const { state } = ctx\n  if (!state.plan?.recipes) return ''\n\n  return `\n    <div class=\"miso-plan-editor__recipe-area\">\n      ${state.plan.recipes.map((recipe, index) => renderRecipeSlot(recipe, index, ctx)).join('')}\n    </div>\n  `\n}\n\n/**\n * Renders a single recipe slot with label, card, and actions\n */\nexport function renderRecipeSlot(recipe: Recipe, index: number, ctx: RenderContext): string {\n  return `\n    <div class=\"miso-plan-editor__recipe-slot\">\n      <div class=\"miso-plan-editor__slot-label\">${escapeHtml(recipe.slot_label)}</div>\n      ${renderRecipeCard(recipe, ctx)}\n      <div class=\"miso-plan-editor__slot-actions\">\n        <button class=\"miso-plan-editor__action-btn miso-plan-editor__swap-btn\" data-recipe-index=\"${index}\">Swap</button>\n        <button class=\"miso-plan-editor__action-btn miso-plan-editor__move-btn\" data-recipe-index=\"${index}\">Move</button>\n      </div>\n    </div>\n  `\n}\n\n/**\n * Renders a recipe card with image, title, and save button\n */\nexport function renderRecipeCard(recipe: Recipe, ctx: RenderContext): string {\n  const { state } = ctx\n  const isSaved = state.savedRecipes.includes(recipe.id)\n\n  return `\n    <div class=\"miso-plan-editor__recipe-card\">\n      <button class=\"miso-plan-editor__save-btn${isSaved ? ' miso-plan-editor__save-btn--active' : ''}\" data-recipe-id=\"${recipe.id}\">\n        <img src=\"${iconLike}\" alt=\"Save\" class=\"miso-plan-editor__save-icon miso-plan-editor__save-icon--default\" />\n        <img src=\"${iconLikeActive}\" alt=\"Save\" class=\"miso-plan-editor__save-icon miso-plan-editor__save-icon--active\" />\n      </button>\n      <a href=\"${escapeHtml(recipe.url)}\" target=\"_blank\" rel=\"noopener\" class=\"miso-plan-editor__recipe-card-link\">\n        <div class=\"miso-plan-editor__recipe-image\" style=\"background-image: url('${recipe.cover_image}')\"></div>\n        <div class=\"miso-plan-editor__recipe-title\">\n          <span class=\"miso-plan-editor__recipe-title-text\">${escapeHtml(recipe.title)}</span>\n        </div>\n      </a>\n    </div>\n  `\n}\n\n/**\n * Renders the bottom section with message area\n */\nexport function renderBottomSection(ctx: RenderContext): string {\n  const { state } = ctx\n  const isNewPlan = !state.planId\n  const isCreating = state.creationPhase !== 'idle'\n\n  let messageContent: string\n  if (isCreating) {\n    messageContent = renderCreationLoadingMessage(ctx)\n  } else if (isNewPlan) {\n    messageContent = renderWelcomeMessage()\n  } else {\n    messageContent = renderLastAssistantMessage(ctx)\n  }\n\n  return `\n    <div class=\"miso-plan-editor__bottom\">\n      <div class=\"miso-plan-editor__message-area\">\n        ${messageContent}\n      </div>\n    </div>\n  `\n}\n\n/**\n * Renders the welcome message for new plans\n */\nexport function renderWelcomeMessage(): string {\n  return `\n    <div class=\"miso-plan-editor__welcome\">\n      Welcome! Let's plan a meal together. Just briefly describe what you'd like to plan, and we'll get started.\n    </div>\n  `\n}\n\n/**\n * Renders the creation loading message with fade animation\n */\nexport function renderCreationLoadingMessage(ctx: RenderContext): string {\n  const { state } = ctx\n  if (!state.creationMessage) return ''\n\n  return `\n    <div class=\"miso-plan-editor__creation-message\">\n      ${escapeHtml(state.creationMessage)}\n    </div>\n  `\n}\n\n/**\n * Renders the last assistant message from plan messages\n */\nexport function renderLastAssistantMessage(ctx: RenderContext): string {\n  const { state } = ctx\n  if (!state.plan?.messages) return ''\n\n  const assistantMessages = state.plan.messages.filter(m => m.role === 'assistant')\n  const lastMessage = assistantMessages[assistantMessages.length - 1]\n\n  if (!lastMessage) return ''\n\n  return `\n    <div class=\"miso-plan-editor__assistant-message\">\n      ${escapeHtml(lastMessage.content)}\n    </div>\n  `\n}\n\n/**\n * Renders the prompt section with suggestions and input\n */\nexport function renderPromptSection(ctx: RenderContext): string {\n  return `\n    <div class=\"miso-plan-editor__prompt-section\">\n      ${renderSuggestions(ctx)}\n      ${renderInputArea(ctx)}\n    </div>\n  `\n}\n\n/**\n * Renders the prompt suggestion buttons\n */\nexport function renderSuggestions(ctx: RenderContext): string {\n  const { state } = ctx\n  if (state.suggestions.length === 0) return ''\n\n  return `\n    <div class=\"miso-plan-editor__suggestions\">\n      ${state.suggestions.map(suggestion => `\n        <button class=\"miso-plan-editor__suggestion-btn\" data-suggestion=\"${escapeHtml(suggestion)}\">\n          <span class=\"miso-plan-editor__suggestion-btn-text\">${escapeHtml(suggestion)}</span>\n        </button>\n      `).join('')}\n    </div>\n  `\n}\n\n/**\n * Renders the input area with form and error message\n */\nexport function renderInputArea(ctx: RenderContext): string {\n  const { state } = ctx\n  const isNewPlan = !state.planId\n  const placeholder = isNewPlan ? 'What shall we plan?' : 'Any updates or tweaks?'\n\n  return `\n    <form class=\"miso-plan-editor__input-form\">\n      <div class=\"miso-plan-editor__input-wrapper\">\n        <input \n          type=\"text\" \n          class=\"miso-plan-editor__input\" \n          placeholder=\"${placeholder}\"\n          value=\"\"\n          ${state.isLoading ? 'disabled' : ''}\n        />\n        <img src=\"${iconClose}\" alt=\"Clear\" class=\"miso-plan-editor__clear-btn\" style=\"display: none;\" />\n      </div>\n      ${state.errorMessage ? `<div class=\"miso-plan-editor__error\">${escapeHtml(state.errorMessage)}</div>` : ''}\n    </form>\n  `\n}\n\n// Re-export icons for use in modals\nexport { iconLike, iconLikeActive }\n","import iconClose from '../../imgs/icon-close.svg'\nimport './styles.css'\n\nexport type CloseReason = 'button' | 'overlay' | 'escape'\n\nexport interface ModalOptions {\n  content: () => HTMLElement\n  onClose?: (reason: CloseReason) => void\n}\n\n// Module-level singleton tracking\nconst modalState = {\n  active: null as ModalWidget | null\n}\n\nexport class ModalWidget {\n  private container: HTMLElement\n  private options: ModalOptions\n  private modalElement: HTMLElement | null = null\n  private previousActiveElement: HTMLElement | null = null\n  private boundHandleKeyDown: (e: KeyboardEvent) => void\n\n  constructor(container: HTMLElement, options: ModalOptions) {\n    this.container = container\n    this.options = options\n    this.boundHandleKeyDown = this.handleKeyDown.bind(this)\n  }\n\n  render(): void {\n    const template = `\n      <div class=\"miso-modal\" role=\"dialog\" aria-modal=\"true\">\n        <div class=\"miso-modal__overlay\"></div>\n        <div class=\"miso-modal__dialog\">\n          <button class=\"miso-modal__close-btn\" aria-label=\"Close modal\">\n            <img src=\"${iconClose}\" alt=\"Close\" />\n          </button>\n          <div class=\"miso-modal__content\"></div>\n        </div>\n      </div>\n    `\n\n    this.container.innerHTML = template\n    this.modalElement = this.container.querySelector('.miso-modal')\n\n    // Render content from render function\n    const contentContainer = this.modalElement?.querySelector('.miso-modal__content')\n    if (contentContainer && this.options.content) {\n      const contentElement = this.options.content()\n      contentContainer.appendChild(contentElement)\n    }\n\n    this.attachEventListeners()\n  }\n\n  private attachEventListeners(): void {\n    if (!this.modalElement) return\n\n    // Close button click\n    const closeBtn = this.modalElement.querySelector('.miso-modal__close-btn')\n    closeBtn?.addEventListener('click', () => this.closeModal('button'))\n\n    // Overlay click\n    const overlay = this.modalElement.querySelector('.miso-modal__overlay')\n    overlay?.addEventListener('click', () => this.closeModal('overlay'))\n\n    // Prevent dialog clicks from closing\n    const dialog = this.modalElement.querySelector('.miso-modal__dialog')\n    dialog?.addEventListener('click', (e) => e.stopPropagation())\n  }\n\n  private handleKeyDown(e: KeyboardEvent): void {\n    if (e.key === 'Escape') {\n      e.preventDefault()\n      this.closeModal('escape')\n    }\n\n    // Focus trap\n    if (e.key === 'Tab' && this.modalElement) {\n      const focusableElements = this.modalElement.querySelectorAll<HTMLElement>(\n        'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n      )\n      const firstElement = focusableElements[0]\n      const lastElement = focusableElements[focusableElements.length - 1]\n\n      if (e.shiftKey && document.activeElement === firstElement) {\n        e.preventDefault()\n        lastElement?.focus()\n      } else if (!e.shiftKey && document.activeElement === lastElement) {\n        e.preventDefault()\n        firstElement?.focus()\n      }\n    }\n  }\n\n  openModal(): void {\n    // Close any existing modal first (singleton)\n    if (modalState.active && modalState.active !== this) {\n      modalState.active.closeModal('button')\n    }\n\n    if (!this.modalElement) return\n\n    // Store current focus for restoration\n    this.previousActiveElement = document.activeElement as HTMLElement\n\n    // Lock body scroll\n    document.body.style.overflow = 'hidden'\n\n    // Add keyboard listener\n    document.addEventListener('keydown', this.boundHandleKeyDown)\n\n    // Force a reflow to ensure initial state is rendered before adding open class\n    // This allows the CSS transition to animate from translateY(100%) to translateY(0)\n    void this.modalElement.offsetHeight\n\n    // Show modal with animation\n    this.modalElement.classList.add('miso-modal--open')\n\n    // Set as active modal\n    modalState.active = this\n\n    // Focus first focusable element\n    const firstFocusable = this.modalElement.querySelector<HTMLElement>(\n      'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n    )\n    firstFocusable?.focus()\n  }\n\n  closeModal(reason: CloseReason = 'button'): void {\n    if (!this.modalElement) return\n\n    // Remove keyboard listener\n    document.removeEventListener('keydown', this.boundHandleKeyDown)\n\n    // Start close animation\n    this.modalElement.classList.remove('miso-modal--open')\n\n    // Wait for animation to complete\n    setTimeout(() => {\n      // Restore body scroll\n      document.body.style.overflow = ''\n\n      // Clear active modal\n      if (modalState.active === this) {\n        modalState.active = null\n      }\n\n      // Restore focus\n      this.previousActiveElement?.focus()\n\n      // Call onClose callback\n      this.options.onClose?.(reason)\n    }, 300) // Match CSS transition duration\n  }\n\n  destroy(): void {\n    // Close if open\n    if (modalState.active === this) {\n      document.removeEventListener('keydown', this.boundHandleKeyDown)\n      document.body.style.overflow = ''\n      modalState.active = null\n    }\n\n    // Remove from DOM\n    if (this.modalElement) {\n      this.modalElement.remove()\n      this.modalElement = null\n    }\n\n    this.container.innerHTML = ''\n  }\n}\n","import type { Recipe } from '../../../types/api'\nimport { ModalWidget } from '../../../utils/modal'\n\n/**\n * Options for creating a MoveModal\n */\nexport interface MoveModalOptions {\n  /** Callback when a recipe is successfully moved */\n  onMove: (recipeIndex: number, targetSlotLabel: string) => Promise<void>\n}\n\n/**\n * MoveModal handles the UI for moving a recipe to a different slot.\n * It displays available slots and triggers the move operation.\n */\nexport class MoveModal {\n  private container: HTMLElement\n  private modal: ModalWidget | null = null\n  private options: MoveModalOptions\n\n  constructor(options: MoveModalOptions) {\n    this.container = document.createElement('div')\n    document.body.appendChild(this.container)\n    this.options = options\n  }\n\n  /**\n   * Opens the move modal for a specific recipe\n   */\n  open(recipe: Recipe, recipeIndex: number, slotLabels: string[]): void {\n    // Destroy existing modal if any\n    this.modal?.destroy()\n\n    this.modal = new ModalWidget(this.container, {\n      content: () => this.createContent(recipe, recipeIndex, slotLabels),\n      onClose: () => {\n        this.modal = null\n      }\n    })\n\n    this.modal.render()\n    this.modal.openModal()\n  }\n\n  /**\n   * Closes the modal\n   */\n  close(): void {\n    this.modal?.closeModal('button')\n  }\n\n  /**\n   * Destroys the modal and removes its container from the DOM\n   */\n  destroy(): void {\n    this.modal?.destroy()\n    this.container.remove()\n  }\n\n  /**\n   * Creates the modal content with slot selection buttons\n   */\n  private createContent(recipe: Recipe, recipeIndex: number, slotLabels: string[]): HTMLElement {\n    const container = document.createElement('div')\n    container.className = 'miso-move-modal'\n\n    // Title\n    const title = document.createElement('h2')\n    title.className = 'miso-move-modal__title'\n    title.textContent = 'Quick Move'\n    container.appendChild(title)\n\n    // Recipe name\n    const recipeName = document.createElement('p')\n    recipeName.className = 'miso-move-modal__recipe-name'\n    recipeName.textContent = recipe.title\n    container.appendChild(recipeName)\n\n    // Slot buttons container\n    const slotsContainer = document.createElement('div')\n    slotsContainer.className = 'miso-move-modal__slots'\n\n    slotLabels.forEach(slotLabel => {\n      const button = document.createElement('button')\n      button.className = 'miso-move-modal__slot-btn'\n      button.textContent = slotLabel\n\n      // Mark current slot as active\n      if (slotLabel === recipe.slot_label) {\n        button.classList.add('miso-move-modal__slot-btn--active')\n      }\n\n      button.addEventListener('click', async () => {\n        // If same slot, just close\n        if (slotLabel === recipe.slot_label) {\n          this.close()\n          return\n        }\n\n        try {\n          await this.options.onMove(recipeIndex, slotLabel)\n          this.close()\n        } catch (error) {\n          console.error('Failed to move recipe:', error)\n          // Error handling is done in the parent widget\n        }\n      })\n\n      slotsContainer.appendChild(button)\n    })\n\n    container.appendChild(slotsContainer)\n\n    return container\n  }\n}\n","import type { Recipe, SwapSuggestionResponse } from '../../../types/api'\nimport { ModalWidget } from '../../../utils/modal'\nimport { escapeHtml } from '../../../utils/html'\nimport iconLoading from '../../../imgs/icon-loading.svg'\n\n/**\n * Options for creating a SwapModal\n */\nexport interface SwapModalOptions {\n  /** Fetches swap suggestions for a recipe */\n  onFetchSuggestions: (recipeIndex: number) => Promise<SwapSuggestionResponse>\n  /** Callback when a recipe swap is requested */\n  onSwap: (recipeIndex: number, newRecipe: Recipe) => Promise<void>\n  /** Callback when an error occurs */\n  onError: (message: string) => void\n}\n\n/**\n * SwapModal handles the UI for swapping a recipe with AI-suggested alternatives.\n * It shows loading state while fetching suggestions, then displays swap options.\n */\nexport class SwapModal {\n  private container: HTMLElement\n  private modal: ModalWidget | null = null\n  private options: SwapModalOptions\n  \n  // Modal-specific state\n  private currentRecipe: Recipe | null = null\n  private currentRecipeIndex: number | null = null\n  private suggestions: SwapSuggestionResponse | null = null\n  private isSwapping = false\n\n  constructor(options: SwapModalOptions) {\n    this.container = document.createElement('div')\n    document.body.appendChild(this.container)\n    this.options = options\n  }\n\n  /**\n   * Opens the swap modal for a specific recipe\n   */\n  async open(recipe: Recipe, recipeIndex: number): Promise<void> {\n    this.currentRecipe = recipe\n    this.currentRecipeIndex = recipeIndex\n    this.suggestions = null\n    this.isSwapping = false\n\n    // Destroy existing modal if any\n    this.modal?.destroy()\n\n    // Create modal with loading state initially\n    this.modal = new ModalWidget(this.container, {\n      content: () => this.createContent(),\n      onClose: () => {\n        this.reset()\n      }\n    })\n\n    this.modal.render()\n    this.modal.openModal()\n\n    // Fetch swap suggestions\n    try {\n      this.suggestions = await this.options.onFetchSuggestions(recipeIndex)\n      this.updateContent()\n    } catch (error) {\n      console.error('Failed to fetch swap suggestions:', error)\n      this.close()\n      this.options.onError('Failed to load swap suggestions. Please try again.')\n    }\n  }\n\n  /**\n   * Closes the modal\n   */\n  close(): void {\n    this.modal?.closeModal('button')\n  }\n\n  /**\n   * Destroys the modal and removes its container from the DOM\n   */\n  destroy(): void {\n    this.modal?.destroy()\n    this.container.remove()\n  }\n\n  /**\n   * Resets modal state\n   */\n  private reset(): void {\n    this.modal = null\n    this.suggestions = null\n    this.currentRecipe = null\n    this.currentRecipeIndex = null\n    this.isSwapping = false\n  }\n\n  /**\n   * Updates the modal content (when suggestions are loaded)\n   */\n  private updateContent(): void {\n    if (!this.modal) return\n\n    const modalContent = this.container.querySelector('.miso-swap-modal')\n    if (modalContent) {\n      const newContent = this.createContent()\n      modalContent.replaceWith(newContent)\n    }\n  }\n\n  /**\n   * Creates the modal content\n   */\n  private createContent(): HTMLElement {\n    const container = document.createElement('div')\n    container.className = 'miso-swap-modal'\n\n    if (!this.currentRecipe) return container\n\n    // Title\n    const title = document.createElement('h2')\n    title.className = 'miso-swap-modal__title'\n    title.innerHTML = `SWAPPING<br>${escapeHtml(this.currentRecipe.title)}`\n    container.appendChild(title)\n\n    // Show loading or suggestions\n    if (!this.suggestions) {\n      container.appendChild(this.createLoading())\n    } else {\n      container.appendChild(this.createSuggestionsList())\n    }\n\n    return container\n  }\n\n  /**\n   * Creates the loading indicator\n   */\n  private createLoading(): HTMLElement {\n    const loading = document.createElement('div')\n    loading.className = 'miso-swap-modal__loading'\n    loading.innerHTML = `<img src=\"${iconLoading}\" alt=\"Loading\" class=\"miso-swap-modal__loading-icon\" />`\n    return loading\n  }\n\n  /**\n   * Creates the suggestions list\n   */\n  private createSuggestionsList(): HTMLElement {\n    const suggestionsContainer = document.createElement('div')\n    suggestionsContainer.className = 'miso-swap-modal__suggestions'\n\n    if (!this.suggestions) return suggestionsContainer\n\n    this.suggestions.recipes.forEach((suggestedRecipe, index) => {\n      const suggestionItem = document.createElement('div')\n      suggestionItem.className = 'miso-swap-modal__suggestion-item'\n\n      // Horizontal recipe card\n      const card = document.createElement('div')\n      card.className = 'miso-swap-modal__card'\n\n      // Left side - image\n      const imageContainer = document.createElement('div')\n      imageContainer.className = 'miso-swap-modal__card-image'\n      imageContainer.style.backgroundImage = `url('${suggestedRecipe.cover_image}')`\n      card.appendChild(imageContainer)\n\n      // Right side - content\n      const content = document.createElement('div')\n      content.className = 'miso-swap-modal__card-content'\n\n      const recipeTitle = document.createElement('div')\n      recipeTitle.className = 'miso-swap-modal__card-title'\n      recipeTitle.textContent = suggestedRecipe.title\n      content.appendChild(recipeTitle)\n\n      const swapButton = document.createElement('button')\n      swapButton.className = 'miso-swap-modal__swap-btn'\n      swapButton.textContent = 'Swap'\n      swapButton.dataset.suggestionIndex = String(index)\n      swapButton.addEventListener('click', () => {\n        this.handleSwap(suggestedRecipe, swapButton)\n      })\n      content.appendChild(swapButton)\n\n      card.appendChild(content)\n      suggestionItem.appendChild(card)\n\n      // Reason text\n      const reason = this.suggestions?.reasons[index]\n      if (reason) {\n        const reasonText = document.createElement('p')\n        reasonText.className = 'miso-swap-modal__reason'\n        reasonText.textContent = reason\n        suggestionItem.appendChild(reasonText)\n      }\n\n      suggestionsContainer.appendChild(suggestionItem)\n    })\n\n    return suggestionsContainer\n  }\n\n  /**\n   * Handles the swap button click\n   */\n  private async handleSwap(newRecipe: Recipe, button: HTMLButtonElement): Promise<void> {\n    if (this.currentRecipeIndex === null || this.isSwapping) return\n\n    this.isSwapping = true\n\n    // Show loading state on button\n    const originalText = button.textContent\n    button.disabled = true\n    button.innerHTML = `<img src=\"${iconLoading}\" alt=\"Loading\" class=\"miso-swap-modal__btn-loading\" />`\n\n    try {\n      await this.options.onSwap(this.currentRecipeIndex, newRecipe)\n      this.close()\n    } catch (error) {\n      console.error('Failed to swap recipe:', error)\n      \n      // Restore button state\n      button.disabled = false\n      button.textContent = originalText\n      this.isSwapping = false\n      \n      // Close modal and show error\n      this.close()\n      this.options.onError('Failed to swap recipe. Please try again.')\n    }\n  }\n}\n","import type { MisoWidgetInstance } from '../../core/instance'\nimport type { Messages, Recipe } from '../../types/api'\nimport { createState, createInitialState, type StateManager, type CreationPhase } from './state'\nimport { renderFullLoading, renderPlanEditor, renderPlanNotFound, renderSuggestions, loadingSteps, iconLike, iconLikeActive } from './renderers'\nimport { MoveModal, SwapModal } from './modals'\nimport './styles.css'\n\n/**\n * Shuffles an array in place using Fisher-Yates algorithm\n */\nfunction shuffleArray<T>(array: T[]): T[] {\n  const shuffled = [...array]\n  for (let i = shuffled.length - 1; i > 0; i--) {\n    const j = Math.floor(Math.random() * (i + 1))\n    ;[shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]\n  }\n  return shuffled\n}\n\n/**\n * Returns a random delay between 3000ms and 5000ms\n */\nfunction getRandomDelay(): number {\n  return 3000 + Math.random() * 2000\n}\n\n/**\n * PlanEditorWidget handles the meal plan editing experience.\n * \n * Responsibilities:\n * - Orchestrates state, rendering, and modal interactions\n * - Handles API calls for plan CRUD operations\n * - Manages event listeners and user interactions\n * \n * Uses state pattern with partial updates for efficient rendering.\n */\nexport class PlanEditorWidget {\n  private container: HTMLElement\n  private instance: MisoWidgetInstance\n  private widgetElement: HTMLElement | null = null\n  private state: StateManager\n  private moveModal: MoveModal\n  private swapModal: SwapModal\n  private creationTimeout: ReturnType<typeof setTimeout> | null = null\n  private shuffledMessages: {\n    searching: string[]\n    validating: string[]\n    building: string[]\n  } | null = null\n  private buildingMessageIndex: number = 0\n\n  constructor(container: HTMLElement, instance: MisoWidgetInstance, planId: string | null) {\n    this.container = container\n    this.instance = instance\n\n    // Initialize state with partial update handlers\n    this.state = createState(\n      createInitialState(planId),\n      {\n        savedRecipes: () => this.updateSaveButtons(),\n        errorMessage: () => this.updateErrorDisplay(),\n        suggestions: () => this.updateSuggestionsDisplay(),\n        isUpdating: () => this.updateLoadingOverlay(),\n        creationMessage: () => this.updateCreationMessage(),\n      },\n      () => this.renderContent()\n    )\n\n    // Initialize modals with callbacks\n    this.moveModal = new MoveModal({\n      onMove: (recipeIndex, targetSlotLabel) => this.handleMoveRecipe(recipeIndex, targetSlotLabel),\n    })\n\n    this.swapModal = new SwapModal({\n      onFetchSuggestions: (recipeIndex) => this.fetchSwapSuggestions(recipeIndex),\n      onSwap: (recipeIndex, newRecipe) => this.handleSwapRecipe(recipeIndex, newRecipe),\n      onError: (message) => this.state.set({ errorMessage: message }),\n    })\n  }\n\n  // ============================================================\n  // Public API\n  // ============================================================\n\n  async render(): Promise<void> {\n    this.renderContent()\n\n    const { planId } = this.state.get()\n    if (planId) {\n      await this.loadPlan()\n    } else {\n      await this.loadSuggestions()\n    }\n  }\n\n  setSavedRecipes(recipeIds: string[]): void {\n    this.state.set({ savedRecipes: recipeIds })\n  }\n\n  destroy(): void {\n    this.stopCreationSequence()\n    this.moveModal.destroy()\n    this.swapModal.destroy()\n\n    if (this.widgetElement) {\n      this.container.removeChild(this.widgetElement)\n      this.widgetElement = null\n    }\n  }\n\n  // ============================================================\n  // Data Loading\n  // ============================================================\n\n  private async loadPlan(): Promise<void> {\n    const { planId } = this.state.get()\n    if (!planId) return\n\n    this.state.set({ isLoading: true })\n\n    try {\n      const response = await this.instance.apiService.getPlan(planId)\n      this.state.set({ plan: response.data })\n      await this.loadSuggestions()\n    } catch (error: any) {\n      console.error('Failed to load plan:', error)\n      // Check if it's a 404 error\n      const is404 = error?.message?.toLowerCase().includes('not found') || \n                    error?.status === 404 || \n                    error?.response?.status === 404\n      \n      if (is404) {\n        this.state.set({ planNotFound: true })\n        this.instance.emit('plan-not-found', planId)\n      } else {\n        this.state.set({ errorMessage: 'Failed to load plan. Please try again.' })\n      }\n    } finally {\n      this.state.set({ isLoading: false })\n    }\n  }\n\n  private async loadSuggestions(): Promise<void> {\n    try {\n      const { plan } = this.state.get()\n      const response = await this.instance.apiService.getSuggestedPrompts(plan)\n      this.state.set({ suggestions: response.data })\n    } catch (error) {\n      console.error('Failed to fetch suggestions:', error)\n      this.state.set({ suggestions: [] })\n    }\n  }\n\n  // ============================================================\n  // Rendering\n  // ============================================================\n\n  private renderContent(): void {\n    const state = this.state.get()\n\n    // Show 404 error when plan not found\n    if (state.planNotFound) {\n      this.container.innerHTML = renderPlanNotFound()\n      this.widgetElement = this.container.firstElementChild as HTMLElement\n      this.attachNotFoundListeners()\n      return\n    }\n\n    // Show full loading when loading a plan in edit mode\n    if (state.isLoading && state.planId && !state.plan) {\n      this.container.innerHTML = renderFullLoading()\n      this.widgetElement = this.container.firstElementChild as HTMLElement\n      return\n    }\n\n    this.container.innerHTML = renderPlanEditor({ state })\n    this.widgetElement = this.container.firstElementChild as HTMLElement\n\n    this.attachEventListeners()\n    this.updateScrollState()\n    this.updateLoadingOverlay()\n  }\n\n  // ============================================================\n  // Partial DOM Updates\n  // ============================================================\n\n  private updateSaveButtons(): void {\n    if (!this.widgetElement) return\n\n    const { savedRecipes } = this.state.get()\n    const saveBtns = this.widgetElement.querySelectorAll('.miso-plan-editor__save-btn')\n\n    saveBtns.forEach(btn => {\n      const recipeId = (btn as HTMLElement).dataset.recipeId\n      if (recipeId) {\n        const isSaved = savedRecipes.includes(recipeId)\n        btn.classList.toggle('miso-plan-editor__save-btn--active', isSaved)\n      }\n    })\n  }\n\n  private updateErrorDisplay(): void {\n    if (!this.widgetElement) return\n\n    const { errorMessage } = this.state.get()\n    const form = this.widgetElement.querySelector('.miso-plan-editor__input-form')\n    let errorEl = form?.querySelector('.miso-plan-editor__error')\n\n    if (errorMessage) {\n      if (!errorEl) {\n        errorEl = document.createElement('div')\n        errorEl.className = 'miso-plan-editor__error'\n        form?.appendChild(errorEl)\n      }\n      errorEl.textContent = errorMessage\n    } else {\n      errorEl?.remove()\n    }\n  }\n\n  private updateSuggestionsDisplay(): void {\n    if (!this.widgetElement) return\n\n    const state = this.state.get()\n    const container = this.widgetElement.querySelector('.miso-plan-editor__prompt-section')\n    if (!container) return\n\n    // Remove existing suggestions\n    const existingSuggestions = container.querySelector('.miso-plan-editor__suggestions')\n    existingSuggestions?.remove()\n\n    // Add new suggestions before the form\n    if (state.suggestions.length > 0) {\n      const form = container.querySelector('.miso-plan-editor__input-form')\n      if (form) {\n        const suggestionsHtml = renderSuggestions({ state })\n        form.insertAdjacentHTML('beforebegin', suggestionsHtml)\n        this.attachSuggestionListeners()\n      }\n    }\n  }\n\n  private updateLoadingOverlay(): void {\n    if (!this.widgetElement) return\n\n    const { isUpdating } = this.state.get()\n    const topSection = this.widgetElement.querySelector('.miso-plan-editor__top')\n    if (!topSection) return\n\n    // Remove existing overlay\n    const existingOverlay = topSection.querySelector('.miso-plan-editor__updating-overlay')\n    existingOverlay?.remove()\n\n    // Disable/enable input and suggestion buttons\n    const input = this.widgetElement.querySelector('.miso-plan-editor__input') as HTMLInputElement\n    if (input) {\n      input.disabled = isUpdating\n    }\n\n    this.widgetElement.querySelectorAll('.miso-plan-editor__suggestion-btn').forEach(btn => {\n      (btn as HTMLButtonElement).disabled = isUpdating\n    })\n\n    // Add overlay when updating\n    if (isUpdating) {\n      const overlay = document.createElement('div')\n      overlay.className = 'miso-plan-editor__updating-overlay'\n      topSection.appendChild(overlay)\n    }\n  }\n\n  private updateCreationMessage(): void {\n    if (!this.widgetElement) return\n\n    const { creationMessage, creationPhase } = this.state.get()\n    const messageArea = this.widgetElement.querySelector('.miso-plan-editor__message-area')\n    if (!messageArea) return\n\n    if (creationPhase === 'idle') {\n      // Will be handled by full re-render when plan is set\n      return\n    }\n\n    // Create new message element with fade animation\n    const newMessageEl = document.createElement('div')\n    newMessageEl.className = 'miso-plan-editor__creation-message'\n    newMessageEl.textContent = creationMessage\n\n    // Replace content\n    messageArea.innerHTML = ''\n    messageArea.appendChild(newMessageEl)\n  }\n\n  // ============================================================\n  // Event Listeners\n  // ============================================================\n\n  private attachEventListeners(): void {\n    if (!this.widgetElement) return\n\n    // Back button\n    this.widgetElement.querySelector('.miso-plan-editor__back-btn')?.addEventListener('click', () => {\n      this.instance.emit('plan-closed')\n    })\n\n    // Suggestion buttons\n    this.attachSuggestionListeners()\n\n    // Input field\n    const input = this.widgetElement.querySelector('.miso-plan-editor__input') as HTMLInputElement\n    if (input) {\n      const { planId } = this.state.get()\n      if (!planId) input.focus()\n      input.addEventListener('input', () => this.updateClearButtonVisibility())\n    }\n\n    // Clear button\n    this.widgetElement.querySelector('.miso-plan-editor__clear-btn')?.addEventListener('click', () => {\n      const input = this.widgetElement?.querySelector('.miso-plan-editor__input') as HTMLInputElement\n      if (input) {\n        input.value = ''\n        this.updateClearButtonVisibility()\n        input.focus()\n      }\n    })\n\n    // Form submit\n    const form = this.widgetElement.querySelector('.miso-plan-editor__input-form') as HTMLFormElement\n    form?.addEventListener('submit', async (e) => {\n      e.preventDefault()\n      await this.handleSubmit()\n    })\n\n    // Scroll events\n    this.widgetElement.addEventListener('scroll', () => this.updateScrollState())\n\n    // Scroll to top button\n    this.widgetElement.querySelector('.miso-plan-editor__scroll-top-btn')?.addEventListener('click', () => {\n      this.widgetElement?.scrollTo({ top: 0, behavior: 'smooth' })\n    })\n\n    // Save buttons\n    this.widgetElement.querySelectorAll('.miso-plan-editor__save-btn').forEach(btn => {\n      btn.addEventListener('click', (e) => {\n        e.stopPropagation()\n        const recipeId = (btn as HTMLElement).dataset.recipeId\n        if (recipeId) {\n          // Always emit the event, regardless of saved state\n          this.instance.emit('save-recipe', recipeId)\n        }\n      })\n    })\n\n    // Move buttons\n    this.widgetElement.querySelectorAll('.miso-plan-editor__move-btn').forEach(btn => {\n      btn.addEventListener('click', () => {\n        const recipeIndex = parseInt((btn as HTMLElement).dataset.recipeIndex || '-1', 10)\n        if (recipeIndex >= 0) this.openMoveModal(recipeIndex)\n      })\n    })\n\n    // Swap buttons\n    this.widgetElement.querySelectorAll('.miso-plan-editor__swap-btn').forEach(btn => {\n      btn.addEventListener('click', () => {\n        const recipeIndex = parseInt((btn as HTMLElement).dataset.recipeIndex || '-1', 10)\n        if (recipeIndex >= 0) this.openSwapModal(recipeIndex)\n      })\n    })\n  }\n\n  private attachSuggestionListeners(): void {\n    if (!this.widgetElement) return\n\n    this.widgetElement.querySelectorAll('.miso-plan-editor__suggestion-btn').forEach(btn => {\n      btn.addEventListener('click', () => {\n        const suggestion = (btn as HTMLElement).dataset.suggestion\n        if (suggestion) {\n          const input = this.widgetElement?.querySelector('.miso-plan-editor__input') as HTMLInputElement\n          if (input) {\n            input.value = suggestion\n            this.updateClearButtonVisibility()\n            input.focus()\n          }\n        }\n      })\n    })\n  }\n\n  private attachNotFoundListeners(): void {\n    if (!this.widgetElement) return\n\n    this.widgetElement.querySelector('[data-action=\"back-to-home\"]')?.addEventListener('click', () => {\n      this.instance.emit('plan-closed')\n    })\n  }\n\n  // ============================================================\n  // UI Helpers\n  // ============================================================\n\n  private updateClearButtonVisibility(): void {\n    if (!this.widgetElement) return\n\n    const input = this.widgetElement.querySelector('.miso-plan-editor__input') as HTMLInputElement\n    const clearBtn = this.widgetElement.querySelector('.miso-plan-editor__clear-btn') as HTMLElement\n\n    if (input && clearBtn) {\n      clearBtn.style.display = input.value ? 'block' : 'none'\n    }\n  }\n\n  private updateScrollState(): void {\n    if (!this.widgetElement) return\n\n    const el = this.widgetElement\n    const hasScroll = el.scrollHeight > el.clientHeight\n    const isAtBottom = el.scrollHeight - el.scrollTop <= el.clientHeight + 1\n    const isScrolledDown = el.scrollTop > 0\n\n    el.classList.toggle('has-scroll', hasScroll && !isAtBottom)\n    el.classList.toggle('is-scrolled', isScrolledDown)\n  }\n\n  // ============================================================\n  // Form Submission\n  // ============================================================\n\n  private async handleSubmit(): Promise<void> {\n    if (!this.widgetElement) return\n\n    const input = this.widgetElement.querySelector('.miso-plan-editor__input') as HTMLInputElement\n    if (!input?.value.trim()) return\n\n    const userMessage = input.value.trim()\n    const state = this.state.get()\n    const isEditing = !!state.planId\n\n    input.disabled = true\n    input.blur()\n\n    this.state.set({ isLoading: true, isUpdating: true, errorMessage: '' })\n\n    // Start creation sequence for new plans\n    if (!isEditing) {\n      this.startCreationSequence()\n    }\n\n    try {\n      if (isEditing) {\n        const existingMessages = state.plan?.messages || []\n        const messages: Messages = [...existingMessages, { role: 'user', content: userMessage }]\n        const response = await this.instance.apiService.sendCompletion(state.planId!, messages)\n        this.state.set({ plan: response.data })\n        this.instance.emit('plan-updated', response.data)\n      } else {\n        const messages: Messages = [{ role: 'user', content: userMessage }]\n        const response = await this.instance.apiService.createPlan(messages)\n        this.stopCreationSequence()\n        this.state.set({ plan: response.data, planId: response.data.id })\n        this.instance.emit('plan-created', response.data)\n      }\n\n      await this.loadSuggestions()\n      this.state.set({ isLoading: false })\n      // Keep loading animation visible for 600ms after plan updated\n      setTimeout(() => this.state.set({ isUpdating: false }), 600)\n    } catch (error) {\n      console.error(isEditing ? 'Failed to update plan:' : 'Failed to create plan:', error)\n      this.stopCreationSequence()\n      this.state.set({ errorMessage: 'Sorry, something went wrong. Please try again.', isLoading: false, isUpdating: false })\n\n      const newInput = this.widgetElement?.querySelector('.miso-plan-editor__input') as HTMLInputElement\n      if (newInput) {\n        newInput.disabled = false\n        newInput.value = userMessage\n        this.updateClearButtonVisibility()\n      }\n    }\n  }\n\n  // ============================================================\n  // Creation Loading Sequence\n  // ============================================================\n\n  private startCreationSequence(): void {\n    // Shuffle all message arrays at start\n    this.shuffledMessages = {\n      searching: shuffleArray([...loadingSteps.searching]),\n      validating: shuffleArray([...loadingSteps.validating]),\n      building: shuffleArray([...loadingSteps.building]),\n    }\n    this.buildingMessageIndex = 0\n\n    // Start with first searching message\n    this.state.set({\n      creationPhase: 'searching',\n      creationMessage: this.shuffledMessages.searching[0],\n    })\n\n    // Schedule transition to validating\n    this.scheduleNextPhase('validating')\n  }\n\n  private scheduleNextPhase(nextPhase: CreationPhase): void {\n    if (this.creationTimeout) {\n      clearTimeout(this.creationTimeout)\n    }\n\n    this.creationTimeout = setTimeout(() => {\n      if (!this.shuffledMessages) return\n\n      const { creationPhase } = this.state.get()\n      if (creationPhase === 'idle') return\n\n      if (nextPhase === 'validating') {\n        this.state.set({\n          creationPhase: 'validating',\n          creationMessage: this.shuffledMessages.validating[0],\n        })\n        this.scheduleNextPhase('building')\n      } else if (nextPhase === 'building') {\n        this.showNextBuildingMessage()\n      }\n    }, getRandomDelay())\n  }\n\n  private showNextBuildingMessage(): void {\n    if (!this.shuffledMessages) return\n\n    const { creationPhase } = this.state.get()\n    if (creationPhase === 'idle') return\n\n    const buildingMessages = this.shuffledMessages.building\n    const message = buildingMessages[this.buildingMessageIndex]\n\n    this.state.set({\n      creationPhase: 'building',\n      creationMessage: message,\n    })\n\n    // Schedule next building message if there are more\n    if (this.buildingMessageIndex < buildingMessages.length - 1) {\n      this.buildingMessageIndex++\n      this.creationTimeout = setTimeout(() => {\n        this.showNextBuildingMessage()\n      }, getRandomDelay())\n    }\n    // If all building messages exhausted, keep last one visible (no more scheduling)\n  }\n\n  private stopCreationSequence(): void {\n    if (this.creationTimeout) {\n      clearTimeout(this.creationTimeout)\n      this.creationTimeout = null\n    }\n    this.shuffledMessages = null\n    this.buildingMessageIndex = 0\n    this.state.set({\n      creationPhase: 'idle',\n      creationMessage: '',\n    })\n  }\n\n  // ============================================================\n  // Modal Operations\n  // ============================================================\n\n  private openMoveModal(recipeIndex: number): void {\n    const { plan } = this.state.get()\n    if (!plan?.recipes) return\n\n    const recipe = plan.recipes[recipeIndex]\n    if (!recipe) return\n\n    const slotLabels = [...new Set(plan.recipes.map(r => r.slot_label))]\n    this.moveModal.open(recipe, recipeIndex, slotLabels)\n  }\n\n  private async handleMoveRecipe(recipeIndex: number, targetSlotLabel: string): Promise<void> {\n    const { plan, planId } = this.state.get()\n    if (!plan?.recipes || !planId) return\n\n    const recipe = plan.recipes[recipeIndex]\n    if (!recipe) return\n\n    this.state.set({ isUpdating: true })\n\n    try {\n    // Create updated recipes array\n    const updatedRecipes = [...plan.recipes]\n    updatedRecipes.splice(recipeIndex, 1)\n\n    const movedRecipe = { ...recipe, slot_label: targetSlotLabel }\n\n    // Find insert position\n    let insertIndex = updatedRecipes.length\n    for (let i = updatedRecipes.length - 1; i >= 0; i--) {\n      if (updatedRecipes[i].slot_label === targetSlotLabel) {\n        insertIndex = i + 1\n        break\n      }\n    }\n\n    if (insertIndex === updatedRecipes.length) {\n      const slotLabels = [...new Set(plan.recipes.map(r => r.slot_label))]\n      const targetSlotIndex = slotLabels.indexOf(targetSlotLabel)\n\n      for (let i = 0; i < updatedRecipes.length; i++) {\n        const currentSlotIndex = slotLabels.indexOf(updatedRecipes[i].slot_label)\n        if (currentSlotIndex > targetSlotIndex) {\n          insertIndex = i\n          break\n        }\n      }\n    }\n\n    updatedRecipes.splice(insertIndex, 0, movedRecipe)\n\n    const response = await this.instance.apiService.updatePlanRecipes(planId, updatedRecipes)\n    this.state.set({ plan: response.data })\n    this.instance.emit('plan-updated', response.data)\n    await this.loadSuggestions()\n    // Keep loading animation visible for 600ms after plan updated\n    setTimeout(() => this.state.set({ isUpdating: false }), 600)\n    } catch (error) {\n      console.error('Failed to move recipe:', error)\n      this.state.set({ errorMessage: 'Failed to move recipe. Please try again.', isUpdating: false })\n    }\n  }\n\n  private openSwapModal(recipeIndex: number): void {\n    const { plan } = this.state.get()\n    if (!plan?.recipes) return\n\n    const recipe = plan.recipes[recipeIndex]\n    if (!recipe) return\n\n    this.swapModal.open(recipe, recipeIndex)\n  }\n\n  private async fetchSwapSuggestions(recipeIndex: number) {\n    const { planId } = this.state.get()\n    if (!planId) throw new Error('No plan ID')\n\n    const response = await this.instance.apiService.getSwapSuggestion(planId, recipeIndex)\n    return response.data\n  }\n\n  private async handleSwapRecipe(recipeIndex: number, newRecipe: Recipe): Promise<void> {\n    const { plan, planId } = this.state.get()\n    if (!plan?.recipes || !planId) return\n\n    this.state.set({ isUpdating: true })\n\n    try {\n    const updatedRecipes = [...plan.recipes]\n    const currentRecipe = updatedRecipes[recipeIndex]\n\n    updatedRecipes[recipeIndex] = {\n      ...newRecipe,\n      slot_label: currentRecipe.slot_label,\n    }\n\n    const response = await this.instance.apiService.updatePlanRecipes(planId, updatedRecipes)\n    this.state.set({ plan: response.data })\n    this.instance.emit('plan-updated', response.data)\n    await this.loadSuggestions()\n    // Keep loading animation visible for 600ms after plan updated\n    setTimeout(() => this.state.set({ isUpdating: false }), 600)\n    } catch (error) {\n      console.error('Failed to swap recipe:', error)\n      this.state.set({ errorMessage: 'Failed to swap recipe. Please try again.', isUpdating: false })\n    }\n  }\n}\n","import type { Plan } from '../../types/api'\n\n/**\n * Main state interface for the Plan Editor widget.\n * All UI-related state is centralized here.\n */\nexport type CreationPhase = 'idle' | 'searching' | 'validating' | 'building'\n\nexport interface PlanEditorState {\n  plan: Plan | null\n  planId: string | null\n  isLoading: boolean\n  isUpdating: boolean\n  planNotFound: boolean\n  errorMessage: string\n  savedRecipes: string[]\n  suggestions: string[]\n  creationPhase: CreationPhase\n  creationMessage: string\n}\n\n/**\n * Creates the initial state for the Plan Editor widget.\n */\nexport function createInitialState(planId: string | null): PlanEditorState {\n  return {\n    plan: null,\n    planId,\n    isLoading: false,\n    isUpdating: false,\n    planNotFound: false,\n    errorMessage: '',\n    savedRecipes: [],\n    suggestions: [],\n    creationPhase: 'idle',\n    creationMessage: '',\n  }\n}\n\n/**\n * State key types for partial update handlers\n */\nexport type StateKey = keyof PlanEditorState\n\n/**\n * Handler function type for partial updates\n */\nexport type StateHandler<T> = (value: T, state: PlanEditorState) => void\n\n/**\n * Partial handler map - only keys with handlers will trigger partial updates\n */\nexport type StateHandlers = {\n  [K in StateKey]?: StateHandler<PlanEditorState[K]>\n}\n\n/**\n * State manager with partial update support.\n * When a state key has a registered handler, only that handler is called.\n * When no handler exists for any changed key, the fallback (full re-render) is called.\n */\nexport interface StateManager {\n  get: () => PlanEditorState\n  set: (partial: Partial<PlanEditorState>) => void\n  refresh: () => void\n}\n\n/**\n * Creates a state manager with partial update support.\n * \n * @param initialState - The initial state object\n * @param handlers - Map of state keys to their partial update handlers\n * @param fallback - Full re-render function called when no specific handler exists\n * @returns StateManager object with get, set, and refresh methods\n * \n * @example\n * ```ts\n * const state = createState(\n *   createInitialState(null),\n *   {\n *     savedRecipes: (recipes) => updateSaveButtons(),\n *     errorMessage: (msg) => updateErrorDisplay(),\n *   },\n *   () => renderContent()\n * )\n * \n * // Partial update - only calls updateSaveButtons()\n * state.set({ savedRecipes: ['123'] })\n * \n * // Full re-render - plan has no handler\n * state.set({ plan: newPlan })\n * ```\n */\nexport function createState(\n  initialState: PlanEditorState,\n  handlers: StateHandlers,\n  fallback: () => void\n): StateManager {\n  let state = { ...initialState }\n\n  return {\n    get: () => state,\n\n    set: (partial: Partial<PlanEditorState>) => {\n      const changedKeys = Object.keys(partial) as StateKey[]\n      \n      // Update state\n      state = { ...state, ...partial }\n\n      // Track if any handler was called\n      let handlerCalled = false\n\n      // Call specific handlers for changed keys\n      for (const key of changedKeys) {\n        const handler = handlers[key]\n        if (handler) {\n          // Type assertion needed due to TypeScript limitations with mapped types\n          ;(handler as StateHandler<PlanEditorState[typeof key]>)(state[key], state)\n          handlerCalled = true\n        }\n      }\n\n      // If no specific handler was called, do full re-render\n      if (!handlerCalled) {\n        fallback()\n      }\n    },\n\n    // Force full re-render regardless of handlers\n    refresh: () => fallback(),\n  }\n}\n","import type { \n  Plan, \n  Recipe, \n  Messages, \n  SimplePlan, \n  SwapSuggestionResponse, \n  ApiService, \n  ApiEventType, \n  ApiEventCallback,\n  ApiError \n} from '../types/api'\n\nconst API_BASE_URL = import.meta.env.VITE_API_BASE_URL as string\n\n// Validate API_BASE_URL at module load time\nif (!API_BASE_URL) {\n  console.error('[MisoForMyR] VITE_API_BASE_URL environment variable is not set. API calls will fail.')\n}\n\nclass RealApiService implements ApiService {\n  private token: string\n  private eventListeners: Map<ApiEventType, Set<ApiEventCallback>> = new Map()\n\n  constructor(token: string) {\n    this.token = token\n  }\n\n  on(event: ApiEventType, callback: ApiEventCallback): void {\n    if (!this.eventListeners.has(event)) {\n      this.eventListeners.set(event, new Set())\n    }\n    this.eventListeners.get(event)!.add(callback)\n  }\n\n  off(event: ApiEventType, callback: ApiEventCallback): void {\n    const listeners = this.eventListeners.get(event)\n    if (listeners) {\n      listeners.delete(callback)\n    }\n  }\n\n  private emit(event: ApiEventType, error?: ApiError): void {\n    const listeners = this.eventListeners.get(event)\n    if (listeners) {\n      listeners.forEach(callback => callback(error))\n    }\n  }\n\n  private async request<T>(\n    endpoint: string,\n    options: { method?: string; headers?: Record<string, string>; body?: string } = {}\n  ): Promise<T> {\n    if (!API_BASE_URL) {\n      throw new Error('API_BASE_URL is not configured')\n    }\n\n    const url = `${API_BASE_URL}${endpoint}`\n    \n    const response = await fetch(url, {\n      ...options,\n      headers: {\n        'Authorization': `Bearer ${this.token}`,\n        'Content-Type': 'application/json',\n        ...options.headers\n      }\n    })\n\n    if (!response.ok) {\n      const apiError: ApiError = {\n        status: response.status,\n        message: response.statusText || `Request failed with status ${response.status}`,\n        endpoint\n      }\n\n      // Handle 401 specifically\n      if (response.status === 401) {\n        this.emit('unauthenticated', apiError)\n      } else {\n        this.emit('apiError', apiError)\n      }\n\n      throw apiError\n    }\n\n    // For DELETE requests that return no content\n    if (response.status === 204) {\n      return undefined as T\n    }\n\n    return response.json()\n  }\n\n  async getPlans(): Promise<SimplePlan[]> {\n    return this.request<SimplePlan[]>('/myr/plan', {\n      method: 'GET'\n    })\n  }\n\n  async getPlan(planId: string): Promise<{ data: Plan }> {\n    return this.request<{ data: Plan }>(`/myr/plan/${planId}`, {\n      method: 'GET'\n    })\n  }\n\n  async getSuggestedPrompts(plan: Plan | null): Promise<{ data: string[] }> {\n    return this.request<{ data: string[] }>('/myr/prompt-suggestion', {\n      method: 'POST',\n      body: JSON.stringify({ plan })\n    })\n  }\n\n  async createPlan(messages: Messages): Promise<{ data: Plan }> {\n    return this.request<{ data: Plan }>('/myr/plan', {\n      method: 'POST',\n      body: JSON.stringify({ messages })\n    })\n  }\n\n  async getSwapSuggestion(planId: string, recipeIndex: number): Promise<{ data: SwapSuggestionResponse }> {\n    return this.request<{ data: SwapSuggestionResponse }>(\n      `/myr/plan/${planId}/swap-suggestion?recipe_index=${recipeIndex}`,\n      { method: 'GET' }\n    )\n  }\n\n  async updatePlanRecipes(planId: string, recipes: Recipe[]): Promise<{ data: Plan }> {\n    return this.request<{ data: Plan }>(`/myr/plan/${planId}`, {\n      method: 'PATCH',\n      body: JSON.stringify({ recipes })\n    })\n  }\n\n  async sendCompletion(planId: string, messages: Messages): Promise<{ data: Plan }> {\n    return this.request<{ data: Plan }>(`/myr/plan/${planId}/completion`, {\n      method: 'POST',\n      body: JSON.stringify({ messages })\n    })\n  }\n\n  async deletePlan(planId: string): Promise<void> {\n    await this.request<void>(`/myr/plan/${planId}`, {\n      method: 'DELETE'\n    })\n  }\n}\n\n/**\n * Create a real API service instance\n * @param token Bearer token for authentication\n */\nexport function createApiService(token: string): ApiService {\n  return new RealApiService(token)\n}\n","import type { WidgetConfig, WidgetInstance, EventCallback } from '../types/widget'\nimport type { ApiService, ApiError, SimplePlan } from '../types/api'\nimport { PlanListingWidget } from '../widgets/plan-listing'\nimport { PlanEditorWidget } from '../widgets/plan-editor'\nimport { createApiService } from '../services/api'\nimport { createMockApiService } from '../services/api.mock'\n\n// Determine which API service to use based on env variable\nconst USE_MOCK_API = import.meta.env.VITE_USE_MOCK_API === 'true'\n\nexport class MisoWidgetInstance implements WidgetInstance {\n  private config: WidgetConfig\n  private eventListeners: Map<string, Set<EventCallback>> = new Map()\n  private planListingWidget: PlanListingWidget | null = null\n  private planEditorWidget: PlanEditorWidget | null = null\n  public readonly apiService: ApiService\n  \n  constructor(config: WidgetConfig) {\n    this.config = config\n\n    // Initialize API service based on env toggle\n    this.apiService = USE_MOCK_API \n      ? createMockApiService() \n      : createApiService(config.token)\n\n    // Bubble up API service events to widget instance\n    this.apiService.on('unauthenticated', (error?: ApiError) => {\n      this.emit('unauthenticated', error)\n    })\n\n    this.apiService.on('apiError', (error?: ApiError) => {\n      this.emit('apiError', error)\n    })\n  }\n\n  on(event: string, callback: EventCallback): void {\n    if (!this.eventListeners.has(event)) {\n      this.eventListeners.set(event, new Set())\n    }\n    this.eventListeners.get(event)!.add(callback)\n  }\n\n  off(event: string, callback: EventCallback): void {\n    const listeners = this.eventListeners.get(event)\n    if (listeners) {\n      listeners.delete(callback)\n    }\n  }\n\n  emit(event: string, ...args: any[]): void {\n    const listeners = this.eventListeners.get(event)\n    if (listeners) {\n      listeners.forEach(callback => callback(...args))\n    }\n  }\n\n  renderPlanListingWidget(container: HTMLElement): void {\n    this.planListingWidget = new PlanListingWidget(container, this)\n    this.planListingWidget.render()\n  }\n\n  destroyPlanListingWidget(): void {\n    if (this.planListingWidget) {\n      this.planListingWidget.destroy()\n      this.planListingWidget = null\n    }\n  }\n\n  renderPlanEditorWidget(container: HTMLElement, planId: string | null): void {\n    this.planEditorWidget = new PlanEditorWidget(container, this, planId)\n    this.planEditorWidget.render()\n  }\n\n  destroyPlanEditorWidget(): void {\n    if (this.planEditorWidget) {\n      this.planEditorWidget.destroy()\n      this.planEditorWidget = null\n    }\n  }\n\n  async getPlans(): Promise<SimplePlan[]> {\n    if (!this.planListingWidget) {\n      return []\n    }\n    return this.planListingWidget.getPlans()\n  }\n\n  async refreshPlans(): Promise<void> {\n    if (this.planListingWidget) {\n      await this.planListingWidget.refreshPlans()\n    }\n  }\n\n  setSavedRecipes(recipeIds: string[]): void {\n    if (this.planEditorWidget) {\n      this.planEditorWidget.setSavedRecipes(recipeIds)\n    }\n  }\n\n  getConfig(): WidgetConfig {\n    return this.config\n  }\n}\n","import { MisoWidgetInstance } from './core/instance'\nimport type { WidgetConfig, WidgetInstance } from './types/widget'\nimport './styles/variables.css'\n\nexport type { WidgetConfig, WidgetInstance } from './types/widget'\nexport type { Plan, Recipe, Message, Messages } from './types/api'\n\nexport function init(config: WidgetConfig): WidgetInstance {\n  return new MisoWidgetInstance(config)\n}\n\n// Export as global for IIFE bundle\nif (typeof window !== 'undefined') {\n  (window as any).misoForMyR = { init }\n}\n"],"names":["escapeHtml","text","div","document","createElement","textContent","innerHTML","iconAdd","iconLoading","PlanListingWidget","constructor","container","instance","this","widgetElement","plans","isLoading","render","renderContent","loadPlans","apiService","getPlans","error","console","template","renderLoading","renderPlans","firstElementChild","attachEventListeners","length","renderEmptyState","map","plan","renderPlanCard","join","recipeCount","n_recipes","createdDate","formatDate","created_at","id","title","timestamp","date","Date","getDate","getMonth","getFullYear","toString","slice","newPlanBtn","querySelector","addEventListener","emit","querySelectorAll","forEach","card","planId","dataset","refreshPlans","destroy","removeChild","iconArrowLeft","iconArrowUp","iconDots","iconClose","iconLike","iconLikeActive","loadingSteps","searching","validating","building","renderPlanEditor","ctx","state","_a","hasRecipes","_b","recipes","recipe","index","slot_label","isSaved","savedRecipes","includes","url","cover_image","renderRecipeCard","renderRecipeSlot","renderRecipeArea","renderTopSection","isNewPlan","messageContent","creationPhase","creationMessage","renderCreationLoadingMessage","messages","assistantMessages","filter","m","role","lastMessage","content","renderLastAssistantMessage","renderBottomSection","renderSuggestions","errorMessage","renderInputArea","renderPromptSection","suggestions","suggestion","modalState","active","ModalWidget","options","modalElement","previousActiveElement","boundHandleKeyDown","handleKeyDown","bind","contentContainer","contentElement","appendChild","closeBtn","closeModal","overlay","dialog","e","stopPropagation","key","preventDefault","focusableElements","firstElement","lastElement","shiftKey","activeElement","focus","openModal","body","style","overflow","offsetHeight","classList","add","firstFocusable","reason","removeEventListener","remove","setTimeout","_c","onClose","call","MoveModal","modal","open","recipeIndex","slotLabels","createContent","close","className","recipeName","slotsContainer","slotLabel","button","async","onMove","SwapModal","currentRecipe","currentRecipeIndex","isSwapping","reset","onFetchSuggestions","updateContent","onError","modalContent","newContent","replaceWith","createSuggestionsList","createLoading","loading","suggestionsContainer","suggestedRecipe","suggestionItem","imageContainer","backgroundImage","recipeTitle","swapButton","suggestionIndex","String","handleSwap","reasons","reasonText","newRecipe","originalText","disabled","onSwap","shuffleArray","array","shuffled","i","j","Math","floor","random","getRandomDelay","PlanEditorWidget","creationTimeout","shuffledMessages","buildingMessageIndex","initialState","handlers","fallback","get","set","partial","changedKeys","Object","keys","handlerCalled","handler","refresh","createState","isUpdating","planNotFound","createInitialState","updateSaveButtons","updateErrorDisplay","updateSuggestionsDisplay","updateLoadingOverlay","updateCreationMessage","moveModal","targetSlotLabel","handleMoveRecipe","swapModal","fetchSwapSuggestions","handleSwapRecipe","message","loadPlan","loadSuggestions","setSavedRecipes","recipeIds","stopCreationSequence","response","getPlan","data","toLowerCase","status","getSuggestedPrompts","attachNotFoundListeners","updateScrollState","btn","recipeId","toggle","form","errorEl","existingSuggestions","suggestionsHtml","insertAdjacentHTML","attachSuggestionListeners","topSection","existingOverlay","input","messageArea","newMessageEl","updateClearButtonVisibility","value","handleSubmit","scrollTo","top","behavior","parseInt","openMoveModal","openSwapModal","clearBtn","display","el","hasScroll","scrollHeight","clientHeight","isAtBottom","scrollTop","isScrolledDown","trim","userMessage","isEditing","blur","startCreationSequence","sendCompletion","createPlan","newInput","scheduleNextPhase","nextPhase","clearTimeout","showNextBuildingMessage","buildingMessages","Set","r","updatedRecipes","splice","movedRecipe","insertIndex","targetSlotIndex","indexOf","updatePlanRecipes","Error","getSwapSuggestion","RealApiService","token","eventListeners","Map","on","event","callback","has","off","listeners","delete","request","endpoint","method","JSON","stringify","deletePlan","MisoWidgetInstance","config","planListingWidget","planEditorWidget","args","renderPlanListingWidget","destroyPlanListingWidget","renderPlanEditorWidget","destroyPlanEditorWidget","getConfig","init","window","misoForMyR"],"mappings":"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"}