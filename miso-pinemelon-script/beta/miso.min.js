!function(){"use strict";function t(t,e){const s=t.indexOf(e);s>-1&&t.splice(s,1)}function e(t){if("object"!=typeof t)return t;for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&void 0===t[e]&&delete t[e];return t}function s(t,e,s){Object.defineProperties(t,(s="string"==typeof s?[s]:s).reduce(((t,s)=>(t[s]="function"==typeof e[s]?{value:e[s].bind(e)}:{get:()=>e[s]},t)),{}))}function r(t,e){for(const s in e)e.hasOwnProperty(s)&&Object.defineProperty(t,s,{value:e[s]})}function n(){return(crypto&&crypto.randomUUID?crypto.randomUUID():void 0)||function(){if(!URL||!URL.createObjectURL||URL.revokeObjectURL||!Blob)return;const t=URL.createObjectURL(new Blob),e=""+t;return URL.revokeObjectURL(t),e.substring(e.lastIndexOf("/")+1)}()||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}class i{constructor(){const t=this;t.promise=new Promise(((e,s)=>{t.resolve=e,t.reject=s})),Object.freeze(this)}}class o{constructor(t,e){this._dispatchRequested=!1,this._requests=[],this._run=t,this._error=e||(t=>console.error(t)),this._bulkId=0,this._dispatch=this._dispatch.bind(this)}get info(){return{bulkId:this._bulkId,index:this._requests.length}}async run(t){const e=new i;return this._requests.push({action:t,resolution:e}),this._requestDispatch(),e.promise}_requestDispatch(){this._dispatchRequested||(this._dispatchRequested=!0,setTimeout(this._dispatch))}_dispatch(){if(!this._dispatchRequested)return;this._dispatchRequested=!1;const t=this._requests,e=this._bulkId++;this._requests=[];try{this._run(t,{bulkId:e})}catch(t){this._error(t)}}}class a{constructor(){let{error:t,replays:e=[]}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._error=t||(t=>console.error(t)),!Array.isArray(e))throw Error("Replays option must be an array of strings: ".concat(e));this._replays=new Set(e),this._namedCallbacks={},this._unnamedCallbacks=[],this._pastEvents={}}emit(t,e){const s={data:e,meta:{name:t,ts:Date.now()}},r=this._namedCallbacks[t];if(r)for(const t of r)t(s);for(const t of this._unnamedCallbacks)t(s);this._shallStoreForReplay(t)&&(this._pastEvents[t]||(this._pastEvents[t]=[])).push(s)}on(t,e){return this._checkName(t),this._checkCallback(e),this._on(t,this._wrapCallback(e))}once(t){this._checkName(t);const e=this;return new Promise(((s,r)=>{const n=e._on(t,(t=>{setTimeout((()=>n()));try{s(t)}catch(t){r(t)}}))}))}_checkName(t){if("string"!=typeof t)throw Error("Event name should be a string: ".concat(t))}_checkCallback(t){if("function"!=typeof t)throw Error("Event callback should be a function: ".concat(t))}_shallStoreForReplay(t){return this._replays.has(t)}_wrapCallback(t){const e=this;return s=>{let{data:r,meta:n}=s;try{t(r,n)}catch(t){e._error(Error("Error in callback of event '".concat(n.name,"': ").concat(t.message),{cause:t}))}}}_on(t,e){if("*"===t?this._unnamedCallbacks.push(e):(this._namedCallbacks[t]||(this._namedCallbacks[t]=[])).push(e),"*"===t)for(const t in this._pastEvents)this._pastEvents[t].forEach(e);else this._pastEvents[t]&&this._pastEvents[t].forEach(e);return()=>this._off(t,e)}_off(e,s){if("*"===e)t(this._unnamedCallbacks,s);else{const r=this._namedCallbacks[e];r&&t(r,s)}}_injectSubscribeInterface(t){s(t,this,["on","once"])}}function c(t,e){return Object.freeze([...e&&e.meta&&e.meta.path||[],...t?[t]:[]])}class u{constructor(t,e){const s=function(t,e){if(void 0!==t&&"string"!=typeof t&&void 0===e&&(e=t,t=void 0),void 0!==t&&("string"!=typeof t||!t))throw Error('Invalid Component name: "'.concat(t,'"'));return Object.freeze({name:t,parent:e,path:c(t,e),uuid:n()})}(t,e);r(this,{meta:s});const i=this._error=this._error.bind(this);(this._events=new a({error:i,replays:["child"]}))._injectSubscribeInterface(this),this._warn=this._warn.bind(this),(e=s.parent)&&e._events&&e._events.emit("child",this)}_warn(){const t=this.meta.parent;(t&&t._warn||console.warn)(...arguments)}_error(){const t=this.meta.parent;(t&&t._error||console.error)(...arguments)}}!function(t,e){const s=Symbol.for(e);Object.defineProperty(t,s,{value:!0}),Object.defineProperty(t,"isTypeOf",{value:e=>e&&e instanceof t||"function"==typeof e.constructor&&!0===e.constructor[s]})}(u,"miso:component");class l extends u{constructor(t,e){let{libName:s,keyName:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(t,e),this._events._replays.add("register"),this._libraries={},this._libName=s,this._keyName=r}isRegistered(t){return this._checkKey(t),!!this._libraries[t]}get registered(){return Object.values(this._libraries)}register(){for(var t=arguments.length,e=Array(t),s=0;t>s;s++)e[s]=arguments[s];for(const t of e)this._register(t)}_checkKey(t){if("string"!=typeof t||!t)throw Error("Expect ".concat(this._libName," ").concat(this._keyName," to be a non-empty string: ").concat(t))}_checkLib(t){if("function"!=typeof t)throw Error("Expect ".concat(this._libName," to be a constructor or function: ").concat(t))}_register(t){this._checkLib(t);const e=t[this._keyName];this._checkKey(e);const s=this._libraries||(this._libraries={});s[e]=t,this._events.emit("register",t)}}const h="https://api.askmiso.com/v1";class d{constructor(t,e){this._client=t,this._root=e,this._bulk=new o(this._runBulkFetch.bind(this),t._error.bind(t))}assertReady(){}async fetch(t,e){let{method:s="POST",timeout:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const n=JSON.stringify(e),i=r&&new AbortController,o=i&&i.signal,a=i&&setTimeout((()=>i.abort()),r),c=await window.fetch(t,{method:s,body:n,cache:"no-cache",mode:"cors",signal:o});a&&clearTimeout(a);const u=await c.json();if(c.status>=400||u.errors){var l=Error(u.message);throw l.data=u,l.status=c.status,l}return u}get bulkInfo(){return this._bulk.info}async fetchForBulk(t,e,s){let{method:r}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(r&&"POST"!==r)throw Error("Non-POST API is not supported in bulk mode: ".concat(url));return this._bulk.run({apiGroup:t,apiName:e,payload:s})}async _runBulkFetch(t){const e=this.url("bulk"),s={requests:t.map((t=>{let{action:{apiGroup:e,apiName:s,payload:r}}=t;return{api_name:"".concat(e,"/").concat(s),body:r}}))},{data:r}=await this.fetch(e,s);for(let e=0,s=t.length;s>e;e++){const{resolution:s}=t[e],{error:n,status_code:i,body:o}=r[e];i>=400||n?s.reject({status_code:i,body:o}):s.resolve(o)}}url(){const{apiKey:t}=this._client.options;for(var e=arguments.length,s=Array(e),r=0;e>r;r++)s[r]=arguments[r];const n=s.filter((t=>t)).join("/");return"".concat(this.apiBaseUrl,"/").concat(n,"?api_key=").concat(window.encodeURIComponent(t))}get apiBaseUrl(){const{apiHost:t="prod"}=this._client.options;return"prod"===t?h:t}applyPayloadPasses(t,e,s,r){const n=this._client;for(const i of this._root._payloadPasses)try{r=i({client:n,apiGroup:e,apiName:s,payload:r})||r}catch(e){t.error(e)}return r}}class p extends u{constructor(t,e){super(e,t),this._apiPath=e,this.helpers=t.helpers,this.clientOptions=t._client.options,this.context=t._client.context}async _run(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.helpers.assertReady();const{bulk:r}=s,n=r?{bulk:this.helpers.bulkInfo}:void 0,i=this._apiPath,o=this._url({apiGroup:i,apiName:t,payload:e,options:s}),a={apiGroup:i,apiName:t,payload:e=this._preprocess({apiGroup:i,apiName:t,payload:e,options:s}),url:o,options:s};this._events.emit("request",{...a,...n});const c=await this._send(a),u={...a,response:c};return this._events.emit("response",{...u,...n}),this._postprocess(u)}_preprocess(t){let{apiGroup:e,apiName:s,payload:r}=t;return this.helpers.applyPayloadPasses(this,e,s,r)}_url(t){let{apiGroup:e,apiName:s}=t;return this.helpers.url(e,s)}async _send(t){let{apiGroup:e,apiName:s,url:r,payload:n,options:{bulk:i,timeout:o}={}}=t;return i?this.helpers.fetchForBulk(e,s,n):this.helpers.fetch(r,n,{timeout:o})}_postprocess(t){let{response:e}=t;return e.data}}class _ extends p{constructor(t){super(t,"interactions")}async upload(t,e){try{return await this._run("upload",t,e)}catch(t){if(400!==t.status||!t.message||-1>=t.message.toLowerCase().indexOf("playground"))throw t;this._warn("Ignore interactions uploaded to playground app.")}}_url(){return this.helpers.url(this._apiPath)}_preprocess(t){let{apiGroup:e,apiName:s,payload:r}=t;return"upload"===s&&(r=this._normalizeUploadPayload(r)),super._preprocess({apiGroup:e,apiName:s,payload:r})}_normalizeUploadPayload(t){if("object"!=typeof t)throw Error("Interactions payload has to be either an object or an array of objects: ".concat(t));return Array.isArray(t)||(t=[t]),{data:t}}}class f extends p{constructor(t){super(t,"search")}async search(t,e){return this._run("search",t,e)}async autocomplete(t,e){return this._run("autocomplete",t,e)}async mget(t,e){return this._run("mget",t,e)}}class m extends p{constructor(t){super(t,"recommendation")}async userToProducts(t,e){return this._run("user_to_products",t,e)}async userToCategories(t,e){return this._run("user_to_categories",t,e)}async userToAttributes(t,e){return this._run("user_to_attributes",t,e)}async userToTrending(t,e){return this._run("user_to_trending",t,e)}async userToHistory(t,e){return this._run("user_to_history",t,e)}async productToProducts(t,e){return this._run("product_to_products",t,e)}}class y extends u{constructor(t,e){super("api",t),this._client=t,this.helpers=new d(t,e),this.interactions=new _(this),this.search=new f(this),this.recommendation=new m(this)}}class g extends u{constructor(t){super("context",t),this._client=t}}var b={api:{Api:y,ApiBase:p,ApiHelpers:d,Interactions:_,Recommendation:m,Search:f},context:{Context:g}};class w{constructor(t){r(this,{install:t})}}class v extends l{constructor(t){super("plugins",t,{libName:"plugin class",keyName:"id"}),this._root=t,this._events._replays.add("install").add("subtree"),this._installed={},this._useRequests={},this._subtrees=[],this.context=new x(this,b),this.plugins=new k(this)}isInstalled(t){return this._checkKey(t),!!this._installed[t]}get installed(){return Object.values(this._installed)}get(t){return this._installed[t]}getPluginClass(t){return this._libraries[t]}use(t,e){if("function"==typeof t&&t.id&&"string"==typeof t.id)return this.register(t),void this.use(t.id,e);let s;if("string"==typeof t&&this.isInstalled(t))return s=this.get(t),void this._tryConfig(s,e);"string"!=typeof t||this.isRegistered(t)?(s=this._instantiate(t,e),this._install(s)):(this._useRequests[t]||(this._useRequests[t]=[])).push(e)}addSubtree(t){this._subtrees.push(t),this._events.emit("subtree",t)}addPayloadPass(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: ".concat(t));this._root._payloadPasses.push(t)}_tryConfig(t,e){void 0!==e&&("function"==typeof t.config?t.config(e):this._warn('Attempt to pass options to plugin "'.concat(t.id,'", which offers no config() method.')))}_instantiate(t,e){switch(typeof t){case"string":this._checkKey(t);const s=this._libraries[t];if(!s)throw Error("Plugin class not found: ".concat(t));const n=new s;return r(n,{id:t}),this._tryConfig(n,e),n;case"function":return new w(t)}throw Error("Unexpected parameters: ".concat(t))}_install(t){if("function"!=typeof t.install)throw Error("Expect plugin.install to be a function: ".concat(t));try{t.installed=!1,t.install(this.MisoClient,this.context),t.installed=!0}catch(t){throw t}t.id&&(this._installed[t.id]=t),this._events.emit("install",t)}_register(t){super._register(t),this._fulfillUseRequests(t.id)}_fulfillUseRequests(t){const e=this._useRequests[t];if(e){for(const s of e)try{this.use(t,s)}catch(t){this._error(t)}delete this._useRequests[t]}}}class x{constructor(t,e){s(this,t,["getPluginClass","addSubtree","addPayloadPass"]),r(this,{classes:e})}}class k{constructor(t){s(this,t,["installed","registered","isInstalled","isRegistered","get","register","use"])}}const P=new class extends u{constructor(){super(),this._events._replays.add("create"),this._pluginRoot=new v(this),this._clients=[],this._payloadPasses=[],this.version="1.3.2;"}get instances(){return[...this._clients]}};class E extends u{constructor(t){var e;super("client",P),this._config(t),this.context=new g(this),this.api=new y(this,P),P._clients.push(e=this),P._events.emit("create",e)}get version(){return E.version}_config(t){this.options=Object.freeze(this._normalizeOptions(t))}_normalizeOptions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("string"==typeof t&&(t={apiKey:t}),!t.apiKey)throw Error("Require API key to initialize miso client.");return e(t)}}function C(t,e){try{e()}catch(e){t(e)}}function O(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t=>console.error(t);const s=window[t]||(window[t]=[]);if(s._processed)return;s._processed=!0;const r=t=>C(e,t);Object.defineProperty(s,"push",{value:r});for(const t of s)r(t)}window.MisoClient?console.warn("Use already defined window.MisoClient (".concat(window.MisoClient.version,").")):(window.MisoClient=function(t){const e=P._pluginRoot;return P.MisoClient=e.MisoClient=t,s(t,P,["version","instances","meta","on","once"]),s(t,e,["plugins"]),t}(E),O("misodev"),setTimeout((()=>O("misocmd"))));var j=window.MisoClient;const R="miso-anonymous-id";let I;class q{constructor(){this._autoAnonymousId=(I||(I=window.sessionStorage.getItem(R)),I||window.sessionStorage.setItem(R,I=n()),I)}get anonymous_id(){return this._anonymousId||this._autoAnonymousId}set anonymous_id(t){this._anonymousId=t}get user_id(){return this._userId}set user_id(t){this._userId=t}get user_hash(){return this._userHash}set user_hash(t){this._userHash=t}}function N(){const t=new URLSearchParams(window.location.search);let s=e({source:t.get("utm_source")||void 0,medium:t.get("utm_medium")||void 0,name:t.get("utm_campaign")||void 0,term:t.get("utm_term")||void 0,content:t.get("utm_content")||void 0});return 0===Object.keys(s).length?void 0:s}const U="%cMiso",S="color: #fff; background-color: #334cbb; padding: 2px 2px 1px 4px;",A=function(t,e){for(var s=arguments.length,r=Array(s>2?s-2:0),n=2;s>n;n++)r[n-2]=arguments[n];return console.log(U,S,L(t),M(e),...r)};function T(t,e,s){void 0===s?A(t,e):Array.isArray(s)?A(t,e,...s.map(F)):A(t,e,F(s))}function L(t){return"<".concat("string"==typeof t?t:t.filter((t=>t)).join("/"),">")}function M(t){return"[".concat(t,"]")}function F(t){const e=typeof t;return"function"===e||"object"===e&&!Array.isArray(t)?[t]:t}j.plugins.register(class{constructor(){this._log=console.log.bind(console,U,S)}static get id(){return"std:debug"}install(t){this._injectComponents(t)}_injectComponents(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t.on("child",(t=>this._injectComponents(t,e))),t.on("subtree",(s=>this._injectComponents(s,e.concat(t.meta.path)))),t.on("*",((s,r)=>this._handleEvent(t,r,s,e)))}_handleEvent(t,e,s){let{name:r}=e;if("child"===r||"subtree"===r)return;const n=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:[]).concat(t.meta.path);if(n.length||"create"!==r){switch(n[0]){case"client":if("api"===n[1])return void this._handleApiEvent(r,{...s,groupName:n[2]});break;case"plugins":return void(1===n.length?this._handlePluginsEvent(r,s):this._handlePluginSpecificEvent(n[1],n.slice(2),r,s))}T(n.join("."),r,s)}else this._handleCreateClient(r,s)}_handleCreateClient(t,e){T("client",t,e)}_handleApiEvent(t,e){let{groupName:s,apiName:r,url:n,bulk:i,...o}=e;const a=new URL(n).pathname,c=["api",t];if(i&&c.push("(bulk ".concat(i.bulkId,")")),c.push("POST ".concat(a)),"interactions"===s){const{type:t}=o.payload.data[0];c.push(t)}c.push([{...o,url:n}]),A.apply(void 0,c)}_handlePluginsEvent(t,e){A("plugins",t,"".concat(e.id||"(anonymous)"),[e])}_handlePluginSpecificEvent(t,e,s,r){T([t,e.join(".")],s,r)}_getPath(t){const e=[];for(let s=t;s;s=s.meta.parent)s.meta.name&&e.push(s.meta.name);return e.reverse()}},class{constructor(){this._options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},this.id="std:dry-run",this.name="dry-run"}static get id(){return"std:dry-run"}install(t,e){const s=this;e.classes.api.ApiBase.prototype._send=async function(t){let{url:e}=t;return this._events.emit("dry-run-send",{url:e}),s._mockResponse()}}_mockResponse(){return{data:{products:[],attributes:[],completions:{}}}}}),j.plugins.use(class{static get id(){return"std:user"}constructor(){}install(t,e){let{addPayloadPass:s}=e;t.on("create",this._injectClient.bind(this)),s(this._modifyPayload.bind(this))}_injectClient(t){const e=t._userContext=new q;var s,r;s=e,Object.defineProperties(t.context,(r="string"==typeof(r=["anonymous_id","user_id","user_hash"])?[r]:r).reduce(((t,e)=>(t[e]={get:()=>s[e],set:t=>{s[e]=t}},t)),{}))}_modifyPayload(t){let{client:e,apiGroup:s,apiName:r,payload:n}=t;return"interactions"===s&&"upload"===r?this._modifyPayloadForInteractions(e,n):this._modifyPayloadForOthers(e,n)}_modifyPayloadForOthers(t,e){const{user_id:s,user_hash:r,anonymous_id:n}=t.context;return{...s?{user_id:s,user_hash:r}:{anonymous_id:n},...e}}_modifyPayloadForInteractions(t,s){let{data:r}=s;const{anonymous_id:n,user_id:i}=t.context,o=e({anonymous_id:n,user_id:i});return r=r.map((t=>({...o,...t}))),{data:r}}}),j.plugins.use(class{static get id(){return"std:page-info"}constructor(){}install(t,e){let{addPayloadPass:s}=e;s(this._modifyPayload.bind(this))}_modifyPayload(t){let{apiGroup:e,apiName:s,payload:r}=t;return"interactions"===e&&"upload"===s?this._modifyPayloadForInteractions(r):r}_modifyPayloadForInteractions(t){let{data:s}=t;return s=s.map((t=>({...t,context:{...e({page:e({url:window.location.href,referrer:document.referrer,title:document.title}),campaign:N()}),...t.context}}))),{data:s}}});var G=function(){const t=document.currentScript;if(!t||!t.src)return Object.freeze({});const e=document.createElement("a");e.href=t.src;let s=e.search;return"?"===s.charAt(0)&&(s=s.substring(1)),Object.freeze(s.split("&").reduce(((t,e)=>{if(e){const[s,r]=e.split("=");t[s]=void 0===r||r}return t}),{}))}();const z=document.createElement("a");function B(t){return z.href=t,new URL(z.href)}class K{constructor(t){this._callback=t}init(t){this._data||(this._data=t.reduce(((t,{productId:e,quantity:s})=>(t[e]=s,t)),{}),this._queuedUpdate&&(this._update(this._queuedUpdate),delete this._queuedUpdate))}update(t){this._data?this._update(t):this._queuedUpdate=t}_update(t){const e=this._data,s={},r=[],n=[],i=[];for(const{productId:o,quantity:a}of t){const t=e[o]||0;delete e[o],s[o]=a;const c=a-t;c>0?(r.push(o),n.push(c)):0>c&&i.push(o)}for(const t in e)i.push(t);this._data=s,this._callback(r.length?{product_ids:r,quantities:n}:void 0,i.length?{product_ids:i}:void 0)}}const D=new WeakMap;var H="1.0.1-beta.0";(()=>{if(!G.api_key)throw Error('Please insert the script tag with parameter "?api_key=..."');window.miso_script_version=H,j.plugins.use("std:debug");const t=window.miso=new j(G.api_key);setTimeout((()=>X(t)),3500);const e=new K(((e,s)=>{e&&t.api.interactions.upload({type:"add_to_cart",...e}),s&&t.api.interactions.upload({type:"remove_from_cart",...s})}));W(e),function(t,e){const s=B("/").origin;!function(t){const{send:e,open:s}=window.XMLHttpRequest.prototype;Object.assign(window.XMLHttpRequest.prototype,{send:function(s){let{method:r,url:n}=D.get(this);n=B(""+n);const i={method:r,url:n,body:s,xhr:this};return this.addEventListener("load",(()=>{t({type:"response",...i})})),t({type:"request",...i}),e.apply(this,arguments)},open:function(t,e){return D.set(this,Object.freeze({method:t,url:e})),s.apply(this,arguments)}})}((({type:r,method:n,url:i,xhr:o})=>{if(i.origin===s&&"response"===r)switch(i.pathname){case"/api/v1/user/profile":try{const e=JSON.parse(o.responseText),s=e.data&&e.data.id;s&&(t.context.user_id=s,X(t))}catch(t){console.error("[Miso Script] Failed to handle /user/profile response.")}break;case"/api/v1/cart/products":if("PUT"===n||"DELETE"===n)try{const t=JSON.parse(o.responseText);e.update(t.data.cartProducts.data)}catch(t){console.error("[Miso Script] Failed to handle /cart/products response.")}}}))}(t,e)})();let J=!1;function X(t){if(J)return;J=!0;const e=window.location.pathname;if("/"===e)t.api.interactions.upload({type:"home_page_view"});else if(e.indexOf("/catalog/cat/")<0){if(e.indexOf("/catalog/item/")>=0){const s=e.match(/\/catalog\/item\/(\d+)-/);if(s){t.api.interactions.upload({type:"product_detail_page_view",product_ids:[s[1]]})}}}else(async()=>{try{const e=(await async function(t){return document.querySelector(t)||new Promise(((e,s)=>{window.addEventListener("DOMContentLoaded",(()=>{const r=document.querySelector(t);r?e(r):s(Error("Element not found: "+t))}))}))}('nav[aria-label="breadcrumb"]')).querySelectorAll(".breadcrumb-item"),s=Array.prototype.slice.call(e,1).map((t=>t.textContent.trim()));t.api.interactions.upload({type:"category_page_view",category:s})}catch(t){console.error(t)}})()}function W(t){window.platformConfiguration?t.init(window.platformConfiguration.cart?window.platformConfiguration.cart.data.cartProducts.data:[]):setTimeout((()=>W(t)),200)}}();
