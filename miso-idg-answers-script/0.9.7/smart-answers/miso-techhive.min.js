!function(){"use strict";var t=Object.freeze({...function(){const t=document.currentScript;if(!t||!t.src)return{};const e=document.createElement("a");e.href=t.src;const s={};for(const[t,n]of new URLSearchParams(e.search))"q"!==t&&(s[t]=""===n||n);return s}(),...function(){const t={};for(const[e,s]of new URLSearchParams(window.location.search))e.startsWith("miso_")&&e.length>5&&"miso_api_key"!==e?t[e.substring(5)]=""===s||s:"q"===e&&(t.q=s);return t}()}),e="0.9.7";function s(t,e){const s=t.indexOf(e);s>-1&&t.splice(s,1)}function n(t){return Array.isArray(t)?t:void 0===t?[]:[t]}function i(t){return null!=t?""+t:t}function r(t){if("object"!=typeof t)return t;const e={};for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&void 0!==t[s]&&(e[s]=t[s]);return e}function o(t,e,s){Object.defineProperties(t,(s="string"==typeof s?[s]:s).reduce(((t,s)=>(t[s]={get:()=>{const t=e[s];return"function"==typeof t?t.bind(e):t}},t)),{}))}function a(t,e){for(const s in e)e.hasOwnProperty(s)&&Object.defineProperty(t,s,{value:e[s]})}class c{constructor(t){let{duration:e=0,onDuration:s,offDuration:n,state:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("function"!=typeof t)throw Error("Callback must be a function: "+t);l(s),l(n),l(e),this._callback=t,Object.defineProperty(this,"durations",{value:Object.freeze({on:void 0!==s?s:e,off:void 0!==n?n:e})}),this._value=this._state=!!i,this._active=!0}get active(){return this._active}get state(){return this._state}get value(){return this._value}set value(t){if(this._value===(t=!!t))return;!function(t){if(!t._timeout)return;clearTimeout(t._timeout),t._timeout=void 0}(this);const e=this.durations[t?"on":"off"];e?this._timeout=setTimeout((()=>u(this,t)),e):u(this,t),this._value=t}disconnect(){this._active=!1}}function u(t,e){t._state!==e&&(t._state=e,t._active&&t._callback(e))}function l(t,e){if(void 0!==e&&(isNaN(e)||0>e))throw Error(`${t} must be a non-negative number: ${e}`)}function h(t){return"object"==typeof t&&t.nodeType===Node.ELEMENT_NODE}function d(t,e){for(;t&&t!==t.ownerDocument;t=t.parentElement){const s=e(t);if(void 0!==s)return s}}function _(t){return t&&t.ownerDocument&&t.ownerDocument.contains(t)}function p(t){const{tagName:e}=t;customElements.define(e,t);for(const t of document.querySelectorAll(e))customElements.upgrade(t)}async function f(t){return new Promise(((e,s)=>{window.requestAnimationFrame((async()=>{try{await t(),e()}catch(t){s(t)}}))}))}async function m(t){let{area:e=.5,duration:s=1e3,signal:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var i;return t="string"==typeof(i=t)?document.querySelector(i):i,new Promise((i=>{const r=new c((t=>{t&&(r.disconnect(),o.disconnect(),i())}),{onDuration:s}),o=new IntersectionObserver((t=>{r.value=t[0].isIntersecting}),{threshold:e});o.observe(t),n&&n.addEventListener&&n.addEventListener("abort",(()=>{r.disconnect(),o.disconnect()}))}))}function g(){return(crypto&&crypto.randomUUID?crypto.randomUUID():void 0)||function(){if(!URL||!URL.createObjectURL||URL.revokeObjectURL||!Blob)return;const t=URL.createObjectURL(new Blob),e=""+t;return URL.revokeObjectURL(t),e.substring(e.lastIndexOf("/")+1)}()||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}function b(t,e){const s=window.localStorage.getItem(t),n=function(t){const e="; "+document.cookie,s=`; ${encodeURIComponent(t)}=`,n=e.indexOf(s);if(0>n)return;const i=n+s.length,r=e.indexOf(";",i);return decodeURIComponent(0>r?e.substring(i):e.substring(i,r))}(t),i=s||n||""+e();return i&&!s&&window.localStorage.setItem(t,i),i&&!n&&function(t,e){document.cookie=`${encodeURIComponent(t)}=${encodeURIComponent(e)}; max-age=31536000; path=/`}(t,i),i}function y(t){return new v(t)}class v{constructor(t){this._value=t;const e=t=>{this._value=t};a(this,{set:e,args:function(){for(var t=arguments.length,s=Array(t),n=0;t>n;n++)s[n]=arguments[n];return e(s)},t:()=>e(!0),f:()=>e(!1),merge:t=>e(Object.assign({},this._value,t))})}get value(){return this._value}}class w{constructor(){const t=this;t.promise=new Promise(((e,s)=>{t.resolve=e,t.reject=s})),Object.freeze(this)}}class E{constructor(){this._index=-1,this._done=!1,this._aborted=!1,this._abortReason=void 0,this._error=void 0}get aborted(){return this._aborted}get abortReason(){return this._abortReason}get done(){return this._done}update(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._done||(this._value=t,this._done=e,this._index++,this._resolution&&(this._resolution.resolve(),this._resolution=void 0))}error(t){this._error=t,this._resolution&&(this._resolution.reject(t),this._resolution=void 0)}abort(t){this._aborted=!0,this._abortReason=t,this._resolution&&(t instanceof Error?this._resolution.reject(t):this._resolution.resolve(),this._resolution=void 0)}async*[Symbol.asyncIterator](){for(let t=0;;t=this._index+1){if(this._error)throw this._error;if(this._aborted)break;if(t>this._index&&(this._resolution||(this._resolution=new w),await this._resolution.promise),this._aborted)break;if(yield this._value,this._done)break}}}function k(){for(var t=arguments.length,e=Array(t),s=0;t>s;s++)e[s]=arguments[s];const n=e.length;if(0===n)return(new AbortController).signal;if(1===n)return e[0];const i=new AbortController;for(const t of e)if(t&&t.addEventListener){if(t.aborted)return AbortSignal.abort(t.reason);t.addEventListener("abort",(()=>i.abort(t.reason)))}return i.signal}const O=Symbol.for("miso:resources");class x{constructor(){this._resources=new Map;const t=window[O]||[];for(const e of t)try{const[t,s]=e;this.push([t,s])}catch(t){}}push(t){let[e,s]=t;C(this._resources,e).resolve(s)}async get(t){return C(this._resources,t).promise}}function C(t,e){if(t.has(e))return t.get(e);const s=new w;return t.set(e,s),s}function j(){return window[O]||(window[O]=new x)}class I{constructor(t,e){this._dispatchRequested=!1,this._requests=[],this._run=t,this._error=e||(t=>console.error(t)),this._bulkId=0,this._dispatch=this._dispatch.bind(this)}get info(){return{bulkId:this._bulkId,index:this._requests.length}}async run(t){const e=new w;return this._requests.push({action:t,resolution:e}),this._requestDispatch(),e.promise}_requestDispatch(){this._dispatchRequested||(this._dispatchRequested=!0,setTimeout(this._dispatch))}_dispatch(){if(!this._dispatchRequested)return;this._dispatchRequested=!1;const t=this._requests,e=this._bulkId++;this._requests=[];try{this._run(t,{bulkId:e})}catch(t){this._error(t)}}}class R{constructor(){let{target:t,error:e,replays:s=[]}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._error=e||(t=>console.error(t)),!Array.isArray(s))throw Error("Replays option must be an array of strings: "+s);this._replays=new Set(s),this._namedCallbacks={},this._unnamedCallbacks=[],this._pastEvents={},t&&this._injectSubscribeInterface(t)}emit(t,e){const s={data:e,meta:{name:t,ts:Date.now()}},n=this._namedCallbacks[t];if(n)for(const t of n)t(s);for(const t of this._unnamedCallbacks)t(s);this._shallStoreForReplay(t)&&(this._pastEvents[t]||(this._pastEvents[t]=[])).push(s)}on(t,e){return this._checkName(t),this._checkCallback(e),this._on(t,this._wrapCallback(e))}once(t){this._checkName(t);const e=this;return new Promise(((s,n)=>{const i=e._on(t,(t=>{setTimeout((()=>i()));try{s(t)}catch(t){n(t)}}))}))}_checkName(t){if("string"!=typeof t)throw Error("Event name should be a string: "+t)}_checkCallback(t){if("function"!=typeof t)throw Error("Event callback should be a function: "+t)}_shallStoreForReplay(t){return this._replays.has(t)}_wrapCallback(t){const e=this;return s=>{let{data:n,meta:i}=s;try{t(n,i)}catch(t){e._error(t)}}}_on(t,e){if("*"===t?this._unnamedCallbacks.push(e):(this._namedCallbacks[t]||(this._namedCallbacks[t]=[])).push(e),"*"===t)for(const t in this._pastEvents)this._pastEvents[t].forEach(e);else this._pastEvents[t]&&this._pastEvents[t].forEach(e);return()=>this._off(t,e)}_off(t,e){if("*"===t)s(this._unnamedCallbacks,e);else{const n=this._namedCallbacks[t];n&&s(n,e)}}_injectSubscribeInterface(t){o(t,this,["on","once"])}}function A(t,e){return Object.freeze([...e&&e.meta&&e.meta.path||[],...t?[t]:[]])}class N{constructor(t,e){const s=function(t,e){if(void 0!==t&&"string"!=typeof t&&void 0===e&&(e=t,t=void 0),void 0!==t&&("string"!=typeof t||!t))throw Error(`Invalid Component name: "${t}"`);return Object.freeze({name:t,parent:e,path:A(t,e),uuid:g()})}(t,e);a(this,{meta:s});const n=this._error=this._error.bind(this);(this._events=new R({error:n,replays:["child"]}))._injectSubscribeInterface(this),this._warn=this._warn.bind(this),(e=s.parent)&&e._events&&e._events.emit("child",this)}_warn(){const t=this.meta.parent;(t&&t._warn||console.warn)(...arguments)}_error(){const t=this.meta.parent;(t&&t._error||console.error)(...arguments)}}!function(t,e){const s=Symbol.for(e);Object.defineProperty(t,s,{value:!0}),Object.defineProperty(t,"isTypeOf",{value:e=>e&&e instanceof t||"function"==typeof e.constructor&&!0===e.constructor[s]})}(N,"miso:component");class S extends N{constructor(t,e){let{libName:s,keyName:n}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};switch(super(t,e),this._events._replays.add("register"),this._libraries={},this._libResolutions={},this._libName=s,typeof n){case"string":this._keyFn=t=>t[n];break;case"function":this._keyFn=n;break;default:throw Error("Expect keyName to be a string or a function: "+n)}}isRegistered(t){return this._checkKey(t),!!this._libraries[t]}get registered(){return Object.values(this._libraries)}async whenRegistered(t){if(this.isRegistered(t))return this._libraries[t];const{promise:e}=this._libResolutions[t]||(this._libResolutions[t]=new w);return e}register(){for(var t=arguments.length,e=Array(t),s=0;t>s;s++)e[s]=arguments[s];for(const t of e)this._register(t)}_checkKey(t){if("string"!=typeof t||!t)throw Error("Expect key to be a non-empty string: "+t)}_checkLib(t){if("function"!=typeof t)throw Error("Expect lib to be a class or function: "+t)}_register(t){this._checkLib(t);const e=this._keyFn(t);this._checkKey(e);const s=this._libraries||(this._libraries={});s[e]=t,this._libResolutions[e]&&this._libResolutions[e].resolve(t),this._events.emit("register",t)}}class ${constructor(t){this._ac=new AbortController,this._timeout=t,this.touch()}clear(){void 0!==this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=void 0)}touch(){this.clear(),this._timeoutId=setTimeout((()=>this.abort()),this._timeout)}get signal(){return this._ac.signal}abort(t){this.clear(),this._ac.abort(t||Error(`Stall timeout: data stay unchanged for ${this._timeout/1e3} seconds.`))}}const P={DATA_ENDPOINT:"https://api-edge.askmiso.com/v1",EVENT_ENDPOINT:"https://api.askmiso.com/v1"};class q{constructor(t,e){this._client=t,this._root=e,this._bulk=new I(this._runBulkFetch.bind(this),t._error.bind(t))}async fetch(t,e){let{method:s="POST",headers:n,timeout:i,sendApiKeyByHeader:o}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{apiKey:a,request:c={}}=this._client.options;i=i||c.timeout,o=o||c.sendApiKeyByHeader,o&&(n=Object.assign({},n,{"X-API-KEY":a}));const u="GET"!==s&&null!=e?JSON.stringify(e):void 0,l=i?AbortSignal.timeout(i):void 0,h=await window.fetch(t,r({method:s,headers:n,body:u,cache:"no-cache",mode:"cors",signal:l})),d=await h.json();if(h.status>=400||d.errors){var _=Error(d.message);throw _.data=d,_.status=h.status,_}return d}get bulkInfo(){return this._bulk.info}async fetchForBulk(t,e,s){let{method:n}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(n&&"POST"!==n)throw Error("Non-POST API is not supported in bulk mode: "+url);return this._bulk.run({apiGroup:t,apiName:e,payload:s})}async _runBulkFetch(t){const e=this.url(["bulk"]),s={requests:t.map((t=>{let{action:{apiGroup:e,apiName:s,payload:n}}=t;return{api_name:`${e}/${s}`,body:n}}))},{data:n}=await this.fetch(e,s);for(let e=0,s=t.length;s>e;e++){const{resolution:s}=t[e],{error:i,status_code:r,body:o}=n[e];r>=400||i?s.reject({status_code:r,body:o}):s.resolve(o)}}sendBeacon(t,e){let{method:s}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(s&&"POST"!==s)throw Error("Non-POST API is not supported in useBeacon mode: "+t);if(!window.navigator.sendBeacon(t,JSON.stringify(e)))throw Error("Send beacon unsuccessful: "+t)}url(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{apiKey:s,request:n={}}=this._client.options,i=e.sendApiKeyByHeader||n.sendApiKeyByHeader,r=t.filter((t=>t)).join("/"),o=`${this.getApiEndpoint(r)}/${r}`;return i?o:`${o}?api_key=${window.encodeURIComponent(s)}`}getApiEndpoint(t){const{dataEndpoint:e=P.DATA_ENDPOINT,eventEndpoint:s=P.EVENT_ENDPOINT}=this._client.options;return"interactions"===t?s:e}applyUrlPasses(t,e){let{apiGroup:s,apiName:n,url:i}=e;const r=this._client;for(const e of this._root._urlPasses)try{i=e({client:r,apiGroup:s,apiName:n,url:i})||i}catch(e){t.error(e)}return i}applyPayloadPasses(t,e){let{apiGroup:s,apiName:n,payload:i}=e;const r=this._client;for(const e of this._root._payloadPasses)try{i=e({client:r,apiGroup:s,apiName:n,payload:i})||i}catch(e){t.error(e)}return i}}const L=["bulk"];class T extends N{constructor(t,e){super(e,t),this._apiPath=e,this.helpers=t.helpers,this.clientOptions=t._client.options,this.context=t._client.context}async _run(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{bulk:n}=s,i=n?{bulk:this.helpers.bulkInfo}:void 0,r=this._apiPath,o=this._url({apiGroup:r,apiName:t,payload:e,options:s}),a={apiGroup:r,apiName:t,payload:e=this._preprocess({apiGroup:r,apiName:t,payload:e,options:s}),url:o,options:s};this._events.emit("request",Object.assign({},a,i));const c=await this._send(a),u=Object.assign({},a,{response:c});return this._events.emit("response",Object.assign({},u,i)),this._postprocess(u)}_preprocess(t){let{apiGroup:e,apiName:s,payload:n}=t;return this.helpers.applyPayloadPasses(this,{apiGroup:e,apiName:s,payload:n})}_url(t){let{apiGroup:e,apiName:s,options:n}=t;const i=this.helpers.url([e,s],n);return this.helpers.applyUrlPasses(this,{apiGroup:e,apiName:s,url:i,options:n})}async _send(t){let{apiGroup:e,apiName:s,url:n,payload:i,options:{bulk:r}={}}=t,o=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t.options,L);return r?this.helpers.fetchForBulk(e,s,i):this.helpers.fetch(n,i,o)}_postprocess(t){let{response:e}=t;return e.data}}const U=["useBeacon"],M=["options"];function D(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}class z extends T{constructor(t){super(t,"interactions")}async upload(t,e){try{return await this._run("upload",t,e)}catch(t){if(400!==t.status||!t.message||-1>=t.message.toLowerCase().indexOf("playground"))throw t;this._warn("Ignore interactions uploaded to playground app.")}}_url(t){let{apiGroup:e,apiName:s,options:n}=t;const i=this.helpers.url([this._apiPath],n);return this.helpers.applyUrlPasses(this,{apiGroup:e,apiName:s,url:i,options:n})}_preprocess(t){let{apiGroup:e,apiName:s,payload:n}=t;return"upload"===s&&(n=this._normalizeUploadPayload(n)),super._preprocess({apiGroup:e,apiName:s,payload:n})}_normalizeUploadPayload(t){if("object"!=typeof t)throw Error("Interactions payload has to be either an object or an array of objects: "+t);return Array.isArray(t)||(t=[t]),{data:t}}async _send(t){let{options:{useBeacon:e=!0}={}}=t,s=D(t.options,U),n=D(t,M);if(e){const{url:t,payload:e}=n;return this.helpers.sendBeacon(t,e,s),{}}return super._send(Object.assign({},n,{options:s}))}}const V=["pollingInterval","signal","stallTimeout"];class B extends T{constructor(t){super(t,"ask")}async questions(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof t&&"{"!==t.charAt(0))return new Q(this,{question_id:t},e);const s=await this._run("questions",t,e);return new Q(this,s,e)}async _questions(t,e){return this._run("questions",t,e)}async _get(t,e){return this._run(`questions/${t}/answer`,void 0,Object.assign({},e,{method:"GET"}))}}class Q{constructor(t,e){let{question_id:s}=e,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._api=t,this._questionId=s,this._ac=new AbortController,this._options=n}get questionId(){return this._questionId}async get(t){return this._api._get(this._questionId,Object.assign({},this._options,t))}abort(t){this._ac.abort(t)}[Symbol.asyncIterator](){var t=this;let e=this._options,{pollingInterval:s,signal:n,stallTimeout:i=3e4}=e,r=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(e,V);const o=new $(i);let a;n=k(this._ac.signal,o.signal,n);return function(t){let{interval:e=1e3,errorLimit:s=10,onError:n,onResponse:i,signal:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(r&&r.aborted)return[];let o=0;const a=new E,c=setInterval((async()=>{let e,u;try{[e,u]=await t(r?{signal:r}:{}),i&&i(e,u)}catch(t){return n&&n(t),o++,void(o>s&&(clearInterval(c),a.error(t)))}a.update(e,u),u&&clearInterval(c)}),e);return r&&r.addEventListener&&r.addEventListener("abort",(()=>{clearInterval(c),a.abort(r.reason)})),a}((async function(){const e=await t.get();return[e,e.finished]}),Object.assign({interval:s,signal:n,onResponse:(t,e)=>{var s,n;e?o.clear():(n=t,(s=a)&&s.answer_stage===n.answer_stage&&s.answer.length===n.answer.length||o.touch()),a=t}},r))[Symbol.asyncIterator]()}}class W extends T{constructor(t){super(t,"search")}async search(t,e){return this._run("search",t,e)}async autocomplete(t,e){return this._run("autocomplete",t,e)}async multipleGet(t,e){return this._run("mget",t,e)}}class G extends T{constructor(t){super(t,"recommendation")}async userToProducts(t,e){return this._run("user_to_products",t,e)}async userToCategories(t,e){return this._run("user_to_categories",t,e)}async userToAttributes(t,e){return this._run("user_to_attributes",t,e)}async userToTrending(t,e){return this._run("user_to_trending",t,e)}async userToHistory(t,e){return this._run("user_to_history",t,e)}async productToProducts(t,e){return this._run("product_to_products",t,e)}}class F extends N{constructor(t,e){super("api",t),this._client=t,this.helpers=new q(t,e),this.interactions=new z(this),this.ask=new B(this),this.search=new W(this),this.recommendation=new G(this)}}class K extends N{constructor(t){super("context",t),this._client=t}}var H={api:{Api:F,ApiBase:T,ApiHelpers:q,Interactions:z,Recommendation:G,Search:W},context:{Context:K}};class Y{constructor(t){a(this,{install:t})}}class Z extends S{constructor(t){super("plugins",t,{libName:"plugin class",keyName:"id"}),this._root=t,this._currentScript=document.currentScript,this._events._replays.add("install").add("subtree"),this._installed={},this._installedResolutions={},this._useRequests={},this._subtrees=[],this.context=new X(this,H),this.plugins=new J(this)}isInstalled(t){return this._checkKey(t),!!this._installed[t]}get installed(){return Object.values(this._installed)}get(t){return this._installed[t]}getPluginClass(t){return this._libraries[t]}use(t,e){if("function"==typeof t&&t.id&&"string"==typeof t.id)return this.register(t),void this.use(t.id,e);let s;if("string"==typeof t&&this.isInstalled(t))return s=this.get(t),void this._tryConfig(s,e);"string"!=typeof t||this.isRegistered(t)?(s=this._instantiate(t,e),this._install(s)):(this._useRequests[t]||(this._useRequests[t]=[])).push(e)}async install(t,e){return this.use(t,e),"string"!=typeof t||this.isRegistered(t)||await this._tryRegisterRemotely(t),this.whenInstalled(t)}async whenInstalled(t){if(this.isInstalled(t))return this.get(t);const{promise:e}=this._installedResolutions[t]||(this._installedResolutions[t]=new w);return e}addSubtree(t){this._subtrees.push(t),this._events.emit("subtree",t)}addPayloadPass(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._payloadPasses.push(t)}addUrlPass(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._urlPasses.push(t)}_tryConfig(t,e){void 0!==e&&("function"==typeof t.config?(t.config(e),this._events.emit("config",[t,e])):this._warn(`Attempt to pass options to plugin "${t.id}", which offers no config() method.`))}_instantiate(t,e){switch(typeof t){case"string":this._checkKey(t);const s=this._libraries[t];if(!s)throw Error("Plugin class not found: "+t);const n=new s;return a(n,{id:t}),this._tryConfig(n,e),n;case"function":return new Y(t)}throw Error("Unexpected parameters: "+t)}_install(t){if("function"!=typeof t.install)throw Error("Expect plugin.install to be a function: "+t);try{t.installed=!1,t.install(this.MisoClient,this.context),t.installed=!0}catch(t){throw t}t.id&&(this._installed[t.id]=t,this._installedResolutions[t.id]&&(this._installedResolutions[t.id].resolve(t),delete this._installedResolutions[t.id])),this._events.emit("install",t)}_register(t){super._register(t),this._fulfillUseRequests(t.id)}_fulfillUseRequests(t){const e=this._useRequests[t];if(e){for(const s of e)try{this.use(t,s)}catch(t){this._error(t)}delete this._useRequests[t]}}async _tryRegisterRemotely(t){if(t.startsWith("std:"))try{return void await this._registerStdRemotely(t)}catch(t){console.error(t)}throw Error("Cannot register plugin remotely: "+t)}async _registerStdRemotely(t){const{version:e}=this._root,s="dev"===e?`plugin:${t}@dev:${MisoClient.uuid}`:`plugin:${t}@${e}`;if(!document.querySelector(`script[data-request="${s}"]`)){const n=document.createElement("script");n.async=!0,n.src=function(t,e,s){const n=t.slice(4);if("dev"===e){const t=s.src,e=t.indexOf("?"),i=0>e?t.length:e,r=t.lastIndexOf("/",i)+1,o=t.indexOf(".",r),a=0>o?"":t.slice(o,i);return`${t.slice(0,r)}plugins/${n}${a}`}return`https://cdn.jsdelivr.net/npm/@miso.ai/client-sdk@${e}/dist/umd/plugins/${n}.min.js`}(t,e,this._currentScript),n.setAttribute("data-request",s),document.head.appendChild(n)}const n=await(new j).get(s);!this.isRegistered(t)&&this.register(n)}}class X{constructor(t,e){o(this,t,["getPluginClass","addSubtree","addPayloadPass","addUrlPass","whenInstalled","whenRegistered"]),a(this,{classes:e})}}class J{constructor(t){o(this,t,["installed","registered","isInstalled","isRegistered","whenInstalled","whenRegistered","get","register","use","install"])}}const tt=new class extends N{constructor(){super(),this._events._replays.add("create"),this._pluginRoot=new Z(this),this._clients=[],this._payloadPasses=[],this._urlPasses=[],this.version="1.8.0-beta.9"}get instances(){return[...this._clients]}async any(){return this._clients[0]||this._any||(this._any=(await this._events.once("create")).data)}};var et=Object.freeze({__proto__:null,viewable:m});class st extends N{static attach(){(window.MisoClients||(window.MisoClients=[])).push(st),window.MisoClient?window.MisoClient!==st&&console.warn(`window.MisoClient already exists: (${window.MisoClient.version}).`):window.MisoClient=st}constructor(t){super("client",tt),this._config(t),this.context=new K(this),this.api=new F(this,tt),function(t){tt._clients.push(t),tt._events.emit("create",t)}(this)}get version(){return st.version}_config(t){this.options=Object.freeze(this._normalizeOptions(t))}_normalizeOptions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("string"==typeof t&&(t={apiKey:t}),t.readConfigFromScriptUrl&&(t=Object.assign({},this._readConfigFromScriptUrl(),t)),!t.apiKey)throw Error("Require API key to initialize miso client.");return t.dataEndpoint=t.dataEndpoint||t.apiHost,t.eventEndpoint=t.eventEndpoint||t.apiHost,delete t.apiHost,r(t)}_readConfigFromScriptUrl(){const t=document.currentScript;return r({apiKey:new URL(new Request(t.src||t.href).url).searchParams.get("api_key")||void 0})}}st.helpers=et,a(st,{uuid:g()});var nt=function(t){const e=tt._pluginRoot;return tt.MisoClient=e.MisoClient=t,o(t,tt,["version","instances","any","meta","on","once"]),o(t,e,["plugins"]),t}(st);class it{constructor(t){this._plugin=t}get anonymous_id(){return this._anonymousId||this._autoAnonymousId||(this._autoAnonymousId=b("miso_anonymous_id",g))}set anonymous_id(t){t=i(t),this._anonymousId=t,this._plugin._events.emit("set",`anonymous_id = '${t}'`)}get user_id(){return this._userId}set user_id(t){t=i(t),this._userId=t,this._plugin._events.emit("set",`user_id = '${t}'`)}get user_hash(){return this._userHash}set user_hash(t){if("string"!=typeof t&&void 0!==t)throw Error("User hash must be a string");this._userHash=t,this._plugin._events.emit("set",`user_hash = '${t}'`)}}function rt(){const t=new URLSearchParams(window.location.search);let e=r({source:t.get("utm_source")||void 0,medium:t.get("utm_medium")||void 0,name:t.get("utm_campaign")||void 0,term:t.get("utm_term")||void 0,content:t.get("utm_content")||void 0});return 0===Object.keys(e).length?void 0:e}class ot{constructor(t){this._plugin=t,this._config={search:!0},this.interface=Object.freeze({config:this.config.bind(this)})}config(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("object"!=typeof t)throw Error("Config options must be an object or undefined: "+t);for(const e of t){if(!this._config.hasOwnProperty(e))continue;const s=this._config[e],n=t[e];n!==s&&(this._config[e]=s,this._plugin._events.emit("config",`${e}: ${s} -> ${n}`))}return Object.freeze(Object.assign({},this._config))}}const at=["groupName","apiName","url","bulk"];function ct(){let{text:t="Miso"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return"%c"+t}function ut(){let{color:t="#fff",background:e="#334cbb"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return`color: ${t}; background-color: ${e}; padding: 2px 2px 1px 4px;`}function lt(t){const e=typeof t;return"function"===e||"object"===e&&!Array.isArray(t)?[t]:t}nt.plugins.register(class{constructor(){this._options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}}static get id(){return"std:debug"}install(t){var e=this;this._injectComponents(t),t.debug=function(){return e._logr(...arguments)}}config(){this._options=Object.assign({},this._options,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}_injectComponents(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t.on("child",(t=>this._injectComponents(t,e))),t.on("subtree",(s=>this._injectComponents(s,e.concat(t.meta.path)))),t.on("*",((s,n)=>this._handleEvent(t,n,s,e)))}_handleEvent(t,e,s){let{name:n}=e;if("child"===n||"subtree"===n)return;const i=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:[]).concat(t.meta.path);if(i.length||"create"!==n){switch(i[0]){case"client":if("api"===i[1])return void this._handleApiEvent(n,Object.assign({},s,{groupName:i[2]}));break;case"plugins":return void(1===i.length?this._handlePluginsEvent(n,s):this._handlePluginSpecificEvent(i[1],i.slice(2),n,s))}this._logw(i.join("."),n,s)}else this._handleCreateClient(n,s)}_handleCreateClient(t,e){this._logw("client",t,e)}_handleApiEvent(t,e){let{groupName:s,url:n,bulk:i}=e,r=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(e,at);const o=new URL(n).pathname,a=["api",t];if(i&&a.push(`(bulk ${i.bulkId})`),a.push("POST "+o),"interactions"===s){const{type:t}=r.payload.data[0];a.push(t)}a.push([Object.assign({},r,{url:n})]),this._log(...a)}_handlePluginsEvent(t,e){let s=[];Array.isArray(e)&&(s=e.slice(1),e=e[0]),this._log("plugins",t,""+(e.id||"(anonymous)"),[e,...s])}_handlePluginSpecificEvent(t,e,s,n){this._logw([t,e.join(".")],s,n)}_getPath(t){const e=[];for(let s=t;s;s=s.meta.parent)s.meta.name&&e.push(s.meta.name);return e.reverse()}_logr(){const t=this._options.console||{};for(var e=arguments.length,s=Array(e),n=0;e>n;n++)s[n]=arguments[n];console.log(ct(t),ut(t),...s)}_log(t,e){const s=this._options.console||{};for(var n=arguments.length,i=Array(n>2?n-2:0),r=2;n>r;r++)i[r-2]=arguments[r];console.log(ct(s),ut(s),function(t){return`<${"string"==typeof t?t:t.filter((t=>t)).join("/")}>`}(t),function(t){return`[${t}]`}(e),...i)}_logw(t,e,s){void 0===s?this._log(t,e):Array.isArray(s)?this._log(t,e,...s.map(lt)):this._log(t,e,lt(s))}},class{constructor(){this._options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},this.id="std:dry-run",this.name="dry-run"}static get id(){return"std:dry-run"}install(t,e){let{addUrlPass:s}=e;s(this._modifyUrl.bind(this))}_modifyUrl(t){let{apiGroup:e,apiName:s,url:n}=t;return"interactions"===e&&"upload"===s?function(t,e,s){if("string"!=typeof e)throw Error("Expect URL parameter to be a string: "+e);return void 0===s&&(s="1"),t+(0>t.indexOf("?")?"?":"&")+encodeURIComponent(e)+"="+encodeURIComponent(""+s)}(n,"dry_run","1"):n}}),nt.plugins.use(class extends N{static get id(){return"std:user"}constructor(){super("user"),this._contexts=new WeakMap}install(t,e){e.addSubtree(this),t.on("create",this._injectClient.bind(this)),e.addPayloadPass(this._modifyPayload.bind(this))}_injectClient(t){const e=new it(this);var s,n;this._contexts.set(t,e),s=e,Object.defineProperties(t.context,(n="string"==typeof(n=["anonymous_id","user_id","user_hash"])?[n]:n).reduce(((t,e)=>(t[e]={get:()=>s[e],set:t=>{s[e]=t}},t)),{}))}_modifyPayload(t){let{client:e,apiGroup:s,apiName:n,payload:i}=t;return"interactions"===s&&"upload"===n?this._modifyPayloadForInteractions(e,i):this._modifyPayloadForOthers(e,i)}_modifyPayloadForOthers(t,e){const{user_id:s,user_hash:n,anonymous_id:i}=t.context;return Object.assign({},s?{user_id:s,user_hash:n}:{anonymous_id:i},e)}_modifyPayloadForInteractions(t,e){let{data:s}=e;const{anonymous_id:n,user_id:i}=t.context,o=r({anonymous_id:n,user_id:i});return s=s.map((t=>Object.assign({},o,t))),{data:s}}}),nt.plugins.use(class{static get id(){return"std:page-info"}constructor(){}install(t,e){let{addPayloadPass:s}=e;s(this._modifyPayload.bind(this))}_modifyPayload(t){let{apiGroup:e,apiName:s,payload:n}=t;return"interactions"===e&&"upload"===s?this._modifyPayloadForInteractions(n):n}_modifyPayloadForInteractions(t){let{data:e}=t;return e=e.map((t=>Object.assign({},t,{context:Object.assign({},r({page:r({url:window.location.href,referrer:document.referrer,title:document.title}),campaign:rt()}),t.context)}))),{data:e}}}),nt.plugins.use(class extends N{static get id(){return"std:auto-events"}constructor(){super("auto-events"),this._contexts=new WeakMap}install(t,e){e.addSubtree(this),t.on("create",this._injectClient.bind(this)),e.addPayloadPass(this._captureApiRequest.bind(this))}_injectClient(t){const e=new ot(this);this._contexts.set(t,e),t.autoEvents=e.interface}_captureApiRequest(t){let{client:e,apiGroup:s,apiName:n,payload:i}=t;if("search"===s)if("search"===n)this._captureSearchApiRequest(e,i)}_captureSearchApiRequest(t,e){let{q:s}=e;if(!s||"*"===s)return;const n=this._contexts.get(t);n&&n._config.search&&t.api.interactions.upload({type:"search",search:{keywords:s},context:{custom_context:{channel:"miso_api"}}})}});class ht{constructor(){(this._events=new R)._injectSubscribeInterface(this),this._states={},a(this,{states:new Proxy(this._states,{set(){}})})}update(t,e){let{silent:s=!1}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._states[t]=Object.freeze(e),s||this._events.emit(t,e)}trigger(t,e){this._events.emit(t,e)}}function dt(){return"data"}function _t(t){return t?"view:"+t:"view"}class pt{constructor(t){this._hub=t,this._sessionIndex=0,o(t,this,["active"])}get active(){const{session:t}=this._hub.states;return!(!t||!t.active)}new(){let{force:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this._hub.states.session;if(e&&!e.active&&!t)return;const s=this._create();this._hub.update("session",s)}start(){const t=this._hub.states.session||this._create();t.active||this._hub.update("session",Object.assign({},t,{active:!0}))}restart(){this.new({force:!0}),this.start()}_create(){return Object.freeze({active:!1,uuid:g(),index:this._sessionIndex++})}}class ft{constructor(t){this._hub=t,this._unsubscribes=[t.on("session",(t=>this._handleSession(t))),t.on("input",(t=>this._handleInput(t)))],this._postProcess=t=>t}get source(){return this._source}set source(t){if(t&&"function"!=typeof t)throw Error("Expect source to be a function: "+t);this._source=t}set postProcess(t){if(t&&"function"!=typeof t)throw Error("Expect postProcess to be a function: "+t);this._postProcess=t||(t=>t)}_handleSession(t){this._source&&(this._session&&t.index===this._session.index||(this._ac&&this._ac.abort({type:"new-session",message:"A new session is created, discarding the old one."}),this._ac=new AbortController),this._session=t,this._emitData({session:t}))}async _handleInput(t){if(!this._source)return;const{session:e}=this._hub.states;try{const{signal:s}=this._ac||{},n=Object.assign({},t.options,{signal:s}),i=await this._source(Object.assign({session:e},t,{options:n})),r=i&&("function"==typeof i.next?i:i[Symbol.asyncIterator]);if(r){let t;for await(t of r){if(!this._isCurrentSession(e))break;this._emitData({session:e,value:t,ongoing:!0})}this._emitDataWithSessionCheck({session:e,value:t})}else this._emitDataWithSessionCheck({session:e,value:i})}catch(t){this._error(t),this._emitDataWithSessionCheck({session:e,error:t})}}_emitDataWithSessionCheck(t){this._isCurrentSession(t.session)&&this._emitData(t)}_isCurrentSession(t){if(!t)return!1;const{session:e}=this._hub.states;return e&&e.index===t.index}_emitData(t){this._hub.update(dt(),this._postProcess(t))}_error(t){console.error(t)}destroy(){this._ac&&this._ac.abort({type:"data-actor-destroy",message:"Data actor is destroyed."});for(const t of this._unsubscribes)t();this._unsubscribes=[]}}const mt="data-miso-product-id",gt="default",bt=Object.freeze({CONTAINER:"container",BANNER:"banner",QUERY:"query",FEEDBACK:"feedback",RESULTS:"results",ITEMS:"items",QUESTION:"question",ANSWER:"answer",SOURCES:"sources",RELATED_RESOURCES:"related_resources",QUERY_SUGGESTIONS:"query_suggestions"}),yt=Object.freeze({CONTAINER:"container",BANNER:"banner",LIST:"list",QUERY:"query",RADIO:"radio",TEXT:"text"}),vt=Object.freeze({IMPRESSION:"impression",VIEWABLE:"viewable",CLICK:"click"}),wt=Object.freeze({UNTRACKED:"untracked",TRACKING:"tracking",TRIGGERED:"triggered"}),Et=Object.freeze({INITIAL:"initial",LOADING:"loading",ERRONEOUS:"erroneous",READY:"ready"});function kt(t){if(t!==vt.IMPRESSION&&t!==vt.VIEWABLE&&t!==vt.CLICK)throw Error("Unrecognized event type: "+t)}class Ot{constructor(t){this._view=t,this._handlers=[],this._unsubscribes=[t.on("element",(()=>this._sync()))],this._sync()}_get(){return this._view.element}on(t,e){const s=this._get();return s&&s.addEventListener(t,e),this._handlers.push({event:t,handler:e}),()=>this._off(t,e)}_off(t,e){const s=this._get();s&&s.removeEventListener(t,e);for(let s=0;this._handlers.length>s;s++)if(this._handlers[s].event===t&&this._handlers[s].handler===e){this._handlers.splice(s,1);break}}_sync(){const t=this._get();if(this._element!==t){if(this._element)for(const{event:t,handler:e}of this._handlers)this._element.removeEventListener(t,e);if(t)for(const{event:e,handler:s}of this._handlers)t.addEventListener(e,s);this._element=t}}_destroy(){for(const t of this._unsubscribes)t();this._unsubscribes=[]}}const xt=["value"];class Ct{constructor(t,e){this._events=new R({target:this}),this._views=t,a(this,{role:e,interface:new jt(this)})}get hub(){return this._views._hub}get element(){return this._element}set element(t){t!==this._element&&(this._element&&this._safeApplyOnLayout("unrender",this._element),this._element=t,this._events.emit("element",t),this.refresh({force:!0}))}get proxyElement(){return this._proxyElement||(this._proxyElement=new Ot(this))}get layout(){return this._layout}set layout(t){if(t===this._layout)return;if(t&&"function"!=typeof t.render)throw Error("Render function is mandatory in a layout.");const{element:e}=this;e&&this._safeApplyOnLayout("unrender",e),this._safeApplyOnLayout("destroy"),this._layout=t,t&&"function"==typeof t.initialize&&t.initialize(this),this.refresh({force:!0})}async refresh(){var t=this;let{force:e=!1,data:s}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this._layout)return;const{element:n}=this;if(!n)return;const i=this._data;this._data=s=this._sliceData(s||this._views._getData());const{session:r,status:o,ongoing:a,meta:c}=s;if(!e&&!(r&&r.active))return;if(!e&&((u=s)===(l=i)||u&&l&&u.status===l.status&&u.error===l.error&&u.value===l.value&&u.ongoing===l.ongoing&&function(t,e){return t===e||t&&e&&t.uuid===e.uuid}(u.session,l.session)))return;var u,l;const h=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1?arguments[1]:void 0;!1!==e&&t.updateState(Object.assign({session:r,status:o,ongoing:a,meta:c},e),s)};try{await this._layout.render(n,s,{notifyUpdate:h})}catch(t){this._error(t),h({error:t})}}updateState(t){let{session:e,status:s,ongoing:n,meta:i,error:o}=t,{silent:a=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o&&(s=Et.ERRONEOUS);const c=this._state=Object.freeze(r({session:e,status:s,ongoing:n,meta:i,error:o})),{role:u}=this;this.hub.update(_t(u),c,{silent:a})}_sliceData(t){const{value:e}=t,s=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,xt);return r(Object.assign({value:e&&e[this.role],meta:e&&e._meta},s))}_syncSize(){this._element&&this._safeApplyOnLayout("syncSize",this._element)}_safeApplyOnLayout(t){if(this._layout&&"function"==typeof this._layout[t])try{for(var e=arguments.length,s=Array(e>1?e-1:0),n=1;e>n;n++)s[n-1]=arguments[n];this._layout[t](...s)}catch(t){this._error(t)}}_error(t){this._views._error(t)}_destroy(){this._safeApplyOnLayout("destroy"),this._proxyElement&&this._proxyElement._destroy()}}class jt{constructor(t){o(this,t,["role","layout","element","proxyElement","refresh","on"])}}class It{constructor(t,e,s){let{roles:n=[],layouts:i={}}=s;this._hub=t,this._extensions=e,this._containers=new Map,this._views={};for(const t of n)this._views[t]=new Ct(this,t);this._layoutFns=new Map,this.layouts=i,a(this,{interface:new Rt(this)});const r=()=>this.syncSize();window.addEventListener("resize",r),this._unsubscribes=[()=>window.removeEventListener("resize",r),t.on(dt(),(()=>this.refresh()))]}addContainer(t){if(this._containers.has(t))return;const e=new Ct(this,bt.CONTAINER);e.layout=this._layoutFns.get(bt.CONTAINER)(),e.element=t,this._containers.set(t,e);const{components:s}=t;for(const t of s)this.addComponent(t)}removeContainer(t){const e=this._containers.get(t);if(!e)return;const{components:s}=t;for(const t of s)this.removeComponent(t);e._destroy(),this._containers.delete(t)}addComponent(t){this._getViewByElement(t).element=t}removeComponent(t){this._getViewByElement(t).element=void 0}updateComponentRole(t,e,s){}refreshElement(t){const e=t.isContainer?this._containers.get(t):this._getViewByElement(t);e&&e.refresh({force:!0})}_getViewByElement(t){let{role:e}=t;if(!e)throw Error("Component must have a role");return this.get(e)}set layouts(t){for(let[e,s]of Object.entries(t))if(this._layoutFns.set(e,s),e===bt.CONTAINER)for(const t of this._containers.values())t.layout=s();else this.get(e).layout=s()}get(t){return this._views[t]||(this._views[t]=new Ct(this,t))}get views(){return this._getViews(!0)}_getViews(){return 0>=arguments.length||void 0===arguments[0]||arguments[0]?[...this._containers.values(),...Object.values(this._views)]:[...Object.values(this._views),...this._containers.values()]}syncSize(){for(const t of Object.values(this._views))t._syncSize()}async refresh(){let{force:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this._getData();await Promise.all(this._getViews(!0).map((s=>s.refresh({force:t,data:e}))))}_getData(){const{[dt()]:t}=this._hub.states;if(!this._data||this._data.data!==t){const e=t&&t.session&&t.session.active?t.error?Et.ERRONEOUS:t.value?Et.READY:Et.LOADING:Et.INITIAL;this._data=Object.freeze(Object.assign({},t,{status:e,ongoing:e===Et.READY?!!t.ongoing:void 0}))}return this._data}_error(t){console.error(t)}destroy(){for(const t of this._getViews(!1))t._destroy();for(const t of this._unsubscribes)t();this._unsubscribes=[]}}class Rt{constructor(t){this._actor=t,o(this,t,["syncSize","refresh"])}get(t){return this._actor.get(t).interface}get views(){return this._actor.views.map((t=>t.interface))}}class At{constructor(t,e){this._hub=t,this._view=e,this._bindings=new Map,this._e2b=new WeakMap}list(){return[...this._bindings.values()]}get(t){if(!t)throw Error("Product ID or element is required.");return h(t)?this._e2b.get(t):this._bindings.get(t)}refresh(){const{element:t}=this._view;if(!t)return this.unbindAll();const e=this._purge(),s=t.querySelectorAll(`[${mt}]`),n=[];for(const t of s){const[s,...i]=this._bind(t);s&&n.push(s);for(const t of i)e.push(t)}return{bounds:n,unbounds:e}}unbindAll(){const t=this.list();return this._bindings.clear(),{bounds:[],unbounds:t}}_bind(t,e){if(!t)throw Error("Product ID or element is required.");if(void 0===e&&h(t)){if(!(e=t).hasAttribute(mt))throw Error(`No attribute "${mt} found on element ${e}"`);t=e.getAttribute(mt)}const s=this._bindings.get(t);if(s&&s.element===e)return[];const n=this._unbind(this.get(t)),i=this._unbind(this.get(e)),r=Object.freeze({productId:t,element:e});this._bindings.set(t,r),this._e2b.set(e,r);const o=[r];return n&&o.push(n),i&&o.push(i),o}_purge(){const t=[];for(const e of this._bindings.values()){const{element:s}=e;_(s)||t.push(this._unbind(e))}return t}_unbind(t){return t&&(this._bindings.delete(t.productId),this._e2b.delete(t.element)),t}_destroy(){this.unbindAll()}}const Nt=["impression","viewable","click"];const{IMPRESSION:St,VIEWABLE:$t,CLICK:Pt}=vt,{UNTRACKED:qt,TRACKING:Lt,TRIGGERED:Tt}=wt;function Ut(t,e){return!!e&&Object.assign({},t,e)}function Mt(t){return t&&t.status===Et.READY}const Dt=Object.freeze({impression:Object.freeze({}),viewable:Object.freeze({area:.5,duration:1e3}),click:Object.freeze({lenient:!1}),watch:!1});class zt{constructor(t,e){this._hub=t,this._view=e;const s=this._role=e.role;this._items=new At(t,e),this._viewables=new WeakMap,this._options=Dt,this._unsubscribes=[e.proxyElement.on("click",(t=>this._handleClick(t))),e.on("element",(()=>this.refresh())),t.on(_t(s),(()=>this.refresh()))],this.refresh()}config(t){const{active:e}=this._hub;if(e)throw Error("Cannot change configuration after unit starts.");this._options=this._normalizeOptions(t)}_normalizeOptions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{impression:e={},viewable:s={},click:n={}}=t,i=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,Nt);return r(Object.assign({},Dt,i,{impression:Ut(Dt.impression,e),viewable:Ut(Dt.viewable,s),click:Ut(Dt.click,n)}))}start(){throw Error("unit.tracker.start() is deprecated. Use unit.startTracker() instead.")}refresh(){this._syncElement();const t=this._getViewState();if(!t)return;const{session:e}=t;this._states&&e.uuid!==this._states.uuid&&this._retireStates(),this._states||(this._states=new Vt(e.uuid)),this._refreshItems()}impression(t,e){this._assertViewReady(),this._trigger(t,St,Object.assign({},e,{manual:!0}))}viewable(t,e){this._assertViewReady(),this._trigger(t,$t,Object.assign({},e,{manual:!0}))}click(t,e){this._assertViewReady(),this._trigger(t,Pt,Object.assign({},e,{manual:!0}))}_getViewState(){return this._hub.states[_t(this._role)]}_assertViewReady(){if(!this._hub.active)throw Error("Unit is not active. Call unit.start() to activate it.");if(!Mt(this._getViewState()))throw Error("Unit is not rendered yet. If you handle rendering by yourself, call unit.notifyViewUpdate() when DOM is ready.")}_isViewReady(){return this._hub.active&&Mt(this._getViewState())}_getMisoId(){const t=this._getViewState();return t&&t.meta&&t.meta.miso_id||this._element&&this._element.getAttribute("miso-id")||void 0}getState(t){return Object.freeze(Object.assign({[Pt]:this._view.element?Lt:qt},this._states.getFullState(t)))}_retireStates(){const{unbounds:t}=this._items.unbindAll();this._untrackViewables(t),this._states=void 0}_refreshItems(){if(!this._states)return;const{bounds:t,unbounds:e}=this._items.refresh();this._untrackViewables(e),this._trackImpressions(t),this._trackViewables(t)}_trackImpressions(t){if(!this._options.impression)return;const e=this._getMisoId();this._trigger(t.map((t=>t.productId)),St,{misoId:e})}_trackViewables(t){if(this._options.viewable)for(const e of t)this._trackViewableOnElement(e)}async _trackViewableOnElement(t){let{productId:e,element:s}=t;if(!e||!h(s)||this._viewables.has(s))return;const n=$t;if(this._states.get(e,n)!==qt)return;this._states.set(e,n,Lt);const{area:i,duration:r}=this._options.viewable,o=this._getMisoId(),a=new AbortController,{signal:c}=a;this._viewables.set(s,{ac:a}),await m(s,{area:i,duration:r,signal:c}),this._viewables.delete(s),this._trigger([e],n,{misoId:o})}_untrackViewableOnElement(t){let{productId:e,element:s}=t;const n=this._viewables.get(s);if(!n)return;n.ac.abort(),this._viewables.delete(s);const i=$t;this._states.get(e,i)===Lt&&this._states.set(e,i,qt)}_untrackViewables(t){for(const e of t)this._untrackViewableOnElement(e)}_syncElement(){const{element:t}=this._view;this._element!==t&&(this._retireElement(),t&&this._options.watch&&(this._mutationObserver=new MutationObserver((()=>this.refresh())),this._mutationObserver.observe(t,{childList:!0,subtree:!0})),this._element=t)}_retireElement(){this._element&&(this._mutationObserver&&(this._mutationObserver.disconnect(),this._mutationObserver=void 0),this._element=void 0)}_handleClick(t){const e=this._options&&this._options.click;if(!e||!this._isViewReady())return;const s=d(t.target,(t=>this._items.get(t)));if(!s)return;const{productId:n}=s;if(!e.lenient){if(0!==t.button)return;if(t.defaultPrevented)return;if(!d(t.target,(t=>"A"===t.tagName&&t.href||void 0)))return}const i=this._getMisoId();this._trigger([n],Pt,{misoId:i})}_trigger(t,e){let{manual:s=!1,misoId:i}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};kt(e),this._isViewReady()&&0!==(t=this._states.untriggered(n(t),e)).length&&(this._states.set(t,e,Tt),this._hub.trigger("interaction",this._buildInteraction({type:e,productIds:t,manual:s,misoId:i})))}_buildInteraction(t){let e,{type:s,productIds:n,manual:i,misoId:o}=t;if(o)try{e=function(t){const e=t.split("-"),s=""+e[2].substring(1)+e[1]+e[0];return Math.floor(parseInt(s,16)/1e7)-12219292800}(o)}catch(t){}return r({type:"viewable"===s?"viewable_impression":s,product_ids:n,miso_id:o,context:{custom_context:r({api_ts:e,trigger:i?"manual":"auto"})}})}_destroy(){this._retireElement(),this._retireStates(),this._items._destroy();for(const t of this._unsubscribes)t();this._unsubscribes=[]}}class Vt{static NEW={[St]:qt,[$t]:qt};static UNTRACKED=Object.freeze({[St]:qt,[$t]:qt,[Pt]:qt});constructor(t){this.uuid=t,this._states=new Map}getFullState(t){const e=this._states.get(t);return e?Object.assign({},e):Vt.UNTRACKED}get(t,e){const s=this._states.get(t);return s&&s[e]||qt}set(t,e,s){kt(e),function(t){if(t!==wt.UNTRACKED&&t!==wt.TRACKING&&t!==wt.TRIGGERED)throw Error("Unrecognized tracking status: "+t)}(s);for(const i of n(t))this._setOne(i,e,s)}_setOne(t,e,s){(function(t,e,s){if(t.has(e))return t.get(e);const n=s(e);return t.set(e,n),n}(this._states,t,(()=>Object.assign({},Vt.NEW))))[e]=s}untriggered(t,e){return t.filter((t=>this.get(t,e)!==Tt))}}class Bt{constructor(t){this._hub=t,this._unsubscribes=[t.on("feedback",(t=>this._trigger(t)))]}_trigger(t){const{[dt()]:e}=this._hub.states,{question_id:s}=e&&e.value||{};s&&this._hub.trigger("interaction",this._buildInteraction(s,t))}_buildInteraction(t,e){let{value:s,unselected:n}=e;return{type:"feedback",context:{custom_context:{result_type:"answer",question_id:t,value:n?"unselected":s}}}}_destroy(){for(const t of this._unsubscribes)t();this._unsubscribes=[]}}class Qt{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._client=e,this.config(s),this._unsubscribes=[t.on("interaction",(t=>this._send(t)))]}config(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(t.preprocess&&"function"!=typeof t.preprocess)throw Error("preprocess must be a function");this._options=t}_send(t){t=n(t);const{preprocess:e}=this._options;e&&(t=t.map(e)),t.length>0&&this._client.api.interactions.upload(t,{merge:!0})}destroy(){for(const t of this._unsubscribes)t();this._unsubscribes=[]}}function Wt(t){return Object.assign({},t,{_meta:{answer_stage:t.answer_stage}})}function Gt(t){return async e=>{let{group:s,name:n,payload:i,options:r}=e;if("ask"===s)if("questions"===n){const{signal:e}=r||{},o=await t.api[s][n](i,r);return e&&e.addEventListener&&e.addEventListener("abort",(()=>o.abort(e.reason))),async function*(t,e){for await(const s of t)yield e(s)}(o,Wt)}return function(t){const{miso_id:e}=t;return{_meta:{miso_id:e},[bt.RESULTS]:t.products}}(await t.api[s]._run(n,i,r))}}const Ft=["role"];class Kt{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{role:e}=t;a(this,{role:e,options:function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,Ft)}),this._unsubscribes=[],this._rendered=new WeakMap,this._element=void 0,this._notifyUpdate=void 0,this._pending=void 0}async render(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._syncElement(t);const n=this._rendered.get(t),i=y(!1);e=this._preprocess({state:e,rendered:n},{skip:i.t})||e,this._updatePending(e,s),i.value||this._handleInput({state:e,rendered:n},s)}_syncElement(t){this._element!==t&&this._rendered.delete(this._element),this._element=t}_preprocess(t){let{state:e}=t;return e}_updatePending(t,e){this._pending=[Object.freeze(t),e]}_takePending(){const t=this._pending;return this._pending=void 0,t}_handleInput(){this._requestRaf()}_requestRaf(){this._requested||(this._requested=!0,f((()=>this._doRaf())))}_doRaf(){this._requested&&(this._requested=!1,this._applyRender())}_applyRender(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this._pending)return;const e=Date.now();let[s,{notifyUpdate:n}]=this._takePending();s=Object.freeze(Object.assign({},s,{timestamp:e}));const i=this._rendered.get(this._element),r=y([]),o=y({});this._render(this._element,{state:s,rendered:i,timestamp:e},Object.assign({notifyUpdate:r.args,writeToState:o.merge},t)),this._rendered.set(this._element,Object.freeze(Object.assign({},s,o.value))),n&&n(...r.value)}_render(){throw Error("Unimplemented")}destroy(){for(const t of this._unsubscribes)t();this._unsubscribes=[],this._element=void 0,this._notifyUpdate=void 0,this._pending=void 0}}function Ht(){for(var t=arguments.length,e=Array(t),s=0;t>s;s++)e[s]=arguments[s];return e.reduce(((t,e)=>(t[e]=function(t){return()=>{throw Error(`Template '${t}' is not implemented.`)}}(e),t)),{})}const Yt=["className","templates"];class Zt extends Kt{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e,templates:s}=t;super(function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,Yt)),a(this,{className:e,templates:Object.assign({},Ht("root"),s)})}_preprocess(t){let{state:e}=t;const s=this.templates.root(this,e);return Object.assign({},e,{html:s})}_render(t,e){let{state:s}=e;t.innerHTML=s.html}}class Xt extends HTMLElement{static get tagName(){return"miso-banner"}async connectedCallback(){Xt.MisoClient.ui.layouts.create("banner").render(this)}}const Jt=["logo"];class te extends Kt{static get category(){return yt.CONTAINER}static get type(){return"container"}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{logo:e="auto"}=t,s=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,Jt);super(Object.assign({logo:e},s))}_render(t,e){let{state:s}=e;this._syncBanner(t),this._syncStatus(t,{state:s})}_syncBanner(t){const e=Xt.tagName,s=this._shallRenderBanner(t),n=t.querySelector(e);s&&!n?t.insertAdjacentHTML("beforeend",`<${e} visible-when="ready"></${e}>`):!s&&n&&n.remove()}_shallRenderBanner(t){const{logo:e}=this.options,{logo:s}=t,n=void 0!==s&&"auto"!==s?s:e;return"auto"===n?t.components.some((t=>{let{role:e}=t;return e===bt.RESULTS||e===bt.ANSWER})):!!n}_syncStatus(t,e){let{state:s}=e;if(!t)return;const{status:n,meta:{miso_id:i}={}}=s;t.setAttribute("status",n),i?t.setAttribute("miso-id",i):t.removeAttribute("miso-id")}}const ee='<svg viewBox="0 0 16 16"><path d="M8.342 3.652 4.979 5.708a1 1 0 0 0-.479.852v5.561a1 1 0 0 0 .87.992l6.029.79a1 1 0 0 0 1.042-.583l2.534-5.65a1 1 0 0 0-.74-1.394l-3.543-.623.9-3.1A2.097 2.097 0 0 0 10.297 0L8.719 3.237a1 1 0 0 1-.377.415ZM1 6.5a1.5 1.5 0 0 1 3 0v6a1.5 1.5 0 0 1-3 0Z"/></svg>',se=["className","templates"];const ne="miso-banner";const ie=Object.freeze({root:function(t){const{className:e,templates:s}=t;return`<div class="${e}"><div class="${e}__logo">${s.logo(t)}</div></div>`},logo:()=>'<svg viewBox="0 0 500 200"><path d="M131.1,39.4 C144.3,39.4 155,43.8 163.2,52.7 C171.3,61.3 175.2,72.9 175.2,87.6 L175.2,159.1 L140.4,159.1 L140.4,90.6 C140.4,78.7 134.6,71.5 123.7,71.5 C112.3,71.5 105.5,79.7 105.5,93.4 L105.5,159.1 L70.7,159.1 L70.7,90.6 C70.7,78.7 64.9,71.5 54,71.5 C42.6,71.5 35.8,79.7 35.8,93.4 L35.8,159.1 L1,159.1 L1,42.7 L35.8,42.7 L35.8,53.4 C42.1,44.1 52.6,39.4 67,39.4 C80.5,39.4 90.7,44.5 97.4,54.8 C104.6,44.5 115.8,39.4 131.1,39.4 Z M202,42.4 L238.4,42.4 L238.4,159.1 L202,159.1 Z M202,0 L238.4,0 L202,36.4 Z M302.6,76.6 C302.6,81.2 311.7,83.8 323,86.8 C339.2,90.3 360.5,98.7 360.3,124 C360.3,136.6 355.6,146.1 346.2,152.6 C336.8,158.9 325.3,162.1 311.5,162.1 C286.9,162.1 270,152.8 261.1,134.5 L291.6,117.3 C294.6,126.3 301.4,131 311.5,131 C319.9,131 324.2,128.7 324.2,123.8 C324.2,119.1 315,116.3 303.8,113.5 C287.6,109.1 266.5,101.2 266.5,77.5 C266.5,65.4 270.9,56.1 279.6,49.4 C288.5,42.6 299.5,39.4 312.4,39.4 C331.9,39.4 348.6,48.2 358.2,64.3 L328.2,80.3 C324.4,73.6 319.2,70.1 312.4,70.1 C305.9,70.1 302.6,72.2 302.6,76.6 Z M480.4,144.5 C468.4,156.3 453.7,162.1 436.3,162.1 C419,162.1 404.2,156.3 392.2,144.5 C380.3,132.6 374.2,118 374.2,100.8 C374.2,83.6 380.3,69.1 392.2,57.3 C404.2,45.4 419,39.4 436.3,39.4 C453.7,39.4 468.4,45.4 480.4,57.3 C492.4,69.1 498.5,83.6 498.5,100.8 C498.5,118 492.4,132.6 480.4,144.5 Z M417.1,120.5 C422.2,125.6 428.6,128.2 436.3,128.2 C444.1,128.2 450.4,125.6 455.5,120.5 C460.7,115.4 463.3,108.9 463.3,100.8 C463.3,92.6 460.7,86.1 455.5,81 C450.4,75.9 444.1,73.3 436.3,73.3 C428.6,73.3 422.2,75.9 417.1,81 C411.9,86.1 409.3,92.6 409.3,100.8 C409.3,108.9 411.9,115.4 417.1,120.5 Z" /></svg>'});const re=["templates"];const oe=Object.freeze({product:function(t,e,s){const[n,i]=function(t,e){let{className:s}=t,{product_id:n,url:i}=e;const r=i?`<a class="${s}__item-body" ${mt}="${n}" href="${i}" target="_blank" rel="noopener">`:`<div class="${s}__item-body">`;return[r,i?"</a>":"</div>"]}(t,s);return`${n}${function(t,e){let{className:s}=t,{cover_image:n}=e;if(!n)return"";return`<div class="${s}__item-cover-image-container"><img class="${s}__item-cover-image" src="${n}"></div>`}(t,s)}${function(t,e){let{className:s}=t,{title:n,snippet:i,description:r,sale_price:o,original_price:a}=e,c="";n&&(c+=`<div class="${s}__item-title">${n}</div>`);i?c+=`<div class="${s}__item-snippet">${i}</div>`:r&&(c+=`<div class="${s}__item-desc">${r}</div>`);const u=o||a;u&&(c+=`<hr><div class="${s}__item-price">${u}</div>`);return`<div class="${s}__item-info-container">${c}</div>`}(t,s)}${i}`},root:function(t,e){const{className:s,role:n,templates:i}=t,{status:r}=e;return`<div class="${s} ${r}" ${n?`data-role="${n}"`:""}>${r===Et.READY?i[r](t,e):""}</div>`},[Et.READY]:function(t,e){const{templates:s}=t,n=e.value;return n&&n.length>0||e.ongoing?s.list(t,e,"product",n):s.empty(t,e)},empty:()=>"",list:function(t,e,s,n){const{className:i,templates:r}=t;return`<ul class="${i}__list" data-item-type="${s}">${r.items(t,e,s,n)}</ul>`},items:function(t,e,s,n){const{templates:i}=t;let r=0;return n.map((n=>i.item(t,e,s,n,r++))).join("")},item:function(t,e,s,n,i){const{className:r,templates:o}=t;return`<li class="${r}__item">${o[s](t,e,n,{index:i})}</li>`}});class ae extends Zt{static get category(){return yt.LIST}static get defaultTemplates(){return oe}constructor(t){let{templates:e}=t,s=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,re);super(Object.assign({templates:Object.assign({},oe,e)},s))}_preprocess(t){let{state:e,rendered:s}=t;const n=this._shallRenderIncrementally(e,s),i=this._html(e,s,n);return Object.assign({},e,{incremental:n,html:i})}_html(t,e,s){if(s){const s=t.value.slice(e.value.length);return s.length>0?this.templates.items(this,t,"product",s):""}return this.templates.root(this,t)}_render(t,e,s){let{state:n}=e,{notifyUpdate:i}=s;const{incremental:r,html:o}=n;if(r)if(o){this._getListElement(t).insertAdjacentHTML("beforeend",o)}else i(!1);else t.innerHTML=o}_shallRenderIncrementally(t,e){return this.options.incremental&&e&&e.value&&e.value.length>0&&t.status===Et.READY&&e.status===Et.READY&&t.session&&e.session&&t.session.id===e.session.id}_getListElement(t){return t.querySelector(`.${this.className}__list`)}}const ce=["className"];const ue="miso-list";class le extends ae{static get category(){return super.category}static get type(){return"list"}static get defaultTemplates(){return super.defaultTemplates}static get defaultClassName(){return ue}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=ue}=t,s=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,ce);super(Object.assign({className:e},s))}}const he=["className"];const de="miso-cards";const _e=["className","templates"];const pe="miso-carousel",fe=Object.freeze({ready:function(t,e){const{templates:s}=t,n=e.value&&e.value.length>0,i=Object.getPrototypeOf(t.constructor).defaultTemplates.ready(t,e);return n?s.carousel(t,e,i):i},carousel:function(t,e,s){const{className:n,templates:i}=t;return`<div class="${n}__control-previous">${i.previous(t,e)}</div><div class="${n}__viewport">${s}</div><div class="${n}__control-next">${i.next(t,e)}</div>`},previous:ge,next:ge}),me=Object.freeze(Object.assign({},ae.defaultTemplates,fe));function ge(t){const{className:e}=t;return`<svg class="${e}__control-button" shape-rendering="geometricPrecision" stroke="currentColor" stroke-width="24" fill="#fff" viewBox="-30 -30 358 572"><path d="M285.77 441c16.24 16.17 16.32 42.46.15 58.7-16.16 16.24-42.45 16.32-58.69.16l-215-214.47c-16.24-16.16-16.32-42.45-.15-58.69L227.23 12.08c16.24-16.17 42.53-16.09 58.69.15 16.17 16.24 16.09 42.54-.15 58.7l-185.5 185.04L285.77 441z"/></svg>`}const be=["className","templates"];const ye="miso-search-box";const ve=Object.freeze({root:function(t){const{className:e,role:s,templates:n,options:i}=t,{autocomplete:r,placeholder:o,buttonText:a="Search"}=i;return`\n<div class="${e}" ${s?`data-role="${s}"`:""}>\n  <div class="${e}__input-group">\n    <input class="${e}__input" type="text" data-role="input" ${o?`placeholder="${o}"`:""}>\n    <button class="${e}__button" type="submit">${a}</button>\n  </div>\n  ${r?n.autocomplete(t):""}\n</div>\n`},autocomplete:function(t){const{className:e,templates:s}=t;return`\n<div class="${e}__autocomplete" data-role="autocomplete">\n  ${s.suggestionList(t)}\n</div>\n`},suggestionList:function(t){const{className:e}=t;return`<ol class="${e}__suggestion-list" data-role="suggestion-list"></ol>`},suggestionItem:function(t,e){let{text:s}=e;const{className:n}=t;return`<li class="${n}__suggestion-item" data-role="suggestion-item" tabindex="0">${s}</li>`}});class we extends Zt{static get category(){return yt.QUERY}static get type(){return"search-box"}static get defaultTemplates(){return ve}static get defaultClassName(){return ye}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=ye,templates:s}=t,n=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,be);super(Object.assign({className:e,templates:Object.assign({},ve,s)},n)),this._contexts=new WeakMap,this._suggestionItems=new WeakMap}initialize(t){const{autocomplete:e}=this.options;this._view=t;const{proxyElement:s,hub:n}=t;this._unsubscribes=[...this._unsubscribes,s.on("keydown",(t=>this._handleKeyDown(t))),s.on("click",(t=>this._handleClick(t)))],e&&this._unsubscribes.push(n.on("suggestions",(()=>this._handleInput())))}_preprocess(t){let{state:e}=t;e=super._preprocess({state:e});const{autocomplete:s}=this.options;if(!s)return e;return Object.assign({},e,{suggestions:this._view.hub.states.suggestions})}_render(t,e,s){0===t.childElementCount&&super._render(t,e,s),this._setupAutocomplete(t),this._renderSuggestions(t,e,s)}_setupAutocomplete(t){const{autocomplete:e}=this.options;e&&this._context(t).setupAutocomplete()}_renderSuggestions(t,e){let{state:s}=e,{writeToState:n}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{autocomplete:i}=this.options;if(!i)return;const{suggestionListElement:r,autocompleteElement:o}=this._context(t);if(!r)return void(n&&n({suggestions:{value:[]}}));const{suggestions:a={}}=s,c=a.value||[];o.classList[0===c.length?"add":"remove"]("empty"),r.innerHTML=c.map((t=>this.templates.suggestionItem(this,t))).join("");let u=0;for(const t of r.children)this._suggestionItems.set(t,c[u++])}_context(t){if(!(t=t||this._view.element))return Ee.empty();let e=this._contexts.get(t);return e||this._contexts.set(t,e=new Ee(t)),e}_handleKeyDown(t){let{key:e,target:s,isComposing:n}=t;!n&&"Enter"===e&&s.matches("input")&&(this._submit(s.value),s.blur())}_handleClick(t){let{target:e}=t;const{inputElement:s}=this._context();for(let t=e;t&&t!==this._view.element;t=t.parentElement)if(t.matches('[type="submit"]')||t.matches('[data-role="button"]'))return void(s&&(s.blur(),this._submit(s.value)));const{autocomplete:n}=this.options;if(n)for(let t=e;t&&t!==this._view.element;t=t.parentElement){const e=this._suggestionItems.get(t);if(e)return s&&(s.value=e.text),void this._submit(e.text)}}async _submit(t){t&&this._view.hub.trigger("query",{q:t})}}class Ee{static empty(){return Ee._empty||(Ee._empty=new Ee)}constructor(t){this._element=t,this._cache={}}get inputElement(){return this._get("input")}get autocompleteElement(){return this._get("autocomplete")}get suggestionListElement(){return this._get("suggestion-list")}setupAutocomplete(){if(!this._element||this._autocompleteSetup)return;this._autocompleteSetup=!0;const{inputElement:t,autocompleteElement:e}=this;t&&e&&(t.addEventListener("focus",(()=>{e.classList.add("open")})),t.addEventListener("blur",(()=>{e.classList.remove("open")})))}_get(t){return this._element?this._cache[t]||(this._cache[t]=this._element.querySelector(`[data-role="${t}"]`)):void 0}}const ke=["className","templates"];const Oe="miso-option-list";const xe=Object.freeze({root:function(t,e){const{className:s,role:n,templates:i}=t;return`\n<div class="${s}" ${n?`data-role="${n}"`:""}>\n  ${i.options(t,e)}\n</div>\n`},options:function(t,e){const{className:s,templates:n}=t,{value:i=[]}=e;return`\n<ol class="${s}__options" data-role="options">\n  ${i.map(((e,s)=>n.option(t,e,{index:s}))).join("")}\n</ol>\n`},option:function(t,e){let{text:s}=e;const{className:n}=t;return`<li class="${n}__option" data-role="option" tabindex="0">${s}</li>`}});class Ce extends Zt{static get category(){return yt.QUERY}static get type(){return"option-list"}static get defaultTemplates(){return xe}static get defaultClassName(){return Oe}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=Oe,templates:s}=t,n=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,ke);super(Object.assign({className:e,templates:Object.assign({},xe,s)},n)),this._optionValues=new WeakMap}initialize(t){this._view=t;const{proxyElement:e,hub:s}=t;this._unsubscribes=[...this._unsubscribes,e.on("click",(t=>this._handleClick(t))),s.on("suggestions",(()=>this._handleInput()))]}_preprocess(){return super._preprocess({state:this._view.hub.states.suggestions})}_render(t,e,s){super._render(t,e,s),this._bindOptionValues(t,e)}_bindOptionValues(t,e){let{state:s}=e;if(!t)return;const n=this._getOptionsElement(t);if(!n)return;const i=s.value||[];n.classList[0===i.length?"add":"remove"]("empty");let r=0;for(const t of n.children)this._optionValues.set(t,i[r++])}_getOptionsElement(t){return t.querySelector('[data-role="options"]')}_handleClick(t){for(let e=t.target;e&&e!==this._view.element;e=e.parentElement){const t=this._optionValues.get(e);if(t)return void this._submit(t.text)}}async _submit(t){t&&this._view.hub.trigger("query",{q:t})}}const je=["className","templates","field","defaultValue"];const Ie=Object.freeze(Object.assign({},Ht("options"),{root:function(t){const{className:e,role:s,templates:n}=t;return`\n<div class="${e}" ${s?`data-role="${s}"`:""}>\n  ${n.options(t)}\n</div>\n`},option:function(t,e){const{className:s,templates:n}=t;return`\n<div role="button" class="${s}__option" data-value="${e.value}">\n  ${n.content(t,e)}\n</div>\n`}}));class Re extends Zt{static get category(){return yt.RADIO}static get defaultTemplates(){return Ie}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e,templates:s,field:n,defaultValue:i}=t,r=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,je);super(Object.assign({className:e,templates:Object.assign({},Ie,s)},r)),this._field=n,this._defaultValue=i}initialize(t){const{proxyElement:e}=this._view=t;this._unsubscribes=[...this._unsubscribes,t.hub.on(this._field,(()=>this._refresh())),e.on("click",(t=>this._handleClick(t)))],this._defaultValue?this._select(this._defaultValue):this._clear()}_preprocess(t,e){return t.rendered&&e.skip(),super._preprocess(t,e)}_handleClick(t){let{target:e}=t;const s=d(e,(t=>t.hasAttribute("data-value")?t:void 0));if(!s)return;let{unselected:n,value:i}=this._view.hub.states[this._field];n=n||void 0===i;const r=s.getAttribute("data-value");n||void 0===i||i!==r?this._select(r):this._clear()}_refresh(){this._state=this._view.hub.states[this._field],f((()=>this._syncValueAttribute()))}_syncValueAttribute(){if(!this._state)return;const{element:t}=this._view,e=t&&t.children[0];if(!e)return;let{unselected:s,value:n}=this._state;s?e.removeAttribute("data-selected"):e.setAttribute("data-selected",n),this._state=void 0}_select(t){this._submit({value:t})}_clear(){this._submit({unselected:!0})}async _submit(t){this._view.hub.update(this._field,t)}}const Ae=["className","templates"];const Ne="miso-feedback",Se=[{text:"Helpful",value:"helpful",icon:ee},{text:"Not helpful",value:"unhelpful",icon:ee}];const $e=Object.freeze({options:function(t){const{templates:e}=t;return Se.map((s=>e.option(t,s))).join("")},content:function(t,e){let{text:s,icon:n}=e;const{className:i,options:r={}}=t;return`\n${!1!==r.icon?`<i class="${i}__icon">${n}</i>`:""}\n${!1!==r.text?`<span class="${i}__text">${s}</span>`:""}\n`}});class Pe extends Re{static get category(){return super.category}static get type(){return"feedback"}static get defaultTemplates(){return $e}static get defaultClassName(){return Ne}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=Ne,templates:s}=t,n=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,Ae);if(super(Object.assign({className:e,templates:Object.assign({},$e,s),field:"feedback"},n)),!1===n.text&&!1===n.icon)throw Error("At least one of options.text or options.icon must be enabled")}}const qe=["className","templates","tag"];const Le="miso-text";const Te=Object.freeze({root:function(t,e){const{className:s,role:n,options:{tag:i}}=t;return`<${i} class="${s}" ${n?`data-role="${n}"`:""}>${e.value||""}</${i}>`}});class Ue extends Zt{static get category(){return yt.TEXT}static get type(){return"text"}static get defaultTemplates(){return Te}static get defaultClassName(){return Le}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=Le,templates:s,tag:n="p"}=t,i=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,qe);super(Object.assign({className:e,templates:Object.assign({},Te,s),tag:n},i))}}class Me extends Kt{constructor(t){super(t)}_takePending(){return this._pending}_applyRender(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=y(!1);super._applyRender(Object.assign({},t,{loop:e.t})),e.value&&this._requestRaf()}}class De{constructor(){let{cps:t=75}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._options={cps:t}}get(t,e){const s=this._cps(e);return t.cursor+Math.floor((e.timestamp-t.timestamp)*s/1e3)}_cps(t){let{doneAt:e,timestamp:s}=t,n=this._options.cps*(Math.random()+.5);return void 0!==e&&(n*=(s-e)/250),n}}class ze{clear(t){return t.innerText="",{cursor:0,done:!1}}update(t,e,s){let{value:n,cursor:i}=e,{value:r,cursor:o,done:a}=s;const c=r.length;o=Math.min(o,c);const u=!!a&&o===c,l=n.substring(0,i),h=!r.startsWith(l);return u||h?t.innerText=r:t.insertAdjacentText("beforeend",r.substring(i,o)),u&&t.classList.add("done"),{cursor:o,done:u}}}function Ve(t,e,s){let{status:n}=s;if(!e)return;0===e.children.length&&(e.innerHTML=function(t){let{className:e,role:s,options:{tag:n,format:i,builtInStyles:r=!0}}=t;"auto"===n&&(n="markdown"===i?"div":"p");const o=s?`data-role="${s}"`:"",a=[e,Be(e)];r&&"markdown"===i&&a.push("miso-markdown");return`<${n} class="${a.join(" ")}" ${o} data-format="${i}"></${n}>`}(t));const i=e.children[0];return i.setAttribute("data-status",n||Et.INITIAL),i}function Be(t){return t+"__cursor"}const Qe=["className","cps","tag","format"];const We="miso-typewriter";class Ge extends Me{static get category(){return yt.TEXT}static get type(){return"typewriter"}static get defaultClassName(){return We}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=We,cps:s,tag:n="auto",format:i="markdown"}=t,r=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,Qe);super(Object.assign({cps:s,tag:n,format:i},r)),a(this,{className:e}),this._prevState=void 0,this._progress=new De({cps:s}),this._readiness=new w,"markdown"===i&&Ge.MisoClient.plugins.install("std:ui-markdown")}initialize(t){this._view=t,this._setup()}async _setup(){try{if("plaintext"===this.options.format)await this._setupForPlaintext();else await this._setupForMarkdown();this._readiness.resolve()}catch(t){this._readiness.reject(t)}}async _setupForMarkdown(){const t=await this._view._views._extensions.require("markdown"),e=Be(this.className);this._renderer=t.createRenderer({onRefChange:(t,s)=>{t&&t.classList.remove(e),s&&s.classList.add(e)},onDone:t=>{t.classList.add("done")}})}async _setupForPlaintext(){this._renderer=new ze}async _ready(){return this._readiness.promise}async render(){await this._ready(),await super.render(...arguments)}_preprocess(t){let{state:e}=t;const s=this._prevState,{value:n="",meta:i,session:o,status:a,ongoing:c}=e,u=i&&i.answer_stage||"result",l=(d=e,(h=s)&&d&&h.session&&d.session&&h.session.uuid===d.session.uuid);var h,d;const _=s?l&&u===s.stage?s.streak:s.streak+1:0,p=l&&s&&s.doneAt||(a!==Et.READY||c?void 0:Date.now());return this._prevState=Object.freeze(r({session:o,status:a,value:n,stage:u,streak:_,doneAt:p,done:void 0!==p}))}_render(t,e,s){let{state:n,rendered:i}=e,{notifyUpdate:r,writeToState:o,loop:a}=s;const c=Ve(this,t,n);let u;if(i&&n.streak===i.streak){const t=this._progress.get(i,n);u=this._renderer.update(c,i,Object.assign({},n,{cursor:t}))}else u=this._renderer.clear(c,i);o(u);const l=n.status===Et.READY&&!u.done;r({ongoing:l},{silent:l&&(!i||i.status===Et.READY)}),l&&a()}}var Fe=Object.freeze({__proto__:null,TemplateBasedLayout:Zt,ContainerLayout:te,BannerLayout:class extends Zt{static get category(){return yt.BANNER}static get type(){return"banner"}static get defaultTemplates(){return ie}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=ne,templates:s}=t,n=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,se);super(Object.assign({className:e,templates:Object.assign({},ie,s)},n))}},CollectionLayout:ae,ListLayout:le,CardsLayout:class extends ae{static get category(){return super.category}static get type(){return"cards"}static get defaultTemplates(){return super.defaultTemplates}static get defaultClassName(){return de}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=de}=t,s=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,he);super(Object.assign({className:e},s))}},CarouselLayout:class extends ae{static get category(){return super.category}static get type(){return"carousel"}static get defaultTemplates(){return me}static get defaultClassName(){return pe}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=pe,templates:s}=t,n=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,_e);super(Object.assign({className:e,templates:Object.assign({},fe,s)},n)),window.addEventListener("resize",this.syncSize=this.syncSize.bind(this)),this._page=0,this._unsubscribes=[]}initialize(t){const{proxyElement:e}=this._view=t;this._unsubscribes.push(e.on("click",this._onClick.bind(this)))}_render(t,e,s){super._render(t,e,s);const{state:n}=e;this._itemCount=n.value?n.value.length:void 0,this.syncSize()}get page(){return this._page}get pageSize(){return this._pageSize}next(){this._setPage(this._page+1)}previous(){this._setPage(this._page-1)}syncSize(){if(void 0===this._itemCount)return;const t=this._findGridElement();if(!t)return;const e=void 0===this._pageSize?0:this._page*this._pageSize,s=this._pageSize=window.getComputedStyle(t).getPropertyValue("grid-template-columns").split(" ").length;this._pageCount=Math.ceil(this._itemCount/this._pageSize),this._setPage(Math.floor(e/s))}_setPage(t){if(0>t?t=this._pageCount-1:this._pageCount>t||(t=0),t===this._page)return;this._page=t;const e=this._findGridElement();if(e){e.style.setProperty("grid-template-rows",(0===t?"":`repeat(${t}, 0)`)+" 1fr repeat(10, 0)")}}_findGridElement(){const{element:t}=this._view;return t&&t.querySelector(`.${this.className}__list`)}_onClick(t){for(let e=t.target;e;e=e.parentElement){if(e.classList.contains(this.className+"__control-previous"))return void this.previous();if(e.classList.contains(this.className+"__control-next"))return void this.next()}}destroy(){window.removeEventListener("resize",this.syncSize),this._view=void 0}},SearchBoxLayout:we,OptionListLayout:Ce,FeedbackLayout:Pe,TextLayout:Ue,TypewriterLayout:Ge});function Ke(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object.freeze(Object.assign({},t,e,{payload:Object.freeze(Object.assign({},t.payload,e.payload))}))}function He(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return!1!==e&&Object.freeze(Object.assign({},t,e,{preprocess:(s=t.preprocess,n=e.preprocess,s?n?function(){return n(s(...arguments))}:s:n)}));var s,n}function Ye(t){let[e,s]=n(t);return"object"==typeof e&&(s=e,e=void 0),[e,s]}const Ze=t=>t;class Xe extends N{constructor(t,e,s){var n;let{name:i,roles:r,layouts:o={},defaultApiParams:a,interactionsOptions:c}=s;super(i||"workflow",t),n=this,this._plugin=t,this._client=e,this._name=i,this._roles=r;const u=t._getExtensions(e);this._defaultLayouts=Object.assign({[bt.CONTAINER]:te.type},o),this._apiParams=this._defaultApiParams=a,this._defaultInteractionsOptions=c=He({preprocess:t=>this._preprocessInteraction(t)},c);const l=this._hub=function(t,e){const{update:s,trigger:n}=t;return t.update=(n,i,r)=>(r&&r.silent||e("update",n,i,r),s.call(t,n,i,r)),t.trigger=function(){for(var s=arguments.length,i=Array(s),r=0;s>r;r++)i[r]=arguments[r];return e("trigger",...i),n.apply(t,i)},t}(new ht,(function(){return n._log(...arguments)}));this._sessions=new pt(l),this._data=new ft(l),this._views=new It(l,u,{roles:r,layouts:this._generateLayoutFactoryFunctions(this._defaultLayouts)}),this._interactions=new Qt(l,e,c),this._unsubscribes=[],this._data.source=Gt(this._client),this._customPostProcessData=Ze}get uuid(){return this.session&&this.session.uuid}get session(){return this._hub.states.session}get active(){const{session:t}=this;return!!t&&t.active}get states(){return this._hub.states}reset(){return this._sessions.new(),this}start(){return this._sessions.start(),this}restart(){return this.reset(),this.start(),this}updateData(t){if(!t)throw Error("Data is required.");const{session:e}=t;if(!e)throw Error("Session is required to update data.");if(!this.session)throw Error("No session is created yet. Call workflow.restart() to start a new session.");if(e.uuid===this.session.uuid)return this._sessions.start(),t=this._customPostProcessData(this._postProcessData(t)),this._hub.update(dt(),t),this}_postProcessData(t){return t}useDataProcessor(t){if(t&&"function"!=typeof t)throw Error("Data processor must be a function or undefined.");return this._data.postProcess=this._customPostProcessData=t||Ze,this}notifyViewUpdate(t,e){return this._assertActive(),e=Object.assign({status:Et.READY,session:this.session},e),this._hub.update(_t(t),e),this}useApi(t,e){return!1===t?this._data.source=!1:this._apiParams=Ke(this._defaultApiParams,{name:t,payload:e}),this}useLayouts(t){return this._views.layouts=this._generateLayoutFactoryFunctions(t),this}_generateLayoutFactoryFunctions(t){const e={};for(const[s,n]of Object.entries(t)){if(!1===n){e[s]=()=>!1;continue}let[t,i]=Ye(this._defaultLayouts[s]),[r,o]=Ye(n);if(r=r||t,o=Object.assign({},i,o),!r)throw Error("Layout name is required for role "+s);e[s]=t=>this._plugin.layouts.create(r,Object.assign({},o,t,{role:s}))}return e}useInteractions(t){return this._interactions.config(He(this._defaultInteractionsOptions,t)),this}_preprocessInteraction(t){return t}destroy(){this._events.emit("destroy"),this._destroy()}_destroy(){for(const t of this._unsubscribes||[])t();this._unsubscribes=[],this._views.destroy(),this._data.destroy()}_log(t,e,s){this._events.emit(e,Object.assign({_action:t},s))}_assertActive(){if(!this.active)throw Error("Unit is not active yet. Call unit.start() to activate it.")}}const Je=["q"],ts=["value"];function es(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}const ss=Object.freeze({group:"ask",name:"questions",payload:{source_fl:["cover_image","url"],related_resource_fl:["cover_image","url"]}}),ns=Object.freeze({[bt.QUERY]:[we.type,{buttonText:"Ask"}],[bt.QUESTION]:[Ue.type,{tag:"h2"}],[bt.ANSWER]:Ge.type,[bt.FEEDBACK]:Pe.type,[bt.SOURCES]:[le.type,{incremental:!0}],[bt.RELATED_RESOURCES]:[le.type,{incremental:!0}],[bt.QUERY_SUGGESTIONS]:Ce.type});function is(t){return t?Object.assign({},ns,{[bt.QUERY]:[we.type,{buttonText:"Ask"}]}):ns}class rs extends Xe{constructor(t,e){super(t._plugin,t._client,{name:"ask",roles:Object.keys(ns),layouts:is(e),defaultApiParams:ss}),a(this,{parentQuestionId:e}),this._context=t,this._setSuggestedQuestions(),this._feedback=new Bt(this._hub),this._unsubscribes=[...this._unsubscribes,this._hub.on("query",(t=>this.query(t))),this._hub.on(dt(),(t=>this._onDataUpdate(t))),this._hub.on(_t(bt.ANSWER),(t=>this._onAnswerViewUpdate(t)))],e&&t._byPqid.set(e,this),t._events.emit("create",this)}get questionId(){return this._questionId}get previous(){const{parentQuestionId:t}=this;return t?this._context.getByQuestionId(t):void 0}get next(){const{questionId:t}=this;return t?this._context.getByParentQuestionId(t):void 0}getOrCreateNext(){const{questionId:t}=this;return t?this._context.getByParentQuestionId(t,{autoCreate:!0}):void 0}query(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{q:e}=t,s=es(t,Je);s=Object.assign({},s,{question:e}),this.parentQuestionId&&(s.parent_question_id=this.parentQuestionId),this._questionId&&(this._context._byQid.delete(this._questionId),this._questionId=void 0),this.restart();const{session:n}=this;return this._hub.update("input",Ke(this._apiParams,{payload:s,session:n})),this}restart(){const{session:t,status:e,ongoing:s}=this._hub.states[_t(bt.ANSWER)]||{};if(t&&e!==Et.INITIAL&&(e!==Et.READY||s)){const n=Object.freeze({session:t,status:e,ongoing:s});this._events.emit("interrupt",n),this._events.emit("finally",n)}super.restart()}_postProcessData(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{value:e}=t,s=es(t,ts);e=Wt(e);return Object.assign({value:e,ongoing:e&&!e.finished},s)}_onDataUpdate(t){if(this._questionId)return;const e=t&&t.value&&t.value.question_id;e&&(this._questionId=e,this._context._byQid.set(e,this))}_onAnswerViewUpdate(t){let{session:e,status:s,ongoing:n}=t;if(s===Et.INITIAL)return;const i=s===Et.READY&&!n,r=s===Et.ERRONEOUS,o=i?"done":r?"error":s,a=Object.freeze({session:e,status:s,ongoing:n});this._events.emit(o,a),(i||r)&&this._events.emit("finally",a)}_setSuggestedQuestions(){const{previous:t}=this;if(!t)return;const e=(t.states[dt()].value.followup_questions||[]).map((t=>({text:t})));this._hub.update("suggestions",{value:e})}_destroy(){const{parentQuestionId:t,questionId:e}=this;t&&this._context._byPqid.delete(t),e&&this._context._byQid.delete(e),this._feedback._destroy(),super._destroy()}}class os extends N{constructor(t,e){super("asks",t),this._plugin=t,this._client=e,this._byQid=new Map,this._byPqid=new Map,this._root=new rs(this)}get root(){return this._root}get workflows(){return[this._root,...this._byPqid.values()]}getByQuestionId(t){if("string"!=typeof t)throw Error("Required ID to be a string: "+t);return this._byQid.get(t)}getByParentQuestionId(t){let{autoCreate:e=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(void 0===t)return this._root;if("string"!=typeof t)throw Error("Required ID to be a string: "+t);let s=this._byPqid.get(t);return!s&&e&&(s=new rs(this,t)),s}}const as=Object.freeze({group:"search",name:"search",payload:{fl:["*"]}}),cs=Object.freeze({[bt.QUERY]:we.type,[bt.RESULTS]:le.type});class us extends Xe{constructor(t,e){super(t,e,{name:"search",roles:Object.keys(cs),layouts:cs,defaultApiParams:as}),this._unsubscribes.push(this._hub.on("query",(t=>this.query(t))))}query(t){this.restart();const{session:e}=this;return this._hub.update("input",Ke(this._apiParams,{payload:t,session:e})),this}notifyViewUpdate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bt.RESULTS;for(var e=arguments.length,s=Array(e>1?e-1:0),n=1;e>n;n++)s[n-1]=arguments[n];return super.notifyViewUpdate(t,...s),this}}const ls=["custom_context"],hs=["context"];function ds(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}const _s=Object.freeze({group:"recommendation",name:"user_to_products",payload:{fl:["*"]}}),ps=Object.freeze({[bt.RESULTS]:le.type});class fs extends Xe{constructor(t,e){super(t._plugin,t._client,{name:"recommendation",roles:Object.keys(ps),layouts:ps,defaultApiParams:_s}),this._tracker=new zt(this._hub,this._views.get(bt.RESULTS)),a(this,{id:e}),this._context=t,t._members.set(e,this)}get tracker(){return this._tracker}start(){this._sessions.start();const{session:t}=this;return this._hub.update("input",Object.assign({},this._apiParams,{session:t})),this}startTracker(){return this.useApi(!1),this.useLayouts({[bt.RESULTS]:!1}),this._sessions.start(),this.notifyViewUpdate(bt.RESULTS),this}notifyViewUpdate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bt.RESULTS;for(var e=arguments.length,s=Array(e>1?e-1:0),n=1;e>n;n++)s[n-1]=arguments[n];return super.notifyViewUpdate(t,...s),this}useTracker(t){return this._tracker.config(t),this}_preprocessInteraction(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{context:{custom_context:e}={}}=t,s=ds(t.context,ls),n=ds(t,hs);const{uuid:i,id:r}=this;return Object.assign({},n,{context:Object.assign({},s,{custom_context:Object.assign({unit_id:r,unit_instance_uuid:i},e)})})}_destroy(){this._context._members.delete(this.id),this._tracker._destroy(),super._destroy()}}class ms{constructor(t,e){this._plugin=t,this._client=e,this._members=new Map}workflows(){return[...this._members.values()]}create(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:gt;if(this._members.has(t))throw Error("Unit already exists: "+t);return new fs(this,t)}has(){return this._members.has(arguments.length>0&&void 0!==arguments[0]?arguments[0]:gt)}get(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:gt;if("string"!=typeof t)throw Error("Required unit ID to be a string: "+t);return this._members.get(t)||new fs(this,t)}}class gs extends S{constructor(t){super("layouts",t,{libName:"layout",keyName:t=>t.type}),this._plugin=t}get(t){return this._libraries[t]}create(t,e){if(!1!==t)switch(typeof t){case"function":return{render:t};case"string":const s=this.get(t);if(!s)throw Error(`Layout of name '${t}' not found.`);return new s(e);default:throw Error("Expect a string, a render function, or boolean value false: "+t)}}}let bs,ys,vs;async function ws(t){const e=await async function(t){return t.MisoClient||window.MisoClient||bs||(bs=async function(){return new Promise((t=>{(window.misocmd||(window.misocmd=[])).push((()=>t(window.MisoClient)))}))}())}(t);var s;return ys=ys||e.any(),vs=vs||await ys,vs.ui||await(s=0,new Promise((t=>setTimeout(t,s)))),vs}const Es="logo",ks="auto",Os=Object.freeze([Es]);function xs(t){if(!t)return ks;switch(t){case"true":return!0;case"false":return!1;default:throw Error(`Invalid logo attribute value: ${t}.`)}}class Cs extends HTMLElement{static get observedAttributes(){return Os}constructor(){super(),this._workflow=void 0,this._components=new Set}get isContainer(){return!0}get workflow(){return this._workflow}set workflow(t){this._setWorkflow(t)}get logo(){return xs(this.getAttribute(Es))}set logo(t){if(this.logo===t)return;const e=function(t){switch(t){case ks:return;case!0:return"true";case!1:return"false";default:throw Error(`Invalid logo property value: ${t}.`)}}(t);e?this.setAttribute(Es,e):this.removeAttribute(Es)}async connectedCallback(){const t=this._client=await ws(Cs);document.body.contains(this)&&this._setWorkflow(this._getWorkflow(t))}disconnectedCallback(){this._setWorkflow(void 0)}_getWorkflow(t){throw Error("Unimplemented")}_setWorkflow(t){this._workflow!==t&&(this._workflow&&this._workflow._views.removeContainer(this),t&&t._views.addContainer(this),this._workflow=t)}attributeChangedCallback(t,e,s){if(t===Es)this._handleLogoUpdate(e,s)}_handleLogoUpdate(t,e){xs(t)!==xs(e)&&this._workflow&&this._workflow._views.refreshElement(this)}get components(){return[...this._components]}_addComponent(t){this._components.has(t)||(this._components.add(t),this._workflow&&this._workflow._views.addComponent(t))}_removeComponent(t){this._components.has(t)&&(this._workflow&&this._workflow._views.removeComponent(t),this._components.delete(t))}_updateComponentRole(t,e,s){this._workflow&&this._workflow._views.updateComponentRole(t,e,s)}}const js="parent-question-id",Is=Object.freeze([...Cs.observedAttributes,js]);const Rs="unit-id",As=Object.freeze([...Cs.observedAttributes,Rs]);var Ns=Object.freeze({__proto__:null,MisoAskElement:class extends Cs{static get tagName(){return"miso-ask"}static get observedAttributes(){return Is}_getWorkflow(t){return this._getWorkflowByParentQuestionId(t,this.parentQuestionId)}_getWorkflowByParentQuestionId(t,e){return t.ui.asks.getByParentQuestionId(e,{autoCreate:!0})}get parentQuestionId(){return this.getAttribute(js)||void 0}set parentQuestionId(t){(t=void 0!==t?""+t:void 0)!==this.parentQuestionId&&(t?this.setAttribute(js,t):this.removeAttribute(js))}set workflow(t){this._setWorkflow(t),this.parentQuestionId=t&&t.parentQuestionId}attributeChangedCallback(t,e,s){if(t===js)this._handleParentQuestionIdUpdate(e,s);else super.attributeChangedCallback(t,e,s)}_handleParentQuestionIdUpdate(t,e){(t=t||void 0)!==(e=e||void 0)&&this._client&&this._setWorkflow(this._getWorkflowByParentQuestionId(this._client,e))}},MisoSearchElement:class extends Cs{static get observedAttributes(){return Cs.observedAttributes}static get tagName(){return"miso-search"}_getWorkflow(t){return t.ui.search}},MisoRecommendationElement:class extends Cs{static get tagName(){return"miso-recommendation"}static get observedAttributes(){return As}_getWorkflow(t){return this._getWorkflowByUnitId(t,this.unitId)}_getWorkflowByUnitId(t,e){return t.ui.recommendations.get(e)}get unitId(){return this.getAttribute(Rs)||void 0}set unitId(t){(t=t&&""+t)?this.setAttribute(Rs,t):this.removeAttribute(Rs)}attributeChangedCallback(t,e,s){if(t===Rs)this._handleUnitIdUpdate(e,s);else super.attributeChangedCallback(t,e,s)}_handleUnitIdUpdate(t,e){t!==e&&this._client&&this._setWorkflow(this._getWorkflowByUnitId(this._client,e))}}});const Ss="role",$s=Object.freeze([Ss]);class Ps extends HTMLElement{static get tagName(){return"miso-component"}static get observedAttributes(){return $s}constructor(){let{role:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),t&&Object.defineProperty(this,"_role",{value:t,writable:!1})}get role(){return this._role}connectedCallback(){const t=function(t){for(let e=t;e;e=e.parentNode)if(e.isContainer)return e;throw Error(t.tagName+" needs to be placed under a workflow container element.")}(this);this._container&&this._container!==t&&this._container._removeComponent(this),this._syncRole(),t._addComponent(this),this._container=t,this._containerResolution&&this._containerResolution.resolve(t)}_syncRole(){const t=this.getAttribute(Ss);if(t)this._role?console.warn(`Element <${this.tagName}>' already has a predefined role '${this._role}', so attribute '${Ss}="${t}"' is ignored.`):this._role=t;else if(!this._role)throw Error(`An attribute '${Ss}' is required for element <${this.tagName}>`)}disconnectedCallback(){this._container&&(this._container._removeComponent(this),this._container=void 0,this._containerResolution=void 0)}attributeChangedCallback(t,e,s){e!==s&&t===Ss&&this._container&&this._container._updateComponentRole(this,e,s)}}var qs=Object.freeze({__proto__:null,containers:Ns,roles:Object.freeze({__proto__:null,MisoComponentElement:Ps,MisoQueryElement:class extends Ps{constructor(){super({role:bt.QUERY})}static get tagName(){return"miso-query"}},MisoQuerySuggestionsElement:class extends Ps{constructor(){super({role:bt.QUERY_SUGGESTIONS})}static get tagName(){return"miso-query-suggestions"}},MisoFeedbackElement:class extends Ps{constructor(){super({role:bt.FEEDBACK})}static get tagName(){return"miso-feedback"}},MisoResultsElement:class extends Ps{constructor(){super({role:bt.RESULTS})}static get tagName(){return"miso-results"}},MisoQuestionElement:class extends Ps{constructor(){super({role:bt.QUESTION})}static get tagName(){return"miso-question"}},MisoAnswerElement:class extends Ps{constructor(){super({role:bt.ANSWER})}static get tagName(){return"miso-answer"}},MisoSourcesElement:class extends Ps{constructor(){super({role:bt.SOURCES})}static get tagName(){return"miso-sources"}},MisoRelatedResourcesElement:class extends Ps{constructor(){super({role:bt.RELATED_RESOURCES})}static get tagName(){return"miso-related-resources"}}}),MisoBannerElement:Xt});const Ls=["containers","roles"];class Ts{constructor(t,e){this._plugin=t,this._client=e,this._contexts={}}async require(t){if(this._contexts[t])return this._contexts[t];const e=await this._plugin.requireExtension(t);return this._contexts[t]=e.getContext(this._client)}}class Us{constructor(t,e){this._plugin=t,this._client=e,a(this,{sources:{api:Gt(e)}})}get recommendations(){return this._recommendations||(this._recommendations=this._plugin._getRecommendations(this._client))}get recommendation(){return this.recommendations.get()}get search(){return this._search||(this._search=new us(this._plugin,this._client))}get asks(){return this._asks||(this._asks=this._plugin._getAsks(this._client))}get ask(){return this.asks.root}}function Ms(t){const e=new Date;return new Date(e.getFullYear()-t,e.getMonth(),e.getDate()).toISOString().substring(0,10)}let Ds;async function zs(){return Ds||(Ds=async function(){return async function(t,{interval:e=300,timeout:s}={}){const n=t();return null!=n?n:new Promise(((n,i)=>{let r,o;function a(){r&&clearInterval(r),o&&clearTimeout(o)}r=setInterval((()=>{const e=t();null!=e&&(a(),n(e))}),e),s&&s>0&&(o=setTimeout((()=>{a(),i(Error("Timeout: "+s))}),s))}))}((()=>window.ga&&window.ga.getAll&&window.ga.getAll()[0]))}())}async function Vs({MisoClient:t,config:e}){const s={readConfigFromScriptUrl:!0};"staging"===e.api_host&&(s.apiHost="https://ask-api.askmiso-staging.com/v1");const n=window.misoSA=new t(s);return n.context.anonymous_id=await async function(){return(await zs()).get("clientId")}(),n}nt.plugins.register(class extends N{static get id(){return"std:ui"}constructor(){super("ui"),this.layouts=new gs(this),this._recommendations=new WeakMap,this._asks=new WeakMap,this._extensions=new WeakMap}install(t,e){e.addSubtree(this),t.on("create",this._injectClient.bind(this));const s={};o(s,this,["layouts"]),a(this,{MisoClient:t}),a(t,{ui:s}),Ge.MisoClient=t;for(const t of Object.values(Fe))t.type&&this.layouts.register(t);Cs.MisoClient=Xt.MisoClient=t;const{containers:n,roles:i}=qs,r=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(qs,Ls);for(const t of[...Object.values(n),...Object.values(i),...Object.values(r)])p(t)}async requireExtension(t){if("markdown"===t)return await this.MisoClient.plugins.install("std:ui-markdown");throw Error("Unknown extension: "+t)}_injectClient(t){a(t,{ui:new Us(this,t)})}_getExtensions(t){if(this._extensions.has(t))return this._extensions.get(t);const e=new Ts(this,t);return this._extensions.set(t,e),e}_getRecommendations(t){let e=this._recommendations.get(t);return e||this._recommendations.set(t,e=new ms(this,t)),e}_getAsks(t){let e=this._asks.get(t);return e||this._asks.set(t,e=new os(this,t)),e}});const Bs=new Map,Qs=new Map;async function Ws(t){return Fs(Bs,t,(async t=>{const e=await async function(t){return await async function(t,e,s={}){if(0===e.length)return[];let n=`/wp-json/idg/v2/${t}?include=${e.join(",")}&per_page=100&_embed=1`;for(const[t,e]of Object.entries(s))n+=`&${encodeURIComponent(t)}=${encodeURIComponent(e)}`;const i=await window.fetch(n);return await i.json()}("products-view",t,{product_block:"price-comparison",article_id:"111111"})}([t]),s=e&&e[t];return s&&s.html&&s.html.trim()||""}))}async function Gs(t){return Fs(Qs,t,(async t=>(await async function(t){const e=await async function(t,e,{fields:s}={}){if(0===e.length)return[];let n=`https://b2c-contenthub.com/wp-json/wp/v2/${t}?include=${e.join(",")}&per_page=100`;s&&(n+="&_fields="+s.join(","));const i=await window.fetch(n);return await i.json()}("product",t,{fields:["id","title"]}),s={};for(const{id:t,title:n}of e)s[t]={id:t,title:n&&n.rendered};return s}([t]))[t]))}async function Fs(t,e,s){if(t.has(e))return t.get(e);const n=await s(e);return t.set(e,n),n}class Ks{constructor(t,e){this._workflow=t,this._config=e,this._element=void 0,this._session=void 0,this._products=[],this._html=void 0,this._syncIndex=0}async updateData({session:t,value:e}={}){if(!t)return;if(this._products.length>0&&this._session&&this._session.uuid===t.uuid)return;const s=this._getProducts(e);var n,i;(i=s,0===(n=this._products).length&&0===i.length||(n[0]&&n[0].product_id)===(i[0]&&i[0].product_id))||(this._session=t,this._products=s,this._syncView())}get element(){if(!this._element){const{parentQuestionId:t}=this._workflow,e=`.miso-smart-answers ${t?`miso-ask[parent-question-id="${CSS.escape(t)}"]`:"miso-ask:not([parent-question-id])"} miso-affiliation`;if(this._element=document.querySelector(e),!this._element)throw Error("Element not found: "+e)}return this._element}_getProducts(t){const{test_product:e}=this._config;if(e)return[{product_id:"product_"+e}];const{affiliation_products:s=[]}=t||{};return s||[]}async _syncView(){const t=this._syncIndex++;this._html=await async function(t){if(0===t.length)return"";const e=t[0],{product_id:s}=e,n=(o=s,o.startsWith("product_")?o.slice(8):o),[i,r]=await Promise.all([Ws(n),Hs(n,e.title)]);var o;return i?function({title:t,block:e}){return`\n<div class="affiliation">\n  <h4 class="title">Best Prices Today: ${t}</h4>\n  ${e}\n</div>\n`}({product_id:s,id:n,title:r,block:i}):""}(this._products),this._syncIndex===t+1&&this._requestRender(t)}async _requestRender(t){this.element.innerHTML=this._html}}async function Hs(t,e){if(e)return e;return(await Gs(t)).title}let Ys,Zs,Xs;function Js(t,e){t.useApi("questions",{yearly_decay:.93,fq:`created_at:{${Ms(2)} TO *] AND type:story AND -custom_attributes.content_type:(DealPost BrandPost SponsoredContent) AND (custom_attributes.languages:English OR NOT _exists_:custom_attributes.languages)`}),t._affiliation=new Ks(t,e),t.on("data",(e=>t._affiliation.updateData(e))),t.useDataProcessor(tn),t.on("done",(()=>{Zs.insertAdjacentHTML("beforeend",function({parentQuestionId:t}){return`\n<div class="session">\n  <miso-ask class="query-suggestions-container" visible-when="initial" parent-question-id="${t}">\n    <div class="phrase query-suggestions">Related questions you can explore</div>\n    <miso-query-suggestions></miso-query-suggestions>\n  </miso-ask>\n  <miso-ask class="query-container" visible-when="initial loading" parent-question-id="${t}">\n    <miso-query>\n      <input class="input" data-role="input" placeholder="Ask a follow-up question">\n      <button class="button" data-role="button">\n        <span>Ask</span>\n      </button>\n    </miso-query>\n  </miso-ask>\n  <miso-ask visible-when="ready" logo="false" parent-question-id="${t}">\n    <hr>\n    <miso-question></miso-question>\n    <miso-answer></miso-answer>\n    <miso-affiliation></miso-affiliation>\n    <miso-feedback></miso-feedback>\n    <div class="phrase sources">My reply is based on the following:</div>\n    <miso-sources></miso-sources>\n  </miso-ask>\n</div>\n`}({parentQuestionId:t.questionId}))})),t.on("loading",(()=>{Xs.workflow=t}))}function tn({value:t,...e}){if(!t)return e;const{sources:s=[],related_resources:n=[]}=t;return{value:{...t,sources:s.map(en),related_resources:n.map(en)},...e}}function en({url:t,...e}){const{product_id:s}=e;if(t&&s&&t.indexOf("//b2c-contenthub.com/")>=0){const[e,n]=s.split("_");t=t.replace("//b2c-contenthub.com/",`//www.${n}.com/`)}return{url:t,...e}}const{currentScript:sn}=document;async function nn({MisoClient:t}){await Promise.all([rn(t),an()])}async function rn(t){await cn(`https://cdn.jsdelivr.net/npm/@miso.ai/client-sdk@${t.version}/dist/css/ui.css`)}let on=!1;async function an(){if(on)return;if(on=!0,!sn)throw Error("currentScript not found");const t=sn.src,e=t.indexOf("?"),s=(0>e?t:t.substring(0,e)).replace(/(\.min)?\.js$/,".css");await cn(s)}async function cn(t){if(!document.querySelector(`link[href="${t}"]`))return new Promise(((e,s)=>{const n=document.createElement("link");n.rel="stylesheet",n.type="text/css",n.onload=e,n.onerror=s,n.href=t,document.head.appendChild(n)}))}const un=".layout--right-rail .wp-block-column";(async(t,s)=>{if("/smart-answers"!==window.location.pathname)return;if(window.miso_smart_answers_script_version)return void console.warn("Miso Smart Answers script already executed: "+window.miso_smart_answers_script_version);window.miso_smart_answers_script_version=e;const n=function({config:t,version:e}){return Object.defineProperty(nt,"name",{value:"smart-answers"}),("dev"===e||e.indexOf("beta")>0||t.debug)&&nt.plugins.use("std:debug",{console:{background:"#9033bb"}}),t.test_product?(nt.plugins.use("std:dry-run"),nt.debug&&nt.debug("[Answers] Test product: "+t.test_product)):t.dry_run&&nt.plugins.use("std:dry-run"),window.MisoClientSA=nt,nt}({site:t,config:s,version:e});n.debug&&n.debug("Miso Smart Answers script version: "+e);const i=document.querySelector(un);if(!i)return void console.error("Container not found: "+un);n.plugins.use("std:ui");const[r]=await Promise.all([Vs({config:s,MisoClient:n}),nn({site:t,MisoClient:n})]);i.innerHTML='\n<div class="miso-smart-answers">\n  <section class="question">\n    <div class="hero">\n      <div class="hero-inner">\n        <h4 class="title">Smart Answers (Powered by A.I.)</h4>\n        <h2 class="slogan">Get Questions Answered.</h2>\n      </div>\n    </div>\n    <miso-ask class="query-container">\n      <miso-query>\n        <input class="input" data-role="input">\n        <button class="button" data-role="button">\n          <span>A.I. Search</span>\n        </button>\n        </miso-query>\n    </miso-ask>\n  </section>\n  <section class="answer">\n    <miso-ask visible-when="ready" logo="false">\n      <miso-question></miso-question>\n      <miso-answer></miso-answer>\n      <miso-affiliation></miso-affiliation>\n      <miso-feedback></miso-feedback>\n      <div class="phrase sources">My reply is based on the following</div>\n      <miso-sources></miso-sources>\n    </miso-ask>\n  </section>\n  <section id="follow-ups" class="follow-ups">\n  </section>\n  <section id="related-resources" class="related-resources">\n    <miso-ask visible-when="ready" logo="false">\n      <div class="phrase related-resources">Go beyond, and learn more about this topic</div>\n      <miso-related-resources></miso-related-resources>\n    </miso-ask>\n  </section>\n</div>\n',function({config:t,client:e}){Ys=document.querySelector(".miso-smart-answers miso-ask miso-query input"),Zs=document.querySelector(".miso-smart-answers #follow-ups"),Xs=document.querySelector(".miso-smart-answers #related-resources miso-ask");const s=e.ui.ask;Js(s,t),e.ui.asks.on("create",(e=>Js(e,t))),s.on("loading",(()=>{Zs.innerHTML="";for(const t of e.ui.asks.workflows)t!==s&&t.destroy()}));const{q:n}=t;n?(Ys.value=n,s.query({q:n})):Ys.focus()}({site:t,config:s,client:r})})({key:"techhive",hostname:"www.techhive.com",name:"TechHive",lang:"en"},t)}();
