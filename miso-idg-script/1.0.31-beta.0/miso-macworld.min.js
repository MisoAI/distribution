!function(){"use strict";function t(t,e){const s=t.indexOf(e);s>-1&&t.splice(s,1)}function e(t){return Array.isArray(t)?t:void 0===t?[]:[t]}function s(t){return null!=t?""+t:t}function n(t){if("object"!=typeof t)return t;const e={};for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&void 0!==t[s]&&(e[s]=t[s]);return e}function i(t,e,s){Object.defineProperties(t,(s="string"==typeof s?[s]:s).reduce(((t,s)=>(t[s]={get:()=>{const t=e[s];return"function"==typeof t?t.bind(e):t}},t)),{}))}function r(t,e){for(const s in e)e.hasOwnProperty(s)&&Object.defineProperty(t,s,{value:e[s]})}class o{constructor(t){let{duration:e=0,onDuration:s,offDuration:n,state:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("function"!=typeof t)throw Error("Callback must be a function: "+t);c(s),c(n),c(e),this._callback=t,Object.defineProperty(this,"durations",{value:Object.freeze({on:void 0!==s?s:e,off:void 0!==n?n:e})}),this._value=this._state=!!i,this._active=!0}get active(){return this._active}get state(){return this._state}get value(){return this._value}set value(t){if(this._value===(t=!!t))return;!function(t){if(!t._timeout)return;clearTimeout(t._timeout),t._timeout=void 0}(this);const e=this.durations[t?"on":"off"];e?this._timeout=setTimeout((()=>a(this,t)),e):a(this,t),this._value=t}disconnect(){this._active=!1}}function a(t,e){t._state!==e&&(t._state=e,t._active&&t._callback(e))}function c(t,e){if(void 0!==e&&(isNaN(e)||0>e))throw Error(`${t} must be a non-negative number: ${e}`)}function u(t){return"string"==typeof t?document.querySelector(t):t}function l(t){return"object"==typeof t&&t.nodeType===Node.ELEMENT_NODE}function h(t,e){for(;t&&t!==t.ownerDocument;t=t.parentElement){const s=e(t);if(void 0!==s)return s}}function d(t){return t&&t.ownerDocument&&t.ownerDocument.contains(t)}function _(t){const{tagName:e}=t;customElements.define(e,t);for(const t of document.querySelectorAll(e))customElements.upgrade(t)}async function p(t){return new Promise(((e,s)=>{window.requestAnimationFrame((async()=>{try{await t(),e()}catch(t){s(t)}}))}))}async function m(t){let{area:e=.5,duration:s=1e3,signal:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t=u(t),new Promise((i=>{const r=new o((t=>{t&&(r.disconnect(),a.disconnect(),i())}),{onDuration:s}),a=new IntersectionObserver((t=>{r.value=t[0].isIntersecting}),{threshold:e});a.observe(t),n&&n.addEventListener&&n.addEventListener("abort",(()=>{r.disconnect(),a.disconnect()}))}))}function f(){return(crypto&&crypto.randomUUID?crypto.randomUUID():void 0)||function(){if(!URL||!URL.createObjectURL||URL.revokeObjectURL||!Blob)return;const t=URL.createObjectURL(new Blob),e=""+t;return URL.revokeObjectURL(t),e.substring(e.lastIndexOf("/")+1)}()||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}function g(t,e){const s=window.localStorage.getItem(t),n=function(t){const e="; "+document.cookie,s=`; ${encodeURIComponent(t)}=`,n=e.indexOf(s);if(0>n)return;const i=n+s.length,r=e.indexOf(";",i);return decodeURIComponent(0>r?e.substring(i):e.substring(i,r))}(t),i=s||n||""+e();return i&&!s&&window.localStorage.setItem(t,i),i&&!n&&function(t,e){document.cookie=`${encodeURIComponent(t)}=${encodeURIComponent(e)}; max-age=31536000; path=/`}(t,i),i}function b(t){return new y(t)}class y{constructor(t){this._value=t;const e=t=>{this._value=t};r(this,{set:e,args:function(){for(var t=arguments.length,s=Array(t),n=0;t>n;n++)s[n]=arguments[n];return e(s)},t:()=>e(!0),f:()=>e(!1),merge:t=>e(Object.assign({},this._value,t))})}get value(){return this._value}}class v{constructor(){const t=this;t.promise=new Promise(((e,s)=>{t.resolve=e,t.reject=s})),Object.freeze(this)}}class w{constructor(){this._index=-1,this._done=!1,this._aborted=!1,this._abortReason=void 0,this._error=void 0}get aborted(){return this._aborted}get abortReason(){return this._abortReason}get done(){return this._done}update(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._done||(this._value=t,this._done=e,this._index++,this._resolution&&(this._resolution.resolve(),this._resolution=void 0))}error(t){this._error=t,this._resolution&&(this._resolution.reject(t),this._resolution=void 0)}abort(t){this._aborted=!0,this._abortReason=t,this._resolution&&(t instanceof Error?this._resolution.reject(t):this._resolution.resolve(),this._resolution=void 0)}async*[Symbol.asyncIterator](){for(let t=0;;t=this._index+1){if(this._error)throw this._error;if(this._aborted)break;if(t>this._index&&(this._resolution||(this._resolution=new v),await this._resolution.promise),this._aborted)break;if(yield this._value,this._done)break}}}function E(){return(new AbortController).signal}function k(t,e){try{e()}catch(e){t(e)}}function O(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t=>console.error(t);const s=window[t]||(window[t]=[]);if(s._processed)return;s._processed=!0;const n=t=>k(e,t);Object.defineProperty(s,"push",{value:n});for(const t of s)n(t)}const x=Symbol.for("miso:resources");class I{constructor(){this._resources=new Map;const t=window[x]||[];for(const e of t)try{const[t,s]=e;this.push([t,s])}catch(t){}}push(t){let[e,s]=t;C(this._resources,e).resolve(s)}async get(t){return C(this._resources,t).promise}}function C(t,e){if(t.has(e))return t.get(e);const s=new v;return t.set(e,s),s}function j(){return window[x]||(window[x]=new I)}class R{constructor(t,e){this._dispatchRequested=!1,this._requests=[],this._run=t,this._error=e||(t=>console.error(t)),this._bulkId=0,this._dispatch=this._dispatch.bind(this)}get info(){return{bulkId:this._bulkId,index:this._requests.length}}async run(t){const e=new v;return this._requests.push({action:t,resolution:e}),this._requestDispatch(),e.promise}_requestDispatch(){this._dispatchRequested||(this._dispatchRequested=!0,setTimeout(this._dispatch))}_dispatch(){if(!this._dispatchRequested)return;this._dispatchRequested=!1;const t=this._requests,e=this._bulkId++;this._requests=[];try{this._run(t,{bulkId:e})}catch(t){this._error(t)}}}class A{constructor(){let{target:t,error:e,replays:s=[]}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._error=e||(t=>console.error(t)),!Array.isArray(s))throw Error("Replays option must be an array of strings: "+s);this._replays=new Set(s),this._namedCallbacks={},this._unnamedCallbacks=[],this._pastEvents={},t&&this._injectSubscribeInterface(t)}emit(t,e){const s={data:e,meta:{name:t,ts:Date.now()}},n=this._namedCallbacks[t];if(n)for(const t of n)t(s);for(const t of this._unnamedCallbacks)t(s);this._shallStoreForReplay(t)&&(this._pastEvents[t]||(this._pastEvents[t]=[])).push(s)}on(t,e){return this._checkName(t),this._checkCallback(e),this._on(t,this._wrapCallback(e))}once(t){this._checkName(t);const e=this;return new Promise(((s,n)=>{const i=e._on(t,(t=>{setTimeout((()=>i()));try{s(t)}catch(t){n(t)}}))}))}_checkName(t){if("string"!=typeof t)throw Error("Event name should be a string: "+t)}_checkCallback(t){if("function"!=typeof t)throw Error("Event callback should be a function: "+t)}_shallStoreForReplay(t){return this._replays.has(t)}_wrapCallback(t){const e=this;return s=>{let{data:n,meta:i}=s;try{t(n,i)}catch(t){e._error(t)}}}_on(t,e){if("*"===t?this._unnamedCallbacks.push(e):(this._namedCallbacks[t]||(this._namedCallbacks[t]=[])).push(e),"*"===t)for(const t in this._pastEvents)this._pastEvents[t].forEach(e);else this._pastEvents[t]&&this._pastEvents[t].forEach(e);return()=>this._off(t,e)}_off(e,s){if("*"===e)t(this._unnamedCallbacks,s);else{const n=this._namedCallbacks[e];n&&t(n,s)}}_injectSubscribeInterface(t){i(t,this,["on","once"])}}function N(t,e){return Object.freeze([...e&&e.meta&&e.meta.path||[],...t?[t]:[]])}class S{constructor(t,e){const s=function(t,e){if(void 0!==t&&"string"!=typeof t&&void 0===e&&(e=t,t=void 0),void 0!==t&&("string"!=typeof t||!t))throw Error(`Invalid Component name: "${t}"`);return Object.freeze({name:t,parent:e,path:N(t,e),uuid:f()})}(t,e);r(this,{meta:s});const n=this._error=this._error.bind(this);(this._events=new A({error:n,replays:["child"]}))._injectSubscribeInterface(this),this._warn=this._warn.bind(this),(e=s.parent)&&e._events&&e._events.emit("child",this)}_warn(){const t=this.meta.parent;(t&&t._warn||console.warn)(...arguments)}_error(){const t=this.meta.parent;(t&&t._error||console.error)(...arguments)}}!function(t,e){const s=Symbol.for(e);Object.defineProperty(t,s,{value:!0}),Object.defineProperty(t,"isTypeOf",{value:e=>e&&e instanceof t||"function"==typeof e.constructor&&!0===e.constructor[s]})}(S,"miso:component");class L extends S{constructor(t,e){let{libName:s,keyName:n}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};switch(super(t,e),this._events._replays.add("register"),this._libraries={},this._libResolutions={},this._libName=s,typeof n){case"string":this._keyFn=t=>t[n];break;case"function":this._keyFn=n;break;default:throw Error("Expect keyName to be a string or a function: "+n)}}isRegistered(t){return this._checkKey(t),!!this._libraries[t]}get registered(){return Object.values(this._libraries)}async whenRegistered(t){if(this.isRegistered(t))return this._libraries[t];const{promise:e}=this._libResolutions[t]||(this._libResolutions[t]=new v);return e}register(){for(var t=arguments.length,e=Array(t),s=0;t>s;s++)e[s]=arguments[s];for(const t of e)this._register(t)}_checkKey(t){if("string"!=typeof t||!t)throw Error("Expect key to be a non-empty string: "+t)}_checkLib(t){if("function"!=typeof t)throw Error("Expect lib to be a class or function: "+t)}_register(t){this._checkLib(t);const e=this._keyFn(t);this._checkKey(e);const s=this._libraries||(this._libraries={});s[e]=t,this._libResolutions[e]&&this._libResolutions[e].resolve(t),this._events.emit("register",t)}}class ${constructor(t){this._ac=new AbortController,this._timeout=t,this.touch()}clear(){void 0!==this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=void 0)}touch(){this.clear(),this._timeoutId=setTimeout((()=>this.abort()),this._timeout)}get signal(){return this._ac.signal}abort(t){this.clear(),this._ac.abort(t||Error(`Stall timeout: data stay unchanged for ${this._timeout/1e3} seconds.`))}}const P={DATA_ENDPOINT:"https://api-edge.askmiso.com/v1",EVENT_ENDPOINT:"https://api.askmiso.com/v1"};class T{constructor(t,e){this._client=t,this._root=e,this._bulk=new R(this._runBulkFetch.bind(this),t._error.bind(t))}async fetch(t,e){let{method:s="POST",headers:i,timeout:r,sendApiKeyByHeader:o}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{apiKey:a,request:c={}}=this._client.options;r=r||c.timeout,o=o||c.sendApiKeyByHeader,o&&(i=Object.assign({},i,{"X-API-KEY":a}));const u="GET"!==s&&null!=e?JSON.stringify(e):void 0,l=r?AbortSignal.timeout(r):void 0,h=await window.fetch(t,n({method:s,headers:i,body:u,cache:"no-cache",mode:"cors",signal:l})),d=await h.json();if(h.status>=400||d.errors){var _=Error(d.message);throw _.data=d,_.status=h.status,_}return d}get bulkInfo(){return this._bulk.info}async fetchForBulk(t,e,s){let{method:n}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(n&&"POST"!==n)throw Error("Non-POST API is not supported in bulk mode: "+url);return this._bulk.run({apiGroup:t,apiName:e,payload:s})}async _runBulkFetch(t){const e=this.url(["bulk"]),s={requests:t.map((t=>{let{action:{apiGroup:e,apiName:s,payload:n}}=t;return{api_name:`${e}/${s}`,body:n}}))},{data:n}=await this.fetch(e,s);for(let e=0,s=t.length;s>e;e++){const{resolution:s}=t[e],{error:i,status_code:r,body:o}=n[e];r>=400||i?s.reject({status_code:r,body:o}):s.resolve(o)}}sendBeacon(t,e){let{method:s}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(s&&"POST"!==s)throw Error("Non-POST API is not supported in useBeacon mode: "+t);if(!window.navigator.sendBeacon(t,JSON.stringify(e)))throw Error("Send beacon unsuccessful: "+t)}url(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{apiKey:s,request:n={}}=this._client.options,i=e.sendApiKeyByHeader||n.sendApiKeyByHeader,r=t.filter((t=>t)).join("/"),o=`${this.getApiEndpoint(r)}/${r}`;return i?o:`${o}?api_key=${window.encodeURIComponent(s)}`}getApiEndpoint(t){const{dataEndpoint:e=P.DATA_ENDPOINT,eventEndpoint:s=P.EVENT_ENDPOINT}=this._client.options;return"interactions"===t?s:e}applyUrlPasses(t,e){let{apiGroup:s,apiName:n,url:i}=e;const r=this._client;for(const e of this._root._urlPasses)try{i=e({client:r,apiGroup:s,apiName:n,url:i})||i}catch(e){t.error(e)}return i}applyPayloadPasses(t,e){let{apiGroup:s,apiName:n,payload:i}=e;const r=this._client;for(const e of this._root._payloadPasses)try{i=e({client:r,apiGroup:s,apiName:n,payload:i})||i}catch(e){t.error(e)}return i}}const U=["bulk"];class q extends S{constructor(t,e){super(e,t),this._apiPath=e,this.helpers=t.helpers,this.clientOptions=t._client.options,this.context=t._client.context}async _run(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{bulk:n}=s,i=n?{bulk:this.helpers.bulkInfo}:void 0,r=this._apiPath,o=this._url({apiGroup:r,apiName:t,payload:e,options:s}),a={apiGroup:r,apiName:t,payload:e=this._preprocess({apiGroup:r,apiName:t,payload:e,options:s}),url:o,options:s};this._events.emit("request",Object.assign({},a,i));const c=await this._send(a),u=Object.assign({},a,{response:c});return this._events.emit("response",Object.assign({},u,i)),this._postprocess(u)}_preprocess(t){let{apiGroup:e,apiName:s,payload:n}=t;return this.helpers.applyPayloadPasses(this,{apiGroup:e,apiName:s,payload:n})}_url(t){let{apiGroup:e,apiName:s,options:n}=t;const i=this.helpers.url([e,s],n);return this.helpers.applyUrlPasses(this,{apiGroup:e,apiName:s,url:i,options:n})}async _send(t){let{apiGroup:e,apiName:s,url:n,payload:i,options:{bulk:r}={}}=t,o=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t.options,U);return r?this.helpers.fetchForBulk(e,s,i):this.helpers.fetch(n,i,o)}_postprocess(t){let{response:e}=t;return e.data}}const M=["useBeacon"],z=["options"];function D(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}class B extends q{constructor(t){super(t,"interactions")}async upload(t,e){try{return await this._run("upload",t,e)}catch(t){if(400!==t.status||!t.message||-1>=t.message.toLowerCase().indexOf("playground"))throw t;this._warn("Ignore interactions uploaded to playground app.")}}_url(t){let{apiGroup:e,apiName:s,options:n}=t;const i=this.helpers.url([this._apiPath],n);return this.helpers.applyUrlPasses(this,{apiGroup:e,apiName:s,url:i,options:n})}_preprocess(t){let{apiGroup:e,apiName:s,payload:n}=t;return"upload"===s&&(n=this._normalizeUploadPayload(n)),super._preprocess({apiGroup:e,apiName:s,payload:n})}_normalizeUploadPayload(t){if("object"!=typeof t)throw Error("Interactions payload has to be either an object or an array of objects: "+t);return Array.isArray(t)||(t=[t]),{data:t}}async _send(t){let{options:{useBeacon:e=!0}={}}=t,s=D(t.options,M),n=D(t,z);if(e){const{url:t,payload:e}=n;return this.helpers.sendBeacon(t,e,s),{}}return super._send(Object.assign({},n,{options:s}))}}const V=["pollingInterval","signal","stallTimeout"];class F extends q{constructor(t){super(t,"ask")}async questions(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof t&&"{"!==t.charAt(0))return new W(this,{question_id:t},e);const s=await this._run("questions",t,e);return new W(this,s,e)}async _questions(t,e){return this._run("questions",t,e)}async _get(t,e){return this._run(`questions/${t}/answer`,void 0,Object.assign({},e,{method:"GET"}))}}class W{constructor(t,e){let{question_id:s}=e,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._api=t,this._questionId=s,this._ac=new AbortController,this._options=n}get questionId(){return this._questionId}async get(t){return this._api._get(this._questionId,Object.assign({},this._options,t))}abort(t){this._ac.abort(t)}[Symbol.asyncIterator](){var t=this;let e=this._options,{pollingInterval:s,signal:n,stallTimeout:i=3e4}=e,r=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(e,V);const o=new $(i);let a;n=function(){for(var t=arguments.length,e=Array(t),s=0;t>s;s++)e[s]=arguments[s];const n=e.length;if(0===n)return E();if(1===n)return e[0];const i=new AbortController;for(const t of e)if(t&&t.addEventListener){if(t.aborted)return AbortSignal.abort(t.reason);t.addEventListener("abort",(()=>i.abort(t.reason)))}return i.signal}(this._ac.signal,o.signal,n);return function(t){let{interval:e=1e3,errorLimit:s=10,onError:n,onResponse:i,signal:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(r&&r.aborted)return[];let o=0;const a=new w,c=setInterval((async()=>{let e,u;try{[e,u]=await t(r?{signal:r}:{}),i&&i(e,u)}catch(t){return n&&n(t),o++,void(o>s&&(clearInterval(c),a.error(t)))}a.update(e,u),u&&clearInterval(c)}),e);return r&&r.addEventListener&&r.addEventListener("abort",(()=>{clearInterval(c),a.abort(r.reason)})),a}((async function(){const e=await t.get();return[e,e.finished]}),Object.assign({interval:s,signal:n,onResponse:(t,e)=>{var s,n;e?o.clear():(n=t,(s=a)&&s.answer_stage===n.answer_stage&&s.answer.length===n.answer.length||o.touch()),a=t}},r))[Symbol.asyncIterator]()}}class Q extends q{constructor(t){super(t,"search")}async search(t,e){return this._run("search",t,e)}async autocomplete(t,e){return this._run("autocomplete",t,e)}async multipleGet(t,e){return this._run("mget",t,e)}}class G extends q{constructor(t){super(t,"recommendation")}async userToProducts(t,e){return this._run("user_to_products",t,e)}async userToCategories(t,e){return this._run("user_to_categories",t,e)}async userToAttributes(t,e){return this._run("user_to_attributes",t,e)}async userToTrending(t,e){return this._run("user_to_trending",t,e)}async userToHistory(t,e){return this._run("user_to_history",t,e)}async productToProducts(t,e){return this._run("product_to_products",t,e)}}class K extends S{constructor(t,e){super("api",t),this._client=t,this.helpers=new T(t,e),this.interactions=new B(this),this.ask=new F(this),this.search=new Q(this),this.recommendation=new G(this)}}class H extends S{constructor(t){super("context",t),this._client=t}}var Y={api:{Api:K,ApiBase:q,ApiHelpers:T,Interactions:B,Recommendation:G,Search:Q},context:{Context:H}};class Z{constructor(t){r(this,{install:t})}}class J extends L{constructor(t){super("plugins",t,{libName:"plugin class",keyName:"id"}),this._root=t,this._currentScript=document.currentScript,this._events._replays.add("install").add("subtree"),this._installed={},this._installedResolutions={},this._useRequests={},this._subtrees=[],this.context=new X(this,Y),this.plugins=new tt(this)}isInstalled(t){return this._checkKey(t),!!this._installed[t]}get installed(){return Object.values(this._installed)}get(t){return this._installed[t]}getPluginClass(t){return this._libraries[t]}use(t,e){if("function"==typeof t&&t.id&&"string"==typeof t.id)return this.register(t),void this.use(t.id,e);let s;if("string"==typeof t&&this.isInstalled(t))return s=this.get(t),void this._tryConfig(s,e);"string"!=typeof t||this.isRegistered(t)?(s=this._instantiate(t,e),this._install(s)):(this._useRequests[t]||(this._useRequests[t]=[])).push(e)}async install(t,e){return this.use(t,e),"string"!=typeof t||this.isRegistered(t)||await this._tryRegisterRemotely(t),this.whenInstalled(t)}async whenInstalled(t){if(this.isInstalled(t))return this.get(t);const{promise:e}=this._installedResolutions[t]||(this._installedResolutions[t]=new v);return e}addSubtree(t){this._subtrees.push(t),this._events.emit("subtree",t)}addPayloadPass(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._payloadPasses.push(t)}addUrlPass(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._urlPasses.push(t)}_tryConfig(t,e){void 0!==e&&("function"==typeof t.config?(t.config(e),this._events.emit("config",[t,e])):this._warn(`Attempt to pass options to plugin "${t.id}", which offers no config() method.`))}_instantiate(t,e){switch(typeof t){case"string":this._checkKey(t);const s=this._libraries[t];if(!s)throw Error("Plugin class not found: "+t);const n=new s;return r(n,{id:t}),this._tryConfig(n,e),n;case"function":return new Z(t)}throw Error("Unexpected parameters: "+t)}_install(t){if("function"!=typeof t.install)throw Error("Expect plugin.install to be a function: "+t);try{t.installed=!1,t.install(this.MisoClient,this.context),t.installed=!0}catch(t){throw t}t.id&&(this._installed[t.id]=t,this._installedResolutions[t.id]&&(this._installedResolutions[t.id].resolve(t),delete this._installedResolutions[t.id])),this._events.emit("install",t)}_register(t){super._register(t),this._fulfillUseRequests(t.id)}_fulfillUseRequests(t){const e=this._useRequests[t];if(e){for(const s of e)try{this.use(t,s)}catch(t){this._error(t)}delete this._useRequests[t]}}async _tryRegisterRemotely(t){if(t.startsWith("std:"))try{return void await this._registerStdRemotely(t)}catch(t){console.error(t)}throw Error("Cannot register plugin remotely: "+t)}async _registerStdRemotely(t){const{version:e}=this._root,s="dev"===e?`plugin:${t}@dev:${MisoClient.uuid}`:`plugin:${t}@${e}`;if(!document.querySelector(`script[data-request="${s}"]`)){const n=document.createElement("script");n.async=!0,n.src=function(t,e,s){const n=t.slice(4);if("dev"===e){const t=s.src,e=t.indexOf("?"),i=0>e?t.length:e,r=t.lastIndexOf("/",i)+1,o=t.indexOf(".",r),a=0>o?"":t.slice(o,i);return`${t.slice(0,r)}plugins/${n}${a}`}return`https://cdn.jsdelivr.net/npm/@miso.ai/client-sdk@${e}/dist/umd/plugins/${n}.min.js`}(t,e,this._currentScript),n.setAttribute("data-request",s),document.head.appendChild(n)}const n=await(new j).get(s);!this.isRegistered(t)&&this.register(n)}}class X{constructor(t,e){i(this,t,["getPluginClass","addSubtree","addPayloadPass","addUrlPass","whenInstalled","whenRegistered"]),r(this,{classes:e})}}class tt{constructor(t){i(this,t,["installed","registered","isInstalled","isRegistered","whenInstalled","whenRegistered","get","register","use","install"])}}const et=new class extends S{constructor(){super(),this._events._replays.add("create"),this._pluginRoot=new J(this),this._clients=[],this._payloadPasses=[],this._urlPasses=[],this.version="1.8.0-beta.2"}get instances(){return[...this._clients]}async any(){return this._clients[0]||this._any||(this._any=(await this._events.once("create")).data)}};var st=Object.freeze({__proto__:null,viewable:m});class nt extends S{static attach(){(window.MisoClients||(window.MisoClients=[])).push(nt),window.MisoClient?window.MisoClient!==nt&&console.warn(`window.MisoClient already exists: (${window.MisoClient.version}).`):window.MisoClient=nt}constructor(t){super("client",et),this._config(t),this.context=new H(this),this.api=new K(this,et),function(t){et._clients.push(t),et._events.emit("create",t)}(this)}get version(){return nt.version}_config(t){this.options=Object.freeze(this._normalizeOptions(t))}_normalizeOptions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("string"==typeof t&&(t={apiKey:t}),t.readConfigFromScriptUrl&&(t=Object.assign({},this._readConfigFromScriptUrl(),t)),!t.apiKey)throw Error("Require API key to initialize miso client.");return t.dataEndpoint=t.dataEndpoint||t.apiHost,t.eventEndpoint=t.eventEndpoint||t.apiHost,delete t.apiHost,n(t)}_readConfigFromScriptUrl(){const t=document.currentScript;return n({apiKey:new URL(new Request(t.src||t.href).url).searchParams.get("api_key")||void 0})}}nt.helpers=st,r(nt,{uuid:f()});var it=function(t){const e=et._pluginRoot;return et.MisoClient=e.MisoClient=t,i(t,et,["version","instances","any","meta","on","once"]),i(t,e,["plugins"]),t}(nt);class rt{constructor(t){this._plugin=t}get anonymous_id(){return this._anonymousId||this._autoAnonymousId||(this._autoAnonymousId=g("miso_anonymous_id",f))}set anonymous_id(t){t=s(t),this._anonymousId=t,this._plugin._events.emit("set",`anonymous_id = '${t}'`)}get user_id(){return this._userId}set user_id(t){t=s(t),this._userId=t,this._plugin._events.emit("set",`user_id = '${t}'`)}get user_hash(){return this._userHash}set user_hash(t){if("string"!=typeof t&&void 0!==t)throw Error("User hash must be a string");this._userHash=t,this._plugin._events.emit("set",`user_hash = '${t}'`)}}function ot(){const t=new URLSearchParams(window.location.search);let e=n({source:t.get("utm_source")||void 0,medium:t.get("utm_medium")||void 0,name:t.get("utm_campaign")||void 0,term:t.get("utm_term")||void 0,content:t.get("utm_content")||void 0});return 0===Object.keys(e).length?void 0:e}class at{constructor(t){this._plugin=t,this._config={search:!0},this.interface=Object.freeze({config:this.config.bind(this)})}config(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("object"!=typeof t)throw Error("Config options must be an object or undefined: "+t);for(const e of t){if(!this._config.hasOwnProperty(e))continue;const s=this._config[e],n=t[e];n!==s&&(this._config[e]=s,this._plugin._events.emit("config",`${e}: ${s} -> ${n}`))}return Object.freeze(Object.assign({},this._config))}}const ct=["groupName","apiName","url","bulk"];function ut(){let{text:t="Miso"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return"%c"+t}function lt(){let{color:t="#fff",background:e="#334cbb"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return`color: ${t}; background-color: ${e}; padding: 2px 2px 1px 4px;`}function ht(t){const e=typeof t;return"function"===e||"object"===e&&!Array.isArray(t)?[t]:t}it.plugins.register(class{constructor(){this._options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}}static get id(){return"std:debug"}install(t){var e=this;this._injectComponents(t),t.debug=function(){return e._logr(...arguments)}}config(){this._options=Object.assign({},this._options,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}_injectComponents(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t.on("child",(t=>this._injectComponents(t,e))),t.on("subtree",(s=>this._injectComponents(s,e.concat(t.meta.path)))),t.on("*",((s,n)=>this._handleEvent(t,n,s,e)))}_handleEvent(t,e,s){let{name:n}=e;if("child"===n||"subtree"===n)return;const i=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:[]).concat(t.meta.path);if(i.length||"create"!==n){switch(i[0]){case"client":if("api"===i[1])return void this._handleApiEvent(n,Object.assign({},s,{groupName:i[2]}));break;case"plugins":return void(1===i.length?this._handlePluginsEvent(n,s):this._handlePluginSpecificEvent(i[1],i.slice(2),n,s))}this._logw(i.join("."),n,s)}else this._handleCreateClient(n,s)}_handleCreateClient(t,e){this._logw("client",t,e)}_handleApiEvent(t,e){let{groupName:s,url:n,bulk:i}=e,r=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(e,ct);const o=new URL(n).pathname,a=["api",t];if(i&&a.push(`(bulk ${i.bulkId})`),a.push("POST "+o),"interactions"===s){const{type:t}=r.payload.data[0];a.push(t)}a.push([Object.assign({},r,{url:n})]),this._log(...a)}_handlePluginsEvent(t,e){let s=[];Array.isArray(e)&&(s=e.slice(1),e=e[0]),this._log("plugins",t,""+(e.id||"(anonymous)"),[e,...s])}_handlePluginSpecificEvent(t,e,s,n){this._logw([t,e.join(".")],s,n)}_getPath(t){const e=[];for(let s=t;s;s=s.meta.parent)s.meta.name&&e.push(s.meta.name);return e.reverse()}_logr(){const t=this._options.console||{};for(var e=arguments.length,s=Array(e),n=0;e>n;n++)s[n]=arguments[n];console.log(ut(t),lt(t),...s)}_log(t,e){const s=this._options.console||{};for(var n=arguments.length,i=Array(n>2?n-2:0),r=2;n>r;r++)i[r-2]=arguments[r];console.log(ut(s),lt(s),function(t){return`<${"string"==typeof t?t:t.filter((t=>t)).join("/")}>`}(t),function(t){return`[${t}]`}(e),...i)}_logw(t,e,s){void 0===s?this._log(t,e):Array.isArray(s)?this._log(t,e,...s.map(ht)):this._log(t,e,ht(s))}},class{constructor(){this._options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},this.id="std:dry-run",this.name="dry-run"}static get id(){return"std:dry-run"}install(t,e){let{addUrlPass:s}=e;s(this._modifyUrl.bind(this))}_modifyUrl(t){let{apiGroup:e,apiName:s,url:n}=t;return"interactions"===e&&"upload"===s?function(t,e,s){if("string"!=typeof e)throw Error("Expect URL parameter to be a string: "+e);return void 0===s&&(s="1"),t+(0>t.indexOf("?")?"?":"&")+encodeURIComponent(e)+"="+encodeURIComponent(""+s)}(n,"dry_run","1"):n}}),it.plugins.use(class extends S{static get id(){return"std:user"}constructor(){super("user"),this._contexts=new WeakMap}install(t,e){e.addSubtree(this),t.on("create",this._injectClient.bind(this)),e.addPayloadPass(this._modifyPayload.bind(this))}_injectClient(t){const e=new rt(this);var s,n;this._contexts.set(t,e),s=e,Object.defineProperties(t.context,(n="string"==typeof(n=["anonymous_id","user_id","user_hash"])?[n]:n).reduce(((t,e)=>(t[e]={get:()=>s[e],set:t=>{s[e]=t}},t)),{}))}_modifyPayload(t){let{client:e,apiGroup:s,apiName:n,payload:i}=t;return"interactions"===s&&"upload"===n?this._modifyPayloadForInteractions(e,i):this._modifyPayloadForOthers(e,i)}_modifyPayloadForOthers(t,e){const{user_id:s,user_hash:n,anonymous_id:i}=t.context;return Object.assign({},s?{user_id:s,user_hash:n}:{anonymous_id:i},e)}_modifyPayloadForInteractions(t,e){let{data:s}=e;const{anonymous_id:i,user_id:r}=t.context,o=n({anonymous_id:i,user_id:r});return s=s.map((t=>Object.assign({},o,t))),{data:s}}}),it.plugins.use(class{static get id(){return"std:page-info"}constructor(){}install(t,e){let{addPayloadPass:s}=e;s(this._modifyPayload.bind(this))}_modifyPayload(t){let{apiGroup:e,apiName:s,payload:n}=t;return"interactions"===e&&"upload"===s?this._modifyPayloadForInteractions(n):n}_modifyPayloadForInteractions(t){let{data:e}=t;return e=e.map((t=>Object.assign({},t,{context:Object.assign({},n({page:n({url:window.location.href,referrer:document.referrer,title:document.title}),campaign:ot()}),t.context)}))),{data:e}}}),it.plugins.use(class extends S{static get id(){return"std:auto-events"}constructor(){super("auto-events"),this._contexts=new WeakMap}install(t,e){e.addSubtree(this),t.on("create",this._injectClient.bind(this)),e.addPayloadPass(this._captureApiRequest.bind(this))}_injectClient(t){const e=new at(this);this._contexts.set(t,e),t.autoEvents=e.interface}_captureApiRequest(t){let{client:e,apiGroup:s,apiName:n,payload:i}=t;if("search"===s)if("search"===n)this._captureSearchApiRequest(e,i)}_captureSearchApiRequest(t,e){let{q:s}=e;if(!s||"*"===s)return;const n=this._contexts.get(t);n&&n._config.search&&t.api.interactions.upload({type:"search",search:{keywords:s},context:{custom_context:{channel:"miso_api"}}})}});class dt{constructor(){(this._events=new A)._injectSubscribeInterface(this),this._states={},r(this,{states:new Proxy(this._states,{set(){}})})}update(t,e){let{silent:s=!1}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._states[t]=Object.freeze(e),s||this._events.emit(t,e)}trigger(t,e){this._events.emit(t,e)}}function _t(){return"data"}function pt(t){return t?"view:"+t:"view"}class mt{constructor(t){this._hub=t,this._sessionIndex=0,i(t,this,["active"])}get active(){const{session:t}=this._hub.states;return!(!t||!t.active)}new(){let{force:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this._hub.states.session;if(e&&!e.active&&!t)return;const s=this._create();this._hub.update("session",s)}start(){const t=this._hub.states.session||this._create();t.active||this._hub.update("session",Object.assign({},t,{active:!0}))}restart(){this.new({force:!0}),this.start()}_create(){return Object.freeze({active:!1,uuid:f(),index:this._sessionIndex++})}}class ft{constructor(t){this._hub=t,this._unsubscribes=[t.on("session",(t=>this._handleSession(t))),t.on("input",(t=>this._handleInput(t)))]}get source(){return this._source}set source(t){if(t&&"function"!=typeof t)throw Error("Expect source to be a function: "+t);this._source=t}_handleSession(t){this._source&&(this._session&&t.index===this._session.index||(this._ac&&this._ac.abort({type:"new-session",message:"A new session is created, discarding the old one."}),this._ac=new AbortController),this._session=t,this._emitData({session:t}))}async _handleInput(t){if(!this._source)return;const{session:e}=this._hub.states;try{const{signal:s}=this._ac||{},n=Object.assign({},t.options,{signal:s}),i=await this._source(Object.assign({session:e},t,{options:n})),r=i&&("function"==typeof i.next?i:i[Symbol.asyncIterator]);if(r){let t;for await(t of r){if(!this._isCurrentSession(e))break;this._emitData({session:e,value:t,ongoing:!0})}this._emitDataWithSessionCheck({session:e,value:t})}else this._emitDataWithSessionCheck({session:e,value:i})}catch(t){this._error(t),this._emitDataWithSessionCheck({session:e,error:t})}}_emitDataWithSessionCheck(t){this._isCurrentSession(t.session)&&this._emitData(t)}_isCurrentSession(t){if(!t)return!1;const{session:e}=this._hub.states;return e&&e.index===t.index}_emitData(t){this._hub.update(_t(),t)}_error(t){console.error(t)}destroy(){this._ac&&this._ac.abort({type:"data-actor-destroy",message:"Data actor is destroyed."});for(const t of this._unsubscribes)t();this._unsubscribes=[]}}const gt="data-miso-product-id",bt="default",yt=Object.freeze({CONTAINER:"container",BANNER:"banner",QUERY:"query",FEEDBACK:"feedback",RESULTS:"results",ITEMS:"items",QUESTION:"question",ANSWER:"answer",SOURCES:"sources",RELATED_RESOURCES:"related_resources"}),vt=Object.freeze({CONTAINER:"container",BANNER:"banner",LIST:"list",QUERY:"query",RADIO:"radio",TEXT:"text"}),wt=Object.freeze({IMPRESSION:"impression",VIEWABLE:"viewable",CLICK:"click"}),Et=Object.freeze({UNTRACKED:"untracked",TRACKING:"tracking",TRIGGERED:"triggered"}),kt=Object.freeze({INITIAL:"initial",LOADING:"loading",ERRONEOUS:"erroneous",READY:"ready"});function Ot(t){if(t!==wt.IMPRESSION&&t!==wt.VIEWABLE&&t!==wt.CLICK)throw Error("Unrecognized event type: "+t)}class xt{constructor(t){this._view=t,this._handlers=[],this._unsubscribes=[t.on("element",(()=>this._sync()))],this._sync()}_get(){return this._view.element}on(t,e){const s=this._get();return s&&s.addEventListener(t,e),this._handlers.push({event:t,handler:e}),()=>this._off(t,e)}_off(t,e){const s=this._get();s&&s.removeEventListener(t,e);for(let s=0;this._handlers.length>s;s++)if(this._handlers[s].event===t&&this._handlers[s].handler===e){this._handlers.splice(s,1);break}}_sync(){const t=this._get();if(this._element!==t){if(this._element)for(const{event:t,handler:e}of this._handlers)this._element.removeEventListener(t,e);if(t)for(const{event:e,handler:s}of this._handlers)t.addEventListener(e,s);this._element=t}}_destroy(){for(const t of this._unsubscribes)t();this._unsubscribes=[]}}const It=["value"];class Ct{constructor(t,e){this._events=new A({target:this}),this._views=t,r(this,{role:e,interface:new jt(this)})}get hub(){return this._views._hub}get element(){return this._element}set element(t){t!==this._element&&(this._element&&this._safeApplyOnLayout("unrender",this._element),this._element=t,this._events.emit("element",t),this.refresh({force:!0}))}get proxyElement(){return this._proxyElement||(this._proxyElement=new xt(this))}get layout(){return this._layout}set layout(t){if(t===this._layout)return;if(t&&"function"!=typeof t.render)throw Error("Render function is mandatory in a layout.");const{element:e}=this;e&&this._safeApplyOnLayout("unrender",e),this._safeApplyOnLayout("destroy"),this._layout=t,t&&"function"==typeof t.initialize&&t.initialize(this),this.refresh({force:!0})}async refresh(){var t=this;let{force:e=!1,data:s}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this._layout)return;const{element:n}=this;if(!n)return;const i=this._data;this._data=s=this._sliceData(s||this._views._getData());const{session:r,status:o,ongoing:a,meta:c}=s;if(!e&&!(r&&r.active))return;if(!e&&((u=s)===(l=i)||u&&l&&u.status===l.status&&u.error===l.error&&u.value===l.value&&u.ongoing===l.ongoing&&function(t,e){return t===e||t&&e&&t.uuid===e.uuid}(u.session,l.session)))return;var u,l;const h=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},s=arguments.length>1?arguments[1]:void 0;!1!==e&&t.updateState(Object.assign({session:r,status:o,ongoing:a,meta:c},e),s)};try{await this._layout.render(n,s,{notifyUpdate:h})}catch(t){this._error(t),h({error:t})}}updateState(t){let{session:e,status:s,ongoing:i,meta:r,error:o}=t,{silent:a=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};o&&(s=kt.ERRONEOUS);const c=this._state=Object.freeze(n({session:e,status:s,ongoing:i,meta:r,error:o})),{role:u}=this;this.hub.update(pt(u),c,{silent:a})}_sliceData(t){const{value:e}=t,s=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,It);return n(Object.assign({value:e&&e[this.role],meta:e&&e._meta},s))}_syncSize(){this._element&&this._safeApplyOnLayout("syncSize",this._element)}_safeApplyOnLayout(t){if(this._layout&&"function"==typeof this._layout[t])try{for(var e=arguments.length,s=Array(e>1?e-1:0),n=1;e>n;n++)s[n-1]=arguments[n];this._layout[t](...s)}catch(t){this._error(t)}}_error(t){this._views._error(t)}_destroy(){this._safeApplyOnLayout("destroy"),this._proxyElement&&this._proxyElement._destroy()}}class jt{constructor(t){i(this,t,["role","layout","element","proxyElement","refresh","on"])}}class Rt{constructor(t,e,s){let{roles:n=[],layouts:i={}}=s;this._hub=t,this._extensions=e,this._containers=new Map,this._views={};for(const t of n)this._views[t]=new Ct(this,t);this._layoutFns=new Map,this.layouts=i,r(this,{interface:new At(this)});const o=()=>this.syncSize();window.addEventListener("resize",o),this._unsubscribes=[()=>window.removeEventListener("resize",o),t.on(_t(),(()=>this.refresh()))]}addContainer(t){if(this._containers.has(t))return;const e=new Ct(this,yt.CONTAINER);e.layout=this._layoutFns.get(yt.CONTAINER)(),e.element=t,this._containers.set(t,e);const{components:s}=t;for(const t of s)this.addComponent(t)}removeContainer(t){const e=this._containers.get(t);if(!e)return;const{components:s}=t;for(const t of s)this.removeComponent(t);e._destroy(),this._containers.delete(t)}addComponent(t){this._getViewByElement(t).element=t}removeComponent(t){this._getViewByElement(t).element=void 0}updateComponentRole(t,e,s){}refreshElement(t){const e=t.isContainer?this._containers.get(t):this._getViewByElement(t);e&&e.refresh({force:!0})}_getViewByElement(t){let{role:e}=t;if(!e)throw Error("Component must have a role");return this.get(e)}set layouts(t){for(let[e,s]of Object.entries(t))if(this._layoutFns.set(e,s),e===yt.CONTAINER)for(const t of this._containers.values())t.layout=s();else this.get(e).layout=s()}get(t){return this._views[t]||(this._views[t]=new Ct(this,t))}get views(){return this._getViews(!0)}_getViews(){return 0>=arguments.length||void 0===arguments[0]||arguments[0]?[...this._containers.values(),...Object.values(this._views)]:[...Object.values(this._views),...this._containers.values()]}syncSize(){for(const t of Object.values(this._views))t._syncSize()}async refresh(){let{force:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this._getData();await Promise.all(this._getViews(!0).map((s=>s.refresh({force:t,data:e}))))}_getData(){const{[_t()]:t}=this._hub.states;if(!this._data||this._data.data!==t){const e=t&&t.session&&t.session.active?t.error?kt.ERRONEOUS:t.value?kt.READY:kt.LOADING:kt.INITIAL;this._data=Object.freeze(Object.assign({},t,{status:e,ongoing:e===kt.READY?!!t.ongoing:void 0}))}return this._data}_error(t){console.error(t)}destroy(){for(const t of this._getViews(!1))t._destroy();for(const t of this._unsubscribes)t();this._unsubscribes=[]}}class At{constructor(t){this._actor=t,i(this,t,["syncSize","refresh"])}get(t){return this._actor.get(t).interface}get views(){return this._actor.views.map((t=>t.interface))}}class Nt{constructor(t,e){this._hub=t,this._view=e,this._bindings=new Map,this._e2b=new WeakMap}list(){return[...this._bindings.values()]}get(t){if(!t)throw Error("Product ID or element is required.");return l(t)?this._e2b.get(t):this._bindings.get(t)}refresh(){const{element:t}=this._view;if(!t)return this.unbindAll();const e=this._purge(),s=t.querySelectorAll("[data-miso-product-id]"),n=[];for(const t of s){const[s,...i]=this._bind(t);s&&n.push(s);for(const t of i)e.push(t)}return{bounds:n,unbounds:e}}unbindAll(){const t=this.list();return this._bindings.clear(),{bounds:[],unbounds:t}}_bind(t,e){if(!t)throw Error("Product ID or element is required.");if(void 0===e&&l(t)){if(!(e=t).hasAttribute(gt))throw Error(`No attribute "data-miso-product-id found on element ${e}"`);t=e.getAttribute(gt)}const s=this._bindings.get(t);if(s&&s.element===e)return[];const n=this._unbind(this.get(t)),i=this._unbind(this.get(e)),r=Object.freeze({productId:t,element:e});this._bindings.set(t,r),this._e2b.set(e,r);const o=[r];return n&&o.push(n),i&&o.push(i),o}_purge(){const t=[];for(const e of this._bindings.values()){const{element:s}=e;d(s)||t.push(this._unbind(e))}return t}_unbind(t){return t&&(this._bindings.delete(t.productId),this._e2b.delete(t.element)),t}_destroy(){this.unbindAll()}}const St=["impression","viewable","click"];const{IMPRESSION:Lt,VIEWABLE:$t,CLICK:Pt}=wt,{UNTRACKED:Tt,TRACKING:Ut,TRIGGERED:qt}=Et;function Mt(t,e){return!!e&&Object.assign({},t,e)}function zt(t){return t&&t.status===kt.READY}const Dt=Object.freeze({impression:Object.freeze({}),viewable:Object.freeze({area:.5,duration:1e3}),click:Object.freeze({lenient:!1}),watch:!1});class Bt{constructor(t,e){this._hub=t,this._view=e;const s=this._role=e.role;this._items=new Nt(t,e),this._viewables=new WeakMap,this._options=Dt,this._unsubscribes=[e.proxyElement.on("click",(t=>this._handleClick(t))),e.on("element",(()=>this.refresh())),t.on(pt(s),(()=>this.refresh()))],this.refresh()}config(t){const{active:e}=this._hub;if(e)throw Error("Cannot change configuration after unit starts.");this._options=this._normalizeOptions(t)}_normalizeOptions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{impression:e={},viewable:s={},click:i={}}=t,r=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,St);return n(Object.assign({},Dt,r,{impression:Mt(Dt.impression,e),viewable:Mt(Dt.viewable,s),click:Mt(Dt.click,i)}))}start(){throw Error("unit.tracker.start() is deprecated. Use unit.startTracker() instead.")}refresh(){this._syncElement();const t=this._getViewState();if(!t)return;const{session:e}=t;this._states&&e.uuid!==this._states.uuid&&this._retireStates(),this._states||(this._states=new Vt(e.uuid)),this._refreshItems()}impression(t,e){this._assertViewReady(),this._trigger(t,Lt,Object.assign({},e,{manual:!0}))}viewable(t,e){this._assertViewReady(),this._trigger(t,$t,Object.assign({},e,{manual:!0}))}click(t,e){this._assertViewReady(),this._trigger(t,Pt,Object.assign({},e,{manual:!0}))}_getViewState(){return this._hub.states[pt(this._role)]}_assertViewReady(){if(!this._hub.active)throw Error("Unit is not active. Call unit.start() to activate it.");if(!zt(this._getViewState()))throw Error("Unit is not rendered yet. If you handle rendering by yourself, call unit.notifyViewUpdate() when DOM is ready.")}_isViewReady(){return this._hub.active&&zt(this._getViewState())}_getMisoId(){const t=this._getViewState();return t&&t.meta&&t.meta.miso_id||this._element&&this._element.getAttribute("miso-id")||void 0}getState(t){return Object.freeze(Object.assign({[Pt]:this._view.element?Ut:Tt},this._states.getFullState(t)))}_retireStates(){const{unbounds:t}=this._items.unbindAll();this._untrackViewables(t),this._states=void 0}_refreshItems(){if(!this._states)return;const{bounds:t,unbounds:e}=this._items.refresh();this._untrackViewables(e),this._trackImpressions(t),this._trackViewables(t)}_trackImpressions(t){if(!this._options.impression)return;const e=this._getMisoId();this._trigger(t.map((t=>t.productId)),Lt,{misoId:e})}_trackViewables(t){if(this._options.viewable)for(const e of t)this._trackViewableOnElement(e)}async _trackViewableOnElement(t){let{productId:e,element:s}=t;if(!e||!l(s)||this._viewables.has(s))return;const n=$t;if(this._states.get(e,n)!==Tt)return;this._states.set(e,n,Ut);const{area:i,duration:r}=this._options.viewable,o=this._getMisoId(),a=new AbortController,{signal:c}=a;this._viewables.set(s,{ac:a}),await m(s,{area:i,duration:r,signal:c}),this._viewables.delete(s),this._trigger([e],n,{misoId:o})}_untrackViewableOnElement(t){let{productId:e,element:s}=t;const n=this._viewables.get(s);if(!n)return;n.ac.abort(),this._viewables.delete(s);const i=$t;this._states.get(e,i)===Ut&&this._states.set(e,i,Tt)}_untrackViewables(t){for(const e of t)this._untrackViewableOnElement(e)}_syncElement(){const{element:t}=this._view;this._element!==t&&(this._retireElement(),t&&this._options.watch&&(this._mutationObserver=new MutationObserver((()=>this.refresh())),this._mutationObserver.observe(t,{childList:!0,subtree:!0})),this._element=t)}_retireElement(){this._element&&(this._mutationObserver&&(this._mutationObserver.disconnect(),this._mutationObserver=void 0),this._element=void 0)}_handleClick(t){const e=this._options&&this._options.click;if(!e||!this._isViewReady())return;const s=h(t.target,(t=>this._items.get(t)));if(!s)return;const{productId:n}=s;if(!e.lenient){if(0!==t.button)return;if(t.defaultPrevented)return;if(!h(t.target,(t=>"A"===t.tagName&&t.href||void 0)))return}const i=this._getMisoId();this._trigger([n],Pt,{misoId:i})}_trigger(t,s){let{manual:n=!1,misoId:i}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Ot(s),this._isViewReady()&&0!==(t=this._states.untriggered(e(t),s)).length&&(this._states.set(t,s,qt),this._hub.trigger("interaction",this._buildInteraction({type:s,productIds:t,manual:n,misoId:i})))}_buildInteraction(t){let e,{type:s,productIds:i,manual:r,misoId:o}=t;if(o)try{e=function(t){const e=t.split("-"),s=""+e[2].substring(1)+e[1]+e[0];return Math.floor(parseInt(s,16)/1e7)-12219292800}(o)}catch(t){}return n({type:"viewable"===s?"viewable_impression":s,product_ids:i,miso_id:o,context:{custom_context:n({api_ts:e,trigger:r?"manual":"auto"})}})}_destroy(){this._retireElement(),this._retireStates(),this._items._destroy();for(const t of this._unsubscribes)t();this._unsubscribes=[]}}class Vt{static NEW={[Lt]:Tt,[$t]:Tt};static UNTRACKED=Object.freeze({[Lt]:Tt,[$t]:Tt,[Pt]:Tt});constructor(t){this.uuid=t,this._states=new Map}getFullState(t){const e=this._states.get(t);return e?Object.assign({},e):Vt.UNTRACKED}get(t,e){const s=this._states.get(t);return s&&s[e]||Tt}set(t,s,n){Ot(s),function(t){if(t!==Et.UNTRACKED&&t!==Et.TRACKING&&t!==Et.TRIGGERED)throw Error("Unrecognized tracking status: "+t)}(n);for(const i of e(t))this._setOne(i,s,n)}_setOne(t,e,s){(function(t,e,s){if(t.has(e))return t.get(e);const n=s(e);return t.set(e,n),n}(this._states,t,(()=>Object.assign({},Vt.NEW))))[e]=s}untriggered(t,e){return t.filter((t=>this.get(t,e)!==qt))}}class Ft{constructor(t){this._hub=t,this._unsubscribes=[t.on("feedback",(t=>this._trigger(t)))]}_trigger(t){const{[_t()]:e}=this._hub.states,{question_id:s}=e&&e.value||{};s&&this._hub.trigger("interaction",this._buildInteraction(s,t))}_buildInteraction(t,e){let{value:s,unselected:n}=e;return{type:"feedback",context:{custom_context:{result_type:"answer",question_id:t,value:n?"unselected":s}}}}_destroy(){for(const t of this._unsubscribes)t();this._unsubscribes=[]}}class Wt{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._client=e,this.config(s),this._unsubscribes=[t.on("interaction",(t=>this._send(t)))]}config(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(t.preprocess&&"function"!=typeof t.preprocess)throw Error("preprocess must be a function");this._options=t}_send(t){t=e(t);const{preprocess:s}=this._options;s&&(t=t.map(s)),t.length>0&&this._client.api.interactions.upload(t,{merge:!0})}destroy(){for(const t of this._unsubscribes)t();this._unsubscribes=[]}}function Qt(t){return Object.assign({},t,{_meta:{answer_stage:t.answer_stage}})}function Gt(t){return async e=>{let{group:s,name:n,payload:i,options:r}=e;if("ask"===s)if("questions"===n){const{signal:e}=r||{},o=await t.api[s][n](i,r);return e&&e.addEventListener&&e.addEventListener("abort",(()=>o.abort(e.reason))),async function*(t,e){for await(const s of t)yield e(s)}(o,Qt)}return function(t){const{miso_id:e}=t;return{_meta:{miso_id:e},[yt.RESULTS]:t.products}}(await t.api[s]._run(n,i,r))}}const Kt=["role"];class Ht{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{role:e}=t;r(this,{role:e,options:function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,Kt)}),this._unsubscribes=[],this._rendered=new WeakMap,this._element=void 0,this._notifyUpdate=void 0,this._pending=void 0}async render(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._syncElement(t);const n=this._rendered.get(t),i=b(!1);e=this._preprocess({state:e,rendered:n},{skip:i.t})||e,this._updatePending(e,s),i.value||this._handleInput({state:e,rendered:n},s)}_syncElement(t){this._element!==t&&this._rendered.delete(this._element),this._element=t}_preprocess(t){let{state:e}=t;return e}_updatePending(t,e){this._pending=[Object.freeze(t),e]}_takePending(){const t=this._pending;return this._pending=void 0,t}_handleInput(){this._requestRaf()}_requestRaf(){this._requested||(this._requested=!0,p((()=>this._doRaf())))}_doRaf(){this._requested&&(this._requested=!1,this._applyRender())}_applyRender(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this._pending)return;const e=Date.now();let[s,{notifyUpdate:n}]=this._takePending();s=Object.freeze(Object.assign({},s,{timestamp:e}));const i=this._rendered.get(this._element),r=b([]),o=b({});this._render(this._element,{state:s,rendered:i,timestamp:e},Object.assign({notifyUpdate:r.args,writeToState:o.merge},t)),this._rendered.set(this._element,Object.freeze(Object.assign({},s,o.value))),n&&n(...r.value)}_render(){throw Error("Unimplemented")}destroy(){for(const t of this._unsubscribes)t();this._unsubscribes=[],this._element=void 0,this._notifyUpdate=void 0,this._pending=void 0}}function Yt(){for(var t=arguments.length,e=Array(t),s=0;t>s;s++)e[s]=arguments[s];return e.reduce(((t,e)=>(t[e]=Zt(e),t)),{})}function Zt(t){return()=>{throw Error(`Template '${t}' is not implemented.`)}}const Jt=["className","templates"];class Xt extends Ht{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e,templates:s}=t;super(function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,Jt)),r(this,{className:e,templates:Object.assign({},Yt("root"),s)})}_preprocess(t){let{state:e}=t;const s=this.templates.root(this,e);return Object.assign({},e,{html:s})}_render(t,e){let{state:s}=e;t.innerHTML=s.html}}class te extends HTMLElement{static get tagName(){return"miso-banner"}async connectedCallback(){te.MisoClient.ui.layouts.create("banner").render(this)}}const ee=["logo"];class se extends Ht{static get category(){return vt.CONTAINER}static get type(){return"container"}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{logo:e="auto"}=t,s=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,ee);super(Object.assign({logo:e},s))}_render(t,e){let{state:s}=e;this._syncBanner(t),this._syncStatus(t,{state:s})}_syncBanner(t){const e=te.tagName,s=this._shallRenderBanner(t),n=t.querySelector(e);s&&!n?t.insertAdjacentHTML("beforeend",`<${e} visible-when="ready"></${e}>`):!s&&n&&n.remove()}_shallRenderBanner(t){const{logo:e}=this.options,{logo:s}=t,n=void 0!==s&&"auto"!==s?s:e;return"auto"===n?t.components.some((t=>{let{role:e}=t;return e===yt.RESULTS||e===yt.ANSWER})):!!n}_syncStatus(t,e){let{state:s}=e;if(!t)return;const{status:n,meta:{miso_id:i}={}}=s;t.setAttribute("status",n),i?t.setAttribute("miso-id",i):t.removeAttribute("miso-id")}}const ne='<svg viewBox="0 0 16 16"><path d="M8.342 3.652 4.979 5.708a1 1 0 0 0-.479.852v5.561a1 1 0 0 0 .87.992l6.029.79a1 1 0 0 0 1.042-.583l2.534-5.65a1 1 0 0 0-.74-1.394l-3.543-.623.9-3.1A2.097 2.097 0 0 0 10.297 0L8.719 3.237a1 1 0 0 1-.377.415ZM1 6.5a1.5 1.5 0 0 1 3 0v6a1.5 1.5 0 0 1-3 0Z"/></svg>',ie=["className","templates"];const re="miso-banner";const oe=Object.freeze({root:function(t){const{className:e,templates:s}=t;return`<div class="${e}"><div class="${e}__logo">${s.logo(t)}</div></div>`},logo:()=>'<svg viewBox="0 0 500 200"><path d="M131.1,39.4 C144.3,39.4 155,43.8 163.2,52.7 C171.3,61.3 175.2,72.9 175.2,87.6 L175.2,159.1 L140.4,159.1 L140.4,90.6 C140.4,78.7 134.6,71.5 123.7,71.5 C112.3,71.5 105.5,79.7 105.5,93.4 L105.5,159.1 L70.7,159.1 L70.7,90.6 C70.7,78.7 64.9,71.5 54,71.5 C42.6,71.5 35.8,79.7 35.8,93.4 L35.8,159.1 L1,159.1 L1,42.7 L35.8,42.7 L35.8,53.4 C42.1,44.1 52.6,39.4 67,39.4 C80.5,39.4 90.7,44.5 97.4,54.8 C104.6,44.5 115.8,39.4 131.1,39.4 Z M202,42.4 L238.4,42.4 L238.4,159.1 L202,159.1 Z M202,0 L238.4,0 L202,36.4 Z M302.6,76.6 C302.6,81.2 311.7,83.8 323,86.8 C339.2,90.3 360.5,98.7 360.3,124 C360.3,136.6 355.6,146.1 346.2,152.6 C336.8,158.9 325.3,162.1 311.5,162.1 C286.9,162.1 270,152.8 261.1,134.5 L291.6,117.3 C294.6,126.3 301.4,131 311.5,131 C319.9,131 324.2,128.7 324.2,123.8 C324.2,119.1 315,116.3 303.8,113.5 C287.6,109.1 266.5,101.2 266.5,77.5 C266.5,65.4 270.9,56.1 279.6,49.4 C288.5,42.6 299.5,39.4 312.4,39.4 C331.9,39.4 348.6,48.2 358.2,64.3 L328.2,80.3 C324.4,73.6 319.2,70.1 312.4,70.1 C305.9,70.1 302.6,72.2 302.6,76.6 Z M480.4,144.5 C468.4,156.3 453.7,162.1 436.3,162.1 C419,162.1 404.2,156.3 392.2,144.5 C380.3,132.6 374.2,118 374.2,100.8 C374.2,83.6 380.3,69.1 392.2,57.3 C404.2,45.4 419,39.4 436.3,39.4 C453.7,39.4 468.4,45.4 480.4,57.3 C492.4,69.1 498.5,83.6 498.5,100.8 C498.5,118 492.4,132.6 480.4,144.5 Z M417.1,120.5 C422.2,125.6 428.6,128.2 436.3,128.2 C444.1,128.2 450.4,125.6 455.5,120.5 C460.7,115.4 463.3,108.9 463.3,100.8 C463.3,92.6 460.7,86.1 455.5,81 C450.4,75.9 444.1,73.3 436.3,73.3 C428.6,73.3 422.2,75.9 417.1,81 C411.9,86.1 409.3,92.6 409.3,100.8 C409.3,108.9 411.9,115.4 417.1,120.5 Z" /></svg>'});const ae=["templates"];const ce=Object.freeze({product:function(t,e,s){const[n,i]=function(t,e){let{className:s}=t,{product_id:n,url:i}=e;return[i?`<a class="${s}__item-body" data-miso-product-id="${n}" href="${i}" target="_blank" rel="noopener">`:`<div class="${s}__item-body">`,i?"</a>":"</div>"]}(t,s);return`${n}${function(t,e){let{className:s}=t,{cover_image:n}=e;if(!n)return"";return`<div class="${s}__item-cover-image-container"><img class="${s}__item-cover-image" src="${n}"></div>`}(t,s)}${function(t,e){let{className:s}=t,{title:n,snippet:i,description:r,sale_price:o,original_price:a}=e,c="";n&&(c+=`<div class="${s}__item-title">${n}</div>`);i?c+=`<div class="${s}__item-snippet">${i}</div>`:r&&(c+=`<div class="${s}__item-desc">${r}</div>`);const u=o||a;u&&(c+=`<hr><div class="${s}__item-price">${u}</div>`);return`<div class="${s}__item-info-container">${c}</div>`}(t,s)}${i}`},root:function(t,e){const{className:s,role:n,templates:i}=t,{status:r}=e;return`<div class="${s} ${r}" ${n?`data-role="${n}"`:""}>${r===kt.READY?i[r](t,e):""}</div>`},[kt.READY]:function(t,e){const{templates:s}=t,n=e.value;return n&&n.length>0||e.ongoing?s.list(t,e,"product",n):s.empty(t,e)},empty:()=>"",list:function(t,e,s,n){const{className:i,templates:r}=t;return`<ul class="${i}__list" data-item-type="${s}">${r.items(t,e,s,n)}</ul>`},items:function(t,e,s,n){const{templates:i}=t;let r=0;return n.map((n=>i.item(t,e,s,n,r++))).join("")},item:function(t,e,s,n,i){const{className:r,templates:o}=t;return`<li class="${r}__item">${o[s](t,e,n,{index:i})}</li>`}});class ue extends Xt{static get category(){return vt.LIST}static get defaultTemplates(){return ce}constructor(t){let{templates:e}=t,s=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,ae);super(Object.assign({templates:Object.assign({},ce,e)},s))}_preprocess(t){let{state:e,rendered:s}=t;const n=this._shallRenderIncrementally(e,s),i=this._html(e,s,n);return Object.assign({},e,{incremental:n,html:i})}_html(t,e,s){if(s){const s=t.value.slice(e.value.length);return s.length>0?this.templates.items(this,t,"product",s):""}return this.templates.root(this,t)}_render(t,e,s){let{state:n}=e,{notifyUpdate:i}=s;const{incremental:r,html:o}=n;if(r)if(o){this._getListElement(t).insertAdjacentHTML("beforeend",o)}else i(!1);else t.innerHTML=o}_shallRenderIncrementally(t,e){return this.options.incremental&&e&&e.value&&e.value.length>0&&t.status===kt.READY&&e.status===kt.READY&&t.session&&e.session&&t.session.id===e.session.id}_getListElement(t){return t.querySelector(`.${this.className}__list`)}}const le=["className"];const he="miso-list";class de extends ue{static get category(){return super.category}static get type(){return"list"}static get defaultTemplates(){return super.defaultTemplates}static get defaultClassName(){return he}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=he}=t,s=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,le);super(Object.assign({className:e},s))}}const _e=["className"];const pe="miso-cards";const me=["className","templates"];const fe="miso-carousel",ge=Object.freeze({ready:function(t,e){const{templates:s}=t,n=e.value&&e.value.length>0,i=Object.getPrototypeOf(t.constructor).defaultTemplates.ready(t,e);return n?s.carousel(t,e,i):i},carousel:function(t,e,s){const{className:n,templates:i}=t;return`<div class="${n}__control-previous">${i.previous(t,e)}</div><div class="${n}__viewport">${s}</div><div class="${n}__control-next">${i.next(t,e)}</div>`},previous:ye,next:ye}),be=Object.freeze(Object.assign({},ue.defaultTemplates,ge));function ye(t){const{className:e}=t;return`<svg class="${e}__control-button" shape-rendering="geometricPrecision" stroke="currentColor" stroke-width="24" fill="#fff" viewBox="-30 -30 358 572"><path d="M285.77 441c16.24 16.17 16.32 42.46.15 58.7-16.16 16.24-42.45 16.32-58.69.16l-215-214.47c-16.24-16.16-16.32-42.45-.15-58.69L227.23 12.08c16.24-16.17 42.53-16.09 58.69.15 16.17 16.24 16.09 42.54-.15 58.7l-185.5 185.04L285.77 441z"/></svg>`}const ve=["className","templates"];const we="miso-search-box";const Ee=Object.freeze({root:function(t){const{className:e,role:s,templates:n,options:i}=t,{autocomplete:r,placeholder:o,buttonText:a="Search"}=i;return`\n<div class="${e}" ${s?`data-role="${s}"`:""}>\n  <div class="${e}__input-group">\n    <input class="${e}__input" type="text" data-role="input" ${o?`placeholder="${o}"`:""}>\n    <button class="${e}__button" type="submit">${a}</button>\n  </div>\n  ${r?n.autocomplete(t):""}\n</div>\n`},autocomplete:function(t){const{className:e,templates:s}=t;return`\n<div class="${e}__autocomplete" data-role="autocomplete">\n  ${s.suggestionList(t)}\n</div>\n`},suggestionList:function(t){const{className:e}=t;return`<ol class="${e}__suggestion-list" data-role="suggestion-list"></ol>`},suggestionItem:function(t,e){let{text:s}=e;const{className:n}=t;return`<li class="${n}__suggestion-item" data-role="suggestion-item" tabindex="0">${s}</li>`}});class ke extends Xt{static get category(){return vt.QUERY}static get type(){return"search-box"}static get defaultTemplates(){return Ee}static get defaultClassName(){return we}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=we,templates:s}=t,n=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,ve);super(Object.assign({className:e,templates:Object.assign({},Ee,s)},n)),this._contexts=new WeakMap,this._suggestionItems=new WeakMap}initialize(t){const{autocomplete:e}=this.options;this._view=t;const{proxyElement:s,hub:n}=t;this._unsubscribes=[...this._unsubscribes,s.on("keydown",(t=>this._handleKeyDown(t))),s.on("click",(t=>this._handleClick(t)))],e&&this._unsubscribes.push(n.on("suggestions",(()=>this._handleInput())))}_preprocess(t){let{state:e}=t;e=super._preprocess({state:e});const{autocomplete:s}=this.options;if(!s)return e;return Object.assign({},e,{suggestions:this._view.hub.states.suggestions})}_render(t,e,s){0===t.childElementCount&&super._render(t,e,s),this._setupAutocomplete(t),this._renderSuggestions(t,e,s)}_setupAutocomplete(t){const{autocomplete:e}=this.options;e&&this._context(t).setupAutocomplete()}_renderSuggestions(t,e){let{state:s}=e,{writeToState:n}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{autocomplete:i}=this.options;if(!i)return;const{suggestionListElement:r,autocompleteElement:o}=this._context(t);if(!r)return void(n&&n({suggestions:{value:[]}}));const{suggestions:a={}}=s,c=a.value||[];o.classList[0===c.length?"add":"remove"]("empty"),r.innerHTML=c.map((t=>this.templates.suggestionItem(this,t))).join("");let u=0;for(const t of r.children)this._suggestionItems.set(t,c[u++])}_context(t){if(!(t=t||this._view.element))return Oe.empty();let e=this._contexts.get(t);return e||this._contexts.set(t,e=new Oe(t)),e}_handleKeyDown(t){let{key:e,target:s,isComposing:n}=t;!n&&"Enter"===e&&s.matches("input")&&(this._submit(s.value),s.blur())}_handleClick(t){let{target:e}=t;if(e.matches('[type="submit"]')){const{inputElement:t}=this._context();return void(t&&(t.blur(),this._submit(t.value)))}const{autocomplete:s}=this.options;if(s)for(let t=e;t&&t!==this._view.element;t=t.parentElement){const e=this._suggestionItems.get(t);if(!e)continue;const{inputElement:s}=this._context();return s&&(s.value=e.text),void this._submit(e.text)}}async _submit(t){t&&this._view.hub.trigger("query",{q:t})}}class Oe{static empty(){return Oe._empty||(Oe._empty=new Oe)}constructor(t){this._element=t,this._cache={}}get inputElement(){return this._get("input")}get autocompleteElement(){return this._get("autocomplete")}get suggestionListElement(){return this._get("suggestion-list")}setupAutocomplete(){if(!this._element||this._autocompleteSetup)return;this._autocompleteSetup=!0;const{inputElement:t,autocompleteElement:e}=this;t&&e&&(t.addEventListener("focus",(()=>{e.classList.add("open")})),t.addEventListener("blur",(()=>{e.classList.remove("open")})))}_get(t){return this._element?this._cache[t]||(this._cache[t]=this._element.querySelector(`[data-role="${t}"]`)):void 0}}const xe=["className","templates","field","defaultValue"];const Ie=Object.freeze(Object.assign({},Yt("options"),{root:function(t){const{className:e,role:s,templates:n}=t;return`\n<div class="${e}" ${s?`data-role="${s}"`:""}>\n  ${n.options(t)}\n</div>\n`},option:function(t,e){const{className:s,templates:n}=t;return`\n<div role="button" class="${s}__option" data-value="${e.value}">\n  ${n.content(t,e)}\n</div>\n`}}));class Ce extends Xt{static get category(){return vt.RADIO}static get defaultTemplates(){return Ie}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e,templates:s,field:n,defaultValue:i}=t,r=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,xe);super(Object.assign({className:e,templates:Object.assign({},Ie,s)},r)),this._field=n,this._defaultValue=i}initialize(t){const{proxyElement:e}=this._view=t;this._unsubscribes=[...this._unsubscribes,t.hub.on(this._field,(()=>this._refresh())),e.on("click",(t=>this._handleClick(t)))],this._defaultValue?this._select(this._defaultValue):this._clear()}_preprocess(t,e){return t.rendered&&e.skip(),super._preprocess(t,e)}_handleClick(t){let{target:e}=t;const s=h(e,(t=>t.hasAttribute("data-value")?t:void 0));if(!s)return;let{unselected:n,value:i}=this._view.hub.states[this._field];n=n||void 0===i;const r=s.getAttribute("data-value");n||void 0===i||i!==r?this._select(r):this._clear()}_refresh(){this._state=this._view.hub.states[this._field],p((()=>this._syncValueAttribute()))}_syncValueAttribute(){if(!this._state)return;const{element:t}=this._view,e=t&&t.children[0];if(!e)return;let{unselected:s,value:n}=this._state;s?e.removeAttribute("data-selected"):e.setAttribute("data-selected",n),this._state=void 0}_select(t){this._submit({value:t})}_clear(){this._submit({unselected:!0})}async _submit(t){this._view.hub.update(this._field,t)}}const je=["className","templates"];const Re="miso-feedback",Ae=[{text:"Helpful",value:"helpful",icon:ne},{text:"Not helpful",value:"unhelpful",icon:ne}];const Ne=Object.freeze({options:function(t){const{templates:e}=t;return Ae.map((s=>e.option(t,s))).join("")},content:function(t,e){let{text:s,icon:n}=e;const{className:i,options:r={}}=t;return`\n${!1!==r.icon?`<i class="${i}__icon">${n}</i>`:""}\n${!1!==r.text?`<span class="${i}__text">${s}</span>`:""}\n`}});class Se extends Ce{static get category(){return super.category}static get type(){return"feedback"}static get defaultTemplates(){return Ne}static get defaultClassName(){return Re}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=Re,templates:s}=t,n=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,je);if(super(Object.assign({className:e,templates:Object.assign({},Ne,s),field:"feedback"},n)),!1===n.text&&!1===n.icon)throw Error("At least one of options.text or options.icon must be enabled")}}const Le=["className","templates","tag"];const $e="miso-text";const Pe=Object.freeze({root:function(t,e){const{className:s,role:n,options:{tag:i}}=t;return`<${i} class="${s}" ${n?`data-role="${n}"`:""}>${e.value||""}</${i}>`}});class Te extends Xt{static get category(){return vt.TEXT}static get type(){return"text"}static get defaultTemplates(){return Pe}static get defaultClassName(){return $e}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=$e,templates:s,tag:n="p"}=t,i=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,Le);super(Object.assign({className:e,templates:Object.assign({},Pe,s),tag:n},i))}}class Ue extends Ht{constructor(t){super(t)}_takePending(){return this._pending}_applyRender(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=b(!1);super._applyRender(Object.assign({},t,{loop:e.t})),e.value&&this._requestRaf()}}class qe{constructor(){let{cps:t=75}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._options={cps:t}}get(t,e){const s=this._cps(e);return t.cursor+Math.floor((e.timestamp-t.timestamp)*s/1e3)}_cps(t){let{doneAt:e,timestamp:s}=t,n=this._options.cps*(Math.random()+.5);return void 0!==e&&(n*=(s-e)/250),n}}class Me{clear(t){return t.innerText="",{cursor:0,done:!1}}update(t,e,s){let{value:n,cursor:i}=e,{value:r,cursor:o,done:a}=s;const c=r.length;o=Math.min(o,c);const u=!!a&&o===c,l=n.substring(0,i),h=!r.startsWith(l);return u||h?t.innerText=r:t.insertAdjacentText("beforeend",r.substring(i,o)),u&&t.classList.add("done"),{cursor:o,done:u}}}function ze(t,e,s){let{status:n}=s;if(!e)return;0===e.children.length&&(e.innerHTML=function(t){let{className:e,role:s,options:{tag:n,format:i,builtInStyles:r=!0}}=t;"auto"===n&&(n="markdown"===i?"div":"p");const o=s?`data-role="${s}"`:"",a=[e,De(e)];r&&"markdown"===i&&a.push("miso-markdown");return`<${n} class="${a.join(" ")}" ${o} data-format="${i}"></${n}>`}(t));const i=e.children[0];return i.setAttribute("data-status",n||kt.INITIAL),i}function De(t){return t+"__cursor"}const Be=["className","cps","tag","format"];const Ve="miso-typewriter";class Fe extends Ue{static get category(){return vt.TEXT}static get type(){return"typewriter"}static get defaultClassName(){return Ve}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=Ve,cps:s,tag:n="auto",format:i="markdown"}=t,o=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,Be);super(Object.assign({cps:s,tag:n,format:i},o)),r(this,{className:e}),this._prevState=void 0,this._progress=new qe({cps:s}),this._readiness=new v,"markdown"===i&&MisoClient.plugins.install("std:ui-markdown")}initialize(t){this._view=t,this._setup()}async _setup(){try{if("plaintext"===this.options.format)await this._setupForPlaintext();else await this._setupForMarkdown();this._readiness.resolve()}catch(t){this._readiness.reject(t)}}async _setupForMarkdown(){const t=await this._view._views._extensions.require("markdown"),e=De(this.className);this._renderer=t.createRenderer({onRefChange:(t,s)=>{t&&t.classList.remove(e),s&&s.classList.add(e)},onDone:t=>{t.classList.add("done")}})}async _setupForPlaintext(){this._renderer=new Me}async _ready(){return this._readiness.promise}async render(){await this._ready(),await super.render(...arguments)}_preprocess(t){let{state:e}=t;const s=this._prevState,{value:i="",meta:r,session:o,status:a,ongoing:c}=e,u=r&&r.answer_stage||"result",l=(d=e,(h=s)&&d&&h.session&&d.session&&h.session.uuid===d.session.uuid);var h,d;const _=s?l&&u===s.stage?s.streak:s.streak+1:0,p=l&&s&&s.doneAt||(a!==kt.READY||c?void 0:Date.now());return this._prevState=Object.freeze(n({session:o,status:a,value:i,stage:u,streak:_,doneAt:p,done:void 0!==p}))}_render(t,e,s){let{state:n,rendered:i}=e,{notifyUpdate:r,writeToState:o,loop:a}=s;const c=ze(this,t,n);let u;if(i&&n.streak===i.streak){const t=this._progress.get(i,n);u=this._renderer.update(c,i,Object.assign({},n,{cursor:t}))}else u=this._renderer.clear(c,i);o(u);const l=n.status===kt.READY&&!u.done;r({ongoing:l},{silent:l&&(!i||i.status===kt.READY)}),l&&a()}}var We=Object.freeze({__proto__:null,TemplateBasedLayout:Xt,ContainerLayout:se,BannerLayout:class extends Xt{static get category(){return vt.BANNER}static get type(){return"banner"}static get defaultTemplates(){return oe}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=re,templates:s}=t,n=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,ie);super(Object.assign({className:e,templates:Object.assign({},oe,s)},n))}},CollectionLayout:ue,ListLayout:de,CardsLayout:class extends ue{static get category(){return super.category}static get type(){return"cards"}static get defaultTemplates(){return super.defaultTemplates}static get defaultClassName(){return pe}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=pe}=t,s=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,_e);super(Object.assign({className:e},s))}},CarouselLayout:class extends ue{static get category(){return super.category}static get type(){return"carousel"}static get defaultTemplates(){return be}static get defaultClassName(){return fe}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{className:e=fe,templates:s}=t,n=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(t,me);super(Object.assign({className:e,templates:Object.assign({},ge,s)},n)),window.addEventListener("resize",this.syncSize=this.syncSize.bind(this)),this._page=0,this._unsubscribes=[]}initialize(t){const{proxyElement:e}=this._view=t;this._unsubscribes.push(e.on("click",this._onClick.bind(this)))}_render(t,e,s){super._render(t,e,s);const{state:n}=e;this._itemCount=n.value?n.value.length:void 0,this.syncSize()}get page(){return this._page}get pageSize(){return this._pageSize}next(){this._setPage(this._page+1)}previous(){this._setPage(this._page-1)}syncSize(){if(void 0===this._itemCount)return;const t=this._findGridElement();if(!t)return;const e=void 0===this._pageSize?0:this._page*this._pageSize,s=this._pageSize=window.getComputedStyle(t).getPropertyValue("grid-template-columns").split(" ").length;this._pageCount=Math.ceil(this._itemCount/this._pageSize),this._setPage(Math.floor(e/s))}_setPage(t){if(0>t?t=this._pageCount-1:this._pageCount>t||(t=0),t===this._page)return;this._page=t;const e=this._findGridElement();if(e){e.style.setProperty("grid-template-rows",(0===t?"":`repeat(${t}, 0)`)+" 1fr repeat(10, 0)")}}_findGridElement(){const{element:t}=this._view;return t&&t.querySelector(`.${this.className}__list`)}_onClick(t){for(let e=t.target;e;e=e.parentElement){if(e.classList.contains(this.className+"__control-previous"))return void this.previous();if(e.classList.contains(this.className+"__control-next"))return void this.next()}}destroy(){window.removeEventListener("resize",this.syncSize),this._view=void 0}},SearchBoxLayout:ke,FeedbackLayout:Se,TextLayout:Te,TypewriterLayout:Fe});function Qe(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Object.freeze(Object.assign({},t,e,{payload:Object.freeze(Object.assign({},t.payload,e.payload))}))}function Ge(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return!1!==e&&Object.freeze(Object.assign({},t,e,{preprocess:Ke(t.preprocess,e.preprocess)}))}function Ke(t,e){return t?e?function(){return e(t(...arguments))}:t:e}function He(t){let[s,n]=e(t);return"object"==typeof s&&(n=s,s=void 0),[s,n]}class Ye extends S{constructor(t,e,s){var n;let{name:i,roles:r,layouts:o={},defaultApiParams:a,interactionsOptions:c}=s;super(i||"workflow",t),n=this,this._plugin=t,this._client=e,this._name=i,this._roles=r;const u=t._getExtensions(e);this._defaultLayouts=Object.assign({[yt.CONTAINER]:se.type},o),this._apiParams=this._defaultApiParams=a,this._defaultInteractionsOptions=c=Ge({preprocess:t=>this._preprocessInteraction(t)},c);const l=this._hub=function(t,e){const{update:s,trigger:n}=t;return t.update=(n,i,r)=>(r&&r.silent||e("update",n,i,r),s.call(t,n,i,r)),t.trigger=function(){for(var s=arguments.length,i=Array(s),r=0;s>r;r++)i[r]=arguments[r];return e("trigger",...i),n.apply(t,i)},t}(new dt,(function(){return n._log(...arguments)}));this._sessions=new mt(l),this._data=new ft(l),this._views=new Rt(l,u,{roles:r,layouts:this._generateLayoutFactoryFunctions(this._defaultLayouts)}),this._interactions=new Wt(l,e,c),this._unsubscribes=[],this._data.source=Gt(this._client)}get uuid(){return this.session&&this.session.uuid}get session(){return this._hub.states.session}get active(){const{session:t}=this;return!!t&&t.active}get states(){return this._hub.states}reset(){return this._sessions.new(),this}start(){return this._sessions.start(),this}restart(){return this.reset(),this.start(),this}updateData(t){if(!t)throw Error("Data is required.");const{session:e}=t;if(!e)throw Error("Session is required to update data.");if(!this.session)throw Error("No session is created yet. Call workflow.restart() to start a new session.");if(e.uuid===this.session.uuid)return this._sessions.start(),t=this._postProcessData(t),this._hub.update(_t(),t),this}_postProcessData(t){return t}notifyViewUpdate(t,e){return this._assertActive(),e=Object.assign({status:kt.READY,session:this.session},e),this._hub.update(pt(t),e),this}useApi(t,e){return!1===t?this._data.source=!1:this._apiParams=Qe(this._defaultApiParams,{name:t,payload:e}),this}useLayouts(t){return this._views.layouts=this._generateLayoutFactoryFunctions(t),this}_generateLayoutFactoryFunctions(t){const e={};for(const[s,n]of Object.entries(t)){if(!1===n){e[s]=()=>!1;continue}let[t,i]=He(this._defaultLayouts[s]),[r,o]=He(n);if(r=r||t,o=Object.assign({},i,o),!r)throw Error("Layout name is required for role "+s);e[s]=t=>this._plugin.layouts.create(r,Object.assign({},o,t,{role:s}))}return e}useInteractions(t){return this._interactions.config(Ge(this._defaultInteractionsOptions,t)),this}_preprocessInteraction(t){return t}destroy(){this._events.emit("destroy"),this._destroy()}_destroy(){for(const t of this._unsubscribes||[])t();this._unsubscribes=[],this._views.destroy(),this._data.destroy()}_log(t,e,s){this._events.emit(e,Object.assign({_action:t},s))}_assertActive(){if(!this.active)throw Error("Unit is not active yet. Call unit.start() to activate it.")}}const Ze=["q"],Je=["value"];function Xe(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}const ts=Object.freeze({group:"ask",name:"questions",payload:{source_fl:["cover_image"],related_resource_fl:["cover_image"]}}),es=Object.freeze({[yt.QUERY]:[ke.type,{buttonText:"Ask"}],[yt.QUESTION]:[Te.type,{tag:"h2"}],[yt.ANSWER]:Fe.type,[yt.FEEDBACK]:Se.type,[yt.SOURCES]:[de.type,{incremental:!0}],[yt.RELATED_RESOURCES]:[de.type,{incremental:!0}]});function ss(t){return t?Object.assign({},es,{[yt.QUERY]:[ke.type,{buttonText:"Ask",autocomplete:!0}]}):es}class ns extends Ye{constructor(t,e){super(t._plugin,t._client,{name:"ask",roles:Object.keys(es),layouts:ss(e),defaultApiParams:ts}),r(this,{parentQuestionId:e}),this._context=t,this._setFollowUpQuestions(),this._feedback=new Ft(this._hub),this._unsubscribes=[...this._unsubscribes,this._hub.on("query",(t=>this.query(t))),this._hub.on(_t(),(t=>this._onDataUpdate(t))),this._hub.on(pt(yt.ANSWER),(t=>this._onAnswerViewUpdate(t)))],e&&t._byPqid.set(e,this),t._events.emit("create",this)}get questionId(){return this._questionId}get previous(){const{parentQuestionId:t}=this;return t?this._context.getByQuestionId(t):void 0}get next(){const{questionId:t}=this;return t?this._context.getByParentQuestionId(t):void 0}getOrCreateNext(){const{questionId:t}=this;return t?this._context.getByParentQuestionId(t,{autoCreate:!0}):void 0}query(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{q:e}=t,s=Xe(t,Ze);s=Object.assign({},s,{question:e}),this.parentQuestionId&&(s.parent_question_id=this.parentQuestionId),this._questionId&&(this._context._byQid.delete(this._questionId),this._questionId=void 0),this.restart();const{session:n}=this;return this._hub.update("input",Qe(this._apiParams,{payload:s,session:n})),this}restart(){const{session:t,status:e,ongoing:s}=this._hub.states[pt(yt.ANSWER)];if(t&&e!==kt.INITIAL&&(e!==kt.READY||s)){const n=Object.freeze({session:t,status:e,ongoing:s});this._events.emit("interrupt",n),this._events.emit("finally",n)}super.restart()}_postProcessData(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{value:e}=t,s=Xe(t,Je);e=Qt(e);return Object.assign({value:e,ongoing:e&&!e.finished},s)}_onDataUpdate(t){if(this._questionId)return;const e=t&&t.value&&t.value.question_id;e&&(this._questionId=e,this._context._byQid.set(e,this))}_onAnswerViewUpdate(t){let{session:e,status:s,ongoing:n}=t;if(s===kt.INITIAL)return;const i=s===kt.READY&&!n,r=s===kt.ERRONEOUS,o=i?"done":r?"error":s,a=Object.freeze({session:e,status:s,ongoing:n});this._events.emit(o,a),(i||r)&&this._events.emit("finally",a)}_setFollowUpQuestions(){const{previous:t}=this;if(!t)return;const e=(t.states[_t()].value.followup_questions||[]).map((t=>({text:t})));this._hub.update("suggestions",{value:e})}_destroy(){const{parentQuestionId:t,questionId:e}=this;t&&this._context._byPqid.delete(t),e&&this._context._byQid.delete(e),this._feedback._destroy(),super._destroy()}}class is extends S{constructor(t,e){super("asks",t),this._plugin=t,this._client=e,this._byQid=new Map,this._byPqid=new Map,this._root=new ns(this)}get root(){return this._root}get workflows(){return[this._root,...this._byPqid.values()]}getByQuestionId(t){if("string"!=typeof t)throw Error("Required ID to be a string: "+t);return this._byQid.get(t)}getByParentQuestionId(t){let{autoCreate:e=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(void 0===t)return this._root;if("string"!=typeof t)throw Error("Required ID to be a string: "+t);let s=this._byPqid.get(t);return!s&&e&&(s=new ns(this,t)),s}}const rs=Object.freeze({group:"search",name:"search",payload:{fl:["*"]}}),os=Object.freeze({[yt.QUERY]:ke.type,[yt.RESULTS]:de.type});class as extends Ye{constructor(t,e){super(t,e,{name:"search",roles:Object.keys(os),layouts:os,defaultApiParams:rs}),this._unsubscribes.push(this._hub.on("query",(t=>this.query(t))))}query(t){this.restart();const{session:e}=this;return this._hub.update("input",Qe(this._apiParams,{payload:t,session:e})),this}notifyViewUpdate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:yt.RESULTS;for(var e=arguments.length,s=Array(e>1?e-1:0),n=1;e>n;n++)s[n-1]=arguments[n];return super.notifyViewUpdate(t,...s),this}}const cs=["custom_context"],us=["context"];function ls(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}const hs=Object.freeze({group:"recommendation",name:"user_to_products",payload:{fl:["*"]}}),ds=Object.freeze({[yt.RESULTS]:de.type});class _s extends Ye{constructor(t,e){super(t._plugin,t._client,{name:"recommendation",roles:Object.keys(ds),layouts:ds,defaultApiParams:hs}),this._tracker=new Bt(this._hub,this._views.get(yt.RESULTS)),r(this,{id:e}),this._context=t,t._members.set(e,this)}get tracker(){return this._tracker}start(){this._sessions.start();const{session:t}=this;return this._hub.update("input",Object.assign({},this._apiParams,{session:t})),this}startTracker(){return this.useApi(!1),this.useLayouts({[yt.RESULTS]:!1}),this._sessions.start(),this.notifyViewUpdate(yt.RESULTS),this}notifyViewUpdate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:yt.RESULTS;for(var e=arguments.length,s=Array(e>1?e-1:0),n=1;e>n;n++)s[n-1]=arguments[n];return super.notifyViewUpdate(t,...s),this}useTracker(t){return this._tracker.config(t),this}_preprocessInteraction(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{context:{custom_context:e}={}}=t,s=ls(t.context,cs),n=ls(t,us);const{uuid:i,id:r}=this;return Object.assign({},n,{context:Object.assign({},s,{custom_context:Object.assign({unit_id:r,unit_instance_uuid:i},e)})})}_destroy(){this._context._members.delete(this.id),this._tracker._destroy(),super._destroy()}}class ps{constructor(t,e){this._plugin=t,this._client=e,this._members=new Map}workflows(){return[...this._members.values()]}create(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bt;if(this._members.has(t))throw Error("Unit already exists: "+t);return new _s(this,t)}has(){return this._members.has(arguments.length>0&&void 0!==arguments[0]?arguments[0]:bt)}get(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:bt;if("string"!=typeof t)throw Error("Required unit ID to be a string: "+t);return this._members.get(t)||new _s(this,t)}}class ms extends L{constructor(t){super("layouts",t,{libName:"layout",keyName:t=>t.type}),this._plugin=t}get(t){return this._libraries[t]}create(t,e){if(!1!==t)switch(typeof t){case"function":return{render:t};case"string":const s=this.get(t);if(!s)throw Error(`Layout of name '${t}' not found.`);return new s(e);default:throw Error("Expect a string, a render function, or boolean value false: "+t)}}}let fs,gs,bs;async function ys(t){const e=await async function(t){return t.MisoClient||window.MisoClient||fs||(fs=async function(){return new Promise((t=>{(window.misocmd||(window.misocmd=[])).push((()=>t(window.MisoClient)))}))}())}(t);var s;return gs=gs||e.any(),bs=bs||await gs,bs.ui||await(s=0,new Promise((t=>setTimeout(t,s)))),bs}const vs="logo",ws="auto",Es=Object.freeze([vs]);function ks(t){if(!t)return ws;switch(t){case"true":return!0;case"false":return!1;default:throw Error(`Invalid logo attribute value: ${t}.`)}}class Os extends HTMLElement{static get observedAttributes(){return Es}constructor(){super(),this._workflow=void 0,this._components=new Set}get isContainer(){return!0}get workflow(){return this._workflow}get logo(){return ks(this.getAttribute(vs))}set logo(t){if(this.logo===t)return;const e=function(t){switch(t){case ws:return;case!0:return"true";case!1:return"false";default:throw Error(`Invalid logo property value: ${t}.`)}}(t);e?this.setAttribute(vs,e):this.removeAttribute(vs)}async connectedCallback(){const t=this._client=await ys(Os);document.body.contains(this)&&this._setWorkflow(this._getWorkflow(t))}disconnectedCallback(){this._setWorkflow(void 0)}_getWorkflow(t){throw Error("Unimplemented")}_setWorkflow(t){this._workflow!==t&&(this._workflow&&this._workflow._views.removeContainer(this),t&&t._views.addContainer(this),this._workflow=t)}attributeChangedCallback(t,e,s){if(t===vs)this._handleLogoUpdate(e,s)}_handleLogoUpdate(t,e){ks(t)!==ks(e)&&this._workflow&&this._workflow._views.refreshElement(this)}get components(){return[...this._components]}_addComponent(t){this._components.has(t)||(this._components.add(t),this._workflow&&this._workflow._views.addComponent(t))}_removeComponent(t){this._components.has(t)&&(this._workflow&&this._workflow._views.removeComponent(t),this._components.delete(t))}_updateComponentRole(t,e,s){this._workflow&&this._workflow._views.updateComponentRole(t,e,s)}}const xs="parent-question-id",Is=Object.freeze([...Os.observedAttributes,xs]);const Cs="unit-id",js=Object.freeze([...Os.observedAttributes,Cs]);var Rs=Object.freeze({__proto__:null,MisoAskElement:class extends Os{static get tagName(){return"miso-ask"}static get observedAttributes(){return Is}_getWorkflow(t){return this._getWorkflowByParentQuestionId(t,this.parentQuestionId)}_getWorkflowByParentQuestionId(t,e){return t.ui.asks.getByParentQuestionId(e,{autoCreate:!0})}get parentQuestionId(){return this.getAttribute(xs)||void 0}set parentQuestionId(t){(t=void 0!==t?""+t:void 0)!==this.parentQuestionId&&(t?this.setAttribute(xs,t):this.removeAttribute(xs))}set workflow(t){this._setWorkflow(t),this.parentQuestionId=t&&t.parentQuestionId}attributeChangedCallback(t,e,s){if(t===xs)this._handleParentQuestionIdUpdate(e,s);else super.attributeChangedCallback(t,e,s)}_handleParentQuestionIdUpdate(t,e){(t=t||void 0)!==(e=e||void 0)&&this._client&&this._setWorkflow(this._getWorkflowByParentQuestionId(this._client,e))}},MisoSearchElement:class extends Os{static get observedAttributes(){return Os.observedAttributes}static get tagName(){return"miso-search"}_getWorkflow(t){return t.ui.search}},MisoRecommendationElement:class extends Os{static get tagName(){return"miso-recommendation"}static get observedAttributes(){return js}_getWorkflow(t){return this._getWorkflowByUnitId(t,this.unitId)}_getWorkflowByUnitId(t,e){return t.ui.recommendations.get(e)}get unitId(){return this.getAttribute(Cs)||void 0}set unitId(t){(t=t&&""+t)?this.setAttribute(Cs,t):this.removeAttribute(Cs)}attributeChangedCallback(t,e,s){if(t===Cs)this._handleUnitIdUpdate(e,s);else super.attributeChangedCallback(t,e,s)}_handleUnitIdUpdate(t,e){t!==e&&this._client&&this._setWorkflow(this._getWorkflowByUnitId(this._client,e))}}});const As="role",Ns=Object.freeze([As]);class Ss extends HTMLElement{static get tagName(){return"miso-component"}static get observedAttributes(){return Ns}constructor(){let{role:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),t&&Object.defineProperty(this,"_role",{value:t,writable:!1})}get role(){return this._role}connectedCallback(){const t=function(t){for(let e=t;e;e=e.parentNode)if(e.isContainer)return e;throw Error(t.tagName+" needs to be placed under a workflow container element.")}(this);this._container&&this._container!==t&&this._container._removeComponent(this),this._syncRole(),t._addComponent(this),this._container=t,this._containerResolution&&this._containerResolution.resolve(t)}_syncRole(){const t=this.getAttribute(As);if(t)this._role?console.warn(`Element <${this.tagName}>' already has a predefined role '${this._role}', so attribute 'role="${t}"' is ignored.`):this._role=t;else if(!this._role)throw Error(`An attribute 'role' is required for element <${this.tagName}>`)}disconnectedCallback(){this._container&&(this._container._removeComponent(this),this._container=void 0,this._containerResolution=void 0)}attributeChangedCallback(t,e,s){e!==s&&t===As&&this._container&&this._container._updateComponentRole(this,e,s)}}var Ls=Object.freeze({__proto__:null,containers:Rs,roles:Object.freeze({__proto__:null,MisoComponentElement:Ss,MisoQueryElement:class extends Ss{constructor(){super({role:yt.QUERY})}static get tagName(){return"miso-query"}},MisoFeedbackElement:class extends Ss{constructor(){super({role:yt.FEEDBACK})}static get tagName(){return"miso-feedback"}},MisoResultsElement:class extends Ss{constructor(){super({role:yt.RESULTS})}static get tagName(){return"miso-results"}},MisoQuestionElement:class extends Ss{constructor(){super({role:yt.QUESTION})}static get tagName(){return"miso-question"}},MisoAnswerElement:class extends Ss{constructor(){super({role:yt.ANSWER})}static get tagName(){return"miso-answer"}},MisoSourcesElement:class extends Ss{constructor(){super({role:yt.SOURCES})}static get tagName(){return"miso-sources"}},MisoRelatedResourcesElement:class extends Ss{constructor(){super({role:yt.RELATED_RESOURCES})}static get tagName(){return"miso-related-resources"}}}),MisoBannerElement:te});const $s=["containers","roles"];class Ps{constructor(t,e){this._plugin=t,this._client=e,this._contexts={}}async require(t){if(this._contexts[t])return this._contexts[t];const e=await this._plugin.requireExtension(t);return this._contexts[t]=e.getContext(this._client)}}class Ts{constructor(t,e){this._plugin=t,this._client=e,r(this,{sources:{api:Gt(e)}})}get recommendations(){return this._recommendations||(this._recommendations=this._plugin._getRecommendations(this._client))}get recommendation(){return this.recommendations.get()}get search(){return this._search||(this._search=new as(this._plugin,this._client))}get asks(){return this._asks||(this._asks=this._plugin._getAsks(this._client))}get ask(){return this.asks.root}}it.plugins.register(class extends S{static get id(){return"std:ui"}constructor(){super("ui"),this.layouts=new ms(this),this._recommendations=new WeakMap,this._asks=new WeakMap,this._extensions=new WeakMap}install(t,e){e.addSubtree(this),t.on("create",this._injectClient.bind(this));const s={};i(s,this,["layouts"]),r(this,{MisoClient:t}),r(t,{ui:s});for(const t of Object.values(We))t.type&&this.layouts.register(t);Os.MisoClient=te.MisoClient=t;const{containers:n,roles:o}=Ls,a=function(t,e){if(null==t)return{};var s,n,i={},r=Object.keys(t);for(n=0;r.length>n;n++)0>e.indexOf(s=r[n])&&(i[s]=t[s]);return i}(Ls,$s);for(const t of[...Object.values(n),...Object.values(o),...Object.values(a)])_(t)}async requireExtension(t){if("markdown"===t)return await this.MisoClient.plugins.install("std:ui-markdown");throw Error("Unknown extension: "+t)}_injectClient(t){r(t,{ui:new Ts(this,t)})}_getExtensions(t){if(this._extensions.has(t))return this._extensions.get(t);const e=new Ps(this,t);return this._extensions.set(t,e),e}_getRecommendations(t){let e=this._recommendations.get(t);return e||this._recommendations.set(t,e=new ps(this,t)),e}_getAsks(t){let e=this._asks.get(t);return e||this._asks.set(t,e=new is(this,t)),e}}),it.attach(),O("misodev"),setTimeout((()=>O("misocmd")));var Us=Object.freeze({...function(){const t=document.currentScript;if(!t||!t.src)return{};const e=document.createElement("a");e.href=t.src;const s={};for(const[t,n]of new URLSearchParams(e.search))s[t]=""===n||n;return s}(),...function(){const t={};for(const[e,s]of new URLSearchParams(window.location.search))e.startsWith("miso_")&&e.length>5&&"miso_api_key"!==e&&(t[e.substring(5)]=""===s||s);return t}()}),qs="1.0.31-beta.0";function Ms(...t){window.MisoClient&&window.MisoClient.plugins.isInstalled("std:debug")&&function(...t){console.log("%cMiso","color: #fff; background-color: #334cbb; padding: 2px 2px 1px 4px;",...t)}(...t)}const zs=864e5;function Ds(t){const e=t.split("-"),s=""+e[2].substring(1)+e[1]+e[0];return Math.floor(parseInt(s,16)/1e7)-12219292800}let Bs;async function Vs(){return Bs||(Bs=async function(){return async function(t,{interval:e=300,timeout:s}={}){const n=t();return null!=n?n:new Promise(((n,i)=>{let r,o;function a(){r&&clearInterval(r),o&&clearTimeout(o)}r=setInterval((()=>{const e=t();null!=e&&(a(),n(e))}),e),s&&s>0&&(o=setTimeout((()=>{a(),i(Error("Timeout: "+s))}),s))}))}((()=>window.ga&&window.ga.getAll&&window.ga.getAll()[0]))}())}async function Fs(t){const e={};let s;try{s=await async function(t){if(!t)throw Error("Blank post ID.");const e=`https://b2c-contenthub.com/wp-json/wp/v2/posts/${t}?_embed=1`;return(await window.fetch(e)).json()}(t),Ms("Fetched post info",[s])}catch(s){return console.error("Cannot fetch post: "+t),console.error(s),e}try{const t=s._embedded["wp:term"];for(const s of t)s.length>0&&"story_types"===s[0].taxonomy&&(e.storyTypes=s.map((t=>t.name)))}catch(e){console.error("Cannot extract story types: "+t),console.error(e)}try{const{suppress_monetization:t='""'}=s.meta||{},n=JSON.parse(t);e.adSuppression=!0===n.content_ads}catch(e){console.error("Cannot extract suppress_monetization info: "+t),console.error(e)}return e}const Ws=new Set(["News","Feature","How-To","Opinion"]);async function Qs(t,e,s){if(0===s.length)return[];const n=`/wp-json/idg/v2/${e}?include=${s.join(",")}&article_id=${t.postId}&per_page=100&_embed=1`,i=await window.fetch(n);return await i.json()}function Gs(t){return t.product_id.replace("product_","")}async function Ks(t,e,{miso_id:s}={}){if(0===e.length)return{};const n=await Qs(t.pageInfo,"deals-view",e);for(const e in n)n[e]=Zs({...n[e],id:e},{...t,id:e,miso_id:s});return n}const Hs='data-vars-link-position="',Ys='data-miso-attribution="miso-ipp" data-miso-product-type="deal" ';function Zs(t,e){return t=function(t,{pageInfo:e}){const{amazon_us_tag:s}=e.site;if(!s)return t;try{const{html:e}=t,r=e.indexOf('"https://go.redirectingat.com/'),o=0>r?-1:e.indexOf('"',r+1);if(o>=0){const a=(n=e.substring(r+1,o),(i=document.createElement("textarea")).innerHTML=n,i.value),{searchParams:c}=new URL(a),u=new URL(c.get("url"));if(u.hostname.endsWith("amazon.com")){u.searchParams.set("tag",s),c.set("url",""+u);const n="https://go.redirectingat.com/?"+c;t.html=e.substring(0,r+1)+"https://go.redirectingat.com/?"+c+e.substring(o),Ms("[Recommendation] Replaced Amazon link tag in deal view.",{original:a,replaced:n})}}}catch(t){console.error("Failed to replace Amazon link tag."),console.error(t)}var n,i;return t}(t=function(t,{miso_id:e}={}){try{const{html:s,id:n}=t,i=`data-product="${n}" `,r=s.indexOf(Hs);if(0>r)throw Error(`Cannot find '${Hs}' in product view HTML.`);let o=Ys;e&&(o+=`data-miso-miso-id="${e}" `),t.html=s.substring(0,r)+i+o+s.substring(r)}catch(t){console.error("Failed to add miso attribution attribute on anchor element."),console.error(t)}return t}(t,e),e)}var Js={block:{title:"Today's Best Deals"},text:{from:"From",was:"Was",now:"Now",view_deal:"View deal"}},Xs={block:{title:"Die besten Angebote des Tages"},text:{from:"Von",was:"Vorher",now:"Jetzt",view_deal:"Angebot ansehen"}};function tn(t,e,s={}){const n={product_ids:e.map((t=>t.product_id)),context:{custom_context:en(t,e,s)}};return s.miso_id&&(n.miso_id=s.miso_id),n}function en({type:t,site:e,storyId:s},n,{miso_id:i}={}){const{geo:r}=Us,o={source:"miso-client-script",script_version:qs,attribution:"miso-ipp",site:e.key,user_geo:r,product_types:n.map((t=>t.type))};if("story"===t&&s&&(o.story_id=s),i)try{o.api_ts=Ds(i)}catch(t){console.warn("[Recommendation] Failed to parse timestamp from miso_id: "+i)}return o}async function sn(t,e,{miso_id:s}={}){if(0===e.length)return{};const n=await Qs(t.pageInfo,"products-view",e);for(const e in n)n[e]=nn(n[e],{...t,id:e,miso_id:s});return n}function nn(t,e){return!!function({html:t},{id:e,client:s,pageInfo:n}){if("false"===config.prod_check||"0"===config.prod_check)return Ms("[Recommendation] Product view validation waived due to prod_check=0 flag"),!0;if(0>t.indexOf(rn))return Ms(`[Recommendation] Exclude product ${e} due to lack of outbound link.`),s.api.interactions.upload({type:"custom",custom_action_name:"invalid_product_view",product_ids:["product_"+e],context:{custom_context:en(n,[{type:"product"}])}}),!1;return!0}(t,e)&&(t=function(t,e){try{const{html:e}=t,s=e.indexOf(cn);if(0>s)throw Error(`Cannot find '${cn}' in product view HTML.`);t.html=e.substring(0,s)+un+e.substring(s)}catch(t){console.error("Failed to add miso attribution attribute on anchor element."),console.error(t)}return t}(t=function(t,{pageInfo:e}){const{html:s}=t,n=(i=e.site.lang,"de"===i?Xs:Js);var i;return t.html=s.replace(an,`${on}${n.block.title}</h4>`),t}(t,e)))}const rn='data-vars-outbound-link="',on='<h4 class="product-widget__block-title" id="">',an=on+"</h4>",cn='data-vars-outbound-link="',un='data-miso-attribution="miso-ipp" data-miso-product-type="product" ';function ln(t,e,s,n){if(!s)return;Ms("[Recommendation] Capturing impression event...");const i=new IntersectionObserver((s=>{if(s[0].isIntersecting){try{i.disconnect()}catch(t){console.error(t)}!function({client:t,pageInfo:e},s,n){if(hn)return;hn=!0,t.api.interactions.upload({...tn(e,s,n),type:"impression"}),Ms("[Recommendation] Impression event sent.")}(t,e,n)}}),{threshold:.5});i.observe(s)}let hn=!1;async function dn(t){const{client:e,pageInfo:s}=t;if("story"!==s.type)return void Ms(`[Recommendation] No block shown: not a story page (${s.type})`);const{storyTypes:n=[],adSuppression:i=!1}=await Fs(s.postId)||{};if(i)return void Ms("[Recommendation] No block shown: ad suppression is enabled.");if(!n.some((t=>Ws.has(t))))return void Ms("[Recommendation] No block shown: not applied for story_type: "+n.join(", "));const r=document.querySelector("#link_wrapped_content > p:nth-of-type(6)")||document.querySelector("#link_wrapped_content > p:last-of-type");if(!r)return void Ms("[Recommendation] No block shown: cannot find the reference position for recommendation block.");Ms("[Recommendation] Fetching results from Miso API...");const{products:o,...a}=await pn(t);if(0===o.length)return void Ms("[Recommendation] No block shown: no result from Miso API.");Ms("[Recommendation] Building views...");const c=await async function(t,e,s){const n=[],i=[];for(const t of e)switch(t.type){case"product":n.push(Gs(t));break;case"deal":i.push(Gs(t));break;default:throw Error("Unrecognized product type: "+t.type)}const[r,o]=await Promise.all([sn(t,n,s),Ks(t,i,s)]),a={...r,...o};return e.map((t=>a[Gs(t)])).filter((t=>t)).map((t=>t&&t.html||"")).join("")}(t,o,a);c&&(Ms("[Recommendation] Inserting view HTML on page..."),r.insertAdjacentHTML("afterend",c),Ms("[Recommendation] Rendered successfully."),e.api.interactions.upload({...tn(s,o,a),type:"custom",custom_action_name:"display"}),ln(t,o,r.nextElementSibling,a))}function _n(){const{geo:t,rec_type:e}=Us;if(e&&"product"!==e&&"deal"!==e)throw Error('Type parameter should be either "product", "deal", or absent: '+e);const s=Date.now();let n;const i=function(t){if(t)switch(t=t.toLowerCase()){case"us":case"gb":return t;case"de":case"at":case"ch":return"eu";default:return}}(t),r=function(t){if(t)switch(t){case"us":return 9910;case"gb":return 17657;case"eu":return 22080;default:return}}(i);if((!e||"deal"===e)&&i){n='type:"deal"';const t=function(t){const e=new Date(t);return e.setMinutes(0,0,0),e}(s).toISOString();n+=` AND custom_attributes.start_date:["${function(t,e){let s=Math.floor((e||Date.now())/zs)-t;return new Date(s*zs)}(28,s).toISOString()}" TO "${t}"]`,n+=` AND custom_attributes.end_date:["${t}" TO *]`,n+=` AND custom_attributes.geo_tags:"${i}"`;const e="custom_attributes.idg_deal_territories:0";n+=" AND "+(r?`(${e} OR custom_attributes.idg_deal_territories:${r})`:e)}return n}async function pn(t,e={}){if(Us.test_deal)return{products:[{product_id:"product_"+Us.test_deal,type:"deal"}]};const{client:s,pageInfo:n}=t,i=_n();if(!i)return{products:[]};e={product_id:n.storyId,fl:["type"],fq:i,rows:1,...e};try{const{products:t,miso_id:n}=await s.api.recommendation.productToProducts(e);return{products:t,miso_id:n}}catch(t){return console.error(t),[]}}Object.defineProperty(it,"name",{value:"ipp"});const mn=["product-name","link-position-id","link-position","outbound-link"],fn=["attribution","product-type"];(async t=>{const e="false"!==Us.ui&&"0"!==Us.ui&&!1!==t.ui;if(window.miso_ipp_script_version)return void console.warn("Miso IPP script already executed: "+window.miso_ipp_script_version);window.miso_ipp_script_version=qs;it.plugins.use("std:debug"),Ms("Miso IPP script version: "+qs),Us.test_deal?(it.plugins.use("std:dry-run"),Ms("[Recommendation] Test deal: "+Us.test_deal)):Us.dry_run&&it.plugins.use("std:dry-run");const s=window.miso=new it({readConfigFromScriptUrl:!0});s.context.anonymous_id=await async function(){return(await Vs()).get("clientId")}();const n=function(t){const e=window.location.pathname;if("/"===e)return{type:"home",site:t};const s=e.substring(1).split("/");if("article"===s[0]){const e=""+s[1];return{type:"story",site:t,postId:e,storyId:`story_${t.key}_${e}`}}return{type:"other",site:t}}(t),i={client:s,pageInfo:n};!function({client:t,pageInfo:e}){const{type:s,site:n,storyId:i}=e,{geo:r}=Us;switch(s){case"home":t.api.interactions.upload({type:"home_page_view",context:{custom_context:{source:"miso-client-script",script_version:qs,site:n.key,user_geo:r}}});break;case"story":t.api.interactions.upload({type:"product_detail_page_view",product_ids:[i],context:{custom_context:{source:"miso-client-script",script_version:qs,site:n.key,user_geo:r}}})}}(i),function({client:t,pageInfo:e}){const{type:s,site:n,storyId:i}=e;document.addEventListener("click",(e=>{if(e.defaultPrevented)return;const r=e.target;if(!r.tagName||"a"!==r.tagName.toLowerCase())return;const o=r.getAttribute("data-product");if(!o)return;const a="product_"+o,{geo:c}=Us,u={source:"miso-client-script",script_version:qs,site:n.key,user_geo:c};"story"===s&&i&&(u.story_id=i);for(const t of mn){const e=r.getAttribute("data-vars-"+t);e&&(u[t.replaceAll("-","_")]=e)}for(const t of fn){const e=r.getAttribute("data-miso-"+t);e&&(u[t.replaceAll("-","_")]=e)}if(u.product_type)u.product_types=[u.product_type],delete u.product_type;else{const t=function(t){for(;(t=t.parentElement)&&!t.classList.contains(yn);){for(const e of gn)if(t.classList.contains(e))return"product";for(const e of bn)if(t.classList.contains(e))return"deal"}return}(r);t&&(u.product_types=[t])}const l=r.getAttribute("data-miso-miso-id");if(l)try{u.api_ts=Ds(l)}catch(t){console.warn("[Recommendation] Failed to parse timestamp from miso_id: "+l)}const h={type:"checkout",product_ids:[a],miso_id:l,context:{custom_context:u}};l&&(h.miso_id=l),t.api.interactions.upload(h)}))}(i),e&&dn(i),s._recp2p=async t=>pn(i,{fl:["*"],...t})})({key:"macworld",hostname:"www.macworld.com",name:"Macworld",amazon_us_tag:"macworld-ipp-20",lang:"en"});const gn=["product-chart-item","product-widget"],bn=["price-comparison"],yn="link_wrapped_content"}();
