!function(){"use strict";function t(t,e){const s=t.indexOf(e);s>-1&&t.splice(s,1)}function e(t){return null!=t?""+t:t}function s(t){if("object"!=typeof t)return t;const e={};for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&void 0!==t[s]&&(e[s]=t[s]);return e}function n(t,e,s){Object.defineProperties(t,(s="string"==typeof s?[s]:s).reduce(((t,s)=>(t[s]={get:()=>{const t=e[s];return"function"==typeof t?t.bind(e):t}},t)),{}))}function o(t,e){for(const s in e)e.hasOwnProperty(s)&&Object.defineProperty(t,s,{value:e[s]})}class i{constructor(t){let{duration:e=0,onDuration:s,offDuration:n,state:o}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("function"!=typeof t)throw Error("Callback must be a function: "+t);a(s),a(n),a(e),this._callback=t,Object.defineProperty(this,"durations",{value:Object.freeze({on:void 0!==s?s:e,off:void 0!==n?n:e})}),this._value=this._state=!!o,this._active=!0}get active(){return this._active}get state(){return this._state}get value(){return this._value}set value(t){if(this._value===(t=!!t))return;!function(t){if(!t._timeout)return;clearTimeout(t._timeout),t._timeout=void 0}(this);const e=this.durations[t?"on":"off"];e?this._timeout=setTimeout((()=>r(this,t)),e):r(this,t),this._value=t}disconnect(){this._active=!1}}function r(t,e){t._state!==e&&(t._state=e,t._active&&t._callback(e))}function a(t,e){if(void 0!==e&&(isNaN(e)||0>e))throw Error(`${t} must be a non-negative number: ${e}`)}function c(t){return"string"==typeof t?document.querySelector(t):t}function u(){return(crypto&&crypto.randomUUID?crypto.randomUUID():void 0)||function(){if(!URL||!URL.createObjectURL||URL.revokeObjectURL||!Blob)return;const t=URL.createObjectURL(new Blob),e=""+t;return URL.revokeObjectURL(t),e.substring(e.lastIndexOf("/")+1)}()||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}function l(t,e){const s=window.localStorage.getItem(t),n=function(t){const e="; "+document.cookie,s=`; ${encodeURIComponent(t)}=`,n=e.indexOf(s);if(0>n)return;const o=n+s.length,i=e.indexOf(";",o);return decodeURIComponent(0>i?e.substring(o):e.substring(o,i))}(t),o=s||n||""+e();return o&&!s&&window.localStorage.setItem(t,o),o&&!n&&function(t,e){document.cookie=`${encodeURIComponent(t)}=${encodeURIComponent(e)}; max-age=31536000; path=/`}(t,o),o}class d{constructor(){const t=this;t.promise=new Promise(((e,s)=>{t.resolve=e,t.reject=s})),Object.freeze(this)}}class h{constructor(){this._index=-1,this._done=!1,this._aborted=!1,this._abortReason=void 0,this._error=void 0}get aborted(){return this._aborted}get abortReason(){return this._abortReason}get done(){return this._done}update(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._done||(this._value=t,this._done=e,this._index++,this._resolution&&(this._resolution.resolve(),this._resolution=void 0))}error(t){this._error=t,this._resolution&&(this._resolution.reject(t),this._resolution=void 0)}abort(t){this._aborted=!0,this._abortReason=t,this._resolution&&(t instanceof Error?this._resolution.reject(t):this._resolution.resolve(),this._resolution=void 0)}async*[Symbol.asyncIterator](){for(let t=0;;t=this._index+1){if(this._error)throw this._error;if(this._aborted)break;if(t>this._index&&(this._resolution||(this._resolution=new d),await this._resolution.promise),this._aborted)break;if(yield this._value,this._done)break}}}function p(){return(new AbortController).signal}function _(t,e){try{e()}catch(e){t(e)}}function f(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t=>console.error(t);const s=window[t]||(window[t]=[]);if(s._processed)return;s._processed=!0;const n=t=>_(e,t);Object.defineProperty(s,"push",{value:n});for(const t of s)n(t)}const m=Symbol.for("miso:resources");class g{constructor(){this._resources=new Map;const t=window[m]||[];for(const e of t)try{const[t,s]=e;this.push([t,s])}catch(t){}}push(t){let[e,s]=t;y(this._resources,e).resolve(s)}async get(t){return y(this._resources,t).promise}}function y(t,e){if(t.has(e))return t.get(e);const s=new d;return t.set(e,s),s}function b(){return window[m]||(window[m]=new g)}class w{constructor(t,e){this._dispatchRequested=!1,this._requests=[],this._run=t,this._error=e||(t=>console.error(t)),this._bulkId=0,this._dispatch=this._dispatch.bind(this)}get info(){return{bulkId:this._bulkId,index:this._requests.length}}async run(t){const e=new d;return this._requests.push({action:t,resolution:e}),this._requestDispatch(),e.promise}_requestDispatch(){this._dispatchRequested||(this._dispatchRequested=!0,setTimeout(this._dispatch))}_dispatch(){if(!this._dispatchRequested)return;this._dispatchRequested=!1;const t=this._requests,e=this._bulkId++;this._requests=[];try{this._run(t,{bulkId:e})}catch(t){this._error(t)}}}class v{constructor(){let{target:t,error:e,replays:s=[]}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._error=e||(t=>console.error(t)),!Array.isArray(s))throw Error("Replays option must be an array of strings: "+s);this._replays=new Set(s),this._namedCallbacks={},this._unnamedCallbacks=[],this._pastEvents={},t&&this._injectSubscribeInterface(t)}emit(t,e){const s={data:e,meta:{name:t,ts:Date.now()}},n=this._namedCallbacks[t];if(n)for(const t of n)t(s);for(const t of this._unnamedCallbacks)t(s);this._shallStoreForReplay(t)&&(this._pastEvents[t]||(this._pastEvents[t]=[])).push(s)}on(t,e){return this._checkName(t),this._checkCallback(e),this._on(t,this._wrapCallback(e))}once(t){this._checkName(t);const e=this;return new Promise(((s,n)=>{const o=e._on(t,(t=>{setTimeout((()=>o()));try{s(t)}catch(t){n(t)}}))}))}_checkName(t){if("string"!=typeof t)throw Error("Event name should be a string: "+t)}_checkCallback(t){if("function"!=typeof t)throw Error("Event callback should be a function: "+t)}_shallStoreForReplay(t){return this._replays.has(t)}_wrapCallback(t){const e=this;return s=>{let{data:n,meta:o}=s;try{t(n,o)}catch(t){e._error(t)}}}_on(t,e){if("*"===t?this._unnamedCallbacks.push(e):(this._namedCallbacks[t]||(this._namedCallbacks[t]=[])).push(e),"*"===t)for(const t in this._pastEvents)this._pastEvents[t].forEach(e);else this._pastEvents[t]&&this._pastEvents[t].forEach(e);return()=>this._off(t,e)}_off(e,s){if("*"===e)t(this._unnamedCallbacks,s);else{const n=this._namedCallbacks[e];n&&t(n,s)}}_injectSubscribeInterface(t){n(t,this,["on","once"])}}function k(t,e){return Object.freeze([...e&&e.meta&&e.meta.path||[],...t?[t]:[]])}class x{constructor(t,e){const s=function(t,e){if(void 0!==t&&"string"!=typeof t&&void 0===e&&(e=t,t=void 0),void 0!==t&&("string"!=typeof t||!t))throw Error(`Invalid Component name: "${t}"`);return Object.freeze({name:t,parent:e,path:k(t,e),uuid:u()})}(t,e);o(this,{meta:s});const n=this._error=this._error.bind(this);(this._events=new v({error:n,replays:["child"]}))._injectSubscribeInterface(this),this._warn=this._warn.bind(this),(e=s.parent)&&e._events&&e._events.emit("child",this)}_warn(){const t=this.meta.parent;(t&&t._warn||console.warn)(...arguments)}_error(){const t=this.meta.parent;(t&&t._error||console.error)(...arguments)}}!function(t,e){const s=Symbol.for(e);Object.defineProperty(t,s,{value:!0}),Object.defineProperty(t,"isTypeOf",{value:e=>e&&e instanceof t||"function"==typeof e.constructor&&!0===e.constructor[s]})}(x,"miso:component");class I extends x{constructor(t,e){let{libName:s,keyName:n}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};switch(super(t,e),this._events._replays.add("register"),this._libraries={},this._libResolutions={},this._libName=s,typeof n){case"string":this._keyFn=t=>t[n];break;case"function":this._keyFn=n;break;default:throw Error("Expect keyName to be a string or a function: "+n)}}isRegistered(t){return this._checkKey(t),!!this._libraries[t]}get registered(){return Object.values(this._libraries)}async whenRegistered(t){if(this.isRegistered(t))return this._libraries[t];const{promise:e}=this._libResolutions[t]||(this._libResolutions[t]=new d);return e}register(){for(var t=arguments.length,e=Array(t),s=0;t>s;s++)e[s]=arguments[s];for(const t of e)this._register(t)}_checkKey(t){if("string"!=typeof t||!t)throw Error("Expect key to be a non-empty string: "+t)}_checkLib(t){if("function"!=typeof t)throw Error("Expect lib to be a class or function: "+t)}_register(t){this._checkLib(t);const e=this._keyFn(t);this._checkKey(e);const s=this._libraries||(this._libraries={});s[e]=t,this._libResolutions[e]&&this._libResolutions[e].resolve(t),this._events.emit("register",t)}}class R{constructor(t){this._ac=new AbortController,this._timeout=t,this.touch()}clear(){void 0!==this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=void 0)}touch(){this.clear(),this._timeoutId=setTimeout((()=>this.abort()),this._timeout)}get signal(){return this._ac.signal}abort(t){this.clear(),this._ac.abort(t||Error(`Stall timeout: data stay unchanged for ${this._timeout/1e3} seconds.`))}}const P={DATA_ENDPOINT:"https://api-edge.askmiso.com/v1",EVENT_ENDPOINT:"https://api.askmiso.com/v1"};class O{constructor(t,e){this._client=t,this._root=e,this._bulk=new w(this._runBulkFetch.bind(this),t._error.bind(t))}async fetch(t,e){let{method:n="POST",headers:o,timeout:i,sendApiKeyByHeader:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{apiKey:a,request:c={}}=this._client.options;i=i||c.timeout,r=r||c.sendApiKeyByHeader,r&&(o=Object.assign({},o,{"X-API-KEY":a}));const u="GET"!==n&&null!=e?JSON.stringify(e):void 0,l=i?AbortSignal.timeout(i):void 0,d=await window.fetch(t,s({method:n,headers:o,body:u,cache:"no-cache",mode:"cors",signal:l})),h=await d.json();if(d.status>=400||h.errors){var p=Error(h.message);throw p.data=h,p.status=d.status,p}return h}get bulkInfo(){return this._bulk.info}async fetchForBulk(t,e,s){let{method:n}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(n&&"POST"!==n)throw Error("Non-POST API is not supported in bulk mode: "+url);return this._bulk.run({apiGroup:t,apiName:e,payload:s})}async _runBulkFetch(t){const e=this.url(["bulk"]),s={requests:t.map((t=>{let{action:{apiGroup:e,apiName:s,payload:n}}=t;return{api_name:`${e}/${s}`,body:n}}))},{data:n}=await this.fetch(e,s);for(let e=0,s=t.length;s>e;e++){const{resolution:s}=t[e],{error:o,status_code:i,body:r}=n[e];i>=400||o?s.reject({status_code:i,body:r}):s.resolve(r)}}sendBeacon(t,e){let{method:s}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(s&&"POST"!==s)throw Error("Non-POST API is not supported in useBeacon mode: "+t);if(!window.navigator.sendBeacon(t,JSON.stringify(e)))throw Error("Send beacon unsuccessful: "+t)}url(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{apiKey:s,request:n={}}=this._client.options,o=e.sendApiKeyByHeader||n.sendApiKeyByHeader,i=t.filter((t=>t)).join("/"),r=`${this.getApiEndpoint(i)}/${i}`;return o?r:`${r}?api_key=${window.encodeURIComponent(s)}`}getApiEndpoint(t){const{dataEndpoint:e=P.DATA_ENDPOINT,eventEndpoint:s=P.EVENT_ENDPOINT}=this._client.options;return"interactions"===t?s:e}applyUrlPasses(t,e){let{apiGroup:s,apiName:n,url:o}=e;const i=this._client;for(const e of this._root._urlPasses)try{o=e({client:i,apiGroup:s,apiName:n,url:o})||o}catch(e){t.error(e)}return o}applyPayloadPasses(t,e){let{apiGroup:s,apiName:n,payload:o}=e;const i=this._client;for(const e of this._root._payloadPasses)try{o=e({client:i,apiGroup:s,apiName:n,payload:o})||o}catch(e){t.error(e)}return o}}const E=["bulk"];class j extends x{constructor(t,e){super(e,t),this._apiPath=e,this.helpers=t.helpers,this.clientOptions=t._client.options,this.context=t._client.context}async _run(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{bulk:n}=s,o=n?{bulk:this.helpers.bulkInfo}:void 0,i=this._apiPath,r=this._url({apiGroup:i,apiName:t,payload:e,options:s}),a={apiGroup:i,apiName:t,payload:e=this._preprocess({apiGroup:i,apiName:t,payload:e,options:s}),url:r,options:s};this._events.emit("request",Object.assign({},a,o));const c=await this._send(a),u=Object.assign({},a,{response:c});return this._events.emit("response",Object.assign({},u,o)),this._postprocess(u)}_preprocess(t){let{apiGroup:e,apiName:s,payload:n}=t;return this.helpers.applyPayloadPasses(this,{apiGroup:e,apiName:s,payload:n})}_url(t){let{apiGroup:e,apiName:s,options:n}=t;const o=this.helpers.url([e,s],n);return this.helpers.applyUrlPasses(this,{apiGroup:e,apiName:s,url:o,options:n})}async _send(t){let{apiGroup:e,apiName:s,url:n,payload:o,options:{bulk:i}={}}=t,r=function(t,e){if(null==t)return{};var s,n,o={},i=Object.keys(t);for(n=0;i.length>n;n++)0>e.indexOf(s=i[n])&&(o[s]=t[s]);return o}(t.options,E);return i?this.helpers.fetchForBulk(e,s,o):this.helpers.fetch(n,o,r)}_postprocess(t){let{response:e}=t;return e.data}}const C=["useBeacon"],A=["options"];function N(t,e){if(null==t)return{};var s,n,o={},i=Object.keys(t);for(n=0;i.length>n;n++)0>e.indexOf(s=i[n])&&(o[s]=t[s]);return o}class S extends j{constructor(t){super(t,"interactions")}async upload(t,e){try{return await this._run("upload",t,e)}catch(t){if(400!==t.status||!t.message||-1>=t.message.toLowerCase().indexOf("playground"))throw t;this._warn("Ignore interactions uploaded to playground app.")}}_url(t){let{apiGroup:e,apiName:s,options:n}=t;const o=this.helpers.url([this._apiPath],n);return this.helpers.applyUrlPasses(this,{apiGroup:e,apiName:s,url:o,options:n})}_preprocess(t){let{apiGroup:e,apiName:s,payload:n}=t;return"upload"===s&&(n=this._normalizeUploadPayload(n)),super._preprocess({apiGroup:e,apiName:s,payload:n})}_normalizeUploadPayload(t){if("object"!=typeof t)throw Error("Interactions payload has to be either an object or an array of objects: "+t);return Array.isArray(t)||(t=[t]),{data:t}}async _send(t){let{options:{useBeacon:e=!0}={}}=t,s=N(t.options,C),n=N(t,A);if(e){const{url:t,payload:e}=n;return this.helpers.sendBeacon(t,e,s),{}}return super._send(Object.assign({},n,{options:s}))}}const $=["pollingInterval","signal","stallTimeout"];class T extends j{constructor(t){super(t,"ask")}async questions(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof t&&"{"!==t.charAt(0))return new q(this,{question_id:t},e);const s=await this._run("questions",t,e);return new q(this,s,e)}async _questions(t,e){return this._run("questions",t,e)}async _get(t,e){return this._run(`questions/${t}/answer`,void 0,Object.assign({},e,{method:"GET"}))}}class q{constructor(t,e){let{question_id:s}=e,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this._api=t,this._questionId=s,this._ac=new AbortController,this._options=n}get questionId(){return this._questionId}async get(t){return this._api._get(this._questionId,Object.assign({},this._options,t))}abort(t){this._ac.abort(t)}[Symbol.asyncIterator](){var t=this;let e=this._options,{pollingInterval:s,signal:n,stallTimeout:o=3e4}=e,i=function(t,e){if(null==t)return{};var s,n,o={},i=Object.keys(t);for(n=0;i.length>n;n++)0>e.indexOf(s=i[n])&&(o[s]=t[s]);return o}(e,$);const r=new R(o);let a;n=function(){for(var t=arguments.length,e=Array(t),s=0;t>s;s++)e[s]=arguments[s];const n=e.length;if(0===n)return p();if(1===n)return e[0];const o=new AbortController;for(const t of e)if(t&&t.addEventListener){if(t.aborted)return AbortSignal.abort(t.reason);t.addEventListener("abort",(()=>o.abort(t.reason)))}return o.signal}(this._ac.signal,r.signal,n);return function(t){let{interval:e=1e3,errorLimit:s=10,onError:n,onResponse:o,signal:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(i&&i.aborted)return[];let r=0;const a=new h,c=setInterval((async()=>{let e,u;try{[e,u]=await t(i?{signal:i}:{}),o&&o(e,u)}catch(t){return n&&n(t),r++,void(r>s&&(clearInterval(c),a.error(t)))}a.update(e,u),u&&clearInterval(c)}),e);return i&&i.addEventListener&&i.addEventListener("abort",(()=>{clearInterval(c),a.abort(i.reason)})),a}((async function(){const e=await t.get();return[e,e.finished]}),Object.assign({interval:s,signal:n,onResponse:(t,e)=>{var s,n;e?r.clear():(n=t,(s=a)&&s.answer_stage===n.answer_stage&&s.answer.length===n.answer.length||r.touch()),a=t}},i))[Symbol.asyncIterator]()}}class U extends j{constructor(t){super(t,"search")}async search(t,e){return this._run("search",t,e)}async autocomplete(t,e){return this._run("autocomplete",t,e)}async multipleGet(t,e){return this._run("mget",t,e)}}class L extends j{constructor(t){super(t,"recommendation")}async userToProducts(t,e){return this._run("user_to_products",t,e)}async userToCategories(t,e){return this._run("user_to_categories",t,e)}async userToAttributes(t,e){return this._run("user_to_attributes",t,e)}async userToTrending(t,e){return this._run("user_to_trending",t,e)}async userToHistory(t,e){return this._run("user_to_history",t,e)}async productToProducts(t,e){return this._run("product_to_products",t,e)}}class M extends x{constructor(t,e){super("api",t),this._client=t,this.helpers=new O(t,e),this.interactions=new S(this),this.ask=new T(this),this.search=new U(this),this.recommendation=new L(this)}}class F extends x{constructor(t){super("context",t),this._client=t}}var D={api:{Api:M,ApiBase:j,ApiHelpers:O,Interactions:S,Recommendation:L,Search:U},context:{Context:F}};class G{constructor(t){o(this,{install:t})}}class z extends I{constructor(t){super("plugins",t,{libName:"plugin class",keyName:"id"}),this._root=t,this._currentScript=document.currentScript,this._events._replays.add("install").add("subtree"),this._installed={},this._installedResolutions={},this._useRequests={},this._subtrees=[],this.context=new B(this,D),this.plugins=new H(this)}isInstalled(t){return this._checkKey(t),!!this._installed[t]}get installed(){return Object.values(this._installed)}get(t){return this._installed[t]}getPluginClass(t){return this._libraries[t]}use(t,e){if("function"==typeof t&&t.id&&"string"==typeof t.id)return this.register(t),void this.use(t.id,e);let s;if("string"==typeof t&&this.isInstalled(t))return s=this.get(t),void this._tryConfig(s,e);"string"!=typeof t||this.isRegistered(t)?(s=this._instantiate(t,e),this._install(s)):(this._useRequests[t]||(this._useRequests[t]=[])).push(e)}async install(t,e){return this.use(t,e),"string"!=typeof t||this.isRegistered(t)||await this._tryRegisterRemotely(t),this.whenInstalled(t)}async whenInstalled(t){if(this.isInstalled(t))return this.get(t);const{promise:e}=this._installedResolutions[t]||(this._installedResolutions[t]=new d);return e}addSubtree(t){this._subtrees.push(t),this._events.emit("subtree",t)}addPayloadPass(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._payloadPasses.push(t)}addUrlPass(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._urlPasses.push(t)}_tryConfig(t,e){void 0!==e&&("function"==typeof t.config?(t.config(e),this._events.emit("config",[t,e])):this._warn(`Attempt to pass options to plugin "${t.id}", which offers no config() method.`))}_instantiate(t,e){switch(typeof t){case"string":this._checkKey(t);const s=this._libraries[t];if(!s)throw Error("Plugin class not found: "+t);const n=new s;return o(n,{id:t}),this._tryConfig(n,e),n;case"function":return new G(t)}throw Error("Unexpected parameters: "+t)}_install(t){if("function"!=typeof t.install)throw Error("Expect plugin.install to be a function: "+t);try{t.installed=!1,t.install(this.MisoClient,this.context),t.installed=!0}catch(t){throw t}t.id&&(this._installed[t.id]=t,this._installedResolutions[t.id]&&(this._installedResolutions[t.id].resolve(t),delete this._installedResolutions[t.id])),this._events.emit("install",t)}_register(t){super._register(t),this._fulfillUseRequests(t.id)}_fulfillUseRequests(t){const e=this._useRequests[t];if(e){for(const s of e)try{this.use(t,s)}catch(t){this._error(t)}delete this._useRequests[t]}}async _tryRegisterRemotely(t){if(t.startsWith("std:"))try{return void await this._registerStdRemotely(t)}catch(t){console.error(t)}throw Error("Cannot register plugin remotely: "+t)}async _registerStdRemotely(t){const{version:e}=this._root,s="dev"===e?`plugin:${t}@dev:${MisoClient.uuid}`:`plugin:${t}@${e}`;if(!document.querySelector(`script[data-request="${s}"]`)){const n=document.createElement("script");n.async=!0,n.src=function(t,e,s){const n=t.slice(4);if("dev"===e){const t=s.src,e=t.indexOf("?"),o=0>e?t.length:e,i=t.lastIndexOf("/",o)+1,r=t.indexOf(".",i),a=0>r?"":t.slice(r,o);return`${t.slice(0,i)}plugins/${n}${a}`}return`https://cdn.jsdelivr.net/npm/@miso.ai/client-sdk@${e}/dist/umd/plugins/${n}.min.js`}(t,e,this._currentScript),n.setAttribute("data-request",s),document.head.appendChild(n)}const n=await(new b).get(s);!this.isRegistered(t)&&this.register(n)}}class B{constructor(t,e){n(this,t,["getPluginClass","addSubtree","addPayloadPass","addUrlPass","whenInstalled","whenRegistered"]),o(this,{classes:e})}}class H{constructor(t){n(this,t,["installed","registered","isInstalled","isRegistered","whenInstalled","whenRegistered","get","register","use","install"])}}const K=new class extends x{constructor(){super(),this._events._replays.add("create"),this._pluginRoot=new z(this),this._clients=[],this._payloadPasses=[],this._urlPasses=[],this.version="1.8.0-beta.4"}get instances(){return[...this._clients]}async any(){return this._clients[0]||this._any||(this._any=(await this._events.once("create")).data)}};var W=Object.freeze({__proto__:null,viewable:async function(t){let{area:e=.5,duration:s=1e3,signal:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t=c(t),new Promise((o=>{const r=new i((t=>{t&&(r.disconnect(),a.disconnect(),o())}),{onDuration:s}),a=new IntersectionObserver((t=>{r.value=t[0].isIntersecting}),{threshold:e});a.observe(t),n&&n.addEventListener&&n.addEventListener("abort",(()=>{r.disconnect(),a.disconnect()}))}))}});class V extends x{static attach(){(window.MisoClients||(window.MisoClients=[])).push(V),window.MisoClient?window.MisoClient!==V&&console.warn(`window.MisoClient already exists: (${window.MisoClient.version}).`):window.MisoClient=V}constructor(t){var e;super("client",K),this._config(t),this.context=new F(this),this.api=new M(this,K),K._clients.push(e=this),K._events.emit("create",e)}get version(){return V.version}_config(t){this.options=Object.freeze(this._normalizeOptions(t))}_normalizeOptions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("string"==typeof t&&(t={apiKey:t}),t.readConfigFromScriptUrl&&(t=Object.assign({},this._readConfigFromScriptUrl(),t)),!t.apiKey)throw Error("Require API key to initialize miso client.");return t.dataEndpoint=t.dataEndpoint||t.apiHost,t.eventEndpoint=t.eventEndpoint||t.apiHost,delete t.apiHost,s(t)}_readConfigFromScriptUrl(){const t=document.currentScript;return s({apiKey:new URL(new Request(t.src||t.href).url).searchParams.get("api_key")||void 0})}}V.helpers=W,o(V,{uuid:u()});var J=function(t){const e=K._pluginRoot;return K.MisoClient=e.MisoClient=t,n(t,K,["version","instances","any","meta","on","once"]),n(t,e,["plugins"]),t}(V);class X{constructor(t){this._plugin=t}get anonymous_id(){return this._anonymousId||this._autoAnonymousId||(this._autoAnonymousId=l("miso_anonymous_id",u))}set anonymous_id(t){t=e(t),this._anonymousId=t,this._plugin._events.emit("set",`anonymous_id = '${t}'`)}get user_id(){return this._userId}set user_id(t){t=e(t),this._userId=t,this._plugin._events.emit("set",`user_id = '${t}'`)}get user_hash(){return this._userHash}set user_hash(t){if("string"!=typeof t&&void 0!==t)throw Error("User hash must be a string");this._userHash=t,this._plugin._events.emit("set",`user_hash = '${t}'`)}}function Y(){const t=new URLSearchParams(window.location.search);let e=s({source:t.get("utm_source")||void 0,medium:t.get("utm_medium")||void 0,name:t.get("utm_campaign")||void 0,term:t.get("utm_term")||void 0,content:t.get("utm_content")||void 0});return 0===Object.keys(e).length?void 0:e}class Q{constructor(t){this._plugin=t,this._config={search:!0},this.interface=Object.freeze({config:this.config.bind(this)})}config(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("object"!=typeof t)throw Error("Config options must be an object or undefined: "+t);for(const e of t){if(!this._config.hasOwnProperty(e))continue;const s=this._config[e],n=t[e];n!==s&&(this._config[e]=s,this._plugin._events.emit("config",`${e}: ${s} -> ${n}`))}return Object.freeze(Object.assign({},this._config))}}const Z=["groupName","apiName","url","bulk"];function tt(){let{text:t="Miso"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return"%c"+t}function et(){let{color:t="#fff",background:e="#334cbb"}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return`color: ${t}; background-color: ${e}; padding: 2px 2px 1px 4px;`}function st(t){const e=typeof t;return"function"===e||"object"===e&&!Array.isArray(t)?[t]:t}J.plugins.register(class{constructor(){this._options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}}static get id(){return"std:debug"}install(t){var e=this;this._injectComponents(t),t.debug=function(){return e._logr(...arguments)}}config(){this._options=Object.assign({},this._options,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}_injectComponents(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];t.on("child",(t=>this._injectComponents(t,e))),t.on("subtree",(s=>this._injectComponents(s,e.concat(t.meta.path)))),t.on("*",((s,n)=>this._handleEvent(t,n,s,e)))}_handleEvent(t,e,s){let{name:n}=e;if("child"===n||"subtree"===n)return;const o=(arguments.length>3&&void 0!==arguments[3]?arguments[3]:[]).concat(t.meta.path);if(o.length||"create"!==n){switch(o[0]){case"client":if("api"===o[1])return void this._handleApiEvent(n,Object.assign({},s,{groupName:o[2]}));break;case"plugins":return void(1===o.length?this._handlePluginsEvent(n,s):this._handlePluginSpecificEvent(o[1],o.slice(2),n,s))}this._logw(o.join("."),n,s)}else this._handleCreateClient(n,s)}_handleCreateClient(t,e){this._logw("client",t,e)}_handleApiEvent(t,e){let{groupName:s,url:n,bulk:o}=e,i=function(t,e){if(null==t)return{};var s,n,o={},i=Object.keys(t);for(n=0;i.length>n;n++)0>e.indexOf(s=i[n])&&(o[s]=t[s]);return o}(e,Z);const r=new URL(n).pathname,a=["api",t];if(o&&a.push(`(bulk ${o.bulkId})`),a.push("POST "+r),"interactions"===s){const{type:t}=i.payload.data[0];a.push(t)}a.push([Object.assign({},i,{url:n})]),this._log(...a)}_handlePluginsEvent(t,e){let s=[];Array.isArray(e)&&(s=e.slice(1),e=e[0]),this._log("plugins",t,""+(e.id||"(anonymous)"),[e,...s])}_handlePluginSpecificEvent(t,e,s,n){this._logw([t,e.join(".")],s,n)}_getPath(t){const e=[];for(let s=t;s;s=s.meta.parent)s.meta.name&&e.push(s.meta.name);return e.reverse()}_logr(){const t=this._options.console||{};for(var e=arguments.length,s=Array(e),n=0;e>n;n++)s[n]=arguments[n];console.log(tt(t),et(t),...s)}_log(t,e){const s=this._options.console||{};for(var n=arguments.length,o=Array(n>2?n-2:0),i=2;n>i;i++)o[i-2]=arguments[i];console.log(tt(s),et(s),function(t){return`<${"string"==typeof t?t:t.filter((t=>t)).join("/")}>`}(t),function(t){return`[${t}]`}(e),...o)}_logw(t,e,s){void 0===s?this._log(t,e):Array.isArray(s)?this._log(t,e,...s.map(st)):this._log(t,e,st(s))}},class{constructor(){this._options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},this.id="std:dry-run",this.name="dry-run"}static get id(){return"std:dry-run"}install(t,e){let{addUrlPass:s}=e;s(this._modifyUrl.bind(this))}_modifyUrl(t){let{apiGroup:e,apiName:s,url:n}=t;return"interactions"===e&&"upload"===s?function(t,e,s){if("string"!=typeof e)throw Error("Expect URL parameter to be a string: "+e);return void 0===s&&(s="1"),t+(0>t.indexOf("?")?"?":"&")+encodeURIComponent(e)+"="+encodeURIComponent(""+s)}(n,"dry_run","1"):n}}),J.plugins.use(class extends x{static get id(){return"std:user"}constructor(){super("user"),this._contexts=new WeakMap}install(t,e){e.addSubtree(this),t.on("create",this._injectClient.bind(this)),e.addPayloadPass(this._modifyPayload.bind(this))}_injectClient(t){const e=new X(this);var s,n;this._contexts.set(t,e),s=e,Object.defineProperties(t.context,(n="string"==typeof(n=["anonymous_id","user_id","user_hash"])?[n]:n).reduce(((t,e)=>(t[e]={get:()=>s[e],set:t=>{s[e]=t}},t)),{}))}_modifyPayload(t){let{client:e,apiGroup:s,apiName:n,payload:o}=t;return"interactions"===s&&"upload"===n?this._modifyPayloadForInteractions(e,o):this._modifyPayloadForOthers(e,o)}_modifyPayloadForOthers(t,e){const{user_id:s,user_hash:n,anonymous_id:o}=t.context;return Object.assign({},s?{user_id:s,user_hash:n}:{anonymous_id:o},e)}_modifyPayloadForInteractions(t,e){let{data:n}=e;const{anonymous_id:o,user_id:i}=t.context,r=s({anonymous_id:o,user_id:i});return n=n.map((t=>Object.assign({},r,t))),{data:n}}}),J.plugins.use(class{static get id(){return"std:page-info"}constructor(){}install(t,e){let{addPayloadPass:s}=e;s(this._modifyPayload.bind(this))}_modifyPayload(t){let{apiGroup:e,apiName:s,payload:n}=t;return"interactions"===e&&"upload"===s?this._modifyPayloadForInteractions(n):n}_modifyPayloadForInteractions(t){let{data:e}=t;return e=e.map((t=>Object.assign({},t,{context:Object.assign({},s({page:s({url:window.location.href,referrer:document.referrer,title:document.title}),campaign:Y()}),t.context)}))),{data:e}}}),J.plugins.use(class extends x{static get id(){return"std:auto-events"}constructor(){super("auto-events"),this._contexts=new WeakMap}install(t,e){e.addSubtree(this),t.on("create",this._injectClient.bind(this)),e.addPayloadPass(this._captureApiRequest.bind(this))}_injectClient(t){const e=new Q(this);this._contexts.set(t,e),t.autoEvents=e.interface}_captureApiRequest(t){let{client:e,apiGroup:s,apiName:n,payload:o}=t;if("search"===s)if("search"===n)this._captureSearchApiRequest(e,o)}_captureSearchApiRequest(t,e){let{q:s}=e;if(!s||"*"===s)return;const n=this._contexts.get(t);n&&n._config.search&&t.api.interactions.upload({type:"search",search:{keywords:s},context:{custom_context:{channel:"miso_api"}}})}}),J.attach(),f("misodev"),setTimeout((()=>f("misocmd")));var nt=Object.freeze({...function(){const t=document.currentScript;if(!t||!t.src)return{};const e=document.createElement("a");e.href=t.src;const s={};for(const[t,n]of new URLSearchParams(e.search))s[t]=""===n||n;return s}(),...function(){const t={};for(const[e,s]of new URLSearchParams(window.location.search))e.startsWith("miso_")&&e.length>5&&"miso_api_key"!==e&&(t[e.substring(5)]=""===s||s);return t}()}),ot="1.0.32-beta.0";function it(...t){window.MisoClient&&window.MisoClient.plugins.isInstalled("std:debug")&&function(...t){console.log("%cMiso","color: #fff; background-color: #334cbb; padding: 2px 2px 1px 4px;",...t)}(...t)}const rt=864e5;function at(t){const e=t.split("-"),s=""+e[2].substring(1)+e[1]+e[0];return Math.floor(parseInt(s,16)/1e7)-12219292800}let ct;async function ut(){return ct||(ct=async function(){return async function(t,{interval:e=300,timeout:s}={}){const n=t();return null!=n?n:new Promise(((n,o)=>{let i,r;function a(){i&&clearInterval(i),r&&clearTimeout(r)}i=setInterval((()=>{const e=t();null!=e&&(a(),n(e))}),e),s&&s>0&&(r=setTimeout((()=>{a(),o(Error("Timeout: "+s))}),s))}))}((()=>window.ga&&window.ga.getAll&&window.ga.getAll()[0]))}())}async function lt(t){const e={};let s;try{s=await async function(t){if(!t)throw Error("Blank post ID.");const e=`https://b2c-contenthub.com/wp-json/wp/v2/posts/${t}?_embed=1`;return(await window.fetch(e)).json()}(t),it("Fetched post info",[s])}catch(s){return console.error("Cannot fetch post: "+t),console.error(s),e}try{const t=s._embedded["wp:term"];for(const s of t)s.length>0&&"story_types"===s[0].taxonomy&&(e.storyTypes=s.map((t=>t.name)))}catch(e){console.error("Cannot extract story types: "+t),console.error(e)}try{const{suppress_monetization:t='""'}=s.meta||{},n=JSON.parse(t);e.adSuppression=!0===n.content_ads}catch(e){console.error("Cannot extract suppress_monetization info: "+t),console.error(e)}return e}const dt=new Set(["News","Feature","How-To","Opinion"]);async function ht(t,e,s){if(0===s.length)return[];const n=`/wp-json/idg/v2/${e}?include=${s.join(",")}&article_id=${t.postId}&per_page=100&_embed=1`,o=await window.fetch(n);return await o.json()}function pt(t){return t.product_id.replace("product_","")}async function _t(t,e,{miso_id:s}={}){if(0===e.length)return{};const n=await ht(t.pageInfo,"deals-view",e);for(const e in n)n[e]=gt({...n[e],id:e},{...t,id:e,miso_id:s});return n}const ft='data-vars-link-position="',mt='data-miso-attribution="miso-ipp" data-miso-product-type="deal" ';function gt(t,e){return t=function(t,{pageInfo:e}){const{amazon_us_tag:s}=e.site;if(!s)return t;try{const{html:e}=t,i=e.indexOf('"https://go.redirectingat.com/'),r=0>i?-1:e.indexOf('"',i+1);if(r>=0){const a=(n=e.substring(i+1,r),(o=document.createElement("textarea")).innerHTML=n,o.value),{searchParams:c}=new URL(a),u=new URL(c.get("url"));if(u.hostname.endsWith("amazon.com")){u.searchParams.set("tag",s),c.set("url",""+u);const n="https://go.redirectingat.com/?"+c;t.html=e.substring(0,i+1)+"https://go.redirectingat.com/?"+c+e.substring(r),it("[Recommendation] Replaced Amazon link tag in deal view.",{original:a,replaced:n})}}}catch(t){console.error("Failed to replace Amazon link tag."),console.error(t)}var n,o;return t}(t=function(t,{miso_id:e}={}){try{const{html:s,id:n}=t,o=`data-product="${n}" `,i=s.indexOf(ft);if(0>i)throw Error(`Cannot find '${ft}' in product view HTML.`);let r=mt;e&&(r+=`data-miso-miso-id="${e}" `),t.html=s.substring(0,i)+o+r+s.substring(i)}catch(t){console.error("Failed to add miso attribution attribute on anchor element."),console.error(t)}return t}(t,e),e)}var yt={block:{title:"Today's Best Deals"},text:{from:"From",was:"Was",now:"Now",view_deal:"View deal"}},bt={block:{title:"Die besten Angebote des Tages"},text:{from:"Von",was:"Vorher",now:"Jetzt",view_deal:"Angebot ansehen"}};function wt(t,e,s={}){const n={product_ids:e.map((t=>t.product_id)),context:{custom_context:vt(t,e,s)}};return s.miso_id&&(n.miso_id=s.miso_id),n}function vt({type:t,site:e,storyId:s},n,{miso_id:o}={}){const{geo:i}=nt,r={source:"miso-client-script",script_version:ot,attribution:"miso-ipp",site:e.key,user_geo:i,product_types:n.map((t=>t.type))};if("story"===t&&s&&(r.story_id=s),o)try{r.api_ts=at(o)}catch(t){console.warn("[Recommendation] Failed to parse timestamp from miso_id: "+o)}return r}async function kt(t,e,{miso_id:s}={}){if(0===e.length)return{};const n=await ht(t.pageInfo,"products-view",e);for(const e in n)n[e]=xt(n[e],{...t,id:e,miso_id:s});return n}function xt(t,e){return!!function({html:t},{id:e,client:s,pageInfo:n}){if("false"===config.prod_check||"0"===config.prod_check)return it("[Recommendation] Product view validation waived due to prod_check=0 flag"),!0;if(0>t.indexOf(It))return it(`[Recommendation] Exclude product ${e} due to lack of outbound link.`),s.api.interactions.upload({type:"custom",custom_action_name:"invalid_product_view",product_ids:["product_"+e],context:{custom_context:vt(n,[{type:"product"}])}}),!1;return!0}(t,e)&&(t=function(t,e){try{const{html:e}=t,s=e.indexOf(Ot);if(0>s)throw Error(`Cannot find '${Ot}' in product view HTML.`);t.html=e.substring(0,s)+Et+e.substring(s)}catch(t){console.error("Failed to add miso attribution attribute on anchor element."),console.error(t)}return t}(t=function(t,{pageInfo:e}){const{html:s}=t,n=(o=e.site.lang,"de"===o?bt:yt);var o;return t.html=s.replace(Pt,`${Rt}${n.block.title}</h4>`),t}(t,e)))}const It='data-vars-outbound-link="',Rt='<h4 class="product-widget__block-title" id="">',Pt=Rt+"</h4>",Ot='data-vars-outbound-link="',Et='data-miso-attribution="miso-ipp" data-miso-product-type="product" ';function jt(t,e,s,n){if(!s)return;it("[Recommendation] Capturing impression event...");const o=new IntersectionObserver((s=>{if(s[0].isIntersecting){try{o.disconnect()}catch(t){console.error(t)}!function({client:t,pageInfo:e},s,n){if(Ct)return;Ct=!0,t.api.interactions.upload({...wt(e,s,n),type:"impression"}),it("[Recommendation] Impression event sent.")}(t,e,n)}}),{threshold:.5});o.observe(s)}let Ct=!1;async function At(t){const{client:e,pageInfo:s}=t;if("story"!==s.type)return void it(`[Recommendation] No block shown: not a story page (${s.type})`);const{storyTypes:n=[],adSuppression:o=!1}=await lt(s.postId)||{};if(o)return void it("[Recommendation] No block shown: ad suppression is enabled.");if(!n.some((t=>dt.has(t))))return void it("[Recommendation] No block shown: not applied for story_type: "+n.join(", "));const i=document.querySelector("#link_wrapped_content > p:nth-of-type(6)")||document.querySelector("#link_wrapped_content > p:last-of-type");if(!i)return void it("[Recommendation] No block shown: cannot find the reference position for recommendation block.");it("[Recommendation] Fetching results from Miso API...");const{products:r,...a}=await St(t);if(0===r.length)return void it("[Recommendation] No block shown: no result from Miso API.");it("[Recommendation] Building views...");const c=await async function(t,e,s){const n=[],o=[];for(const t of e)switch(t.type){case"product":n.push(pt(t));break;case"deal":o.push(pt(t));break;default:throw Error("Unrecognized product type: "+t.type)}const[i,r]=await Promise.all([kt(t,n,s),_t(t,o,s)]),a={...i,...r};return e.map((t=>a[pt(t)])).filter((t=>t)).map((t=>t&&t.html||"")).join("")}(t,r,a);c&&(it("[Recommendation] Inserting view HTML on page..."),i.insertAdjacentHTML("afterend",c),it("[Recommendation] Rendered successfully."),e.api.interactions.upload({...wt(s,r,a),type:"custom",custom_action_name:"display"}),jt(t,r,i.nextElementSibling,a))}function Nt(){const{geo:t,rec_type:e}=nt;if(e&&"product"!==e&&"deal"!==e)throw Error('Type parameter should be either "product", "deal", or absent: '+e);const s=Date.now();let n;const o=function(t){if(t)switch(t=t.toLowerCase()){case"us":case"gb":return t;case"de":case"at":case"ch":return"eu";default:return}}(t),i=function(t){if(t)switch(t){case"us":return 9910;case"gb":return 17657;case"eu":return 22080;default:return}}(o);if((!e||"deal"===e)&&o){n='type:"deal"';const t=function(t){const e=new Date(t);return e.setMinutes(0,0,0),e}(s).toISOString();n+=` AND custom_attributes.start_date:["${function(t,e){let s=Math.floor((e||Date.now())/rt)-t;return new Date(s*rt)}(28,s).toISOString()}" TO "${t}"]`,n+=` AND custom_attributes.end_date:["${t}" TO *]`,n+=` AND custom_attributes.geo_tags:"${o}"`;const e="custom_attributes.idg_deal_territories:0";n+=" AND "+(i?`(${e} OR custom_attributes.idg_deal_territories:${i})`:e)}return n}async function St(t,e={}){if(nt.test_deal)return{products:[{product_id:"product_"+nt.test_deal,type:"deal"}]};const{client:s,pageInfo:n}=t,o=Nt();if(!o)return{products:[]};e={product_id:n.storyId,fl:["type"],fq:o,rows:1,...e};try{const{products:t,miso_id:n}=await s.api.recommendation.productToProducts(e);return{products:t,miso_id:n}}catch(t){return console.error(t),[]}}Object.defineProperty(J,"name",{value:"ipp"});const $t=["product-name","link-position-id","link-position","outbound-link"],Tt=["attribution","product-type"];(async t=>{const e="false"!==nt.ui&&"0"!==nt.ui&&!1!==t.ui;if(window.miso_ipp_script_version)return void console.warn("Miso IPP script already executed: "+window.miso_ipp_script_version);window.miso_ipp_script_version=ot;J.plugins.use("std:debug"),it("Miso IPP script version: "+ot),nt.test_deal?(J.plugins.use("std:dry-run"),it("[Recommendation] Test deal: "+nt.test_deal)):nt.dry_run&&J.plugins.use("std:dry-run");const s=window.miso=new J({readConfigFromScriptUrl:!0});s.context.anonymous_id=await async function(){return(await ut()).get("clientId")}();const n=function(t){const e=window.location.pathname;if("/"===e)return{type:"home",site:t};const s=e.substring(1).split("/");if("article"===s[0]){const e=""+s[1];return{type:"story",site:t,postId:e,storyId:`story_${t.key}_${e}`}}return{type:"other",site:t}}(t),o={client:s,pageInfo:n};!function({client:t,pageInfo:e}){const{type:s,site:n,storyId:o}=e,{geo:i}=nt;switch(s){case"home":t.api.interactions.upload({type:"home_page_view",context:{custom_context:{source:"miso-client-script",script_version:ot,site:n.key,user_geo:i}}});break;case"story":t.api.interactions.upload({type:"product_detail_page_view",product_ids:[o],context:{custom_context:{source:"miso-client-script",script_version:ot,site:n.key,user_geo:i}}})}}(o),function({client:t,pageInfo:e}){const{type:s,site:n,storyId:o}=e;document.addEventListener("click",(e=>{if(e.defaultPrevented)return;const i=e.target;if(!i.tagName||"a"!==i.tagName.toLowerCase())return;const r=i.getAttribute("data-product");if(!r)return;const a="product_"+r,{geo:c}=nt,u={source:"miso-client-script",script_version:ot,site:n.key,user_geo:c};"story"===s&&o&&(u.story_id=o);for(const t of $t){const e=i.getAttribute("data-vars-"+t);e&&(u[t.replaceAll("-","_")]=e)}for(const t of Tt){const e=i.getAttribute("data-miso-"+t);e&&(u[t.replaceAll("-","_")]=e)}if(u.product_type)u.product_types=[u.product_type],delete u.product_type;else{const t=function(t){for(;(t=t.parentElement)&&!t.classList.contains(Lt);){for(const e of qt)if(t.classList.contains(e))return"product";for(const e of Ut)if(t.classList.contains(e))return"deal"}return}(i);t&&(u.product_types=[t])}const l=i.getAttribute("data-miso-miso-id");if(l)try{u.api_ts=at(l)}catch(t){console.warn("[Recommendation] Failed to parse timestamp from miso_id: "+l)}const d={type:"checkout",product_ids:[a],miso_id:l,context:{custom_context:u}};l&&(d.miso_id=l),t.api.interactions.upload(d)}))}(o),e&&At(o),s._recp2p=async t=>St(o,{fl:["*"],...t})})({key:"pcwelt",hostname:"www.pcwelt.de",name:"PC-WELT",lang:"de"});const qt=["product-chart-item","product-widget"],Ut=["price-comparison"],Lt="link_wrapped_content"}();
