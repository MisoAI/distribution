!function(){"use strict";const t=Symbol.for("miso-alm-cmd"),e=Symbol.for("miso-alm-ctx");var s="1.12.5";function n(...t){const e=t.length;if(0===e)return(new AbortController).signal;if(1===e)return t[0];const s=new AbortController;for(const e of t)if(e&&e.addEventListener){if(e.aborted)return AbortSignal.abort(e.reason);e.addEventListener("abort",(()=>s.abort(e.reason)))}return s.signal}const i=Object.freeze({ASK:"ask",SEARCH:"search",RECOMMENDATION:"recommendation",INTERACTIONS:"interactions"}),o=Object.freeze({QUESTIONS:"questions",RELATED_QUESTIONS:"related_questions",TRENDING_QUESTIONS:"trending_questions",SEARCH:"search",AUTOCOMPLETE:"autocomplete",SEARCH_AUTOCOMPLETE:"search_autocomplete",MGET:"mget",USER_TO_PRODUCTS:"user_to_products",USER_TO_CATEGORIES:"user_to_categories",USER_TO_ATTRIBUTES:"user_to_attributes",USER_TO_TRENDING:"user_to_trending",USER_TO_HISTORY:"user_to_history",PRODUCT_TO_PRODUCTS:"product_to_products",UPLOAD:"upload"});var r=Object.freeze({__proto__:null,GROUP:i,NAME:o});function a(t,e){if(!t)return;const s=t.indexOf(e);s>-1&&t.splice(s,1)}function c(t){if("object"!=typeof t)return t;const e={};for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&void 0!==t[s]&&(e[s]=t[s]);return e}function u(t){return null==t}function l(t,e,s){Object.defineProperties(t,(s="string"==typeof s?[s]:s).reduce(((t,s)=>(t[s]={get:()=>{const t=e[s];return"function"==typeof t?t.bind(e):t}},t)),{}))}function h(t,e){for(const s in e)e.hasOwnProperty(s)&&Object.defineProperty(t,s,{value:e[s]})}class d{constructor(t,{duration:e=0,onDuration:s,offDuration:n,state:i}={}){if("function"!=typeof t)throw Error("Callback must be a function: "+t);_(s),_(n),_(e),this._callback=t,Object.defineProperty(this,"durations",{value:Object.freeze({on:void 0!==s?s:e,off:void 0!==n?n:e})}),this._value=this._state=!!i,this._active=!0}get active(){return this._active}get state(){return this._state}get value(){return this._value}set value(t){if(this._value===(t=!!t))return;!function(t){if(!t._timeout)return;clearTimeout(t._timeout),t._timeout=void 0}(this);const e=this.durations[t?"on":"off"];e?this._timeout=setTimeout((()=>p(this,t)),e):p(this,t),this._value=t}disconnect(){this._active=!1}}function p(t,e){t._state!==e&&(t._state=e,t._active&&t._callback(e))}function _(t,e){if(void 0!==e&&(isNaN(e)||0>e))throw Error(`${t} must be a non-negative number: ${e}`)}function f(){return(crypto&&crypto.randomUUID?crypto.randomUUID():void 0)||function(){if(!URL||!URL.createObjectURL||URL.revokeObjectURL||!Blob)return;const t=URL.createObjectURL(new Blob),e=""+t;return URL.revokeObjectURL(t),e.substring(e.lastIndexOf("/")+1)}()||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}function m(t,e){const s=y((()=>window.localStorage.getItem(t))),n=y((()=>function(t){const e="; "+document.cookie,s=`; ${encodeURIComponent(t)}=`,n=e.indexOf(s);if(0>n)return;const i=n+s.length,o=e.indexOf(";",i);return decodeURIComponent(0>o?e.substring(i):e.substring(i,o))}(t))),i=s||n||""+e();return i&&!s&&y((()=>window.localStorage.setItem(t,i))),i&&!n&&y((()=>function(t,e){document.cookie=`${encodeURIComponent(t)}=${encodeURIComponent(e)}; max-age=31536000; path=/`}(t,i))),i}function y(t){try{return t()}catch(t){if(!function(t){return"SecurityError"===t.name}(t))throw t}}class g{constructor(){const t=this;t.promise=new Promise(((e,s)=>{t.resolve=e,t.reject=s})),Object.freeze(this)}}class b{constructor(){this._index=-1,this._done=!1,this._aborted=!1,this._abortReason=void 0,this._error=void 0}get aborted(){return this._aborted}get abortReason(){return this._abortReason}get done(){return this._done}update(t,e=!1){this._done||(this._value=t,this._done=e,this._index++,this._resolution&&(this._resolution.resolve(),this._resolution=void 0))}error(t){this._error=t,this._resolution&&(this._resolution.reject(t),this._resolution=void 0)}abort(t){this._aborted=!0,this._abortReason=t,this._resolution&&(t instanceof Error?this._resolution.reject(t):this._resolution.resolve(),this._resolution=void 0)}async*[Symbol.asyncIterator](){let t=0;for(;;){if(this._error)throw this._error;if(this._aborted)break;if(t>this._index&&(this._resolution||(this._resolution=new g),await this._resolution.promise),this._aborted)break;const e=this._done,s=this._index+1;if(yield this._value,this._aborted||e)break;t=s}}}let w;try{w=document.currentScript}catch(t){}async function v(t){try{let e=function(t){return document.head.querySelector(`link[href="${t}"]`)}(t);return e||(e=document.createElement("link"),e.rel="stylesheet",e.href=t,document.head.appendChild(e)),async function(t){await async function(t){if(t.sheet)return;return new Promise(((e,s)=>{let n;t.onerror=()=>{n&&clearInterval(n),s()},n=setInterval((()=>{t.sheet&&(n&&clearInterval(n),e())}),100)}))}(t),await async function(t){if(E(t))return;return new Promise((e=>{let s;s=setInterval((()=>{E(t)&&(s&&clearInterval(s),e())}),100)}))}(t)}(e)}catch(t){console.error(t)}}function E(t){for(const e of document.styleSheets)if(e.ownerNode===t)return!0;return!1}function x(t,{depth:e=5,...s}={}){return O(t,e)}function O(t,e,s){return e>0?"object"==typeof t&&t?void 0!==t.length?Array.prototype.map.call(t,(t=>O(t,e-1))):t instanceof Node?function(t){if(t instanceof Element)return`<${t.tagName.toLowerCase()}${t.id?` id="${t.id}"`:""}${t.className?` class="${t.className}"`:""}>`;return`[TextNode](${t.length})`}(t):function(t,e){const s={};if(0>=e)return s;for(const n in t){const i=t[n];"function"!=typeof i&&(n.startsWith("_")&&"object"==typeof i&&"Object"!==i.constructor.name||(s[n]=O(i,e-1)))}return s}(t,e):t:"(...)"}const R=Symbol.for("miso:resources");class P{constructor(){this._resources=new Map;const t=window[R]||[];for(const e of t)try{const[t,s]=e;this.push([t,s])}catch(t){}}push([t,e]){S(this._resources,t).resolve(e)}async get(t){return S(this._resources,t).promise}}function S(t,e){if(t.has(e))return t.get(e);const s=new g;return t.set(e,s),s}function C(){return window[R]||(window[R]=new P)}class T{constructor(t,e){this._dispatchRequested=!1,this._requests=[],this._run=t,this._error=e||(t=>console.error(t)),this._bulkId=0,this._dispatch=this._dispatch.bind(this)}get info(){return{bulkId:this._bulkId,index:this._requests.length}}async run(t){const e=new g;return this._requests.push({action:t,resolution:e}),this._requestDispatch(),e.promise}_requestDispatch(){this._dispatchRequested||(this._dispatchRequested=!0,setTimeout(this._dispatch))}_dispatch(){if(!this._dispatchRequested)return;this._dispatchRequested=!1;const t=this._requests,e=this._bulkId++;this._requests=[];try{this._run(t,{bulkId:e})}catch(t){this._error(t)}}}class I{constructor({target:t,error:e,replays:s=[]}={}){if(this._error=e||(t=>console.error(t)),!Array.isArray(s))throw Error("Replays option must be an array of strings: "+s);this._replays=new Set(s),this._namedCallbacks={},this._unnamedCallbacks=[],this._pastEvents={},t&&this._injectSubscribeInterface(t)}emit(t,e){const s={data:e,meta:{name:t,ts:Date.now()}},n=this._namedCallbacks[t];if(n)for(const t of n)t(s);for(const t of this._unnamedCallbacks)t(s);this._shallStoreForReplay(t)&&(this._pastEvents[t]||(this._pastEvents[t]=[])).push(s)}on(t,e){return this._checkName(t),this._checkCallback(e),this._on(t,this._wrapCallback(e))}once(t){this._checkName(t);const e=this;return new Promise(((s,n)=>{const i=e._on(t,(t=>{setTimeout((()=>i()));try{s(t)}catch(t){n(t)}}))}))}clear(){this._namedCallbacks={},this._unnamedCallbacks=[],this._pastEvents={}}_checkName(t){if("string"!=typeof t)throw Error("Event name should be a string: "+t)}_checkCallback(t){if("function"!=typeof t)throw Error("Event callback should be a function: "+t)}_shallStoreForReplay(t){return this._replays.has(t)}_wrapCallback(t){const e=this;return({data:s,meta:n})=>{try{t(s,n)}catch(t){e._error(t)}}}_on(t,e){if("*"===t?this._unnamedCallbacks.push(e):(this._namedCallbacks[t]||(this._namedCallbacks[t]=[])).push(e),"*"===t)for(const t in this._pastEvents)this._pastEvents[t].forEach(e);else this._pastEvents[t]&&this._pastEvents[t].forEach(e);return()=>this._off(t,e)}_off(t,e){if("*"===t)a(this._unnamedCallbacks,e);else{const s=this._namedCallbacks[t];s&&a(s,e)}}_injectSubscribeInterface(t){l(t,this,["on","once"])}}function k(t,e){return Object.freeze([...e&&e.meta&&e.meta.path||[],...t?[t]:[]])}class N{constructor(t,e){const s=function(t,e){if(void 0!==t&&"string"!=typeof t&&void 0===e&&(e=t,t=void 0),void 0!==t&&("string"!=typeof t||!t))throw Error(`Invalid Component name: "${t}"`);return Object.freeze({name:t,parent:e,path:k(t,e),uuid:f()})}(t,e);h(this,{meta:s});const n=this._error=this._error.bind(this);this._events=new I({target:this,error:n,replays:["child"]}),this._warn=this._warn.bind(this),(e=s.parent)&&e._events&&e._events.emit("child",this)}_warn(...t){const e=this.meta.parent;(e&&e._warn||console.warn)(...t)}_error(...t){const e=this.meta.parent;(e&&e._error||console.error)(...t)}}!function(t,e){const s=Symbol.for(e);Object.defineProperty(t,s,{value:!0}),Object.defineProperty(t,"isTypeOf",{value:e=>e&&e instanceof t||"function"==typeof e.constructor&&!0===e.constructor[s]})}(N,"miso:component");class U extends N{constructor(t,e,{libName:s,keyName:n}={}){switch(super(t,e),this._events._replays.add("register"),this._libraries={},this._libResolutions={},this._libName=s,typeof n){case"string":this._keyFn=t=>t[n];break;case"function":this._keyFn=n;break;default:throw Error("Expect keyName to be a string or a function: "+n)}}isRegistered(t){return this._checkKey(t),!!this._libraries[t]}get registered(){return Object.values(this._libraries)}async whenRegistered(t){if(this.isRegistered(t))return this._libraries[t];const{promise:e}=this._libResolutions[t]||(this._libResolutions[t]=new g);return e}register(...t){for(const e of t)this._register(e)}_checkKey(t){if("string"!=typeof t||!t)throw Error("Expect key to be a non-empty string: "+t)}_checkLib(t){if("function"!=typeof t)throw Error("Expect lib to be a class or function: "+t)}_register(t){this._checkLib(t);const e=this._keyFn(t);this._checkKey(e);const s=this._libraries||(this._libraries={});s[e]=t,this._libResolutions[e]&&this._libResolutions[e].resolve(t),this._events.emit("register",t)}}class A{constructor(t){this._ac=new AbortController,this._timeout=t,this.touch()}clear(){void 0!==this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=void 0)}touch(){this.clear(),this._timeoutId=setTimeout((()=>this.abort()),this._timeout)}get signal(){return this._ac.signal}abort(t){this.clear(),this._ac.abort(t||Error(`Stall timeout: data stay unchanged for ${this._timeout/1e3} seconds.`))}}const j=Object.freeze({DATA_ENDPOINT:"https://api-edge.askmiso.com/v1",EVENT_ENDPOINT:"https://api.askmiso.com/v1"});class q{constructor(t,e){this._client=t,this._root=e,this._bulk=new T(this._runBulkFetch.bind(this),t._error.bind(t))}async fetch(t,e,{method:s="POST",headers:n,timeout:i}={}){const{request:o={}}=this._client.options;i=i||o.timeout;const r="GET"!==s&&null!=e?JSON.stringify(e):void 0,a=i?AbortSignal.timeout(i):void 0,u=await(this._root._customFetch||window.fetch)(t,c({method:s,headers:n,body:r,cache:"no-cache",mode:"cors",signal:a})),l=await u.json();if(u.status>=400||l.errors){var h=Error(l.message);throw h.data=l,h.status=u.status,h}return l}get bulkInfo(){return this._bulk.info}async fetchForBulk(t,e,s,{method:n}={}){if(n&&"POST"!==n)throw Error("Non-POST API is not supported in bulk mode: "+url);return this._bulk.run({apiGroup:t,apiName:e,payload:s})}async _runBulkFetch(t){const e=this.url(["bulk"]),s={requests:t.map((({action:{apiGroup:t,apiName:e,payload:s}})=>({api_name:`${t}/${e}`,body:s})))},{data:n}=await this.fetch(e,s);for(let e=0,s=t.length;s>e;e++){const{resolution:s}=t[e],{error:i,status_code:o,body:r}=n[e];o>=400||i?s.reject({status_code:o,body:r}):s.resolve(r)}}sendBeacon(t,e,{method:s}={}){if(s&&"POST"!==s)throw Error("Non-POST API is not supported in useBeacon mode: "+t);if(!(this._root._customSendBeacon?this._root._customSendBeacon(t,JSON.stringify(e)):window.navigator.sendBeacon(t,JSON.stringify(e))))throw Error("Send beacon unsuccessful: "+t)}url(t){const{apiKey:e}=this._client.options,s=t.filter((t=>t)).join("/");return`${`${this.getApiEndpoint(s)}/${s}`}?api_key=${window.encodeURIComponent(e)}`}getApiEndpoint(t){const{dataEndpoint:e=j.DATA_ENDPOINT,eventEndpoint:s=j.EVENT_ENDPOINT}=this._client.options;return"interactions"===t?s:e}applyUrlPasses(t,{apiGroup:e,apiName:s,url:n}){const i=this._client;for(const o of this._root._urlPasses)try{n=o({client:i,apiGroup:e,apiName:s,url:n})||n}catch(e){(t._error||console.error)(e)}return n}applyPayloadPasses(t,{apiGroup:e,apiName:s,payload:n}){const i=this._client;for(const o of this._root._payloadPasses)try{n=o({client:i,apiGroup:e,apiName:s,payload:n})||n}catch(e){(t._error||console.error)(e)}return n}applyHeaderPasses(t,{apiGroup:e,apiName:s,payload:n,headers:i,options:o}){const r=this._client;for(const a of this._root._headersPasses)try{i=a({client:r,apiGroup:e,apiName:s,payload:n,headers:i,options:o})||i}catch(e){(t._error||console.error)(e)}return i}}class $ extends N{constructor(t,e){super(e,t),this._apiPath=e,this.helpers=t.helpers,this.clientOptions=t._client.options,this.context=t._client.context}async _run(t,e,s={}){const{bulk:n}=s,i=n?{bulk:this.helpers.bulkInfo}:void 0,o=this._apiPath,r=this._url({apiGroup:o,apiName:t,payload:e,options:s}),a=this._headers({apiGroup:o,apiName:t,payload:e,options:s}),c={apiGroup:o,apiName:t,payload:e=this._preprocess({apiGroup:o,apiName:t,payload:e,options:s}),url:r,headers:a,options:s};this._events.emit("request",{...c,...i});const u=await this._send(c),l={...c,response:u};return this._events.emit("response",{...l,...i}),this._postprocess(l)}_headers({apiGroup:t,apiName:e,payload:s,options:n}){return this.helpers.applyHeaderPasses(this,{apiGroup:t,apiName:e,payload:s,headers:{},options:n})}_preprocess({apiGroup:t,apiName:e,payload:s,options:n}){return this.helpers.applyPayloadPasses(this,{apiGroup:t,apiName:e,payload:s,options:n})}_url({apiGroup:t,apiName:e,options:s}){const n=this.helpers.url([t,e],s);return this.helpers.applyUrlPasses(this,{apiGroup:t,apiName:e,url:n,options:s})}async _send({apiGroup:t,apiName:e,url:s,headers:n,payload:i,options:{bulk:o,...r}={}}){return o?this.helpers.fetchForBulk(t,e,i):this.helpers.fetch(s,i,{...r,headers:n})}_postprocess({response:t}){return t.data}}const{GROUP:G,NAME:M}=r;class D extends ${constructor(t){super(t,G.INTERACTIONS)}async upload(t,e){try{return await this._run(M.UPLOAD,t,e)}catch(t){if(400!==t.status||!t.message||-1>=t.message.toLowerCase().indexOf("playground"))throw t;this._warn("Ignore interactions uploaded to playground app.")}}_url({apiGroup:t,apiName:e,options:s}){const n=this.helpers.url([this._apiPath],s);return this.helpers.applyUrlPasses(this,{apiGroup:t,apiName:e,url:n,options:s})}_preprocess({apiGroup:t,apiName:e,payload:s}){return e===M.UPLOAD&&(s=this._normalizeUploadPayload(s)),super._preprocess({apiGroup:t,apiName:e,payload:s})}_normalizeUploadPayload(t){if("object"!=typeof t)throw Error("Interactions payload has to be either an object or an array of objects: "+t);return Array.isArray(t)||(t=[t]),{data:t}}async _send({options:{useBeacon:t=!0,...e}={},...s}){if(t){const{url:t,payload:n}=s;return this.helpers.sendBeacon(t,n,e),{}}return super._send({...s,options:e})}}class L{constructor(t={}){this._ac=new AbortController,this._options=t}async get(t){return this._get({...this._options,...t})}_get(t){throw Error("Not implemented")}abort(t){this._ac.abort(t)}[Symbol.asyncIterator](){let{pollingInterval:t,signal:e,stallTimeout:s=12e4,...i}=this._options;const o=new A(s);let r;e=n(this._ac.signal,o.signal,e);return function(t,{interval:e=1e3,errorLimit:s=10,onError:n,onResponse:i,signal:o}={}){if(o&&o.aborted)return[];let r,a,c=0,l=!1;function h(){r&&clearInterval(r),l=!0}const d=new b;return r=setInterval((async()=>{let e,r,p;try{if([e,r,p]=await t(o?{signal:o}:{}),l||!u(a)&&a>=p)return;u(p)||(a=p),i&&i(e,r,p),c=0}catch(t){return n&&n(t),c++,void(c>s&&(h(),d.error(t)))}d.update(e,r),r&&h()}),e),o&&o.addEventListener&&o.addEventListener("abort",(()=>{h(),d.abort(o.reason)})),d}((async({}={})=>{const t=await this.get();return[t,this._isFinished(t),this._revisionOf(t)]}),{interval:t,signal:e,onResponse:(t,e)=>{e?o.clear():this._isUpdated(r,t)&&o.touch(),r=t},...i})[Symbol.asyncIterator]()}_isFinished(t){return!(!t||!t.finished)}_isUpdated(t,e){return!t||t.answer_stage!==e.answer_stage||B(t.answer)!==B(e.answer)||B(t.reasoning)!==B(e.reasoning)}_revisionOf(t){return t&&t.revision}}class H extends L{constructor(t,e,s,n){super(n),this._api=t,this._method=e,this._id=s}async _get(t){return this._api[this._method](this._id,t)}}function B(t=""){return t.length}const{GROUP:F,NAME:z}=r;class K extends ${constructor(t){super(t,F.ASK)}async questions(t,e={}){if(V(t)&&(t={question_id:t}),t.question_id)return new Q(this,t,e);const s=await this._run(z.QUESTIONS,t,e);return new Q(this,s,e)}async _questions(t,e){return this._run(z.QUESTIONS,t,e)}async _questionGet(t,e){return this._run(`${z.QUESTIONS}/${t}/answer`,void 0,{...e,method:"GET"})}async relatedQuestions(t,e={}){return this._run(z.RELATED_QUESTIONS,t,e)}async trendingQuestions(t,e={}){return this._run(z.TRENDING_QUESTIONS,t,e)}async search(t,e={}){if(V(t)&&(t={question_id:t}),t.question_id)return new J(this,t,e);const s=await this._run(z.SEARCH,t,e);return s.question_id?new J(this,s,e):s}async _searchGet(t,e){return this._run(`${z.QUESTIONS}/${t}/answer`,void 0,{...e,method:"GET"})}async autocomplete(t,e){return this._run(z.AUTOCOMPLETE,t,e)}async searchAutocomplete(t,e){return this._run(z.SEARCH_AUTOCOMPLETE,t,e)}}class Q extends H{constructor(t,e,s={}){super(t,"_questionGet",e.question_id,s),this._response=e}get questionId(){return this._id}}class J extends H{constructor(t,e,s={}){super(t,"_searchGet",e.question_id,s),h(this,e),this._response=e}get questionId(){return this._id}}function V(t){return"string"==typeof t&&"{"!==t.charAt(0)}const{GROUP:W,NAME:Y}=r;class X extends ${constructor(t){super(t,W.SEARCH)}async search(t,e){return this._run(Y.SEARCH,t,e)}async autocomplete(t,e){return this._run(Y.AUTOCOMPLETE,t,e)}async multipleGet(t,e){return this._run(Y.MGET,t,e)}}const{GROUP:Z,NAME:tt}=r;class et extends ${constructor(t){super(t,Z.RECOMMENDATION)}async userToProducts(t,e){return this._run(tt.USER_TO_PRODUCTS,t,e)}async userToCategories(t,e){return this._run(tt.USER_TO_CATEGORIES,t,e)}async userToAttributes(t,e){return this._run(tt.USER_TO_ATTRIBUTES,t,e)}async userToTrending(t,e){return this._run(tt.USER_TO_TRENDING,t,e)}async userToHistory(t,e){return this._run(tt.USER_TO_HISTORY,t,e)}async productToProducts(t,e){return this._run(tt.PRODUCT_TO_PRODUCTS,t,e)}}class st extends N{constructor(t,e){super("api",t),this._client=t,this.helpers=new q(t,e),this.interactions=new D(this),this.ask=new K(this),this.search=new X(this),this.recommendation=new et(this)}}var nt=Object.freeze({__proto__:null,Api:st,ApiBase:$,ApiHelpers:q,Interactions:D,Ask:K,Search:X,Recommendation:et});class it extends N{constructor(t){super("context",t),this._client=t}}var ot={api:nt,context:{Context:it}};class rt{constructor(t){h(this,{install:t})}}class at extends U{constructor(t){super("plugins",t,{libName:"plugin class",keyName:"id"}),this._root=t,this._currentScript=document.currentScript,this._events._replays.add("install").add("subtree"),this._installed={},this._installedResolutions={},this._useRequests={},this._subtrees=[],this.context=new ct(this,ot),this.plugins=new ut(this)}isInstalled(t){return this._checkKey(t),!!this._installed[t]}get installed(){return Object.values(this._installed)}get(t){return this._installed[t]}getPluginClass(t){return this._libraries[t]}use(t,e){if("function"==typeof t&&t.id&&"string"==typeof t.id)return this.register(t),void this.use(t.id,e);let s;if("string"==typeof t&&this.isInstalled(t))return s=this.get(t),void this._tryConfig(s,e);"string"!=typeof t||this.isRegistered(t)?(s=this._instantiate(t,e),this._install(s)):(this._useRequests[t]||(this._useRequests[t]=[])).push(e)}async install(t,e){return this.use(t,e),"string"!=typeof t||this.isRegistered(t)||await this._tryRegisterRemotely(t),this.whenInstalled(t)}async whenInstalled(t){if("function"==typeof t&&t.id&&"string"==typeof t.id&&(t=t.id),this.isInstalled(t))return this.get(t);const{promise:e}=this._installedResolutions[t]||(this._installedResolutions[t]=new g);return e}addSubtree(t){this._subtrees.push(t),this._events.emit("subtree",t)}addPayloadPass(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._payloadPasses.push(t)}addHeadersPass(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._headersPasses.push(t)}addUrlPass(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._urlPasses.push(t)}setCustomFetch(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._customFetch=t}setCustomSendBeacon(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._customSendBeacon=t}onHubUpdate(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._hubUpdateCallbacks.push(t)}onHubEmit(t){if("function"!=typeof t)throw Error("Expect parameter to be a function: "+t);this._root._hubEmitCallbacks.push(t)}_tryConfig(t,e){void 0!==e&&("function"==typeof t.config?(t.config(e),this._events.emit("config",[t,e])):this._warn(`Attempt to pass options to plugin "${t.id}", which offers no config() method.`))}_instantiate(t,e){switch(typeof t){case"string":this._checkKey(t);const s=this._libraries[t];if(!s)throw Error("Plugin class not found: "+t);const n=new s;return h(n,{id:t}),this._tryConfig(n,e),n;case"function":return new rt(t)}throw Error("Unexpected parameters: "+t)}_install(t){if("function"!=typeof t.install)throw Error("Expect plugin.install to be a function: "+t);try{t.installed=!1,t.install(this.MisoClient,this.context),t.installed=!0}catch(t){throw t}t.id&&(this._installed[t.id]=t,this._installedResolutions[t.id]&&(this._installedResolutions[t.id].resolve(t),delete this._installedResolutions[t.id])),this._events.emit("install",t)}_register(t){super._register(t),this._fulfillUseRequests(t.id)}_fulfillUseRequests(t){const e=this._useRequests[t];if(e){for(const s of e)try{this.use(t,s)}catch(t){this._error(t)}delete this._useRequests[t]}}async _tryRegisterRemotely(t){if(t.startsWith("std:"))try{return void await this._registerStdRemotely(t)}catch(t){console.error(t)}throw Error("Cannot register plugin remotely: "+t)}async _registerStdRemotely(t){const{version:e}=this._root,s="dev"===e?`plugin:${t}@dev:${this.MisoClient.uuid}`:`plugin:${t}@${e}`;if(!document.querySelector(`script[data-request="${s}"]`)){const n=document.createElement("script");n.async=!0,n.src=function(t,e,s){const n=t.slice(4);if("dev"===e){const t=s.src,e=t.indexOf("?"),i=0>e?t.length:e,o=t.lastIndexOf("/",i)+1,r=t.indexOf(".",o),a=0>r?"":t.slice(r,i);return`${t.slice(0,o)}plugins/${n}${a}`}return`https://cdn.jsdelivr.net/npm/@miso.ai/client-sdk@${e}/dist/umd/plugins/${n}.min.js`}(t,e,this._currentScript),n.setAttribute("data-request",s),document.head.appendChild(n)}const n=await(new C).get(s);!this.isRegistered(t)&&this.register(n)}}class ct{constructor(t,e){l(this,t,["getPluginClass","addSubtree","addPayloadPass","addHeadersPass","addUrlPass","setCustomFetch","setCustomSendBeacon","onHubUpdate","onHubEmit","whenInstalled","whenRegistered"]),h(this,{classes:e})}}class ut{constructor(t){l(this,t,["installed","registered","isInstalled","isRegistered","whenInstalled","whenRegistered","get","register","use","install"])}}const lt=new class extends N{constructor(){super(),this._events._replays.add("create"),this._pluginRoot=new at(this),this._clients=[],this._payloadPasses=[],this._headersPasses=[],this._urlPasses=[],this._customFetch=void 0,this._customSendBeacon=void 0,this._hubUpdateCallbacks=[],this._hubEmitCallbacks=[],this.version=s,this._cmdRes=new g}get instances(){return[...this._clients]}async any(){return this._clients[0]||this._any||(this._any=(await this._events.once("create")).data)}get cmdDone(){return this._cmdRes.promise}};var ht=Object.freeze({__proto__:null,viewable:async function(t,{area:e=.5,duration:s=1e3,signal:n}={}){var i;return t="string"==typeof(i=t)?document.querySelector(i):i,new Promise(((i,o)=>{const r=new d((t=>{t&&(r.disconnect(),a.disconnect(),i())}),{onDuration:s}),a=new IntersectionObserver((t=>{r.value=t[0].isIntersecting}),{threshold:e});a.observe(t),n&&n.addEventListener&&n.addEventListener("abort",(()=>{r.disconnect(),a.disconnect(),o(new DOMException("Aborted","AbortError"))}))}))},debounce:function(t){let e;return s=>{e&&clearTimeout(e),e=setTimeout((()=>{e=void 0,s()}),t)}}});const{currentScript:dt}=document;class pt extends N{static attach(){(window.MisoClients||(window.MisoClients=[])).push(pt),window.MisoClient?window.MisoClient!==pt&&console.warn(`window.MisoClient already exists: (${window.MisoClient.version}).`):window.MisoClient=pt}static debug(){}constructor(t){super("client",lt),this._config(t),this.context=new it(this),this.api=new st(this,lt),function(t){lt._clients.push(t),lt._events.emit("create",t)}(this)}get version(){return pt.version}_config(t){this.options=Object.freeze(this._normalizeOptions(t))}_normalizeOptions(t={}){if("string"==typeof t&&(t={apiKey:t}),t.readConfigFromScriptUrl&&(t={...this._readConfigFromScriptUrl(),...t}),!t.apiKey)throw Error("Require API key to initialize miso client.");return t.request&&t.request.sendApiKeyByHeader&&console.warn('`sendApiKeyByHeader` option is deprecated. Please call `MisoClient.plugins.use("std:header-api-key");` instead.'),t.dataEndpoint=t.dataEndpoint||t.apiHost,t.eventEndpoint=t.eventEndpoint||t.apiHost,delete t.apiHost,c(t)}_readConfigFromScriptUrl(){return c({apiKey:new URL(new Request(dt.src||dt.href).url).searchParams.get("api_key")||void 0})}}pt.helpers=ht,h(pt,{uuid:f()});var _t=function(t){const e=lt._pluginRoot;return lt.MisoClient=e.MisoClient=t,l(t,lt,["version","instances","any","meta","on","once","cmdDone"]),l(t,e,["plugins"]),t}(pt);const{GROUP:ft,NAME:mt}=r;let yt;class gt{constructor(t){this._plugin=t,this._props={}}get anonymous_id(){return this._props.anonymous_id||yt||(yt=m("miso_anonymous_id",f))}set anonymous_id(t){this._requireString("anonymous_id",t),this._set("anonymous_id",t)}get user_id(){return this._props.user_id}set user_id(t){this._requireString("user_id",t),this._set("user_id",t)}get user_hash(){return this._props.user_hash}set user_hash(t){this._requireString("user_hash",t),this._set("user_hash",t)}get user_type(){return this._props.user_type}set user_type(t){this._requireString("user_type",t),this._set("user_type",t)}get site(){return this._props.site}set site(t){this._requireString("site",t),this._set("site",t)}get auth(){return this._props.auth}set auth(t){this._requireString("auth",t),this._set("auth",t)}_set(t,e){this._props[t]=e,this._plugin._events.emit("set",`${t} = '${e}'`)}_requireString(t,e){if("string"!=typeof e&&void 0!==e)throw Error(t+" must be a string");return e}}function bt(){const t=new URLSearchParams(window.location.search);let e=c({source:t.get("utm_source")||void 0,medium:t.get("utm_medium")||void 0,name:t.get("utm_campaign")||void 0,term:t.get("utm_term")||void 0,content:t.get("utm_content")||void 0});return 0===Object.keys(e).length?void 0:e}class wt{constructor(t){this._plugin=t,this._config={search:!0},this.interface=Object.freeze({config:this.config.bind(this)})}config(t={}){if("object"!=typeof t)throw Error("Config options must be an object or undefined: "+t);for(const e of t){if(!this._config.hasOwnProperty(e))continue;const s=this._config[e],n=t[e];n!==s&&(this._config[e]=s,this._plugin._events.emit("config",`${e}: ${s} -> ${n}`))}return Object.freeze({...this._config})}}function vt(t){const{context:e={}}=t,n={...e.custom_context,sdk_version:s};return n.uuid||(n.uuid=f()),{...t,context:{...e,custom_context:n}}}const Et="std:native-fetch";let xt,Ot;const Rt=(()=>{if((""+window.fetch).indexOf("[native code]")>-1)return xt="original",window.fetch;try{const t=document.createElement("iframe");return t.style.display="none",document.head.appendChild(t),xt="borrowed",t.contentWindow.fetch}catch(t){Ot=t}})();const Pt="std:header-api-key";const St="miso-logdump",Ct="miso-logdump",Tt=Ct+"__download-btn",It="Miso Log";class kt{constructor(t={}){this._options=t,this._logs=[]}config(t={}){this._options={...this._options,...t}}async showDownloadButton(){await async function(){return jt||(jt=v((t="logdump",`https://cdn.jsdelivr.net/npm/@miso.ai/client-sdk@1.12.5/dist/css/${t}.css`)));var t}();let t=document.getElementById(St);if(!t){const e=document.createElement("div");e.textContent=this._options.logDownloadButtonText||It,e.classList.add(Tt),e.addEventListener("click",(()=>this.download())),t=document.createElement("div"),t.id=St,t.classList.add(Ct),t.appendChild(e),document.body.appendChild(t)}t.style.display="block"}_syncUi(){const t=document.getElementById(St),e=t&&t.querySelector("."+Tt);e&&(e.textContent=this._options.logDownloadButtonText||It)}hideDownloadButton(){const t=document.getElementById(St);t&&(t.style.display="none")}download(){const t=new Blob([Ut(this._logs)],{type:"application/json"}),e=URL.createObjectURL(t),s=document.createElement("a");s.href=e,s.download=this._filename(),s.click()}_filename(){let{logFilename:t}=this._options;if("function"==typeof t){t=t({timestamp:Nt()})}return t&&"string"==typeof t?t:`miso-log.${Nt()}.jsonl`}clear(){this._logs=[]}}function Nt(){return(new Date).toISOString().replaceAll(/[\:\.]/g,"-")}function Ut(t){return t.map((t=>JSON.stringify(x(function(t){if("<progressive-markdown>"===t[0]){const e=t.length;return[...t.slice(0,e-1),At(t[e-1])]}return t}(t),{depth:10})))).join("\n")}function At(t){return t?x(t,{depth:2}):t}let jt;const qt="std:debug";function $t(t){const e=typeof t;return"function"===e||"object"===e&&!Array.isArray(t)?[t]:t}_t.plugins.register(class{constructor(t={}){this._options=t,this._logs=new kt(t)}static get id(){return qt}install(t){this._injectComponents(t),t.debug=(...t)=>this._logr(...t),t.logs=this._logs}config(t={}){this._options={...this._options,...t},this._logs.config(t),t.preserveLog&&this._log(qt,"ua",window.navigator.userAgent)}_injectComponents(t,e=[]){t.on("child",(t=>this._injectComponents(t,e))),t.on("subtree",(s=>this._injectComponents(s,e.concat(t.meta.path)))),t.on("*",((s,n)=>this._handleEvent(t,n,s,e)))}_handleEvent(t,{name:e},s,n=[]){if("child"===e||"subtree"===e)return;const i=n.concat(t.meta.path);if(i.length||"create"!==e){switch(i[0]){case"client":if("api"===i[1])return void this._handleApiEvent(e,{...s,groupName:i[2]});break;case"plugins":return void(1===i.length?this._handlePluginsEvent(e,s):this._handlePluginSpecificEvent(i[1],i.slice(2),e,s))}this._logw(i.join("."),e,s)}else this._handleCreateClient(e,s)}_handleCreateClient(t,e){this._logw("client",t,e)}_handleApiEvent(t,{groupName:e,apiName:s,url:n,bulk:i,...o}){const r=new URL(n).pathname,a=["api",t];if(i&&a.push(`(bulk ${i.bulkId})`),a.push("POST "+r),"interactions"===e){const t=o.payload.data[0],{type:e,custom_action_name:s,context:{custom_context:{property:n}={}}={}}=t,i="custom"===e&&s?`${e}:${s}`:e;a.push(n?`${i} (${n})`:""+i)}a.push([{...o,url:n}]),this._log(...a)}_handlePluginsEvent(t,e){let s=[];Array.isArray(e)&&(s=e.slice(1),e=e[0]),this._log("plugins",t,""+(e.id||"(anonymous)"),[e,...s])}_handlePluginSpecificEvent(t,e,s,n){this._logw([t,e.join(".")],s,n)}_getPath(t){const e=[];for(let s=t;s;s=s.meta.parent)s.meta.name&&e.push(s.meta.name);return e.reverse()}_logw(t,e,s){void 0===s?this._log(t,e):Array.isArray(s)?this._log(t,e,...s.map($t)):this._log(t,e,$t(s))}_log(t,e,...s){this._logr(function(t){return`<${"string"==typeof t?t:t.filter((t=>t)).join("/")}>`}(t),function(t){return`[${t}]`}(e),...s)}_logr(...t){const e=this._options.console||{};this._options.preserveLog&&this._logs._logs.push(t),console.log(function({text:t="Miso"}={}){return"%c"+t}(e),function({color:t="#fff",background:e="#334cbb"}={}){return`color: ${t}; background-color: ${e}; padding: 2px 2px 1px 4px;`}(e),...t)}},class{constructor(t={}){this._options=t,this.id="std:dry-run",this.name="dry-run"}static get id(){return"std:dry-run"}install(t,{addUrlPass:e}){e(this._modifyUrl.bind(this))}_modifyUrl({apiGroup:t,apiName:e,url:s}){return"interactions"===t&&"upload"===e?function(t,e,s){if("string"!=typeof e)throw Error("Expect URL parameter to be a string: "+e);return void 0===s&&(s="1"),t+(0>t.indexOf("?")?"?":"&")+encodeURIComponent(e)+"="+encodeURIComponent(""+s)}(s,"dry_run","1"):s}},class{static get id(){return Et}install(t,e){Rt?(e.setCustomFetch(Rt),t.debug(`<plugin:${Et}>`,"[info]",`Using ${xt} native fetch`)):t.debug(`<plugin:${Et}>`,"[error]","Failed to obtain native fetch: "+Ot.message)}},class{static get id(){return Pt}install(t,e){e.addUrlPass(this._modifyUrl.bind(this)),e.addHeadersPass(this._modifyHeaders.bind(this)),t.debug(`<plugin:${Pt}>`,"[info]","Send API key in header")}_modifyUrl({url:t}){return t.replace(/[?&]api_key=[^&]*/g,"")}_modifyHeaders({client:t,headers:e}){const{apiKey:s}=t.options;return s?{...e,"X-API-KEY":s}:e}}),_t.plugins.use(class extends N{static get id(){return"std:context"}constructor(){super("context")}install(t,e){e.addSubtree(this),t.on("create",this._injectClient.bind(this)),e.addHeadersPass(this._modifyHeaders.bind(this)),e.addPayloadPass(this._modifyPayload.bind(this))}_injectClient(t){const e=new gt(this);var s,n;s=e,Object.defineProperties(t.context,(n="string"==typeof(n=["anonymous_id","user_id","user_hash","user_type","site","auth"])?[n]:n).reduce(((t,e)=>(t[e]={get:()=>s[e],set:t=>{s[e]=t}},t)),{}))}_modifyHeaders({client:t,headers:e}){const{auth:s}=t.context;return s&&(e={...e,Authorization:s}),e}_modifyPayload({client:t,apiGroup:e,apiName:s,payload:n}){return n?e===ft.INTERACTIONS?s===mt.UPLOAD?this._modifyPayloadForInteractions(t,n):n:this._modifyPayloadForQueries(t,n):n}_modifyPayloadForQueries(t,e){const{user_id:s,user_hash:n,user_type:i,anonymous_id:o,site:r}=t.context;return function(t={},e={}){const s=t.metadata||e.metadata?c({...t.metadata,...e.metadata}):void 0,n=t._meta||e._meta?c({...t._meta,...e._meta}):void 0;return c({...t,...e,metadata:s,_meta:n})}(e,{...s?{user_id:s,user_type:i,user_hash:n}:{anonymous_id:o},metadata:r?{site:r}:void 0})}_modifyPayloadForInteractions(t,{data:e}){const{anonymous_id:s,user_id:n,site:i}=t.context,o={anonymous_id:s,user_id:n},r=i?{site:i}:void 0,a=r?{custom_context:r}:void 0;return e=e.map((t=>function(t={},e={}){const s=t.context&&t.context.custom_context||e.context&&e.context.custom_context?c({...t.context&&t.context.custom_context,...e.context&&e.context.custom_context}):void 0,n=t.context||e.context?c({...t.context,...e.context,custom_context:s}):void 0;return c({...t,...e,context:n})}(t,{...o,context:a}))),{data:e}}}),_t.plugins.use(class{static get id(){return"std:page-info"}constructor(){}install(t,{addPayloadPass:e}){e(this._modifyPayload.bind(this))}_modifyPayload({apiGroup:t,apiName:e,payload:s}){return"interactions"===t&&"upload"===e?this._modifyPayloadForInteractions(s):s}_modifyPayloadForInteractions({data:t}){return{data:t=t.map((t=>({...t,context:{...c({page:c({url:window.location.href,referrer:document.referrer||void 0,title:document.title}),campaign:bt()}),...t.context}})))}}}),_t.plugins.use(class extends N{static get id(){return"std:auto-events"}constructor(){super("auto-events"),this._contexts=new WeakMap}install(t,e){e.addSubtree(this),t.on("create",this._injectClient.bind(this)),e.addPayloadPass(this._captureApiRequest.bind(this))}_injectClient(t){const e=new wt(this);this._contexts.set(t,e),t.autoEvents=e.interface}_captureApiRequest({client:t,apiGroup:e,apiName:s,payload:n}){if(e===i.SEARCH)if(s===o.SEARCH)this._captureSearchApiRequest(t,n)}_captureSearchApiRequest(t,{q:e}){if(!e||"*"===e)return;const s=this._contexts.get(t);s&&s._config.search&&t.api.interactions.upload({type:"search",search:{keywords:e},context:{custom_context:{channel:"miso_api"}}})}}),_t.plugins.use(class{static get id(){return"std:interactions"}constructor(){}install(t,{addPayloadPass:e}){e(this._modifyPayload.bind(this))}_modifyPayload({apiGroup:t,apiName:e,payload:s}){return"interactions"===t&&"upload"===e?this._modifyPayloadForInteractions(s):s}_modifyPayloadForInteractions({data:t}){return{data:t.map(vt)}}}),_t.plugins.use(class extends N{static get id(){return"std:api-patch"}constructor(){super("api-patch")}install(t,e){e.addSubtree(this),e.addPayloadPass(this._patchApiPayload.bind(this))}_patchApiPayload(t){let{payload:e,...s}=t;return e?(e=this._copyMetadataToMeta(e,s),e=this._suppressMetadata(e,s),e=this._suppressUserType(e,s),e):e}_copyMetadataToMeta(t,{apiGroup:e}){return e===i.ASK&&t.metadata?{...t,_meta:t.metadata}:t}_suppressMetadata(t,{apiGroup:e}){switch(e){case i.SEARCH:case i.RECOMMENDATION:const{_meta:e,metadata:s,...n}=t;return n;default:return t}}_suppressUserType(t,{apiGroup:e}){switch(e){case i.SEARCH:case i.RECOMMENDATION:const{user_type:e,...s}=t;return s;default:return t}}});const Gt="B43jkUKwmy9iEz17kO5V21KoPTmORcuBTRfltOVO";let Mt,Dt,Lt;async function Ht(t){return Mt||(Mt=async function(t){const e=new _t(Gt),s=function(t){return t.tealium_visitor_id}(t);if(!s)throw Error("Anonymous ID not found");const n=function(t){return t["cp.userId"]}(t);e.context.anonymous_id=s,n&&(e.context.user_id=n);return[_t,e]}(t))}function Bt(t){return t()||new Promise((e=>{const s=Date.now();let n;n=setInterval((()=>{const i=t();i?(n&&clearInterval(n),e(i)):Date.now()-s>5e3&&(n&&clearInterval(n),e(void 0))}),300)}))}const Ft={utag:[],utag_data:[]};function zt(t,...e){for(const s of Ft[t])try{s(...e)}catch(t){console.error(t)}}function Kt(t,e){return"utag"===t&&Dt?(e(Dt),()=>{}):"utag_data"===t&&Lt?(e(Lt),()=>{}):(Ft[t].push(e),()=>function(t,e){const s=Ft[t].indexOf(e);-1!==s&&Ft[t].splice(s,1)}(t,e))}async function Qt(t,e){try{await async function(t){!function({client:t,params:e}){const{natural_id:s}=e;s&&t.api.interactions.upload({type:"product_detail_page_view",product_ids:[s]})}(t)}({...t,params:e})}catch(t){console.error(t)}}(async()=>{Dt=await Bt((()=>window.utag)),zt("utag",Dt)})(),(async()=>{Lt=await Bt((()=>window.utag_data)),zt("utag_data",Lt)})(),(async()=>{window[e]||async function(e){const[s]=await async function(t){let e;const s=await new Promise(((s,n)=>{e=Kt(t,((...t)=>s(t)))}));return e(),s}("utag_data"),[n,i]=await Ht(s);Object.assign(e,{MisoClient:n,client:i,utag_data:s});const o=window[t]||[];Object.defineProperty(window,t,{value:Object.freeze({push:t=>Qt(e,t)})});for(const t of o)Qt(e,t)}(window[e]={})})(),(()=>{const{currentScript:e}=document;if(!e)return;const{src:s}=e;if(s)try{const e={};for(const[t,n]of new URL(s).searchParams)e[t]=n;(window[t]||(window[t]=[])).push(e)}catch(t){console.error(t)}})()}();
